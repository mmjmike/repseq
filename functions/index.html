
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
      
        <link rel="prev" href="../usage_diffexp/">
      
      
      
      <link rel="icon" href="../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.6.1, mkdocs-material-9.6.20">
    
    
      
        <title>Functions - Repseq Library for Immune repertoire postanalysis</title>
      
    
    
      <link rel="stylesheet" href="../assets/stylesheets/main.e53b48f4.min.css">
      
        
        <link rel="stylesheet" href="../assets/stylesheets/palette.06af60db.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
      <link rel="stylesheet" href="../assets/_mkdocstrings.css">
    
    <script>__md_scope=new URL("..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    
    
      
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="teal" data-md-color-accent="purple">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#all-functions" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

<header class="md-header" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href=".." title="Repseq Library for Immune repertoire postanalysis" class="md-header__button md-logo" aria-label="Repseq Library for Immune repertoire postanalysis" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            Repseq Library for Immune repertoire postanalysis
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Functions
            
          </span>
        </div>
      </div>
    </div>
    
      
        <form class="md-header__option" data-md-component="palette">
  
    
    
    
    <input class="md-option" data-md-color-media="" data-md-color-scheme="default" data-md-color-primary="teal" data-md-color-accent="purple"  aria-label="Switch to dark mode"  type="radio" name="__palette" id="__palette_0">
    
      <label class="md-header__button md-icon" title="Switch to dark mode" for="__palette_1" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M17 6H7c-3.31 0-6 2.69-6 6s2.69 6 6 6h10c3.31 0 6-2.69 6-6s-2.69-6-6-6m0 10H7c-2.21 0-4-1.79-4-4s1.79-4 4-4h10c2.21 0 4 1.79 4 4s-1.79 4-4 4M7 9c-1.66 0-3 1.34-3 3s1.34 3 3 3 3-1.34 3-3-1.34-3-3-3"/></svg>
      </label>
    
  
    
    
    
    <input class="md-option" data-md-color-media="" data-md-color-scheme="slate" data-md-color-primary="teal" data-md-color-accent="lime"  aria-label="Switch to light mode"  type="radio" name="__palette" id="__palette_1">
    
      <label class="md-header__button md-icon" title="Switch to light mode" for="__palette_0" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M17 7H7a5 5 0 0 0-5 5 5 5 0 0 0 5 5h10a5 5 0 0 0 5-5 5 5 0 0 0-5-5m0 8a3 3 0 0 1-3-3 3 3 0 0 1 3-3 3 3 0 0 1 3 3 3 3 0 0 1-3 3"/></svg>
      </label>
    
  
</form>
      
    
    
      <script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
    
    
    
      
      
        <label class="md-header__button md-icon" for="__search">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        </label>
        <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
        </button>
      </nav>
      
        <div class="md-search__suggest" data-md-component="search-suggest"></div>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" tabindex="0" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
      
    
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
            
<nav class="md-tabs" aria-label="Tabs" data-md-component="tabs">
  <div class="md-grid">
    <ul class="md-tabs__list">
      
        
  
  
  
  
    <li class="md-tabs__item">
      <a href=".." class="md-tabs__link">
        
  
  
    
  
  Home

      </a>
    </li>
  

      
        
  
  
  
  
    <li class="md-tabs__item">
      <a href="../installation/" class="md-tabs__link">
        
  
  
    
  
  Installation

      </a>
    </li>
  

      
        
  
  
  
  
    <li class="md-tabs__item">
      <a href="../modules/" class="md-tabs__link">
        
  
  
    
  
  Modules

      </a>
    </li>
  

      
        
  
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../usage_mixcr/" class="md-tabs__link">
          
  
  
  Usage

        </a>
      </li>
    
  

      
        
  
  
  
    
  
  
    <li class="md-tabs__item md-tabs__item--active">
      <a href="./" class="md-tabs__link">
        
  
  
    
  
  Functions

      </a>
    </li>
  

      
    </ul>
  </div>
</nav>
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


  


  

<nav class="md-nav md-nav--primary md-nav--lifted md-nav--integrated" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href=".." title="Repseq Library for Immune repertoire postanalysis" class="md-nav__button md-logo" aria-label="Repseq Library for Immune repertoire postanalysis" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    Repseq Library for Immune repertoire postanalysis
  </label>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href=".." class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Home
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../installation/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Installation
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../modules/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Modules
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_4" >
        
          
          <label class="md-nav__link" for="__nav_4" id="__nav_4_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Usage
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_4_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_4">
            <span class="md-nav__icon md-icon"></span>
            Usage
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../usage_mixcr/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    MiXCR
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../usage_stats/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Stats
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../usage_intersections/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Intersections
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../usage_clustering/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Clustering
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../usage_diffexp/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Differential expression
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
    
  
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          
  
  
  <span class="md-ellipsis">
    Functions
    
  </span>
  

          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        
  
  
  <span class="md-ellipsis">
    Functions
    
  </span>
  

      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#clone_filter" class="md-nav__link">
    <span class="md-ellipsis">
      clone_filter
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#clonosets" class="md-nav__link">
    <span class="md-ellipsis">
      clonosets
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#clustering" class="md-nav__link">
    <span class="md-ellipsis">
      clustering
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#common_functions" class="md-nav__link">
    <span class="md-ellipsis">
      common_functions
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#constants" class="md-nav__link">
    <span class="md-ellipsis">
      constants
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#diffexp" class="md-nav__link">
    <span class="md-ellipsis">
      diffexp
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#intersections" class="md-nav__link">
    <span class="md-ellipsis">
      intersections
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#io" class="md-nav__link">
    <span class="md-ellipsis">
      io
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#logo" class="md-nav__link">
    <span class="md-ellipsis">
      logo
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#migec" class="md-nav__link">
    <span class="md-ellipsis">
      migec
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#minnn" class="md-nav__link">
    <span class="md-ellipsis">
      minnn
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#mixcr" class="md-nav__link">
    <span class="md-ellipsis">
      mixcr
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#pgen_calculation" class="md-nav__link">
    <span class="md-ellipsis">
      pgen_calculation
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#processing_stats" class="md-nav__link">
    <span class="md-ellipsis">
      processing_stats
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#segment_usage" class="md-nav__link">
    <span class="md-ellipsis">
      segment_usage
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#slurm" class="md-nav__link">
    <span class="md-ellipsis">
      slurm
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#stats" class="md-nav__link">
    <span class="md-ellipsis">
      stats
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#tcrdist_clustering" class="md-nav__link">
    <span class="md-ellipsis">
      tcrdist_clustering
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#tcrdist_clusters_slurm" class="md-nav__link">
    <span class="md-ellipsis">
      tcrdist_clusters_slurm
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#vdjtools" class="md-nav__link">
    <span class="md-ellipsis">
      vdjtools
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  



<h1 id="all-functions">All functions</h1>
<h2 id="clone_filter"><strong>clone_filter</strong></h2>


<div class="doc doc-object doc-module">




    <div class="doc doc-contents first">










  <div class="doc doc-children">









<div class="doc doc-object doc-class">



<h4 id="clone_filter.Filter" class="doc doc-heading">
            <code>Filter</code>


</h4>


    <div class="doc doc-contents ">


        <p>Clonoset filter.
May be used to filter clonosets:
    - by clone functionality
    - randomly downsample them to particular number of reads of UMIs
    - take top clonotypes by size (number of reads of UMIs) with or without random mixing</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>name</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>the name of the filter. Will be displayed in print</p>
              </div>
            </td>
            <td>
                  <code>&#39;default_filter&#39;</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>functionality</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Possible values:
- "a" - any (default). No clones are filtered out
- "f" - only functional. Those, not having stop codons and 
    frame shifts in CDR3 regions, or having non-empty values in CDR3 amino-acid
    sequence
- "n" - only-nonfunctional - opposite to "f" - functional</p>
              </div>
            </td>
            <td>
                  <code>&#39;a&#39;</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>downsample</code>
            </td>
            <td>
                  <code><span title="int">int</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>the number of reads/UMIs to randomly downsample the clonoset to.
default value 'None' - means not to apply downsampling</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>top</code>
            </td>
            <td>
                  <code><span title="int">int</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>the number of top biggest by reads/UMIs clonotypes to take from the clonoset.
default value 'None' - means not to apply top</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>by_umi</code>
            </td>
            <td>
                  <code><span title="bool">bool</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>default=False. Which column to take for clonotype count - reads or UMIs 
(if UMI count column exists).</p>
              </div>
            </td>
            <td>
                  <code>False</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>mix_tails</code>
            </td>
            <td>
                  <code><span title="bool">bool</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>default=False. Defines whether to randomly mix-up the order of clonotypes
before sorting by size and taking the top clonotypes. Basically mix_tails=True mixes up 
clonotypes with the same size in read or UMIs.</p>
              </div>
            </td>
            <td>
                  <code>False</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>count_threshold</code>
            </td>
            <td>
                  <code><span title="int">int</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>limits [0:100000], all clonotypes with count less than this value will
be filtered out</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>seed</code>
            </td>
            <td>
                  <code>any hashable type</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>better to use int - seed for reproducibility of random events 
(downsampling or top with mix-tails). Default=None.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>unweight</code>
            </td>
            <td>
                  <code><span title="bool">bool</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>each clonotype counts (either reads or UMIs) are set to 1</p>
              </div>
            </td>
            <td>
                  <code>False</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>recount_fractions</code>
            </td>
            <td>
                  <code><span title="bool">bool</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>if <code>True</code>, clonotype fractions are recalculated after filtration</p>
              </div>
            </td>
            <td>
                  <code>True</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>white_list</code>
            </td>
            <td>
                  <code>list of tuples</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If specified, only clonotypes matching those listed will be retained. Either <code>aa</code>, <code>aaV</code> or <code>aaVJ</code> 
formats can be used to list clonotypes, e.g. [(“CASSS..”)], [(“CASSS..”, “TRBV2”)] or [(“CASSS..”, “TRBV2”, “TRBJ1”)]. 
It is applied before <code>black_list</code></p>
              </div>
            </td>
            <td>
                  <code>[]</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>black_list</code>
            </td>
            <td>
                  <code>list of tuples</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If specified, only clonotypes not listed will be retained. Either <code>aa</code>, <code>aaV</code> or <code>aaVJ</code> 
formats can be used to list clonotypes, e.g. [(“CASSS..”)], [(“CASSS..”, “TRBV2”)] or [(“CASSS..”, “TRBV2”, “TRBJ1”)]</p>
              </div>
            </td>
            <td>
                  <code>[]</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>pool_clonoset_by</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>possible values are ["", "aa", "aaV", "aaVj", "nt", "ntV", "ntVJ"]. Clones with identical parameters are merged, 
keeping the largest one, while their counts are summed.</p>
              </div>
            </td>
            <td>
                  <code>&#39;&#39;</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>convert</code>
            </td>
            <td>
                  <code><span title="bool">bool</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>By default, columns are added to the clonotype set to convert 
it to the VDJtools format, and the original columns are removed. If set to  <code>False</code>, all original columns are preserved.</p>
              </div>
            </td>
            <td>
                  <code>True</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>ignore_small_clonosets</code>
            </td>
            <td>
                  <code><span title="bool">bool</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If the top or downsample threshold exceeds the counts for a clonoset, the set is kept intact</p>
              </div>
            </td>
            <td>
                  <code>False</code>
            </td>
          </tr>
      </tbody>
    </table>








              <details class="quote">
                <summary>Source code in <code>repseq/clone_filter.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-12"> 12</a></span>
<span class="normal"><a href="#__codelineno-0-13"> 13</a></span>
<span class="normal"><a href="#__codelineno-0-14"> 14</a></span>
<span class="normal"><a href="#__codelineno-0-15"> 15</a></span>
<span class="normal"><a href="#__codelineno-0-16"> 16</a></span>
<span class="normal"><a href="#__codelineno-0-17"> 17</a></span>
<span class="normal"><a href="#__codelineno-0-18"> 18</a></span>
<span class="normal"><a href="#__codelineno-0-19"> 19</a></span>
<span class="normal"><a href="#__codelineno-0-20"> 20</a></span>
<span class="normal"><a href="#__codelineno-0-21"> 21</a></span>
<span class="normal"><a href="#__codelineno-0-22"> 22</a></span>
<span class="normal"><a href="#__codelineno-0-23"> 23</a></span>
<span class="normal"><a href="#__codelineno-0-24"> 24</a></span>
<span class="normal"><a href="#__codelineno-0-25"> 25</a></span>
<span class="normal"><a href="#__codelineno-0-26"> 26</a></span>
<span class="normal"><a href="#__codelineno-0-27"> 27</a></span>
<span class="normal"><a href="#__codelineno-0-28"> 28</a></span>
<span class="normal"><a href="#__codelineno-0-29"> 29</a></span>
<span class="normal"><a href="#__codelineno-0-30"> 30</a></span>
<span class="normal"><a href="#__codelineno-0-31"> 31</a></span>
<span class="normal"><a href="#__codelineno-0-32"> 32</a></span>
<span class="normal"><a href="#__codelineno-0-33"> 33</a></span>
<span class="normal"><a href="#__codelineno-0-34"> 34</a></span>
<span class="normal"><a href="#__codelineno-0-35"> 35</a></span>
<span class="normal"><a href="#__codelineno-0-36"> 36</a></span>
<span class="normal"><a href="#__codelineno-0-37"> 37</a></span>
<span class="normal"><a href="#__codelineno-0-38"> 38</a></span>
<span class="normal"><a href="#__codelineno-0-39"> 39</a></span>
<span class="normal"><a href="#__codelineno-0-40"> 40</a></span>
<span class="normal"><a href="#__codelineno-0-41"> 41</a></span>
<span class="normal"><a href="#__codelineno-0-42"> 42</a></span>
<span class="normal"><a href="#__codelineno-0-43"> 43</a></span>
<span class="normal"><a href="#__codelineno-0-44"> 44</a></span>
<span class="normal"><a href="#__codelineno-0-45"> 45</a></span>
<span class="normal"><a href="#__codelineno-0-46"> 46</a></span>
<span class="normal"><a href="#__codelineno-0-47"> 47</a></span>
<span class="normal"><a href="#__codelineno-0-48"> 48</a></span>
<span class="normal"><a href="#__codelineno-0-49"> 49</a></span>
<span class="normal"><a href="#__codelineno-0-50"> 50</a></span>
<span class="normal"><a href="#__codelineno-0-51"> 51</a></span>
<span class="normal"><a href="#__codelineno-0-52"> 52</a></span>
<span class="normal"><a href="#__codelineno-0-53"> 53</a></span>
<span class="normal"><a href="#__codelineno-0-54"> 54</a></span>
<span class="normal"><a href="#__codelineno-0-55"> 55</a></span>
<span class="normal"><a href="#__codelineno-0-56"> 56</a></span>
<span class="normal"><a href="#__codelineno-0-57"> 57</a></span>
<span class="normal"><a href="#__codelineno-0-58"> 58</a></span>
<span class="normal"><a href="#__codelineno-0-59"> 59</a></span>
<span class="normal"><a href="#__codelineno-0-60"> 60</a></span>
<span class="normal"><a href="#__codelineno-0-61"> 61</a></span>
<span class="normal"><a href="#__codelineno-0-62"> 62</a></span>
<span class="normal"><a href="#__codelineno-0-63"> 63</a></span>
<span class="normal"><a href="#__codelineno-0-64"> 64</a></span>
<span class="normal"><a href="#__codelineno-0-65"> 65</a></span>
<span class="normal"><a href="#__codelineno-0-66"> 66</a></span>
<span class="normal"><a href="#__codelineno-0-67"> 67</a></span>
<span class="normal"><a href="#__codelineno-0-68"> 68</a></span>
<span class="normal"><a href="#__codelineno-0-69"> 69</a></span>
<span class="normal"><a href="#__codelineno-0-70"> 70</a></span>
<span class="normal"><a href="#__codelineno-0-71"> 71</a></span>
<span class="normal"><a href="#__codelineno-0-72"> 72</a></span>
<span class="normal"><a href="#__codelineno-0-73"> 73</a></span>
<span class="normal"><a href="#__codelineno-0-74"> 74</a></span>
<span class="normal"><a href="#__codelineno-0-75"> 75</a></span>
<span class="normal"><a href="#__codelineno-0-76"> 76</a></span>
<span class="normal"><a href="#__codelineno-0-77"> 77</a></span>
<span class="normal"><a href="#__codelineno-0-78"> 78</a></span>
<span class="normal"><a href="#__codelineno-0-79"> 79</a></span>
<span class="normal"><a href="#__codelineno-0-80"> 80</a></span>
<span class="normal"><a href="#__codelineno-0-81"> 81</a></span>
<span class="normal"><a href="#__codelineno-0-82"> 82</a></span>
<span class="normal"><a href="#__codelineno-0-83"> 83</a></span>
<span class="normal"><a href="#__codelineno-0-84"> 84</a></span>
<span class="normal"><a href="#__codelineno-0-85"> 85</a></span>
<span class="normal"><a href="#__codelineno-0-86"> 86</a></span>
<span class="normal"><a href="#__codelineno-0-87"> 87</a></span>
<span class="normal"><a href="#__codelineno-0-88"> 88</a></span>
<span class="normal"><a href="#__codelineno-0-89"> 89</a></span>
<span class="normal"><a href="#__codelineno-0-90"> 90</a></span>
<span class="normal"><a href="#__codelineno-0-91"> 91</a></span>
<span class="normal"><a href="#__codelineno-0-92"> 92</a></span>
<span class="normal"><a href="#__codelineno-0-93"> 93</a></span>
<span class="normal"><a href="#__codelineno-0-94"> 94</a></span>
<span class="normal"><a href="#__codelineno-0-95"> 95</a></span>
<span class="normal"><a href="#__codelineno-0-96"> 96</a></span>
<span class="normal"><a href="#__codelineno-0-97"> 97</a></span>
<span class="normal"><a href="#__codelineno-0-98"> 98</a></span>
<span class="normal"><a href="#__codelineno-0-99"> 99</a></span>
<span class="normal"><a href="#__codelineno-0-100">100</a></span>
<span class="normal"><a href="#__codelineno-0-101">101</a></span>
<span class="normal"><a href="#__codelineno-0-102">102</a></span>
<span class="normal"><a href="#__codelineno-0-103">103</a></span>
<span class="normal"><a href="#__codelineno-0-104">104</a></span>
<span class="normal"><a href="#__codelineno-0-105">105</a></span>
<span class="normal"><a href="#__codelineno-0-106">106</a></span>
<span class="normal"><a href="#__codelineno-0-107">107</a></span>
<span class="normal"><a href="#__codelineno-0-108">108</a></span>
<span class="normal"><a href="#__codelineno-0-109">109</a></span>
<span class="normal"><a href="#__codelineno-0-110">110</a></span>
<span class="normal"><a href="#__codelineno-0-111">111</a></span>
<span class="normal"><a href="#__codelineno-0-112">112</a></span>
<span class="normal"><a href="#__codelineno-0-113">113</a></span>
<span class="normal"><a href="#__codelineno-0-114">114</a></span>
<span class="normal"><a href="#__codelineno-0-115">115</a></span>
<span class="normal"><a href="#__codelineno-0-116">116</a></span>
<span class="normal"><a href="#__codelineno-0-117">117</a></span>
<span class="normal"><a href="#__codelineno-0-118">118</a></span>
<span class="normal"><a href="#__codelineno-0-119">119</a></span>
<span class="normal"><a href="#__codelineno-0-120">120</a></span>
<span class="normal"><a href="#__codelineno-0-121">121</a></span>
<span class="normal"><a href="#__codelineno-0-122">122</a></span>
<span class="normal"><a href="#__codelineno-0-123">123</a></span>
<span class="normal"><a href="#__codelineno-0-124">124</a></span>
<span class="normal"><a href="#__codelineno-0-125">125</a></span>
<span class="normal"><a href="#__codelineno-0-126">126</a></span>
<span class="normal"><a href="#__codelineno-0-127">127</a></span>
<span class="normal"><a href="#__codelineno-0-128">128</a></span>
<span class="normal"><a href="#__codelineno-0-129">129</a></span>
<span class="normal"><a href="#__codelineno-0-130">130</a></span>
<span class="normal"><a href="#__codelineno-0-131">131</a></span>
<span class="normal"><a href="#__codelineno-0-132">132</a></span>
<span class="normal"><a href="#__codelineno-0-133">133</a></span>
<span class="normal"><a href="#__codelineno-0-134">134</a></span>
<span class="normal"><a href="#__codelineno-0-135">135</a></span>
<span class="normal"><a href="#__codelineno-0-136">136</a></span>
<span class="normal"><a href="#__codelineno-0-137">137</a></span>
<span class="normal"><a href="#__codelineno-0-138">138</a></span>
<span class="normal"><a href="#__codelineno-0-139">139</a></span>
<span class="normal"><a href="#__codelineno-0-140">140</a></span>
<span class="normal"><a href="#__codelineno-0-141">141</a></span>
<span class="normal"><a href="#__codelineno-0-142">142</a></span>
<span class="normal"><a href="#__codelineno-0-143">143</a></span>
<span class="normal"><a href="#__codelineno-0-144">144</a></span>
<span class="normal"><a href="#__codelineno-0-145">145</a></span>
<span class="normal"><a href="#__codelineno-0-146">146</a></span>
<span class="normal"><a href="#__codelineno-0-147">147</a></span>
<span class="normal"><a href="#__codelineno-0-148">148</a></span>
<span class="normal"><a href="#__codelineno-0-149">149</a></span>
<span class="normal"><a href="#__codelineno-0-150">150</a></span>
<span class="normal"><a href="#__codelineno-0-151">151</a></span>
<span class="normal"><a href="#__codelineno-0-152">152</a></span>
<span class="normal"><a href="#__codelineno-0-153">153</a></span>
<span class="normal"><a href="#__codelineno-0-154">154</a></span>
<span class="normal"><a href="#__codelineno-0-155">155</a></span>
<span class="normal"><a href="#__codelineno-0-156">156</a></span>
<span class="normal"><a href="#__codelineno-0-157">157</a></span>
<span class="normal"><a href="#__codelineno-0-158">158</a></span>
<span class="normal"><a href="#__codelineno-0-159">159</a></span>
<span class="normal"><a href="#__codelineno-0-160">160</a></span>
<span class="normal"><a href="#__codelineno-0-161">161</a></span>
<span class="normal"><a href="#__codelineno-0-162">162</a></span>
<span class="normal"><a href="#__codelineno-0-163">163</a></span>
<span class="normal"><a href="#__codelineno-0-164">164</a></span>
<span class="normal"><a href="#__codelineno-0-165">165</a></span>
<span class="normal"><a href="#__codelineno-0-166">166</a></span>
<span class="normal"><a href="#__codelineno-0-167">167</a></span>
<span class="normal"><a href="#__codelineno-0-168">168</a></span>
<span class="normal"><a href="#__codelineno-0-169">169</a></span>
<span class="normal"><a href="#__codelineno-0-170">170</a></span>
<span class="normal"><a href="#__codelineno-0-171">171</a></span>
<span class="normal"><a href="#__codelineno-0-172">172</a></span>
<span class="normal"><a href="#__codelineno-0-173">173</a></span>
<span class="normal"><a href="#__codelineno-0-174">174</a></span>
<span class="normal"><a href="#__codelineno-0-175">175</a></span>
<span class="normal"><a href="#__codelineno-0-176">176</a></span>
<span class="normal"><a href="#__codelineno-0-177">177</a></span>
<span class="normal"><a href="#__codelineno-0-178">178</a></span>
<span class="normal"><a href="#__codelineno-0-179">179</a></span>
<span class="normal"><a href="#__codelineno-0-180">180</a></span>
<span class="normal"><a href="#__codelineno-0-181">181</a></span>
<span class="normal"><a href="#__codelineno-0-182">182</a></span>
<span class="normal"><a href="#__codelineno-0-183">183</a></span>
<span class="normal"><a href="#__codelineno-0-184">184</a></span>
<span class="normal"><a href="#__codelineno-0-185">185</a></span>
<span class="normal"><a href="#__codelineno-0-186">186</a></span>
<span class="normal"><a href="#__codelineno-0-187">187</a></span>
<span class="normal"><a href="#__codelineno-0-188">188</a></span>
<span class="normal"><a href="#__codelineno-0-189">189</a></span>
<span class="normal"><a href="#__codelineno-0-190">190</a></span>
<span class="normal"><a href="#__codelineno-0-191">191</a></span>
<span class="normal"><a href="#__codelineno-0-192">192</a></span>
<span class="normal"><a href="#__codelineno-0-193">193</a></span>
<span class="normal"><a href="#__codelineno-0-194">194</a></span>
<span class="normal"><a href="#__codelineno-0-195">195</a></span>
<span class="normal"><a href="#__codelineno-0-196">196</a></span>
<span class="normal"><a href="#__codelineno-0-197">197</a></span>
<span class="normal"><a href="#__codelineno-0-198">198</a></span>
<span class="normal"><a href="#__codelineno-0-199">199</a></span>
<span class="normal"><a href="#__codelineno-0-200">200</a></span>
<span class="normal"><a href="#__codelineno-0-201">201</a></span>
<span class="normal"><a href="#__codelineno-0-202">202</a></span>
<span class="normal"><a href="#__codelineno-0-203">203</a></span>
<span class="normal"><a href="#__codelineno-0-204">204</a></span>
<span class="normal"><a href="#__codelineno-0-205">205</a></span>
<span class="normal"><a href="#__codelineno-0-206">206</a></span>
<span class="normal"><a href="#__codelineno-0-207">207</a></span>
<span class="normal"><a href="#__codelineno-0-208">208</a></span>
<span class="normal"><a href="#__codelineno-0-209">209</a></span>
<span class="normal"><a href="#__codelineno-0-210">210</a></span>
<span class="normal"><a href="#__codelineno-0-211">211</a></span>
<span class="normal"><a href="#__codelineno-0-212">212</a></span>
<span class="normal"><a href="#__codelineno-0-213">213</a></span>
<span class="normal"><a href="#__codelineno-0-214">214</a></span>
<span class="normal"><a href="#__codelineno-0-215">215</a></span>
<span class="normal"><a href="#__codelineno-0-216">216</a></span>
<span class="normal"><a href="#__codelineno-0-217">217</a></span>
<span class="normal"><a href="#__codelineno-0-218">218</a></span>
<span class="normal"><a href="#__codelineno-0-219">219</a></span>
<span class="normal"><a href="#__codelineno-0-220">220</a></span>
<span class="normal"><a href="#__codelineno-0-221">221</a></span>
<span class="normal"><a href="#__codelineno-0-222">222</a></span>
<span class="normal"><a href="#__codelineno-0-223">223</a></span>
<span class="normal"><a href="#__codelineno-0-224">224</a></span>
<span class="normal"><a href="#__codelineno-0-225">225</a></span>
<span class="normal"><a href="#__codelineno-0-226">226</a></span>
<span class="normal"><a href="#__codelineno-0-227">227</a></span>
<span class="normal"><a href="#__codelineno-0-228">228</a></span>
<span class="normal"><a href="#__codelineno-0-229">229</a></span>
<span class="normal"><a href="#__codelineno-0-230">230</a></span>
<span class="normal"><a href="#__codelineno-0-231">231</a></span>
<span class="normal"><a href="#__codelineno-0-232">232</a></span>
<span class="normal"><a href="#__codelineno-0-233">233</a></span>
<span class="normal"><a href="#__codelineno-0-234">234</a></span>
<span class="normal"><a href="#__codelineno-0-235">235</a></span>
<span class="normal"><a href="#__codelineno-0-236">236</a></span>
<span class="normal"><a href="#__codelineno-0-237">237</a></span>
<span class="normal"><a href="#__codelineno-0-238">238</a></span>
<span class="normal"><a href="#__codelineno-0-239">239</a></span>
<span class="normal"><a href="#__codelineno-0-240">240</a></span>
<span class="normal"><a href="#__codelineno-0-241">241</a></span>
<span class="normal"><a href="#__codelineno-0-242">242</a></span>
<span class="normal"><a href="#__codelineno-0-243">243</a></span>
<span class="normal"><a href="#__codelineno-0-244">244</a></span>
<span class="normal"><a href="#__codelineno-0-245">245</a></span>
<span class="normal"><a href="#__codelineno-0-246">246</a></span>
<span class="normal"><a href="#__codelineno-0-247">247</a></span>
<span class="normal"><a href="#__codelineno-0-248">248</a></span>
<span class="normal"><a href="#__codelineno-0-249">249</a></span>
<span class="normal"><a href="#__codelineno-0-250">250</a></span>
<span class="normal"><a href="#__codelineno-0-251">251</a></span>
<span class="normal"><a href="#__codelineno-0-252">252</a></span>
<span class="normal"><a href="#__codelineno-0-253">253</a></span>
<span class="normal"><a href="#__codelineno-0-254">254</a></span>
<span class="normal"><a href="#__codelineno-0-255">255</a></span>
<span class="normal"><a href="#__codelineno-0-256">256</a></span>
<span class="normal"><a href="#__codelineno-0-257">257</a></span>
<span class="normal"><a href="#__codelineno-0-258">258</a></span>
<span class="normal"><a href="#__codelineno-0-259">259</a></span>
<span class="normal"><a href="#__codelineno-0-260">260</a></span>
<span class="normal"><a href="#__codelineno-0-261">261</a></span>
<span class="normal"><a href="#__codelineno-0-262">262</a></span>
<span class="normal"><a href="#__codelineno-0-263">263</a></span>
<span class="normal"><a href="#__codelineno-0-264">264</a></span>
<span class="normal"><a href="#__codelineno-0-265">265</a></span>
<span class="normal"><a href="#__codelineno-0-266">266</a></span>
<span class="normal"><a href="#__codelineno-0-267">267</a></span>
<span class="normal"><a href="#__codelineno-0-268">268</a></span>
<span class="normal"><a href="#__codelineno-0-269">269</a></span>
<span class="normal"><a href="#__codelineno-0-270">270</a></span>
<span class="normal"><a href="#__codelineno-0-271">271</a></span>
<span class="normal"><a href="#__codelineno-0-272">272</a></span>
<span class="normal"><a href="#__codelineno-0-273">273</a></span>
<span class="normal"><a href="#__codelineno-0-274">274</a></span>
<span class="normal"><a href="#__codelineno-0-275">275</a></span>
<span class="normal"><a href="#__codelineno-0-276">276</a></span>
<span class="normal"><a href="#__codelineno-0-277">277</a></span>
<span class="normal"><a href="#__codelineno-0-278">278</a></span>
<span class="normal"><a href="#__codelineno-0-279">279</a></span>
<span class="normal"><a href="#__codelineno-0-280">280</a></span>
<span class="normal"><a href="#__codelineno-0-281">281</a></span>
<span class="normal"><a href="#__codelineno-0-282">282</a></span>
<span class="normal"><a href="#__codelineno-0-283">283</a></span>
<span class="normal"><a href="#__codelineno-0-284">284</a></span>
<span class="normal"><a href="#__codelineno-0-285">285</a></span>
<span class="normal"><a href="#__codelineno-0-286">286</a></span>
<span class="normal"><a href="#__codelineno-0-287">287</a></span>
<span class="normal"><a href="#__codelineno-0-288">288</a></span>
<span class="normal"><a href="#__codelineno-0-289">289</a></span>
<span class="normal"><a href="#__codelineno-0-290">290</a></span>
<span class="normal"><a href="#__codelineno-0-291">291</a></span>
<span class="normal"><a href="#__codelineno-0-292">292</a></span>
<span class="normal"><a href="#__codelineno-0-293">293</a></span>
<span class="normal"><a href="#__codelineno-0-294">294</a></span>
<span class="normal"><a href="#__codelineno-0-295">295</a></span>
<span class="normal"><a href="#__codelineno-0-296">296</a></span>
<span class="normal"><a href="#__codelineno-0-297">297</a></span>
<span class="normal"><a href="#__codelineno-0-298">298</a></span>
<span class="normal"><a href="#__codelineno-0-299">299</a></span>
<span class="normal"><a href="#__codelineno-0-300">300</a></span>
<span class="normal"><a href="#__codelineno-0-301">301</a></span>
<span class="normal"><a href="#__codelineno-0-302">302</a></span>
<span class="normal"><a href="#__codelineno-0-303">303</a></span>
<span class="normal"><a href="#__codelineno-0-304">304</a></span>
<span class="normal"><a href="#__codelineno-0-305">305</a></span>
<span class="normal"><a href="#__codelineno-0-306">306</a></span>
<span class="normal"><a href="#__codelineno-0-307">307</a></span>
<span class="normal"><a href="#__codelineno-0-308">308</a></span>
<span class="normal"><a href="#__codelineno-0-309">309</a></span>
<span class="normal"><a href="#__codelineno-0-310">310</a></span>
<span class="normal"><a href="#__codelineno-0-311">311</a></span>
<span class="normal"><a href="#__codelineno-0-312">312</a></span>
<span class="normal"><a href="#__codelineno-0-313">313</a></span>
<span class="normal"><a href="#__codelineno-0-314">314</a></span>
<span class="normal"><a href="#__codelineno-0-315">315</a></span>
<span class="normal"><a href="#__codelineno-0-316">316</a></span>
<span class="normal"><a href="#__codelineno-0-317">317</a></span>
<span class="normal"><a href="#__codelineno-0-318">318</a></span>
<span class="normal"><a href="#__codelineno-0-319">319</a></span>
<span class="normal"><a href="#__codelineno-0-320">320</a></span>
<span class="normal"><a href="#__codelineno-0-321">321</a></span>
<span class="normal"><a href="#__codelineno-0-322">322</a></span>
<span class="normal"><a href="#__codelineno-0-323">323</a></span>
<span class="normal"><a href="#__codelineno-0-324">324</a></span>
<span class="normal"><a href="#__codelineno-0-325">325</a></span>
<span class="normal"><a href="#__codelineno-0-326">326</a></span>
<span class="normal"><a href="#__codelineno-0-327">327</a></span>
<span class="normal"><a href="#__codelineno-0-328">328</a></span>
<span class="normal"><a href="#__codelineno-0-329">329</a></span>
<span class="normal"><a href="#__codelineno-0-330">330</a></span>
<span class="normal"><a href="#__codelineno-0-331">331</a></span>
<span class="normal"><a href="#__codelineno-0-332">332</a></span>
<span class="normal"><a href="#__codelineno-0-333">333</a></span>
<span class="normal"><a href="#__codelineno-0-334">334</a></span>
<span class="normal"><a href="#__codelineno-0-335">335</a></span>
<span class="normal"><a href="#__codelineno-0-336">336</a></span>
<span class="normal"><a href="#__codelineno-0-337">337</a></span>
<span class="normal"><a href="#__codelineno-0-338">338</a></span>
<span class="normal"><a href="#__codelineno-0-339">339</a></span>
<span class="normal"><a href="#__codelineno-0-340">340</a></span>
<span class="normal"><a href="#__codelineno-0-341">341</a></span>
<span class="normal"><a href="#__codelineno-0-342">342</a></span>
<span class="normal"><a href="#__codelineno-0-343">343</a></span>
<span class="normal"><a href="#__codelineno-0-344">344</a></span>
<span class="normal"><a href="#__codelineno-0-345">345</a></span>
<span class="normal"><a href="#__codelineno-0-346">346</a></span>
<span class="normal"><a href="#__codelineno-0-347">347</a></span>
<span class="normal"><a href="#__codelineno-0-348">348</a></span>
<span class="normal"><a href="#__codelineno-0-349">349</a></span>
<span class="normal"><a href="#__codelineno-0-350">350</a></span>
<span class="normal"><a href="#__codelineno-0-351">351</a></span>
<span class="normal"><a href="#__codelineno-0-352">352</a></span>
<span class="normal"><a href="#__codelineno-0-353">353</a></span>
<span class="normal"><a href="#__codelineno-0-354">354</a></span>
<span class="normal"><a href="#__codelineno-0-355">355</a></span>
<span class="normal"><a href="#__codelineno-0-356">356</a></span>
<span class="normal"><a href="#__codelineno-0-357">357</a></span>
<span class="normal"><a href="#__codelineno-0-358">358</a></span>
<span class="normal"><a href="#__codelineno-0-359">359</a></span>
<span class="normal"><a href="#__codelineno-0-360">360</a></span>
<span class="normal"><a href="#__codelineno-0-361">361</a></span>
<span class="normal"><a href="#__codelineno-0-362">362</a></span>
<span class="normal"><a href="#__codelineno-0-363">363</a></span>
<span class="normal"><a href="#__codelineno-0-364">364</a></span>
<span class="normal"><a href="#__codelineno-0-365">365</a></span>
<span class="normal"><a href="#__codelineno-0-366">366</a></span>
<span class="normal"><a href="#__codelineno-0-367">367</a></span>
<span class="normal"><a href="#__codelineno-0-368">368</a></span>
<span class="normal"><a href="#__codelineno-0-369">369</a></span>
<span class="normal"><a href="#__codelineno-0-370">370</a></span>
<span class="normal"><a href="#__codelineno-0-371">371</a></span>
<span class="normal"><a href="#__codelineno-0-372">372</a></span>
<span class="normal"><a href="#__codelineno-0-373">373</a></span>
<span class="normal"><a href="#__codelineno-0-374">374</a></span>
<span class="normal"><a href="#__codelineno-0-375">375</a></span>
<span class="normal"><a href="#__codelineno-0-376">376</a></span>
<span class="normal"><a href="#__codelineno-0-377">377</a></span>
<span class="normal"><a href="#__codelineno-0-378">378</a></span>
<span class="normal"><a href="#__codelineno-0-379">379</a></span>
<span class="normal"><a href="#__codelineno-0-380">380</a></span>
<span class="normal"><a href="#__codelineno-0-381">381</a></span>
<span class="normal"><a href="#__codelineno-0-382">382</a></span>
<span class="normal"><a href="#__codelineno-0-383">383</a></span>
<span class="normal"><a href="#__codelineno-0-384">384</a></span>
<span class="normal"><a href="#__codelineno-0-385">385</a></span>
<span class="normal"><a href="#__codelineno-0-386">386</a></span>
<span class="normal"><a href="#__codelineno-0-387">387</a></span>
<span class="normal"><a href="#__codelineno-0-388">388</a></span>
<span class="normal"><a href="#__codelineno-0-389">389</a></span>
<span class="normal"><a href="#__codelineno-0-390">390</a></span>
<span class="normal"><a href="#__codelineno-0-391">391</a></span>
<span class="normal"><a href="#__codelineno-0-392">392</a></span>
<span class="normal"><a href="#__codelineno-0-393">393</a></span>
<span class="normal"><a href="#__codelineno-0-394">394</a></span>
<span class="normal"><a href="#__codelineno-0-395">395</a></span>
<span class="normal"><a href="#__codelineno-0-396">396</a></span>
<span class="normal"><a href="#__codelineno-0-397">397</a></span>
<span class="normal"><a href="#__codelineno-0-398">398</a></span>
<span class="normal"><a href="#__codelineno-0-399">399</a></span>
<span class="normal"><a href="#__codelineno-0-400">400</a></span>
<span class="normal"><a href="#__codelineno-0-401">401</a></span>
<span class="normal"><a href="#__codelineno-0-402">402</a></span>
<span class="normal"><a href="#__codelineno-0-403">403</a></span>
<span class="normal"><a href="#__codelineno-0-404">404</a></span>
<span class="normal"><a href="#__codelineno-0-405">405</a></span>
<span class="normal"><a href="#__codelineno-0-406">406</a></span>
<span class="normal"><a href="#__codelineno-0-407">407</a></span>
<span class="normal"><a href="#__codelineno-0-408">408</a></span>
<span class="normal"><a href="#__codelineno-0-409">409</a></span>
<span class="normal"><a href="#__codelineno-0-410">410</a></span>
<span class="normal"><a href="#__codelineno-0-411">411</a></span>
<span class="normal"><a href="#__codelineno-0-412">412</a></span>
<span class="normal"><a href="#__codelineno-0-413">413</a></span>
<span class="normal"><a href="#__codelineno-0-414">414</a></span>
<span class="normal"><a href="#__codelineno-0-415">415</a></span>
<span class="normal"><a href="#__codelineno-0-416">416</a></span>
<span class="normal"><a href="#__codelineno-0-417">417</a></span>
<span class="normal"><a href="#__codelineno-0-418">418</a></span>
<span class="normal"><a href="#__codelineno-0-419">419</a></span>
<span class="normal"><a href="#__codelineno-0-420">420</a></span>
<span class="normal"><a href="#__codelineno-0-421">421</a></span>
<span class="normal"><a href="#__codelineno-0-422">422</a></span>
<span class="normal"><a href="#__codelineno-0-423">423</a></span>
<span class="normal"><a href="#__codelineno-0-424">424</a></span>
<span class="normal"><a href="#__codelineno-0-425">425</a></span>
<span class="normal"><a href="#__codelineno-0-426">426</a></span>
<span class="normal"><a href="#__codelineno-0-427">427</a></span>
<span class="normal"><a href="#__codelineno-0-428">428</a></span>
<span class="normal"><a href="#__codelineno-0-429">429</a></span>
<span class="normal"><a href="#__codelineno-0-430">430</a></span>
<span class="normal"><a href="#__codelineno-0-431">431</a></span>
<span class="normal"><a href="#__codelineno-0-432">432</a></span>
<span class="normal"><a href="#__codelineno-0-433">433</a></span>
<span class="normal"><a href="#__codelineno-0-434">434</a></span>
<span class="normal"><a href="#__codelineno-0-435">435</a></span>
<span class="normal"><a href="#__codelineno-0-436">436</a></span>
<span class="normal"><a href="#__codelineno-0-437">437</a></span>
<span class="normal"><a href="#__codelineno-0-438">438</a></span>
<span class="normal"><a href="#__codelineno-0-439">439</a></span>
<span class="normal"><a href="#__codelineno-0-440">440</a></span>
<span class="normal"><a href="#__codelineno-0-441">441</a></span>
<span class="normal"><a href="#__codelineno-0-442">442</a></span>
<span class="normal"><a href="#__codelineno-0-443">443</a></span>
<span class="normal"><a href="#__codelineno-0-444">444</a></span>
<span class="normal"><a href="#__codelineno-0-445">445</a></span>
<span class="normal"><a href="#__codelineno-0-446">446</a></span>
<span class="normal"><a href="#__codelineno-0-447">447</a></span>
<span class="normal"><a href="#__codelineno-0-448">448</a></span>
<span class="normal"><a href="#__codelineno-0-449">449</a></span>
<span class="normal"><a href="#__codelineno-0-450">450</a></span>
<span class="normal"><a href="#__codelineno-0-451">451</a></span>
<span class="normal"><a href="#__codelineno-0-452">452</a></span>
<span class="normal"><a href="#__codelineno-0-453">453</a></span>
<span class="normal"><a href="#__codelineno-0-454">454</a></span>
<span class="normal"><a href="#__codelineno-0-455">455</a></span>
<span class="normal"><a href="#__codelineno-0-456">456</a></span>
<span class="normal"><a href="#__codelineno-0-457">457</a></span>
<span class="normal"><a href="#__codelineno-0-458">458</a></span>
<span class="normal"><a href="#__codelineno-0-459">459</a></span>
<span class="normal"><a href="#__codelineno-0-460">460</a></span>
<span class="normal"><a href="#__codelineno-0-461">461</a></span>
<span class="normal"><a href="#__codelineno-0-462">462</a></span>
<span class="normal"><a href="#__codelineno-0-463">463</a></span>
<span class="normal"><a href="#__codelineno-0-464">464</a></span>
<span class="normal"><a href="#__codelineno-0-465">465</a></span>
<span class="normal"><a href="#__codelineno-0-466">466</a></span>
<span class="normal"><a href="#__codelineno-0-467">467</a></span>
<span class="normal"><a href="#__codelineno-0-468">468</a></span>
<span class="normal"><a href="#__codelineno-0-469">469</a></span>
<span class="normal"><a href="#__codelineno-0-470">470</a></span>
<span class="normal"><a href="#__codelineno-0-471">471</a></span>
<span class="normal"><a href="#__codelineno-0-472">472</a></span>
<span class="normal"><a href="#__codelineno-0-473">473</a></span>
<span class="normal"><a href="#__codelineno-0-474">474</a></span>
<span class="normal"><a href="#__codelineno-0-475">475</a></span>
<span class="normal"><a href="#__codelineno-0-476">476</a></span>
<span class="normal"><a href="#__codelineno-0-477">477</a></span>
<span class="normal"><a href="#__codelineno-0-478">478</a></span>
<span class="normal"><a href="#__codelineno-0-479">479</a></span>
<span class="normal"><a href="#__codelineno-0-480">480</a></span>
<span class="normal"><a href="#__codelineno-0-481">481</a></span>
<span class="normal"><a href="#__codelineno-0-482">482</a></span>
<span class="normal"><a href="#__codelineno-0-483">483</a></span>
<span class="normal"><a href="#__codelineno-0-484">484</a></span>
<span class="normal"><a href="#__codelineno-0-485">485</a></span>
<span class="normal"><a href="#__codelineno-0-486">486</a></span>
<span class="normal"><a href="#__codelineno-0-487">487</a></span>
<span class="normal"><a href="#__codelineno-0-488">488</a></span>
<span class="normal"><a href="#__codelineno-0-489">489</a></span>
<span class="normal"><a href="#__codelineno-0-490">490</a></span>
<span class="normal"><a href="#__codelineno-0-491">491</a></span>
<span class="normal"><a href="#__codelineno-0-492">492</a></span>
<span class="normal"><a href="#__codelineno-0-493">493</a></span>
<span class="normal"><a href="#__codelineno-0-494">494</a></span>
<span class="normal"><a href="#__codelineno-0-495">495</a></span>
<span class="normal"><a href="#__codelineno-0-496">496</a></span>
<span class="normal"><a href="#__codelineno-0-497">497</a></span>
<span class="normal"><a href="#__codelineno-0-498">498</a></span>
<span class="normal"><a href="#__codelineno-0-499">499</a></span>
<span class="normal"><a href="#__codelineno-0-500">500</a></span>
<span class="normal"><a href="#__codelineno-0-501">501</a></span>
<span class="normal"><a href="#__codelineno-0-502">502</a></span>
<span class="normal"><a href="#__codelineno-0-503">503</a></span>
<span class="normal"><a href="#__codelineno-0-504">504</a></span>
<span class="normal"><a href="#__codelineno-0-505">505</a></span>
<span class="normal"><a href="#__codelineno-0-506">506</a></span>
<span class="normal"><a href="#__codelineno-0-507">507</a></span>
<span class="normal"><a href="#__codelineno-0-508">508</a></span>
<span class="normal"><a href="#__codelineno-0-509">509</a></span>
<span class="normal"><a href="#__codelineno-0-510">510</a></span>
<span class="normal"><a href="#__codelineno-0-511">511</a></span>
<span class="normal"><a href="#__codelineno-0-512">512</a></span>
<span class="normal"><a href="#__codelineno-0-513">513</a></span>
<span class="normal"><a href="#__codelineno-0-514">514</a></span>
<span class="normal"><a href="#__codelineno-0-515">515</a></span>
<span class="normal"><a href="#__codelineno-0-516">516</a></span>
<span class="normal"><a href="#__codelineno-0-517">517</a></span>
<span class="normal"><a href="#__codelineno-0-518">518</a></span>
<span class="normal"><a href="#__codelineno-0-519">519</a></span>
<span class="normal"><a href="#__codelineno-0-520">520</a></span>
<span class="normal"><a href="#__codelineno-0-521">521</a></span>
<span class="normal"><a href="#__codelineno-0-522">522</a></span>
<span class="normal"><a href="#__codelineno-0-523">523</a></span>
<span class="normal"><a href="#__codelineno-0-524">524</a></span>
<span class="normal"><a href="#__codelineno-0-525">525</a></span>
<span class="normal"><a href="#__codelineno-0-526">526</a></span>
<span class="normal"><a href="#__codelineno-0-527">527</a></span>
<span class="normal"><a href="#__codelineno-0-528">528</a></span>
<span class="normal"><a href="#__codelineno-0-529">529</a></span>
<span class="normal"><a href="#__codelineno-0-530">530</a></span>
<span class="normal"><a href="#__codelineno-0-531">531</a></span>
<span class="normal"><a href="#__codelineno-0-532">532</a></span>
<span class="normal"><a href="#__codelineno-0-533">533</a></span>
<span class="normal"><a href="#__codelineno-0-534">534</a></span>
<span class="normal"><a href="#__codelineno-0-535">535</a></span>
<span class="normal"><a href="#__codelineno-0-536">536</a></span>
<span class="normal"><a href="#__codelineno-0-537">537</a></span>
<span class="normal"><a href="#__codelineno-0-538">538</a></span>
<span class="normal"><a href="#__codelineno-0-539">539</a></span>
<span class="normal"><a href="#__codelineno-0-540">540</a></span>
<span class="normal"><a href="#__codelineno-0-541">541</a></span>
<span class="normal"><a href="#__codelineno-0-542">542</a></span>
<span class="normal"><a href="#__codelineno-0-543">543</a></span>
<span class="normal"><a href="#__codelineno-0-544">544</a></span>
<span class="normal"><a href="#__codelineno-0-545">545</a></span>
<span class="normal"><a href="#__codelineno-0-546">546</a></span>
<span class="normal"><a href="#__codelineno-0-547">547</a></span>
<span class="normal"><a href="#__codelineno-0-548">548</a></span>
<span class="normal"><a href="#__codelineno-0-549">549</a></span>
<span class="normal"><a href="#__codelineno-0-550">550</a></span>
<span class="normal"><a href="#__codelineno-0-551">551</a></span>
<span class="normal"><a href="#__codelineno-0-552">552</a></span>
<span class="normal"><a href="#__codelineno-0-553">553</a></span>
<span class="normal"><a href="#__codelineno-0-554">554</a></span>
<span class="normal"><a href="#__codelineno-0-555">555</a></span>
<span class="normal"><a href="#__codelineno-0-556">556</a></span>
<span class="normal"><a href="#__codelineno-0-557">557</a></span>
<span class="normal"><a href="#__codelineno-0-558">558</a></span>
<span class="normal"><a href="#__codelineno-0-559">559</a></span>
<span class="normal"><a href="#__codelineno-0-560">560</a></span>
<span class="normal"><a href="#__codelineno-0-561">561</a></span>
<span class="normal"><a href="#__codelineno-0-562">562</a></span>
<span class="normal"><a href="#__codelineno-0-563">563</a></span>
<span class="normal"><a href="#__codelineno-0-564">564</a></span>
<span class="normal"><a href="#__codelineno-0-565">565</a></span>
<span class="normal"><a href="#__codelineno-0-566">566</a></span>
<span class="normal"><a href="#__codelineno-0-567">567</a></span>
<span class="normal"><a href="#__codelineno-0-568">568</a></span>
<span class="normal"><a href="#__codelineno-0-569">569</a></span>
<span class="normal"><a href="#__codelineno-0-570">570</a></span>
<span class="normal"><a href="#__codelineno-0-571">571</a></span>
<span class="normal"><a href="#__codelineno-0-572">572</a></span>
<span class="normal"><a href="#__codelineno-0-573">573</a></span>
<span class="normal"><a href="#__codelineno-0-574">574</a></span>
<span class="normal"><a href="#__codelineno-0-575">575</a></span>
<span class="normal"><a href="#__codelineno-0-576">576</a></span>
<span class="normal"><a href="#__codelineno-0-577">577</a></span>
<span class="normal"><a href="#__codelineno-0-578">578</a></span>
<span class="normal"><a href="#__codelineno-0-579">579</a></span>
<span class="normal"><a href="#__codelineno-0-580">580</a></span>
<span class="normal"><a href="#__codelineno-0-581">581</a></span>
<span class="normal"><a href="#__codelineno-0-582">582</a></span>
<span class="normal"><a href="#__codelineno-0-583">583</a></span>
<span class="normal"><a href="#__codelineno-0-584">584</a></span>
<span class="normal"><a href="#__codelineno-0-585">585</a></span>
<span class="normal"><a href="#__codelineno-0-586">586</a></span>
<span class="normal"><a href="#__codelineno-0-587">587</a></span>
<span class="normal"><a href="#__codelineno-0-588">588</a></span>
<span class="normal"><a href="#__codelineno-0-589">589</a></span>
<span class="normal"><a href="#__codelineno-0-590">590</a></span>
<span class="normal"><a href="#__codelineno-0-591">591</a></span>
<span class="normal"><a href="#__codelineno-0-592">592</a></span>
<span class="normal"><a href="#__codelineno-0-593">593</a></span>
<span class="normal"><a href="#__codelineno-0-594">594</a></span>
<span class="normal"><a href="#__codelineno-0-595">595</a></span>
<span class="normal"><a href="#__codelineno-0-596">596</a></span>
<span class="normal"><a href="#__codelineno-0-597">597</a></span>
<span class="normal"><a href="#__codelineno-0-598">598</a></span>
<span class="normal"><a href="#__codelineno-0-599">599</a></span>
<span class="normal"><a href="#__codelineno-0-600">600</a></span>
<span class="normal"><a href="#__codelineno-0-601">601</a></span>
<span class="normal"><a href="#__codelineno-0-602">602</a></span>
<span class="normal"><a href="#__codelineno-0-603">603</a></span>
<span class="normal"><a href="#__codelineno-0-604">604</a></span>
<span class="normal"><a href="#__codelineno-0-605">605</a></span>
<span class="normal"><a href="#__codelineno-0-606">606</a></span>
<span class="normal"><a href="#__codelineno-0-607">607</a></span>
<span class="normal"><a href="#__codelineno-0-608">608</a></span>
<span class="normal"><a href="#__codelineno-0-609">609</a></span>
<span class="normal"><a href="#__codelineno-0-610">610</a></span>
<span class="normal"><a href="#__codelineno-0-611">611</a></span>
<span class="normal"><a href="#__codelineno-0-612">612</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-12" name="__codelineno-0-12"></a><span class="k">class</span><span class="w"> </span><span class="nc">Filter</span><span class="p">:</span>
<a id="__codelineno-0-13" name="__codelineno-0-13"></a>
<a id="__codelineno-0-14" name="__codelineno-0-14"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-15" name="__codelineno-0-15"></a><span class="sd">    Clonoset filter.</span>
<a id="__codelineno-0-16" name="__codelineno-0-16"></a><span class="sd">    May be used to filter clonosets:</span>
<a id="__codelineno-0-17" name="__codelineno-0-17"></a><span class="sd">        - by clone functionality</span>
<a id="__codelineno-0-18" name="__codelineno-0-18"></a><span class="sd">        - randomly downsample them to particular number of reads of UMIs</span>
<a id="__codelineno-0-19" name="__codelineno-0-19"></a><span class="sd">        - take top clonotypes by size (number of reads of UMIs) with or without random mixing</span>
<a id="__codelineno-0-20" name="__codelineno-0-20"></a>
<a id="__codelineno-0-21" name="__codelineno-0-21"></a><span class="sd">    Args:</span>
<a id="__codelineno-0-22" name="__codelineno-0-22"></a><span class="sd">        name (str): the name of the filter. Will be displayed in print</span>
<a id="__codelineno-0-23" name="__codelineno-0-23"></a><span class="sd">        functionality (str): Possible values:</span>
<a id="__codelineno-0-24" name="__codelineno-0-24"></a><span class="sd">            - &quot;a&quot; - any (default). No clones are filtered out</span>
<a id="__codelineno-0-25" name="__codelineno-0-25"></a><span class="sd">            - &quot;f&quot; - only functional. Those, not having stop codons and </span>
<a id="__codelineno-0-26" name="__codelineno-0-26"></a><span class="sd">                frame shifts in CDR3 regions, or having non-empty values in CDR3 amino-acid</span>
<a id="__codelineno-0-27" name="__codelineno-0-27"></a><span class="sd">                sequence</span>
<a id="__codelineno-0-28" name="__codelineno-0-28"></a><span class="sd">            - &quot;n&quot; - only-nonfunctional - opposite to &quot;f&quot; - functional</span>
<a id="__codelineno-0-29" name="__codelineno-0-29"></a><span class="sd">        downsample (int): the number of reads/UMIs to randomly downsample the clonoset to.</span>
<a id="__codelineno-0-30" name="__codelineno-0-30"></a><span class="sd">            default value &#39;None&#39; - means not to apply downsampling</span>
<a id="__codelineno-0-31" name="__codelineno-0-31"></a><span class="sd">        top (int): the number of top biggest by reads/UMIs clonotypes to take from the clonoset.</span>
<a id="__codelineno-0-32" name="__codelineno-0-32"></a><span class="sd">            default value &#39;None&#39; - means not to apply top</span>
<a id="__codelineno-0-33" name="__codelineno-0-33"></a><span class="sd">        by_umi (bool): default=False. Which column to take for clonotype count - reads or UMIs </span>
<a id="__codelineno-0-34" name="__codelineno-0-34"></a><span class="sd">            (if UMI count column exists).</span>
<a id="__codelineno-0-35" name="__codelineno-0-35"></a><span class="sd">        mix_tails (bool): default=False. Defines whether to randomly mix-up the order of clonotypes</span>
<a id="__codelineno-0-36" name="__codelineno-0-36"></a><span class="sd">            before sorting by size and taking the top clonotypes. Basically mix_tails=True mixes up </span>
<a id="__codelineno-0-37" name="__codelineno-0-37"></a><span class="sd">            clonotypes with the same size in read or UMIs.</span>
<a id="__codelineno-0-38" name="__codelineno-0-38"></a><span class="sd">        count_threshold (int): limits [0:100000], all clonotypes with count less than this value will</span>
<a id="__codelineno-0-39" name="__codelineno-0-39"></a><span class="sd">            be filtered out</span>
<a id="__codelineno-0-40" name="__codelineno-0-40"></a><span class="sd">        seed (any hashable type): better to use int - seed for reproducibility of random events </span>
<a id="__codelineno-0-41" name="__codelineno-0-41"></a><span class="sd">            (downsampling or top with mix-tails). Default=None.</span>
<a id="__codelineno-0-42" name="__codelineno-0-42"></a><span class="sd">        unweight (bool): each clonotype counts (either reads or UMIs) are set to 1</span>
<a id="__codelineno-0-43" name="__codelineno-0-43"></a><span class="sd">        recount_fractions (bool): if `True`, clonotype fractions are recalculated after filtration</span>
<a id="__codelineno-0-44" name="__codelineno-0-44"></a><span class="sd">        white_list (list of tuples): If specified, only clonotypes matching those listed will be retained. Either `aa`, `aaV` or `aaVJ` </span>
<a id="__codelineno-0-45" name="__codelineno-0-45"></a><span class="sd">            formats can be used to list clonotypes, e.g. [(“CASSS..”)], [(“CASSS..”, “TRBV2”)] or [(“CASSS..”, “TRBV2”, “TRBJ1”)]. </span>
<a id="__codelineno-0-46" name="__codelineno-0-46"></a><span class="sd">            It is applied before `black_list`</span>
<a id="__codelineno-0-47" name="__codelineno-0-47"></a><span class="sd">        black_list (list of tuples): If specified, only clonotypes not listed will be retained. Either `aa`, `aaV` or `aaVJ` </span>
<a id="__codelineno-0-48" name="__codelineno-0-48"></a><span class="sd">            formats can be used to list clonotypes, e.g. [(“CASSS..”)], [(“CASSS..”, “TRBV2”)] or [(“CASSS..”, “TRBV2”, “TRBJ1”)]</span>
<a id="__codelineno-0-49" name="__codelineno-0-49"></a><span class="sd">        pool_clonoset_by (str): possible values are [&quot;&quot;, &quot;aa&quot;, &quot;aaV&quot;, &quot;aaVj&quot;, &quot;nt&quot;, &quot;ntV&quot;, &quot;ntVJ&quot;]. Clones with identical parameters are merged, </span>
<a id="__codelineno-0-50" name="__codelineno-0-50"></a><span class="sd">            keeping the largest one, while their counts are summed.</span>
<a id="__codelineno-0-51" name="__codelineno-0-51"></a><span class="sd">        convert (bool): By default, columns are added to the clonotype set to convert </span>
<a id="__codelineno-0-52" name="__codelineno-0-52"></a><span class="sd">            it to the VDJtools format, and the original columns are removed. If set to  `False`, all original columns are preserved.</span>
<a id="__codelineno-0-53" name="__codelineno-0-53"></a><span class="sd">        ignore_small_clonosets (bool): If the top or downsample threshold exceeds the counts for a clonoset, the set is kept intact</span>
<a id="__codelineno-0-54" name="__codelineno-0-54"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-55" name="__codelineno-0-55"></a>
<a id="__codelineno-0-56" name="__codelineno-0-56"></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;default_filter&quot;</span><span class="p">,</span> <span class="n">functionality</span><span class="o">=</span><span class="s2">&quot;a&quot;</span><span class="p">,</span> <span class="n">downsample</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-57" name="__codelineno-0-57"></a>                 <span class="n">top</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">by_umi</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">mix_tails</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">count_threshold</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> 
<a id="__codelineno-0-58" name="__codelineno-0-58"></a>                 <span class="n">unweight</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">seed</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">recount_fractions</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<a id="__codelineno-0-59" name="__codelineno-0-59"></a>                 <span class="n">white_list</span><span class="o">=</span><span class="p">[],</span> <span class="n">black_list</span><span class="o">=</span><span class="p">[],</span> <span class="n">pool_clonoset_by</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">convert</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> 
<a id="__codelineno-0-60" name="__codelineno-0-60"></a>                 <span class="n">ignore_small_clonosets</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<a id="__codelineno-0-61" name="__codelineno-0-61"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">name</span>
<a id="__codelineno-0-62" name="__codelineno-0-62"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">functionality</span> <span class="o">=</span> <span class="n">functionality</span>
<a id="__codelineno-0-63" name="__codelineno-0-63"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">downsample_size</span> <span class="o">=</span> <span class="n">downsample</span>
<a id="__codelineno-0-64" name="__codelineno-0-64"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">top</span> <span class="o">=</span> <span class="n">top</span>
<a id="__codelineno-0-65" name="__codelineno-0-65"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">by_umi</span> <span class="o">=</span> <span class="n">by_umi</span>
<a id="__codelineno-0-66" name="__codelineno-0-66"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">mix_tails</span> <span class="o">=</span> <span class="n">mix_tails</span>
<a id="__codelineno-0-67" name="__codelineno-0-67"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">seed</span> <span class="o">=</span> <span class="n">seed</span>
<a id="__codelineno-0-68" name="__codelineno-0-68"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">count_threshold</span> <span class="o">=</span> <span class="n">count_threshold</span>
<a id="__codelineno-0-69" name="__codelineno-0-69"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">unweight</span> <span class="o">=</span> <span class="n">unweight</span>
<a id="__codelineno-0-70" name="__codelineno-0-70"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">recount_fractions</span> <span class="o">=</span> <span class="n">recount_fractions</span>
<a id="__codelineno-0-71" name="__codelineno-0-71"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">white_list</span> <span class="o">=</span> <span class="n">white_list</span>
<a id="__codelineno-0-72" name="__codelineno-0-72"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">black_list</span> <span class="o">=</span> <span class="n">black_list</span>
<a id="__codelineno-0-73" name="__codelineno-0-73"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">pool_by</span> <span class="o">=</span> <span class="n">pool_clonoset_by</span>
<a id="__codelineno-0-74" name="__codelineno-0-74"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">convert</span> <span class="o">=</span> <span class="n">convert</span>
<a id="__codelineno-0-75" name="__codelineno-0-75"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">ignore_small_clonosets</span> <span class="o">=</span> <span class="n">ignore_small_clonosets</span>
<a id="__codelineno-0-76" name="__codelineno-0-76"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_check_input</span><span class="p">()</span>
<a id="__codelineno-0-77" name="__codelineno-0-77"></a>
<a id="__codelineno-0-78" name="__codelineno-0-78"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">spawn</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a id="__codelineno-0-79" name="__codelineno-0-79"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-80" name="__codelineno-0-80"></a>
<a id="__codelineno-0-81" name="__codelineno-0-81"></a><span class="sd">        Returns:</span>
<a id="__codelineno-0-82" name="__codelineno-0-82"></a><span class="sd">            the copy of the filter. Necessary for parallel computing</span>
<a id="__codelineno-0-83" name="__codelineno-0-83"></a>
<a id="__codelineno-0-84" name="__codelineno-0-84"></a><span class="sd">        &quot;&quot;&quot;</span>
<a id="__codelineno-0-85" name="__codelineno-0-85"></a>        <span class="k">return</span> <span class="n">Filter</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">functionality</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">functionality</span><span class="p">,</span>
<a id="__codelineno-0-86" name="__codelineno-0-86"></a>                      <span class="n">downsample</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">downsample_size</span><span class="p">,</span> <span class="n">top</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">top</span><span class="p">,</span>
<a id="__codelineno-0-87" name="__codelineno-0-87"></a>                      <span class="n">by_umi</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">by_umi</span><span class="p">,</span> <span class="n">mix_tails</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">mix_tails</span><span class="p">,</span>
<a id="__codelineno-0-88" name="__codelineno-0-88"></a>                      <span class="n">count_threshold</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">count_threshold</span><span class="p">,</span> <span class="n">seed</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">seed</span><span class="p">,</span>
<a id="__codelineno-0-89" name="__codelineno-0-89"></a>                      <span class="n">unweight</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">unweight</span><span class="p">,</span>
<a id="__codelineno-0-90" name="__codelineno-0-90"></a>                      <span class="n">recount_fractions</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">recount_fractions</span><span class="p">,</span>
<a id="__codelineno-0-91" name="__codelineno-0-91"></a>                      <span class="n">white_list</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">white_list</span><span class="p">,</span>
<a id="__codelineno-0-92" name="__codelineno-0-92"></a>                      <span class="n">black_list</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">black_list</span><span class="p">,</span>
<a id="__codelineno-0-93" name="__codelineno-0-93"></a>                      <span class="n">ignore_small_clonosets</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">ignore_small_clonosets</span>
<a id="__codelineno-0-94" name="__codelineno-0-94"></a>                      <span class="p">)</span>
<a id="__codelineno-0-95" name="__codelineno-0-95"></a>
<a id="__codelineno-0-96" name="__codelineno-0-96"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">apply</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">input_clonoset</span><span class="p">,</span> <span class="n">colnames</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<a id="__codelineno-0-97" name="__codelineno-0-97"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-98" name="__codelineno-0-98"></a><span class="sd">        Main method of the Filter object - application of it to a clonoset</span>
<a id="__codelineno-0-99" name="__codelineno-0-99"></a>
<a id="__codelineno-0-100" name="__codelineno-0-100"></a><span class="sd">        Args:</span>
<a id="__codelineno-0-101" name="__codelineno-0-101"></a><span class="sd">            input_clonoset (pd.DataFrame): clonoset in the form of Pandas DataFrame in</span>
<a id="__codelineno-0-102" name="__codelineno-0-102"></a><span class="sd">                MiXCR(3 or 4+ version), VDJtools or Bioadaptive formats.</span>
<a id="__codelineno-0-103" name="__codelineno-0-103"></a><span class="sd">            colnames (dict, optional): Dictionary of available specific column names.</span>
<a id="__codelineno-0-104" name="__codelineno-0-104"></a><span class="sd">                Defaults to None - colnames imputed automatically.</span>
<a id="__codelineno-0-105" name="__codelineno-0-105"></a>
<a id="__codelineno-0-106" name="__codelineno-0-106"></a><span class="sd">        Returns:</span>
<a id="__codelineno-0-107" name="__codelineno-0-107"></a><span class="sd">            clonoset (pd.DataFrame): clonoset after converting to common (VDJtools-like)</span>
<a id="__codelineno-0-108" name="__codelineno-0-108"></a><span class="sd">                format and applying functionality filtration and downsampling or taking top</span>
<a id="__codelineno-0-109" name="__codelineno-0-109"></a><span class="sd">        &quot;&quot;&quot;</span>
<a id="__codelineno-0-110" name="__codelineno-0-110"></a>
<a id="__codelineno-0-111" name="__codelineno-0-111"></a>        <span class="c1"># copy clonoset for not changing the original one</span>
<a id="__codelineno-0-112" name="__codelineno-0-112"></a>        <span class="n">clonoset</span> <span class="o">=</span> <span class="n">input_clonoset</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
<a id="__codelineno-0-113" name="__codelineno-0-113"></a>        <span class="k">if</span> <span class="n">colnames</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-114" name="__codelineno-0-114"></a>            <span class="n">colnames</span> <span class="o">=</span> <span class="n">get_column_names_from_clonoset</span><span class="p">(</span><span class="n">clonoset</span><span class="p">)</span>
<a id="__codelineno-0-115" name="__codelineno-0-115"></a>
<a id="__codelineno-0-116" name="__codelineno-0-116"></a>        <span class="c1"># create common columns: vdj-refPoints and VDJC-segments in common state</span>
<a id="__codelineno-0-117" name="__codelineno-0-117"></a>        <span class="n">clonoset</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_make_common_columns</span><span class="p">(</span><span class="n">clonoset</span><span class="p">,</span> <span class="n">colnames</span><span class="p">)</span>
<a id="__codelineno-0-118" name="__codelineno-0-118"></a>        <span class="n">colnames</span> <span class="o">=</span> <span class="n">get_column_names_from_clonoset</span><span class="p">(</span><span class="n">clonoset</span><span class="p">)</span>
<a id="__codelineno-0-119" name="__codelineno-0-119"></a>
<a id="__codelineno-0-120" name="__codelineno-0-120"></a>        <span class="c1"># converting to common VDJtools-like format and obtaining new colnames</span>
<a id="__codelineno-0-121" name="__codelineno-0-121"></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">convert</span><span class="p">:</span>
<a id="__codelineno-0-122" name="__codelineno-0-122"></a>            <span class="n">clonoset</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_convert_clonoset</span><span class="p">(</span><span class="n">clonoset</span><span class="p">,</span> <span class="n">colnames</span><span class="p">)</span>
<a id="__codelineno-0-123" name="__codelineno-0-123"></a>            <span class="n">colnames</span> <span class="o">=</span> <span class="n">get_column_names_from_clonoset</span><span class="p">(</span><span class="n">clonoset</span><span class="p">)</span>
<a id="__codelineno-0-124" name="__codelineno-0-124"></a>
<a id="__codelineno-0-125" name="__codelineno-0-125"></a>        <span class="c1"># application of main filters</span>
<a id="__codelineno-0-126" name="__codelineno-0-126"></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">functionality</span> <span class="o">!=</span> <span class="s2">&quot;a&quot;</span><span class="p">:</span>
<a id="__codelineno-0-127" name="__codelineno-0-127"></a>            <span class="n">clonoset</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_filter_by_functionality</span><span class="p">(</span><span class="n">clonoset</span><span class="p">,</span> <span class="n">colnames</span><span class="p">)</span>
<a id="__codelineno-0-128" name="__codelineno-0-128"></a>
<a id="__codelineno-0-129" name="__codelineno-0-129"></a>        <span class="n">clonoset</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_filter_by_count</span><span class="p">(</span><span class="n">clonoset</span><span class="p">,</span> <span class="n">colnames</span><span class="p">)</span>
<a id="__codelineno-0-130" name="__codelineno-0-130"></a>
<a id="__codelineno-0-131" name="__codelineno-0-131"></a>        <span class="n">clonoset</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_downsample</span><span class="p">(</span><span class="n">clonoset</span><span class="p">,</span> <span class="n">colnames</span><span class="p">)</span>
<a id="__codelineno-0-132" name="__codelineno-0-132"></a>        <span class="n">clonoset</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_top</span><span class="p">(</span><span class="n">clonoset</span><span class="p">,</span> <span class="n">colnames</span><span class="p">)</span>
<a id="__codelineno-0-133" name="__codelineno-0-133"></a>
<a id="__codelineno-0-134" name="__codelineno-0-134"></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">unweight</span><span class="p">:</span>
<a id="__codelineno-0-135" name="__codelineno-0-135"></a>            <span class="n">clonoset</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_unweight</span><span class="p">(</span><span class="n">clonoset</span><span class="p">,</span> <span class="n">colnames</span><span class="p">)</span>
<a id="__codelineno-0-136" name="__codelineno-0-136"></a>        <span class="c1"># the fraction columns need to be recounted after filtering, as they</span>
<a id="__codelineno-0-137" name="__codelineno-0-137"></a>        <span class="c1"># remain the same as in the original clonoset before filtration</span>
<a id="__codelineno-0-138" name="__codelineno-0-138"></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">recount_fractions</span><span class="p">:</span>
<a id="__codelineno-0-139" name="__codelineno-0-139"></a>            <span class="n">clonoset</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_recount_fractions_for_clonoset</span><span class="p">(</span><span class="n">clonoset</span><span class="p">,</span> <span class="n">colnames</span><span class="p">)</span>
<a id="__codelineno-0-140" name="__codelineno-0-140"></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">pool_by</span><span class="p">:</span>
<a id="__codelineno-0-141" name="__codelineno-0-141"></a>            <span class="n">clonoset</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pool_clonoset</span><span class="p">(</span><span class="n">clonoset</span><span class="p">,</span> <span class="n">colnames</span><span class="p">)</span>
<a id="__codelineno-0-142" name="__codelineno-0-142"></a>        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">white_list</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
<a id="__codelineno-0-143" name="__codelineno-0-143"></a>            <span class="n">clonoset</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_filter_clonotypes</span><span class="p">(</span><span class="n">clonoset</span><span class="p">,</span> <span class="n">list_type</span><span class="o">=</span><span class="s2">&quot;white&quot;</span><span class="p">)</span>
<a id="__codelineno-0-144" name="__codelineno-0-144"></a>        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">black_list</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
<a id="__codelineno-0-145" name="__codelineno-0-145"></a>            <span class="n">clonoset</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_filter_clonotypes</span><span class="p">(</span><span class="n">clonoset</span><span class="p">,</span> <span class="n">list_type</span><span class="o">=</span><span class="s2">&quot;black&quot;</span><span class="p">)</span>
<a id="__codelineno-0-146" name="__codelineno-0-146"></a>        <span class="k">return</span> <span class="n">clonoset</span>
<a id="__codelineno-0-147" name="__codelineno-0-147"></a>
<a id="__codelineno-0-148" name="__codelineno-0-148"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_convert_clonoset</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">clonoset</span><span class="p">,</span> <span class="n">colnames</span><span class="p">):</span>
<a id="__codelineno-0-149" name="__codelineno-0-149"></a>        <span class="c1"># copy clonoset for not changing the original one</span>
<a id="__codelineno-0-150" name="__codelineno-0-150"></a>        <span class="n">c_clonoset</span> <span class="o">=</span> <span class="n">clonoset</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
<a id="__codelineno-0-151" name="__codelineno-0-151"></a>
<a id="__codelineno-0-152" name="__codelineno-0-152"></a>        <span class="c1"># basic column name in clonoset DF</span>
<a id="__codelineno-0-153" name="__codelineno-0-153"></a>
<a id="__codelineno-0-154" name="__codelineno-0-154"></a>        <span class="n">count_column</span><span class="p">,</span> <span class="n">fraction_column</span> <span class="o">=</span> <span class="n">decide_count_and_frac_columns</span><span class="p">(</span><span class="n">colnames</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">by_umi</span><span class="p">,</span> <span class="n">suppress_warnings</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<a id="__codelineno-0-155" name="__codelineno-0-155"></a>
<a id="__codelineno-0-156" name="__codelineno-0-156"></a>        <span class="n">rename_dict</span> <span class="o">=</span> <span class="p">{</span><span class="n">count_column</span><span class="p">:</span> <span class="s2">&quot;count&quot;</span><span class="p">,</span>
<a id="__codelineno-0-157" name="__codelineno-0-157"></a>                       <span class="n">fraction_column</span><span class="p">:</span> <span class="s2">&quot;freq&quot;</span><span class="p">,</span>
<a id="__codelineno-0-158" name="__codelineno-0-158"></a>                       <span class="n">colnames</span><span class="p">[</span><span class="s2">&quot;cdr3aa_column&quot;</span><span class="p">]:</span> <span class="s2">&quot;cdr3aa&quot;</span><span class="p">,</span>
<a id="__codelineno-0-159" name="__codelineno-0-159"></a>                       <span class="n">colnames</span><span class="p">[</span><span class="s2">&quot;cdr3nt_column&quot;</span><span class="p">]:</span> <span class="s2">&quot;cdr3nt&quot;</span><span class="p">,</span>
<a id="__codelineno-0-160" name="__codelineno-0-160"></a>                       <span class="n">colnames</span><span class="p">[</span><span class="s2">&quot;v_column&quot;</span><span class="p">]:</span> <span class="s2">&quot;v&quot;</span><span class="p">,</span>
<a id="__codelineno-0-161" name="__codelineno-0-161"></a>                       <span class="n">colnames</span><span class="p">[</span><span class="s2">&quot;d_column&quot;</span><span class="p">]:</span> <span class="s2">&quot;d&quot;</span><span class="p">,</span>
<a id="__codelineno-0-162" name="__codelineno-0-162"></a>                       <span class="n">colnames</span><span class="p">[</span><span class="s2">&quot;j_column&quot;</span><span class="p">]:</span> <span class="s2">&quot;j&quot;</span><span class="p">}</span>
<a id="__codelineno-0-163" name="__codelineno-0-163"></a>        <span class="n">c_clonoset</span> <span class="o">=</span> <span class="n">c_clonoset</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="n">rename_dict</span><span class="p">)</span>
<a id="__codelineno-0-164" name="__codelineno-0-164"></a>
<a id="__codelineno-0-165" name="__codelineno-0-165"></a>        <span class="n">result_columns</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;count&quot;</span><span class="p">,</span> <span class="s2">&quot;freq&quot;</span><span class="p">]</span>
<a id="__codelineno-0-166" name="__codelineno-0-166"></a>        <span class="k">if</span> <span class="s2">&quot;cdr3nt&quot;</span> <span class="ow">in</span> <span class="n">c_clonoset</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
<a id="__codelineno-0-167" name="__codelineno-0-167"></a>            <span class="n">result_columns</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;cdr3nt&quot;</span><span class="p">)</span>
<a id="__codelineno-0-168" name="__codelineno-0-168"></a>        <span class="n">result_columns</span> <span class="o">+=</span> <span class="p">[</span><span class="s2">&quot;cdr3aa&quot;</span><span class="p">,</span> <span class="s2">&quot;v&quot;</span><span class="p">]</span>
<a id="__codelineno-0-169" name="__codelineno-0-169"></a>        <span class="n">segment_borders_columns</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;VEnd&quot;</span><span class="p">,</span> <span class="s2">&quot;DStart&quot;</span><span class="p">,</span> <span class="s2">&quot;DEnd&quot;</span><span class="p">,</span> <span class="s2">&quot;JStart&quot;</span><span class="p">]</span>
<a id="__codelineno-0-170" name="__codelineno-0-170"></a>
<a id="__codelineno-0-171" name="__codelineno-0-171"></a>
<a id="__codelineno-0-172" name="__codelineno-0-172"></a>        <span class="n">clonoset</span><span class="p">[</span><span class="s2">&quot;cdr3aa&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">clonoset</span><span class="p">[</span><span class="s2">&quot;cdr3aa&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
<a id="__codelineno-0-173" name="__codelineno-0-173"></a>        <span class="n">clonoset</span><span class="p">[</span><span class="s2">&quot;cdr3nt&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">clonoset</span><span class="p">[</span><span class="s2">&quot;cdr3nt&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
<a id="__codelineno-0-174" name="__codelineno-0-174"></a>
<a id="__codelineno-0-175" name="__codelineno-0-175"></a>
<a id="__codelineno-0-176" name="__codelineno-0-176"></a>        <span class="c1"># In the case of MiXCR and Bioadaptive format the segment type columns</span>
<a id="__codelineno-0-177" name="__codelineno-0-177"></a>        <span class="c1"># usually show several segment variants with particular allele and score.</span>
<a id="__codelineno-0-178" name="__codelineno-0-178"></a>        <span class="c1"># Here we extract only the name of the best hit without allele ane score</span>
<a id="__codelineno-0-179" name="__codelineno-0-179"></a>        <span class="n">c_clonoset</span><span class="p">[</span><span class="s2">&quot;v&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">c_clonoset</span><span class="p">[</span><span class="s2">&quot;v&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">extract_segment</span><span class="p">(</span><span class="n">x</span><span class="p">))</span>
<a id="__codelineno-0-180" name="__codelineno-0-180"></a>        <span class="k">if</span> <span class="s2">&quot;d&quot;</span> <span class="ow">in</span> <span class="n">c_clonoset</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
<a id="__codelineno-0-181" name="__codelineno-0-181"></a>            <span class="n">c_clonoset</span><span class="p">[</span><span class="s2">&quot;d&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">c_clonoset</span><span class="p">[</span><span class="s2">&quot;d&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">extract_segment</span><span class="p">(</span><span class="n">x</span><span class="p">))</span>
<a id="__codelineno-0-182" name="__codelineno-0-182"></a>            <span class="n">result_columns</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;d&quot;</span><span class="p">)</span>
<a id="__codelineno-0-183" name="__codelineno-0-183"></a>        <span class="k">if</span> <span class="s2">&quot;j&quot;</span> <span class="ow">in</span> <span class="n">c_clonoset</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
<a id="__codelineno-0-184" name="__codelineno-0-184"></a>            <span class="n">c_clonoset</span><span class="p">[</span><span class="s2">&quot;j&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">c_clonoset</span><span class="p">[</span><span class="s2">&quot;j&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">extract_segment</span><span class="p">(</span><span class="n">x</span><span class="p">))</span>
<a id="__codelineno-0-185" name="__codelineno-0-185"></a>            <span class="n">result_columns</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;j&quot;</span><span class="p">)</span>
<a id="__codelineno-0-186" name="__codelineno-0-186"></a>
<a id="__codelineno-0-187" name="__codelineno-0-187"></a>        <span class="c1"># add the column for Constant segment if it exists in the original clonoset</span>
<a id="__codelineno-0-188" name="__codelineno-0-188"></a>        <span class="k">if</span> <span class="n">colnames</span><span class="p">[</span><span class="s2">&quot;c_column&quot;</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-189" name="__codelineno-0-189"></a>            <span class="n">c_clonoset</span> <span class="o">=</span> <span class="n">c_clonoset</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="n">colnames</span><span class="p">[</span><span class="s2">&quot;c_column&quot;</span><span class="p">]:</span> <span class="s2">&quot;c&quot;</span><span class="p">})</span>
<a id="__codelineno-0-190" name="__codelineno-0-190"></a>            <span class="n">c_clonoset</span><span class="p">[</span><span class="s2">&quot;c&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">c_clonoset</span><span class="p">[</span><span class="s2">&quot;c&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">extract_segment</span><span class="p">(</span><span class="n">x</span><span class="p">))</span>
<a id="__codelineno-0-191" name="__codelineno-0-191"></a>            <span class="n">result_columns</span> <span class="o">+=</span> <span class="p">[</span><span class="s2">&quot;c&quot;</span><span class="p">]</span>
<a id="__codelineno-0-192" name="__codelineno-0-192"></a>
<a id="__codelineno-0-193" name="__codelineno-0-193"></a>        <span class="c1"># obtain the borders of the segments within CDR3 region, if possible and add them to</span>
<a id="__codelineno-0-194" name="__codelineno-0-194"></a>        <span class="c1"># resulting clonoset</span>
<a id="__codelineno-0-195" name="__codelineno-0-195"></a>        <span class="k">if</span> <span class="s2">&quot;refPoints&quot;</span> <span class="ow">in</span> <span class="n">c_clonoset</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
<a id="__codelineno-0-196" name="__codelineno-0-196"></a>            <span class="n">c_clonoset</span><span class="p">[</span><span class="s2">&quot;VEnd&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">c_clonoset</span><span class="p">[</span><span class="s2">&quot;refPoints&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">extract_refpoint_position</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="mi">11</span><span class="p">,</span> <span class="n">minus</span><span class="o">=</span><span class="kc">True</span><span class="p">))</span>
<a id="__codelineno-0-197" name="__codelineno-0-197"></a>            <span class="n">c_clonoset</span><span class="p">[</span><span class="s2">&quot;DStart&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">c_clonoset</span><span class="p">[</span><span class="s2">&quot;refPoints&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">extract_refpoint_position</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="mi">12</span><span class="p">,</span> <span class="n">minus</span><span class="o">=</span><span class="kc">False</span><span class="p">))</span>
<a id="__codelineno-0-198" name="__codelineno-0-198"></a>            <span class="n">c_clonoset</span><span class="p">[</span><span class="s2">&quot;DEnd&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">c_clonoset</span><span class="p">[</span><span class="s2">&quot;refPoints&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">extract_refpoint_position</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="mi">15</span><span class="p">,</span> <span class="n">minus</span><span class="o">=</span><span class="kc">True</span><span class="p">))</span>
<a id="__codelineno-0-199" name="__codelineno-0-199"></a>            <span class="n">c_clonoset</span><span class="p">[</span><span class="s2">&quot;JStart&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">c_clonoset</span><span class="p">[</span><span class="s2">&quot;refPoints&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">extract_refpoint_position</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="n">minus</span><span class="o">=</span><span class="kc">False</span><span class="p">))</span>
<a id="__codelineno-0-200" name="__codelineno-0-200"></a>
<a id="__codelineno-0-201" name="__codelineno-0-201"></a>        <span class="n">result_columns</span> <span class="o">+=</span> <span class="p">[</span><span class="n">col</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">segment_borders_columns</span> <span class="k">if</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">c_clonoset</span><span class="o">.</span><span class="n">columns</span><span class="p">]</span>    
<a id="__codelineno-0-202" name="__codelineno-0-202"></a>
<a id="__codelineno-0-203" name="__codelineno-0-203"></a>        <span class="c1"># save &quot;sample_id&quot; column if it is present in clonoset</span>
<a id="__codelineno-0-204" name="__codelineno-0-204"></a>        <span class="k">if</span> <span class="s2">&quot;sample_id&quot;</span> <span class="ow">in</span> <span class="n">c_clonoset</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
<a id="__codelineno-0-205" name="__codelineno-0-205"></a>            <span class="n">result_columns</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;sample_id&quot;</span><span class="p">)</span>
<a id="__codelineno-0-206" name="__codelineno-0-206"></a>        <span class="n">c_clonoset</span> <span class="o">=</span> <span class="n">c_clonoset</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="s2">&quot;count&quot;</span><span class="p">,</span> <span class="n">ascending</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<a id="__codelineno-0-207" name="__codelineno-0-207"></a>        <span class="k">return</span> <span class="n">c_clonoset</span><span class="p">[</span><span class="n">result_columns</span><span class="p">]</span>
<a id="__codelineno-0-208" name="__codelineno-0-208"></a>
<a id="__codelineno-0-209" name="__codelineno-0-209"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_make_common_columns</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">clonoset_in</span><span class="p">,</span> <span class="n">colnames</span><span class="p">):</span>
<a id="__codelineno-0-210" name="__codelineno-0-210"></a>        <span class="n">clonoset</span> <span class="o">=</span> <span class="n">clonoset_in</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
<a id="__codelineno-0-211" name="__codelineno-0-211"></a>
<a id="__codelineno-0-212" name="__codelineno-0-212"></a>        <span class="c1"># treat refPoints</span>
<a id="__codelineno-0-213" name="__codelineno-0-213"></a>        <span class="n">refpoints_columns</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;VEnd&quot;</span><span class="p">,</span> <span class="s2">&quot;DStart&quot;</span><span class="p">,</span> <span class="s2">&quot;DEnd&quot;</span><span class="p">,</span> <span class="s2">&quot;JStart&quot;</span><span class="p">]</span>
<a id="__codelineno-0-214" name="__codelineno-0-214"></a>        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">clonoset</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span><span class="o">.</span><span class="n">intersection</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">refpoints_columns</span><span class="p">)))</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">:</span> <span class="c1"># check if not all the columns present</span>
<a id="__codelineno-0-215" name="__codelineno-0-215"></a>            <span class="k">if</span> <span class="s2">&quot;refPoints&quot;</span> <span class="ow">in</span> <span class="n">clonoset</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span> <span class="c1"># if refPoints is present, create new columns</span>
<a id="__codelineno-0-216" name="__codelineno-0-216"></a>                <span class="n">clonoset</span><span class="p">[</span><span class="s2">&quot;VEnd&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">clonoset</span><span class="p">[</span><span class="s2">&quot;refPoints&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">extract_refpoint_position</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="mi">11</span><span class="p">,</span> <span class="n">minus</span><span class="o">=</span><span class="kc">True</span><span class="p">))</span>
<a id="__codelineno-0-217" name="__codelineno-0-217"></a>                <span class="n">clonoset</span><span class="p">[</span><span class="s2">&quot;DStart&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">clonoset</span><span class="p">[</span><span class="s2">&quot;refPoints&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">extract_refpoint_position</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="mi">12</span><span class="p">,</span> <span class="n">minus</span><span class="o">=</span><span class="kc">False</span><span class="p">))</span>
<a id="__codelineno-0-218" name="__codelineno-0-218"></a>                <span class="n">clonoset</span><span class="p">[</span><span class="s2">&quot;DEnd&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">clonoset</span><span class="p">[</span><span class="s2">&quot;refPoints&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">extract_refpoint_position</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="mi">15</span><span class="p">,</span> <span class="n">minus</span><span class="o">=</span><span class="kc">True</span><span class="p">))</span>
<a id="__codelineno-0-219" name="__codelineno-0-219"></a>                <span class="n">clonoset</span><span class="p">[</span><span class="s2">&quot;JStart&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">clonoset</span><span class="p">[</span><span class="s2">&quot;refPoints&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">extract_refpoint_position</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="n">minus</span><span class="o">=</span><span class="kc">False</span><span class="p">))</span>
<a id="__codelineno-0-220" name="__codelineno-0-220"></a>
<a id="__codelineno-0-221" name="__codelineno-0-221"></a>        <span class="c1"># treat v,d,j segments</span>
<a id="__codelineno-0-222" name="__codelineno-0-222"></a>
<a id="__codelineno-0-223" name="__codelineno-0-223"></a>        <span class="c1"># V</span>
<a id="__codelineno-0-224" name="__codelineno-0-224"></a>        <span class="k">if</span> <span class="s2">&quot;v&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">clonoset</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
<a id="__codelineno-0-225" name="__codelineno-0-225"></a>            <span class="k">if</span> <span class="n">colnames</span><span class="p">[</span><span class="s2">&quot;v_column&quot;</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-226" name="__codelineno-0-226"></a>                <span class="n">clonoset</span><span class="p">[</span><span class="s2">&quot;v&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">clonoset</span><span class="p">[</span><span class="n">colnames</span><span class="p">[</span><span class="s2">&quot;v_column&quot;</span><span class="p">]]</span>
<a id="__codelineno-0-227" name="__codelineno-0-227"></a>        <span class="k">if</span> <span class="s2">&quot;v&quot;</span> <span class="ow">in</span> <span class="n">clonoset</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
<a id="__codelineno-0-228" name="__codelineno-0-228"></a>            <span class="n">clonoset</span><span class="p">[</span><span class="s2">&quot;v&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">clonoset</span><span class="p">[</span><span class="s2">&quot;v&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">extract_segment</span><span class="p">(</span><span class="n">x</span><span class="p">))</span>
<a id="__codelineno-0-229" name="__codelineno-0-229"></a>
<a id="__codelineno-0-230" name="__codelineno-0-230"></a>        <span class="c1"># D</span>
<a id="__codelineno-0-231" name="__codelineno-0-231"></a>        <span class="k">if</span> <span class="s2">&quot;d&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">clonoset</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
<a id="__codelineno-0-232" name="__codelineno-0-232"></a>            <span class="k">if</span> <span class="n">colnames</span><span class="p">[</span><span class="s2">&quot;d_column&quot;</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-233" name="__codelineno-0-233"></a>                <span class="n">clonoset</span><span class="p">[</span><span class="s2">&quot;d&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">clonoset</span><span class="p">[</span><span class="n">colnames</span><span class="p">[</span><span class="s2">&quot;d_column&quot;</span><span class="p">]]</span>
<a id="__codelineno-0-234" name="__codelineno-0-234"></a>        <span class="k">if</span> <span class="s2">&quot;d&quot;</span> <span class="ow">in</span> <span class="n">clonoset</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
<a id="__codelineno-0-235" name="__codelineno-0-235"></a>            <span class="n">clonoset</span><span class="p">[</span><span class="s2">&quot;d&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">clonoset</span><span class="p">[</span><span class="s2">&quot;d&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">extract_segment</span><span class="p">(</span><span class="n">x</span><span class="p">))</span>
<a id="__codelineno-0-236" name="__codelineno-0-236"></a>
<a id="__codelineno-0-237" name="__codelineno-0-237"></a>        <span class="c1"># J</span>
<a id="__codelineno-0-238" name="__codelineno-0-238"></a>        <span class="k">if</span> <span class="s2">&quot;j&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">clonoset</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
<a id="__codelineno-0-239" name="__codelineno-0-239"></a>            <span class="k">if</span> <span class="n">colnames</span><span class="p">[</span><span class="s2">&quot;j_column&quot;</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-240" name="__codelineno-0-240"></a>                <span class="n">clonoset</span><span class="p">[</span><span class="s2">&quot;j&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">clonoset</span><span class="p">[</span><span class="n">colnames</span><span class="p">[</span><span class="s2">&quot;j_column&quot;</span><span class="p">]]</span>
<a id="__codelineno-0-241" name="__codelineno-0-241"></a>        <span class="k">if</span> <span class="s2">&quot;j&quot;</span> <span class="ow">in</span> <span class="n">clonoset</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
<a id="__codelineno-0-242" name="__codelineno-0-242"></a>            <span class="n">clonoset</span><span class="p">[</span><span class="s2">&quot;j&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">clonoset</span><span class="p">[</span><span class="s2">&quot;j&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">extract_segment</span><span class="p">(</span><span class="n">x</span><span class="p">))</span>
<a id="__codelineno-0-243" name="__codelineno-0-243"></a>
<a id="__codelineno-0-244" name="__codelineno-0-244"></a>        <span class="c1"># C</span>
<a id="__codelineno-0-245" name="__codelineno-0-245"></a>        <span class="k">if</span> <span class="s2">&quot;c&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">clonoset</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
<a id="__codelineno-0-246" name="__codelineno-0-246"></a>            <span class="k">if</span> <span class="n">colnames</span><span class="p">[</span><span class="s2">&quot;c_column&quot;</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-247" name="__codelineno-0-247"></a>                <span class="n">clonoset</span><span class="p">[</span><span class="s2">&quot;c&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">clonoset</span><span class="p">[</span><span class="n">colnames</span><span class="p">[</span><span class="s2">&quot;c_column&quot;</span><span class="p">]]</span>
<a id="__codelineno-0-248" name="__codelineno-0-248"></a>        <span class="k">if</span> <span class="s2">&quot;c&quot;</span> <span class="ow">in</span> <span class="n">clonoset</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
<a id="__codelineno-0-249" name="__codelineno-0-249"></a>            <span class="n">clonoset</span><span class="p">[</span><span class="s2">&quot;c&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">clonoset</span><span class="p">[</span><span class="s2">&quot;c&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">extract_segment</span><span class="p">(</span><span class="n">x</span><span class="p">))</span>
<a id="__codelineno-0-250" name="__codelineno-0-250"></a>
<a id="__codelineno-0-251" name="__codelineno-0-251"></a>        <span class="k">if</span> <span class="s2">&quot;cdr3aa&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">clonoset</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
<a id="__codelineno-0-252" name="__codelineno-0-252"></a>            <span class="k">if</span> <span class="n">colnames</span><span class="p">[</span><span class="s2">&quot;cdr3aa_column&quot;</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-253" name="__codelineno-0-253"></a>                <span class="n">clonoset</span><span class="p">[</span><span class="s2">&quot;cdr3aa&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">clonoset</span><span class="p">[</span><span class="n">colnames</span><span class="p">[</span><span class="s2">&quot;cdr3aa_column&quot;</span><span class="p">]]</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
<a id="__codelineno-0-254" name="__codelineno-0-254"></a>        <span class="k">if</span> <span class="s2">&quot;cdr3nt&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">clonoset</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
<a id="__codelineno-0-255" name="__codelineno-0-255"></a>            <span class="k">if</span> <span class="n">colnames</span><span class="p">[</span><span class="s2">&quot;cdr3nt_column&quot;</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-256" name="__codelineno-0-256"></a>                <span class="n">clonoset</span><span class="p">[</span><span class="s2">&quot;cdr3nt&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">clonoset</span><span class="p">[</span><span class="n">colnames</span><span class="p">[</span><span class="s2">&quot;cdr3nt_column&quot;</span><span class="p">]]</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
<a id="__codelineno-0-257" name="__codelineno-0-257"></a>
<a id="__codelineno-0-258" name="__codelineno-0-258"></a>        <span class="k">return</span> <span class="n">clonoset</span>
<a id="__codelineno-0-259" name="__codelineno-0-259"></a>
<a id="__codelineno-0-260" name="__codelineno-0-260"></a>
<a id="__codelineno-0-261" name="__codelineno-0-261"></a>
<a id="__codelineno-0-262" name="__codelineno-0-262"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_unweight</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">clonoset_in</span><span class="p">,</span> <span class="n">colnames</span><span class="p">):</span>
<a id="__codelineno-0-263" name="__codelineno-0-263"></a>        <span class="n">clonoset</span> <span class="o">=</span> <span class="n">clonoset_in</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
<a id="__codelineno-0-264" name="__codelineno-0-264"></a>        <span class="n">clonoset</span><span class="p">[</span><span class="n">colnames</span><span class="p">[</span><span class="s2">&quot;count_column&quot;</span><span class="p">]]</span> <span class="o">=</span> <span class="mi">1</span>
<a id="__codelineno-0-265" name="__codelineno-0-265"></a>        <span class="k">return</span> <span class="n">clonoset</span>
<a id="__codelineno-0-266" name="__codelineno-0-266"></a>
<a id="__codelineno-0-267" name="__codelineno-0-267"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_recount_fractions_for_clonoset</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">clonoset_in</span><span class="p">,</span> <span class="n">colnames</span><span class="p">):</span>
<a id="__codelineno-0-268" name="__codelineno-0-268"></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_empty</span><span class="p">():</span>
<a id="__codelineno-0-269" name="__codelineno-0-269"></a>            <span class="k">return</span> <span class="n">clonoset_in</span>
<a id="__codelineno-0-270" name="__codelineno-0-270"></a>        <span class="n">clonoset</span> <span class="o">=</span> <span class="n">clonoset_in</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
<a id="__codelineno-0-271" name="__codelineno-0-271"></a>
<a id="__codelineno-0-272" name="__codelineno-0-272"></a>        <span class="n">count_column</span> <span class="o">=</span> <span class="n">colnames</span><span class="p">[</span><span class="s2">&quot;count_column&quot;</span><span class="p">]</span>
<a id="__codelineno-0-273" name="__codelineno-0-273"></a>        <span class="n">fraction_column</span> <span class="o">=</span> <span class="n">colnames</span><span class="p">[</span><span class="s2">&quot;fraction_column&quot;</span><span class="p">]</span>
<a id="__codelineno-0-274" name="__codelineno-0-274"></a>        <span class="n">umi_column</span> <span class="o">=</span> <span class="n">colnames</span><span class="p">[</span><span class="s2">&quot;umi_column&quot;</span><span class="p">]</span>
<a id="__codelineno-0-275" name="__codelineno-0-275"></a>        <span class="n">umi_fraction_column</span> <span class="o">=</span> <span class="n">colnames</span><span class="p">[</span><span class="s2">&quot;umi_fraction_column&quot;</span><span class="p">]</span>
<a id="__codelineno-0-276" name="__codelineno-0-276"></a>
<a id="__codelineno-0-277" name="__codelineno-0-277"></a>        <span class="n">clonoset</span><span class="p">[</span><span class="n">fraction_column</span><span class="p">]</span> <span class="o">=</span> <span class="n">clonoset</span><span class="p">[</span><span class="n">count_column</span><span class="p">]</span><span class="o">/</span><span class="n">clonoset</span><span class="p">[</span><span class="n">count_column</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
<a id="__codelineno-0-278" name="__codelineno-0-278"></a>        <span class="k">if</span> <span class="n">colnames</span><span class="p">[</span><span class="s2">&quot;umi&quot;</span><span class="p">]:</span>
<a id="__codelineno-0-279" name="__codelineno-0-279"></a>            <span class="n">clonoset</span><span class="p">[</span><span class="n">umi_fraction_column</span><span class="p">]</span> <span class="o">=</span> <span class="n">clonoset</span><span class="p">[</span><span class="n">umi_column</span><span class="p">]</span><span class="o">/</span><span class="n">clonoset</span><span class="p">[</span><span class="n">umi_column</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
<a id="__codelineno-0-280" name="__codelineno-0-280"></a>        <span class="k">return</span> <span class="n">clonoset</span>
<a id="__codelineno-0-281" name="__codelineno-0-281"></a>
<a id="__codelineno-0-282" name="__codelineno-0-282"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_filter_by_count</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">clonoset_in</span><span class="p">,</span> <span class="n">colnames</span><span class="p">):</span>
<a id="__codelineno-0-283" name="__codelineno-0-283"></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">count_threshold</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-284" name="__codelineno-0-284"></a>            <span class="k">return</span> <span class="n">clonoset_in</span>
<a id="__codelineno-0-285" name="__codelineno-0-285"></a>        <span class="n">clonoset</span> <span class="o">=</span> <span class="n">clonoset_in</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
<a id="__codelineno-0-286" name="__codelineno-0-286"></a>        <span class="n">count_column</span> <span class="o">=</span> <span class="n">colnames</span><span class="p">[</span><span class="s2">&quot;count_column&quot;</span><span class="p">]</span>
<a id="__codelineno-0-287" name="__codelineno-0-287"></a>        <span class="n">clonoset</span> <span class="o">=</span> <span class="n">clonoset</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">clonoset</span><span class="p">[</span><span class="n">count_column</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">count_threshold</span><span class="p">]</span>
<a id="__codelineno-0-288" name="__codelineno-0-288"></a>
<a id="__codelineno-0-289" name="__codelineno-0-289"></a>        <span class="k">return</span> <span class="n">clonoset</span>
<a id="__codelineno-0-290" name="__codelineno-0-290"></a>
<a id="__codelineno-0-291" name="__codelineno-0-291"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_check_input</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a id="__codelineno-0-292" name="__codelineno-0-292"></a>
<a id="__codelineno-0-293" name="__codelineno-0-293"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-294" name="__codelineno-0-294"></a><span class="sd">        Check if the object was created properly</span>
<a id="__codelineno-0-295" name="__codelineno-0-295"></a>
<a id="__codelineno-0-296" name="__codelineno-0-296"></a><span class="sd">        Raises:</span>
<a id="__codelineno-0-297" name="__codelineno-0-297"></a><span class="sd">            ValueError: in case of incorrect parameter values</span>
<a id="__codelineno-0-298" name="__codelineno-0-298"></a><span class="sd">        &quot;&quot;&quot;</span>
<a id="__codelineno-0-299" name="__codelineno-0-299"></a>        <span class="n">functionality_options</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;a&quot;</span><span class="p">,</span> <span class="s2">&quot;f&quot;</span><span class="p">,</span> <span class="s2">&quot;n&quot;</span><span class="p">]</span>
<a id="__codelineno-0-300" name="__codelineno-0-300"></a>        <span class="n">count_threshold_limits</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">100000</span><span class="p">]</span>
<a id="__codelineno-0-301" name="__codelineno-0-301"></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">functionality</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">functionality_options</span><span class="p">:</span>
<a id="__codelineno-0-302" name="__codelineno-0-302"></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Incorrect value &#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">functionality</span><span class="si">}</span><span class="s2">&#39; for functionality. Possible values: </span><span class="si">{</span><span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">functionality_options</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-0-303" name="__codelineno-0-303"></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">count_threshold</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-304" name="__codelineno-0-304"></a>            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">count_threshold</span><span class="p">,</span> <span class="nb">int</span><span class="p">):</span>
<a id="__codelineno-0-305" name="__codelineno-0-305"></a>                <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;Count threshold must be an &#39;int&#39; or &#39;None&#39;&quot;</span><span class="p">)</span>
<a id="__codelineno-0-306" name="__codelineno-0-306"></a>            <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">count_threshold</span> <span class="o">&lt;</span> <span class="n">count_threshold_limits</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<a id="__codelineno-0-307" name="__codelineno-0-307"></a>                  <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">count_threshold</span> <span class="o">&gt;</span> <span class="n">count_threshold_limits</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>
<a id="__codelineno-0-308" name="__codelineno-0-308"></a>                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Incorrect value &#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">functionality</span><span class="si">}</span><span class="s2">&#39; for count_threshold. Possible values: </span><span class="si">{</span><span class="n">count_threshold_limits</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>                
<a id="__codelineno-0-309" name="__codelineno-0-309"></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">downsample_size</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-310" name="__codelineno-0-310"></a>            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">downsample_size</span><span class="p">,</span> <span class="nb">int</span><span class="p">):</span>
<a id="__codelineno-0-311" name="__codelineno-0-311"></a>                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Incorrect value &#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">downsample_size</span><span class="si">}</span><span class="s2">&#39; for downsample_size. Only int or None possible&quot;</span><span class="p">)</span>
<a id="__codelineno-0-312" name="__codelineno-0-312"></a>            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">downsample_size</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">:</span>
<a id="__codelineno-0-313" name="__codelineno-0-313"></a>                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Incorrect value &#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">downsample_size</span><span class="si">}</span><span class="s2">&#39; for downsample_size. Value too low&quot;</span><span class="p">)</span>
<a id="__codelineno-0-314" name="__codelineno-0-314"></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">top</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-315" name="__codelineno-0-315"></a>            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">top</span><span class="p">,</span> <span class="nb">int</span><span class="p">):</span>
<a id="__codelineno-0-316" name="__codelineno-0-316"></a>                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Incorrect value &#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">top</span><span class="si">}</span><span class="s2">&#39; for top. Only int or None possible&quot;</span><span class="p">)</span>
<a id="__codelineno-0-317" name="__codelineno-0-317"></a>            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">top</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">:</span>
<a id="__codelineno-0-318" name="__codelineno-0-318"></a>                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Incorrect value &#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">top</span><span class="si">}</span><span class="s2">&#39; for top. Value too low&quot;</span><span class="p">)</span>
<a id="__codelineno-0-319" name="__codelineno-0-319"></a>        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">seed</span><span class="p">,</span> <span class="n">Hashable</span><span class="p">):</span>
<a id="__codelineno-0-320" name="__codelineno-0-320"></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Incorrect value &#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">seed</span><span class="si">}</span><span class="s2">&#39; for seed. Must be hashable&quot;</span><span class="p">)</span>
<a id="__codelineno-0-321" name="__codelineno-0-321"></a>        <span class="n">pool_by_options</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="s2">&quot;aa&quot;</span><span class="p">,</span> <span class="s2">&quot;aaV&quot;</span><span class="p">,</span> <span class="s2">&quot;aaVj&quot;</span><span class="p">,</span> <span class="s2">&quot;nt&quot;</span><span class="p">,</span> <span class="s2">&quot;ntV&quot;</span><span class="p">,</span> <span class="s2">&quot;ntVJ&quot;</span><span class="p">]</span>
<a id="__codelineno-0-322" name="__codelineno-0-322"></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">pool_by</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">pool_by_options</span><span class="p">:</span>
<a id="__codelineno-0-323" name="__codelineno-0-323"></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Incorrect value &#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">pool_by</span><span class="si">}</span><span class="s2">&#39; for clonoset pool. Possible values: </span><span class="si">{</span><span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">pool_by_options</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-0-324" name="__codelineno-0-324"></a>
<a id="__codelineno-0-325" name="__codelineno-0-325"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_downsample</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">clonoset_in</span><span class="p">,</span> <span class="n">colnames</span><span class="p">):</span>
<a id="__codelineno-0-326" name="__codelineno-0-326"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-327" name="__codelineno-0-327"></a><span class="sd">        Downsample clonoset.</span>
<a id="__codelineno-0-328" name="__codelineno-0-328"></a>
<a id="__codelineno-0-329" name="__codelineno-0-329"></a><span class="sd">        This function takes the total number of reads or UMIs of the clonoset.</span>
<a id="__codelineno-0-330" name="__codelineno-0-330"></a><span class="sd">        Then randomly samples the downsample_size from 0 to this total number of reads/UMIs. </span>
<a id="__codelineno-0-331" name="__codelineno-0-331"></a><span class="sd">        This random sample is mapped to the clonotype sizes and </span>
<a id="__codelineno-0-332" name="__codelineno-0-332"></a><span class="sd">        the new downsampled clonoset is created</span>
<a id="__codelineno-0-333" name="__codelineno-0-333"></a><span class="sd">        &quot;&quot;&quot;</span>
<a id="__codelineno-0-334" name="__codelineno-0-334"></a>
<a id="__codelineno-0-335" name="__codelineno-0-335"></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">downsample_size</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-336" name="__codelineno-0-336"></a>            <span class="k">return</span> <span class="n">clonoset_in</span>
<a id="__codelineno-0-337" name="__codelineno-0-337"></a>
<a id="__codelineno-0-338" name="__codelineno-0-338"></a>        <span class="n">clonoset</span> <span class="o">=</span> <span class="n">clonoset_in</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
<a id="__codelineno-0-339" name="__codelineno-0-339"></a>        <span class="n">count_column</span> <span class="o">=</span> <span class="n">colnames</span><span class="p">[</span><span class="s2">&quot;count_column&quot;</span><span class="p">]</span>
<a id="__codelineno-0-340" name="__codelineno-0-340"></a>        <span class="n">total_count</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">clonoset</span><span class="p">[</span><span class="n">count_column</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">())</span>
<a id="__codelineno-0-341" name="__codelineno-0-341"></a>
<a id="__codelineno-0-342" name="__codelineno-0-342"></a>        <span class="c1"># raise ValueError if UMI/read count is less then downsample_size</span>
<a id="__codelineno-0-343" name="__codelineno-0-343"></a>
<a id="__codelineno-0-344" name="__codelineno-0-344"></a>        <span class="k">if</span> <span class="n">total_count</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">downsample_size</span><span class="p">:</span>
<a id="__codelineno-0-345" name="__codelineno-0-345"></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ignore_small_clonosets</span><span class="p">:</span>
<a id="__codelineno-0-346" name="__codelineno-0-346"></a>                <span class="k">return</span> <span class="n">clonoset</span>
<a id="__codelineno-0-347" name="__codelineno-0-347"></a>            <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-348" name="__codelineno-0-348"></a>                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;total count </span><span class="si">{</span><span class="n">total_count</span><span class="si">}</span><span class="s2"> is less than downsample size </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">downsample_size</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-0-349" name="__codelineno-0-349"></a>        <span class="k">elif</span> <span class="n">total_count</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">downsample_size</span><span class="p">:</span>
<a id="__codelineno-0-350" name="__codelineno-0-350"></a>            <span class="k">return</span> <span class="n">clonoset</span>
<a id="__codelineno-0-351" name="__codelineno-0-351"></a>
<a id="__codelineno-0-352" name="__codelineno-0-352"></a>        <span class="c1"># set seed if given and take the sample of total_count</span>
<a id="__codelineno-0-353" name="__codelineno-0-353"></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">seed</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-354" name="__codelineno-0-354"></a>            <span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">seed</span><span class="p">)</span>
<a id="__codelineno-0-355" name="__codelineno-0-355"></a>        <span class="n">sample</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">random</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">total_count</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">downsample_size</span><span class="p">))</span>
<a id="__codelineno-0-356" name="__codelineno-0-356"></a>
<a id="__codelineno-0-357" name="__codelineno-0-357"></a>        <span class="c1"># map the sample to the clone counts in the clonoset</span>
<a id="__codelineno-0-358" name="__codelineno-0-358"></a>        <span class="n">curr_sum</span> <span class="o">=</span> <span class="mi">0</span>
<a id="__codelineno-0-359" name="__codelineno-0-359"></a>        <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>
<a id="__codelineno-0-360" name="__codelineno-0-360"></a>        <span class="n">new_counts_dict</span> <span class="o">=</span> <span class="p">{}</span>
<a id="__codelineno-0-361" name="__codelineno-0-361"></a>        <span class="k">for</span> <span class="n">index</span><span class="p">,</span><span class="n">r</span> <span class="ow">in</span> <span class="n">clonoset</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>
<a id="__codelineno-0-362" name="__codelineno-0-362"></a>            <span class="n">curr_sum</span><span class="o">+=</span><span class="n">r</span><span class="p">[</span><span class="n">count_column</span><span class="p">]</span>
<a id="__codelineno-0-363" name="__codelineno-0-363"></a>            <span class="n">new_count</span> <span class="o">=</span> <span class="mi">0</span>
<a id="__codelineno-0-364" name="__codelineno-0-364"></a>            <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">downsample_size</span><span class="p">:</span>
<a id="__codelineno-0-365" name="__codelineno-0-365"></a>                <span class="k">break</span>
<a id="__codelineno-0-366" name="__codelineno-0-366"></a>            <span class="k">while</span><span class="p">(</span><span class="n">sample</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">&lt;</span><span class="n">curr_sum</span><span class="p">):</span>
<a id="__codelineno-0-367" name="__codelineno-0-367"></a>                <span class="n">new_count</span><span class="o">+=</span><span class="mi">1</span>
<a id="__codelineno-0-368" name="__codelineno-0-368"></a>                <span class="n">i</span><span class="o">+=</span><span class="mi">1</span>
<a id="__codelineno-0-369" name="__codelineno-0-369"></a>                <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">downsample_size</span><span class="p">:</span>
<a id="__codelineno-0-370" name="__codelineno-0-370"></a>                    <span class="k">break</span>
<a id="__codelineno-0-371" name="__codelineno-0-371"></a>            <span class="k">if</span> <span class="n">new_count</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
<a id="__codelineno-0-372" name="__codelineno-0-372"></a>                <span class="n">new_counts_dict</span><span class="p">[</span><span class="n">index</span><span class="p">]</span><span class="o">=</span><span class="n">new_count</span>
<a id="__codelineno-0-373" name="__codelineno-0-373"></a>
<a id="__codelineno-0-374" name="__codelineno-0-374"></a>        <span class="c1"># filter clonoset for missed clones and set new clone counts</span>
<a id="__codelineno-0-375" name="__codelineno-0-375"></a>        <span class="p">(</span><span class="n">indices</span><span class="p">,</span><span class="n">counts</span><span class="p">)</span> <span class="o">=</span> <span class="nb">zip</span><span class="p">(</span><span class="o">*</span><span class="n">new_counts_dict</span><span class="o">.</span><span class="n">items</span><span class="p">())</span>
<a id="__codelineno-0-376" name="__codelineno-0-376"></a>        <span class="n">clonoset</span> <span class="o">=</span> <span class="n">clonoset</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">clonoset</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">indices</span><span class="p">)]</span>
<a id="__codelineno-0-377" name="__codelineno-0-377"></a>        <span class="n">clonoset</span><span class="p">[</span><span class="n">count_column</span><span class="p">]</span> <span class="o">=</span> <span class="n">counts</span>    
<a id="__codelineno-0-378" name="__codelineno-0-378"></a>        <span class="k">return</span> <span class="n">clonoset</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<a id="__codelineno-0-379" name="__codelineno-0-379"></a>
<a id="__codelineno-0-380" name="__codelineno-0-380"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_get_top</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">clonoset_in</span><span class="p">,</span> <span class="n">colnames</span><span class="p">):</span>
<a id="__codelineno-0-381" name="__codelineno-0-381"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-382" name="__codelineno-0-382"></a><span class="sd">        Takes top N biggest clones from the clonoset.</span>
<a id="__codelineno-0-383" name="__codelineno-0-383"></a>
<a id="__codelineno-0-384" name="__codelineno-0-384"></a><span class="sd">        Mix-tails is recommended for use, because the order of the clonotypes</span>
<a id="__codelineno-0-385" name="__codelineno-0-385"></a><span class="sd">        with equal count may not be independent from their other properties.</span>
<a id="__codelineno-0-386" name="__codelineno-0-386"></a><span class="sd">        This option mixes up the order of all clonotypes in clonoset and then</span>
<a id="__codelineno-0-387" name="__codelineno-0-387"></a><span class="sd">        sorts them by count in decreasing order, so that clonotypes with the same</span>
<a id="__codelineno-0-388" name="__codelineno-0-388"></a><span class="sd">        count not have completely random order. Also use seed option for reproducibility</span>
<a id="__codelineno-0-389" name="__codelineno-0-389"></a><span class="sd">        of the results.</span>
<a id="__codelineno-0-390" name="__codelineno-0-390"></a>
<a id="__codelineno-0-391" name="__codelineno-0-391"></a><span class="sd">        Raises:</span>
<a id="__codelineno-0-392" name="__codelineno-0-392"></a><span class="sd">            ValueError: if clone count is less then required top</span>
<a id="__codelineno-0-393" name="__codelineno-0-393"></a><span class="sd">        &quot;&quot;&quot;</span>
<a id="__codelineno-0-394" name="__codelineno-0-394"></a>
<a id="__codelineno-0-395" name="__codelineno-0-395"></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">top</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-396" name="__codelineno-0-396"></a>            <span class="k">return</span> <span class="n">clonoset_in</span>
<a id="__codelineno-0-397" name="__codelineno-0-397"></a>
<a id="__codelineno-0-398" name="__codelineno-0-398"></a>        <span class="n">clonoset</span> <span class="o">=</span> <span class="n">clonoset_in</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
<a id="__codelineno-0-399" name="__codelineno-0-399"></a>        <span class="n">count_column</span> <span class="o">=</span> <span class="n">colnames</span><span class="p">[</span><span class="s2">&quot;count_column&quot;</span><span class="p">]</span>
<a id="__codelineno-0-400" name="__codelineno-0-400"></a>
<a id="__codelineno-0-401" name="__codelineno-0-401"></a>        <span class="c1">#shuffle the order of clonotypes if required</span>
<a id="__codelineno-0-402" name="__codelineno-0-402"></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">seed</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-403" name="__codelineno-0-403"></a>            <span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">seed</span><span class="p">)</span>
<a id="__codelineno-0-404" name="__codelineno-0-404"></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">mix_tails</span><span class="p">:</span>
<a id="__codelineno-0-405" name="__codelineno-0-405"></a>            <span class="n">index_order</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">clonoset</span><span class="o">.</span><span class="n">index</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">clonoset</span><span class="p">))</span>
<a id="__codelineno-0-406" name="__codelineno-0-406"></a>            <span class="n">clonoset</span> <span class="o">=</span> <span class="n">clonoset</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">index_order</span><span class="p">]</span> 
<a id="__codelineno-0-407" name="__codelineno-0-407"></a>            <span class="n">clonoset</span> <span class="o">=</span> <span class="n">clonoset</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="n">count_column</span><span class="p">,</span> <span class="n">ascending</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<a id="__codelineno-0-408" name="__codelineno-0-408"></a>
<a id="__codelineno-0-409" name="__codelineno-0-409"></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">top</span> <span class="o">&gt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">clonoset</span><span class="p">):</span>
<a id="__codelineno-0-410" name="__codelineno-0-410"></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ignore_small_clonosets</span><span class="p">:</span>
<a id="__codelineno-0-411" name="__codelineno-0-411"></a>                <span class="k">return</span> <span class="n">clonoset</span>
<a id="__codelineno-0-412" name="__codelineno-0-412"></a>            <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-413" name="__codelineno-0-413"></a>                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Warning! Clonoset size - </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">clonoset</span><span class="p">)</span><span class="si">}</span><span class="s2"> - is less than required top - </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">top</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-0-414" name="__codelineno-0-414"></a>
<a id="__codelineno-0-415" name="__codelineno-0-415"></a>        <span class="c1"># take top</span>
<a id="__codelineno-0-416" name="__codelineno-0-416"></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">top</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
<a id="__codelineno-0-417" name="__codelineno-0-417"></a>            <span class="n">clonoset</span><span class="o">=</span><span class="n">clonoset</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:</span><span class="bp">self</span><span class="o">.</span><span class="n">top</span><span class="p">]</span>
<a id="__codelineno-0-418" name="__codelineno-0-418"></a>
<a id="__codelineno-0-419" name="__codelineno-0-419"></a>        <span class="k">return</span> <span class="n">clonoset</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<a id="__codelineno-0-420" name="__codelineno-0-420"></a>
<a id="__codelineno-0-421" name="__codelineno-0-421"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_filter_by_functionality</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">clonoset_in</span><span class="p">,</span> <span class="n">colnames</span><span class="p">):</span>
<a id="__codelineno-0-422" name="__codelineno-0-422"></a>        <span class="n">clonoset</span> <span class="o">=</span> <span class="n">clonoset_in</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
<a id="__codelineno-0-423" name="__codelineno-0-423"></a>
<a id="__codelineno-0-424" name="__codelineno-0-424"></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">functionality</span> <span class="o">==</span> <span class="s2">&quot;f&quot;</span><span class="p">:</span>
<a id="__codelineno-0-425" name="__codelineno-0-425"></a>            <span class="n">clonoset</span> <span class="o">=</span> <span class="n">filter_by_functionality</span><span class="p">(</span><span class="n">clonoset</span><span class="p">,</span> <span class="n">colnames</span><span class="o">=</span><span class="n">colnames</span><span class="p">,</span> <span class="n">functional</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<a id="__codelineno-0-426" name="__codelineno-0-426"></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">functionality</span> <span class="o">==</span> <span class="s2">&quot;n&quot;</span><span class="p">:</span>
<a id="__codelineno-0-427" name="__codelineno-0-427"></a>            <span class="n">clonoset</span> <span class="o">=</span> <span class="n">filter_by_functionality</span><span class="p">(</span><span class="n">clonoset</span><span class="p">,</span> <span class="n">colnames</span><span class="o">=</span><span class="n">colnames</span><span class="p">,</span> <span class="n">functional</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<a id="__codelineno-0-428" name="__codelineno-0-428"></a>
<a id="__codelineno-0-429" name="__codelineno-0-429"></a>        <span class="k">return</span> <span class="n">clonoset</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<a id="__codelineno-0-430" name="__codelineno-0-430"></a>
<a id="__codelineno-0-431" name="__codelineno-0-431"></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a id="__codelineno-0-432" name="__codelineno-0-432"></a>
<a id="__codelineno-0-433" name="__codelineno-0-433"></a>        <span class="n">functionality</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;a&quot;</span><span class="p">:</span> <span class="s2">&quot;any&quot;</span><span class="p">,</span>
<a id="__codelineno-0-434" name="__codelineno-0-434"></a>                         <span class="s2">&quot;f&quot;</span><span class="p">:</span> <span class="s2">&quot;only functional clones (no frameshifts and Stops)&quot;</span><span class="p">,</span>
<a id="__codelineno-0-435" name="__codelineno-0-435"></a>                         <span class="s2">&quot;n&quot;</span><span class="p">:</span> <span class="s2">&quot;only non-functional&quot;</span><span class="p">}</span>
<a id="__codelineno-0-436" name="__codelineno-0-436"></a>        <span class="n">output</span>  <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Filter name:</span><span class="se">\t</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
<a id="__codelineno-0-437" name="__codelineno-0-437"></a>        <span class="n">output</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;Functionality:</span><span class="se">\t</span><span class="si">{</span><span class="n">functionality</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">functionality</span><span class="p">]</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
<a id="__codelineno-0-438" name="__codelineno-0-438"></a>        <span class="n">random</span> <span class="o">=</span> <span class="kc">False</span>
<a id="__codelineno-0-439" name="__codelineno-0-439"></a>        <span class="n">change_size</span> <span class="o">=</span> <span class="kc">False</span>
<a id="__codelineno-0-440" name="__codelineno-0-440"></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">functionality</span> <span class="o">!=</span> <span class="s2">&quot;a&quot;</span><span class="p">:</span>
<a id="__codelineno-0-441" name="__codelineno-0-441"></a>            <span class="n">change_size</span> <span class="o">=</span> <span class="kc">True</span>
<a id="__codelineno-0-442" name="__codelineno-0-442"></a>        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">count_threshold</span><span class="p">,</span> <span class="nb">int</span><span class="p">):</span>
<a id="__codelineno-0-443" name="__codelineno-0-443"></a>            <span class="n">output</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;Count threshold:</span><span class="se">\t</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">count_threshold</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
<a id="__codelineno-0-444" name="__codelineno-0-444"></a>            <span class="n">change_size</span> <span class="o">=</span> <span class="kc">True</span>
<a id="__codelineno-0-445" name="__codelineno-0-445"></a>        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">downsample_size</span><span class="p">,</span> <span class="nb">int</span><span class="p">):</span>
<a id="__codelineno-0-446" name="__codelineno-0-446"></a>            <span class="n">output</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;Downsample size:</span><span class="se">\t</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">downsample_size</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
<a id="__codelineno-0-447" name="__codelineno-0-447"></a>            <span class="n">random</span> <span class="o">=</span> <span class="kc">True</span>
<a id="__codelineno-0-448" name="__codelineno-0-448"></a>            <span class="n">change_size</span> <span class="o">=</span> <span class="kc">True</span>
<a id="__codelineno-0-449" name="__codelineno-0-449"></a>        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">top</span><span class="p">,</span> <span class="nb">int</span><span class="p">):</span>
<a id="__codelineno-0-450" name="__codelineno-0-450"></a>            <span class="n">output</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;Take top:</span><span class="se">\t</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">top</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
<a id="__codelineno-0-451" name="__codelineno-0-451"></a>            <span class="n">change_size</span> <span class="o">=</span> <span class="kc">True</span>
<a id="__codelineno-0-452" name="__codelineno-0-452"></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">mix_tails</span><span class="p">:</span>
<a id="__codelineno-0-453" name="__codelineno-0-453"></a>                <span class="n">random</span> <span class="o">=</span> <span class="kc">True</span>
<a id="__codelineno-0-454" name="__codelineno-0-454"></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">unweight</span><span class="p">:</span>
<a id="__codelineno-0-455" name="__codelineno-0-455"></a>            <span class="n">output</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;Clone size unweighted (all clone counts = 1)&quot;</span>
<a id="__codelineno-0-456" name="__codelineno-0-456"></a>
<a id="__codelineno-0-457" name="__codelineno-0-457"></a>        <span class="k">if</span> <span class="n">change_size</span><span class="p">:</span>
<a id="__codelineno-0-458" name="__codelineno-0-458"></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">by_umi</span><span class="p">:</span>
<a id="__codelineno-0-459" name="__codelineno-0-459"></a>                <span class="n">output</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;Count by:</span><span class="se">\t</span><span class="s2"> UMI (if exist)</span><span class="se">\n</span><span class="s2">&quot;</span>
<a id="__codelineno-0-460" name="__codelineno-0-460"></a>            <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-461" name="__codelineno-0-461"></a>                <span class="n">output</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;Count by:</span><span class="se">\t</span><span class="s2"> reads/counts</span><span class="se">\n</span><span class="s2">&quot;</span>
<a id="__codelineno-0-462" name="__codelineno-0-462"></a>        <span class="k">if</span> <span class="n">random</span><span class="p">:</span>
<a id="__codelineno-0-463" name="__codelineno-0-463"></a>            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">seed</span><span class="p">,</span> <span class="nb">int</span><span class="p">):</span>
<a id="__codelineno-0-464" name="__codelineno-0-464"></a>                <span class="n">output</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;Seed for random:</span><span class="se">\t</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">seed</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
<a id="__codelineno-0-465" name="__codelineno-0-465"></a>            <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-466" name="__codelineno-0-466"></a>                <span class="n">output</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;Seed for random:</span><span class="se">\t</span><span class="s2">unset</span><span class="se">\n</span><span class="s2">&quot;</span>
<a id="__codelineno-0-467" name="__codelineno-0-467"></a>                <span class="n">output</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;Warning: filter contains random events.</span><span class="se">\n</span><span class="s2">To obtain reproducible results, set seed in calcutations or manually (random.seed(some_int))</span><span class="se">\n</span><span class="s2">prior to applying the filter.</span><span class="se">\n</span><span class="s2">Note only seed that is set as this object parameter will work for mix_tails</span><span class="se">\n</span><span class="s2">&quot;</span>
<a id="__codelineno-0-468" name="__codelineno-0-468"></a>
<a id="__codelineno-0-469" name="__codelineno-0-469"></a>        <span class="k">return</span> <span class="n">output</span>
<a id="__codelineno-0-470" name="__codelineno-0-470"></a>
<a id="__codelineno-0-471" name="__codelineno-0-471"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_pool_clonoset</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">clonoset_in</span><span class="p">,</span> <span class="n">colnames</span><span class="p">):</span>
<a id="__codelineno-0-472" name="__codelineno-0-472"></a>        <span class="c1"># copy clonoset and sort by clone counts and reset index for order</span>
<a id="__codelineno-0-473" name="__codelineno-0-473"></a>        <span class="n">clonoset</span> <span class="o">=</span> <span class="n">clonoset_in</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="n">colnames</span><span class="p">[</span><span class="s2">&quot;count_column&quot;</span><span class="p">],</span> <span class="n">ascending</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<a id="__codelineno-0-474" name="__codelineno-0-474"></a>
<a id="__codelineno-0-475" name="__codelineno-0-475"></a>        <span class="c1"># create list of pool columns</span>
<a id="__codelineno-0-476" name="__codelineno-0-476"></a>        <span class="n">aa</span><span class="p">,</span> <span class="n">check_v</span><span class="p">,</span> <span class="n">check_j</span> <span class="o">=</span> <span class="n">overlap_type_to_flags</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pool_by</span><span class="p">)</span>
<a id="__codelineno-0-477" name="__codelineno-0-477"></a>        <span class="n">columns_for_pool</span> <span class="o">=</span> <span class="p">[]</span>
<a id="__codelineno-0-478" name="__codelineno-0-478"></a>        <span class="k">if</span> <span class="n">aa</span><span class="p">:</span>
<a id="__codelineno-0-479" name="__codelineno-0-479"></a>            <span class="n">columns_for_pool</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">colnames</span><span class="p">[</span><span class="s2">&quot;cdr3aa_column&quot;</span><span class="p">])</span>
<a id="__codelineno-0-480" name="__codelineno-0-480"></a>        <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-481" name="__codelineno-0-481"></a>            <span class="n">columns_for_pool</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">colnames</span><span class="p">[</span><span class="s2">&quot;cdr3nt_column&quot;</span><span class="p">])</span>
<a id="__codelineno-0-482" name="__codelineno-0-482"></a>        <span class="k">if</span> <span class="n">check_v</span><span class="p">:</span>
<a id="__codelineno-0-483" name="__codelineno-0-483"></a>            <span class="n">columns_for_pool</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">colnames</span><span class="p">[</span><span class="s2">&quot;v_column&quot;</span><span class="p">])</span>
<a id="__codelineno-0-484" name="__codelineno-0-484"></a>        <span class="k">if</span> <span class="n">check_j</span><span class="p">:</span>
<a id="__codelineno-0-485" name="__codelineno-0-485"></a>            <span class="n">columns_for_pool</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">colnames</span><span class="p">[</span><span class="s2">&quot;j_column&quot;</span><span class="p">])</span>
<a id="__codelineno-0-486" name="__codelineno-0-486"></a>
<a id="__codelineno-0-487" name="__codelineno-0-487"></a>        <span class="c1"># create column combining all pool columns</span>
<a id="__codelineno-0-488" name="__codelineno-0-488"></a>        <span class="n">clonoset</span><span class="p">[</span><span class="s2">&quot;pool_id&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">clonoset</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="s2">&quot;|&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">x</span><span class="p">[</span><span class="n">colname</span><span class="p">]</span> <span class="k">for</span> <span class="n">colname</span> <span class="ow">in</span> <span class="n">columns_for_pool</span><span class="p">]),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<a id="__codelineno-0-489" name="__codelineno-0-489"></a>
<a id="__codelineno-0-490" name="__codelineno-0-490"></a>        <span class="n">indices_to_retain</span> <span class="o">=</span> <span class="p">[]</span>
<a id="__codelineno-0-491" name="__codelineno-0-491"></a>
<a id="__codelineno-0-492" name="__codelineno-0-492"></a>        <span class="k">for</span> <span class="n">pool_id</span> <span class="ow">in</span> <span class="n">clonoset</span><span class="p">[</span><span class="s2">&quot;pool_id&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">():</span>
<a id="__codelineno-0-493" name="__codelineno-0-493"></a>            <span class="n">pool_clonoset</span> <span class="o">=</span> <span class="n">clonoset</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">clonoset</span><span class="p">[</span><span class="s2">&quot;pool_id&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">pool_id</span><span class="p">]</span>
<a id="__codelineno-0-494" name="__codelineno-0-494"></a>
<a id="__codelineno-0-495" name="__codelineno-0-495"></a>            <span class="c1"># select the clone with biggest count - it will represent pooled clonotypes by</span>
<a id="__codelineno-0-496" name="__codelineno-0-496"></a>            <span class="c1"># columns other that count and freq</span>
<a id="__codelineno-0-497" name="__codelineno-0-497"></a>            <span class="n">top_index</span> <span class="o">=</span> <span class="n">pool_clonoset</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<a id="__codelineno-0-498" name="__codelineno-0-498"></a>            <span class="n">indices_to_retain</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">top_index</span><span class="p">)</span>
<a id="__codelineno-0-499" name="__codelineno-0-499"></a>
<a id="__codelineno-0-500" name="__codelineno-0-500"></a>            <span class="c1"># sum counts and fractions for pooled clonotypes</span>
<a id="__codelineno-0-501" name="__codelineno-0-501"></a>            <span class="n">clonoset</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">top_index</span><span class="p">,</span><span class="n">colnames</span><span class="p">[</span><span class="s2">&quot;count_column&quot;</span><span class="p">]]</span> <span class="o">=</span> <span class="n">pool_clonoset</span><span class="p">[</span><span class="n">colnames</span><span class="p">[</span><span class="s2">&quot;count_column&quot;</span><span class="p">]]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
<a id="__codelineno-0-502" name="__codelineno-0-502"></a>            <span class="n">clonoset</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">top_index</span><span class="p">,</span><span class="n">colnames</span><span class="p">[</span><span class="s2">&quot;fraction_column&quot;</span><span class="p">]]</span> <span class="o">=</span> <span class="n">pool_clonoset</span><span class="p">[</span><span class="n">colnames</span><span class="p">[</span><span class="s2">&quot;fraction_column&quot;</span><span class="p">]]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
<a id="__codelineno-0-503" name="__codelineno-0-503"></a>
<a id="__codelineno-0-504" name="__codelineno-0-504"></a>        <span class="c1"># retain only rows with representative clonotypes and remove technical column</span>
<a id="__codelineno-0-505" name="__codelineno-0-505"></a>        <span class="n">clonoset</span> <span class="o">=</span> <span class="n">clonoset</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">indices_to_retain</span><span class="p">]</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;pool_id&quot;</span><span class="p">])</span>
<a id="__codelineno-0-506" name="__codelineno-0-506"></a>
<a id="__codelineno-0-507" name="__codelineno-0-507"></a>        <span class="k">return</span> <span class="n">clonoset</span>
<a id="__codelineno-0-508" name="__codelineno-0-508"></a>
<a id="__codelineno-0-509" name="__codelineno-0-509"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_filter_clonotypes</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">clonoset_in</span><span class="p">,</span> <span class="n">list_type</span><span class="p">):</span>
<a id="__codelineno-0-510" name="__codelineno-0-510"></a>        <span class="k">if</span> <span class="n">list_type</span> <span class="o">==</span> <span class="s2">&quot;white&quot;</span><span class="p">:</span>
<a id="__codelineno-0-511" name="__codelineno-0-511"></a>            <span class="n">clonotypes_list</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">white_list</span>
<a id="__codelineno-0-512" name="__codelineno-0-512"></a>        <span class="k">elif</span> <span class="n">list_type</span> <span class="o">==</span> <span class="s2">&quot;black&quot;</span><span class="p">:</span>
<a id="__codelineno-0-513" name="__codelineno-0-513"></a>            <span class="n">clonotypes_list</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">black_list</span>
<a id="__codelineno-0-514" name="__codelineno-0-514"></a>        <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-515" name="__codelineno-0-515"></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;list_type must be &#39;white&#39; or &#39;black&#39;&quot;</span><span class="p">)</span>
<a id="__codelineno-0-516" name="__codelineno-0-516"></a>
<a id="__codelineno-0-517" name="__codelineno-0-517"></a>        <span class="n">clonoset</span> <span class="o">=</span> <span class="n">clonoset_in</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
<a id="__codelineno-0-518" name="__codelineno-0-518"></a>
<a id="__codelineno-0-519" name="__codelineno-0-519"></a>        <span class="n">clonoset</span><span class="p">[</span><span class="s2">&quot;filter_pass&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">clonoset</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_compare_clonoset_list_row_with_clonotype</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">clonotypes_list</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<a id="__codelineno-0-520" name="__codelineno-0-520"></a>        <span class="k">if</span> <span class="n">list_type</span> <span class="o">==</span> <span class="s2">&quot;white&quot;</span><span class="p">:</span>
<a id="__codelineno-0-521" name="__codelineno-0-521"></a>            <span class="n">clonoset</span> <span class="o">=</span> <span class="n">clonoset</span><span class="p">[</span><span class="n">clonoset</span><span class="p">[</span><span class="s2">&quot;filter_pass&quot;</span><span class="p">]]</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;filter_pass&quot;</span><span class="p">])</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<a id="__codelineno-0-522" name="__codelineno-0-522"></a>        <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-523" name="__codelineno-0-523"></a>            <span class="n">clonoset</span> <span class="o">=</span> <span class="n">clonoset</span><span class="p">[</span><span class="o">~</span><span class="n">clonoset</span><span class="p">[</span><span class="s2">&quot;filter_pass&quot;</span><span class="p">]]</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;filter_pass&quot;</span><span class="p">])</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<a id="__codelineno-0-524" name="__codelineno-0-524"></a>        <span class="k">return</span> <span class="n">clonoset</span>
<a id="__codelineno-0-525" name="__codelineno-0-525"></a>
<a id="__codelineno-0-526" name="__codelineno-0-526"></a>
<a id="__codelineno-0-527" name="__codelineno-0-527"></a><span class="c1"># def convert_clonoset_to_clonotype_filter_list(clonoset_df, overlap_type=&quot;aaVJ&quot;):</span>
<a id="__codelineno-0-528" name="__codelineno-0-528"></a><span class="c1">#     clonotypes_list = []</span>
<a id="__codelineno-0-529" name="__codelineno-0-529"></a><span class="c1">#     aa, include_v, include_j = intersections.overlap_type_to_flags(overlap_type)</span>
<a id="__codelineno-0-530" name="__codelineno-0-530"></a><span class="c1">#     for i,r in clonoset_df.iterrows():</span>
<a id="__codelineno-0-531" name="__codelineno-0-531"></a><span class="c1">#         clonotype = []</span>
<a id="__codelineno-0-532" name="__codelineno-0-532"></a><span class="c1">#         if aa:</span>
<a id="__codelineno-0-533" name="__codelineno-0-533"></a><span class="c1">#             clonotype.append(row[&quot;cdr3aa&quot;])</span>
<a id="__codelineno-0-534" name="__codelineno-0-534"></a><span class="c1">#         else:</span>
<a id="__codelineno-0-535" name="__codelineno-0-535"></a><span class="c1">#             clonotype.append(row[&quot;cdr3nt&quot;])</span>
<a id="__codelineno-0-536" name="__codelineno-0-536"></a><span class="c1">#         if include_v:</span>
<a id="__codelineno-0-537" name="__codelineno-0-537"></a><span class="c1">#             clonotype.append(row[&quot;v&quot;])</span>
<a id="__codelineno-0-538" name="__codelineno-0-538"></a><span class="c1">#         if include_j:</span>
<a id="__codelineno-0-539" name="__codelineno-0-539"></a><span class="c1">#             clonotype.append(row[&quot;j&quot;])</span>
<a id="__codelineno-0-540" name="__codelineno-0-540"></a>
<a id="__codelineno-0-541" name="__codelineno-0-541"></a><span class="c1">#         clonotype = tuple(clonotype)</span>
<a id="__codelineno-0-542" name="__codelineno-0-542"></a><span class="c1">#         clonotypes_list.append(clonotype)</span>
<a id="__codelineno-0-543" name="__codelineno-0-543"></a><span class="c1">#     return clonotypes_list</span>
<a id="__codelineno-0-544" name="__codelineno-0-544"></a>
<a id="__codelineno-0-545" name="__codelineno-0-545"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_compare_clonoset_row_with_clonotype</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">row</span><span class="p">,</span> <span class="n">clonotype</span><span class="p">):</span>
<a id="__codelineno-0-546" name="__codelineno-0-546"></a>        <span class="n">c_len</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">clonotype</span><span class="p">)</span>
<a id="__codelineno-0-547" name="__codelineno-0-547"></a>        <span class="k">if</span> <span class="n">c_len</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
<a id="__codelineno-0-548" name="__codelineno-0-548"></a>            <span class="k">if</span> <span class="n">row</span><span class="p">[</span><span class="s2">&quot;cdr3aa&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">clonotype</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
<a id="__codelineno-0-549" name="__codelineno-0-549"></a>                <span class="k">return</span> <span class="kc">True</span>
<a id="__codelineno-0-550" name="__codelineno-0-550"></a>        <span class="k">elif</span> <span class="n">c_len</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
<a id="__codelineno-0-551" name="__codelineno-0-551"></a>            <span class="k">if</span> <span class="n">row</span><span class="p">[</span><span class="s2">&quot;cdr3aa&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">clonotype</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">and</span> <span class="n">row</span><span class="p">[</span><span class="s2">&quot;v&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">clonotype</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span>
<a id="__codelineno-0-552" name="__codelineno-0-552"></a>                <span class="k">return</span> <span class="kc">True</span>
<a id="__codelineno-0-553" name="__codelineno-0-553"></a>        <span class="k">elif</span> <span class="n">c_len</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
<a id="__codelineno-0-554" name="__codelineno-0-554"></a>            <span class="k">if</span> <span class="n">row</span><span class="p">[</span><span class="s2">&quot;cdr3aa&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">clonotype</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">and</span> <span class="n">row</span><span class="p">[</span><span class="s2">&quot;v&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">clonotype</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="ow">and</span> <span class="n">row</span><span class="p">[</span><span class="s2">&quot;j&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">clonotype</span><span class="p">[</span><span class="mi">2</span><span class="p">]:</span>
<a id="__codelineno-0-555" name="__codelineno-0-555"></a>                <span class="k">return</span> <span class="kc">True</span>
<a id="__codelineno-0-556" name="__codelineno-0-556"></a>        <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-557" name="__codelineno-0-557"></a>            <span class="c1"># need to write better explanation for error</span>
<a id="__codelineno-0-558" name="__codelineno-0-558"></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;clonotypes must contain from 1 to 3 values&quot;</span><span class="p">)</span>
<a id="__codelineno-0-559" name="__codelineno-0-559"></a>
<a id="__codelineno-0-560" name="__codelineno-0-560"></a>        <span class="k">return</span> <span class="kc">False</span>
<a id="__codelineno-0-561" name="__codelineno-0-561"></a>
<a id="__codelineno-0-562" name="__codelineno-0-562"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_compare_clonoset_list_row_with_clonotype</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">row</span><span class="p">,</span> <span class="n">clonotypes_list</span><span class="p">):</span>
<a id="__codelineno-0-563" name="__codelineno-0-563"></a>        <span class="k">for</span> <span class="n">clonotype</span> <span class="ow">in</span> <span class="n">clonotypes_list</span><span class="p">:</span>
<a id="__codelineno-0-564" name="__codelineno-0-564"></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_compare_clonoset_row_with_clonotype</span><span class="p">(</span><span class="n">row</span><span class="p">,</span> <span class="n">clonotype</span><span class="p">):</span>
<a id="__codelineno-0-565" name="__codelineno-0-565"></a>                <span class="k">return</span> <span class="kc">True</span>
<a id="__codelineno-0-566" name="__codelineno-0-566"></a>        <span class="k">return</span> <span class="kc">False</span>
<a id="__codelineno-0-567" name="__codelineno-0-567"></a>
<a id="__codelineno-0-568" name="__codelineno-0-568"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">is_empty</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a id="__codelineno-0-569" name="__codelineno-0-569"></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">functionality</span> <span class="o">==</span> <span class="s2">&quot;a&quot;</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">downsample_size</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">top</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">count_threshold</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">unweight</span>
<a id="__codelineno-0-570" name="__codelineno-0-570"></a>
<a id="__codelineno-0-571" name="__codelineno-0-571"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_repr_html_</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a id="__codelineno-0-572" name="__codelineno-0-572"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-573" name="__codelineno-0-573"></a><span class="sd">        function for printing the Filter properties to Jupyter output</span>
<a id="__codelineno-0-574" name="__codelineno-0-574"></a><span class="sd">        &quot;&quot;&quot;</span>
<a id="__codelineno-0-575" name="__codelineno-0-575"></a>
<a id="__codelineno-0-576" name="__codelineno-0-576"></a>        <span class="n">functionality</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;a&quot;</span><span class="p">:</span> <span class="s2">&quot;any&quot;</span><span class="p">,</span>
<a id="__codelineno-0-577" name="__codelineno-0-577"></a>                         <span class="s2">&quot;f&quot;</span><span class="p">:</span> <span class="s2">&quot;only functional clones (no frameshifts and Stops)&quot;</span><span class="p">,</span>
<a id="__codelineno-0-578" name="__codelineno-0-578"></a>                         <span class="s2">&quot;n&quot;</span><span class="p">:</span> <span class="s2">&quot;only non-functional&quot;</span><span class="p">}</span>
<a id="__codelineno-0-579" name="__codelineno-0-579"></a>        <span class="n">output</span>  <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;&lt;p&gt;Filter name: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&lt;/p&gt;&quot;</span>
<a id="__codelineno-0-580" name="__codelineno-0-580"></a>        <span class="n">output</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;&lt;p&gt;Functionality:</span><span class="se">\t</span><span class="si">{</span><span class="n">functionality</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">functionality</span><span class="p">]</span><span class="si">}</span><span class="s2">&lt;/p&gt;&quot;</span>
<a id="__codelineno-0-581" name="__codelineno-0-581"></a>        <span class="n">random</span> <span class="o">=</span> <span class="kc">False</span>
<a id="__codelineno-0-582" name="__codelineno-0-582"></a>        <span class="n">change_size</span> <span class="o">=</span> <span class="kc">False</span>
<a id="__codelineno-0-583" name="__codelineno-0-583"></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">functionality</span> <span class="o">!=</span> <span class="s2">&quot;a&quot;</span><span class="p">:</span>
<a id="__codelineno-0-584" name="__codelineno-0-584"></a>            <span class="n">change_size</span> <span class="o">=</span> <span class="kc">True</span>
<a id="__codelineno-0-585" name="__codelineno-0-585"></a>        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">count_threshold</span><span class="p">,</span> <span class="nb">int</span><span class="p">):</span>
<a id="__codelineno-0-586" name="__codelineno-0-586"></a>            <span class="n">output</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;&lt;p&gt;Count threshold: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">count_threshold</span><span class="si">}</span><span class="s2">&lt;/p&gt;&quot;</span>
<a id="__codelineno-0-587" name="__codelineno-0-587"></a>            <span class="n">change_size</span> <span class="o">=</span> <span class="kc">True</span>
<a id="__codelineno-0-588" name="__codelineno-0-588"></a>        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">downsample_size</span><span class="p">,</span> <span class="nb">int</span><span class="p">):</span>
<a id="__codelineno-0-589" name="__codelineno-0-589"></a>            <span class="n">output</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;&lt;p&gt;Downsample size: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">downsample_size</span><span class="si">}</span><span class="s2">&lt;/p&gt;&quot;</span>
<a id="__codelineno-0-590" name="__codelineno-0-590"></a>            <span class="n">random</span> <span class="o">=</span> <span class="kc">True</span>
<a id="__codelineno-0-591" name="__codelineno-0-591"></a>            <span class="n">change_size</span> <span class="o">=</span> <span class="kc">True</span>
<a id="__codelineno-0-592" name="__codelineno-0-592"></a>        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">top</span><span class="p">,</span> <span class="nb">int</span><span class="p">):</span>
<a id="__codelineno-0-593" name="__codelineno-0-593"></a>            <span class="n">output</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;&lt;p&gt;Take top: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">top</span><span class="si">}</span><span class="s2">&lt;/p&gt;&quot;</span>
<a id="__codelineno-0-594" name="__codelineno-0-594"></a>            <span class="n">change_size</span> <span class="o">=</span> <span class="kc">True</span>
<a id="__codelineno-0-595" name="__codelineno-0-595"></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">mix_tails</span><span class="p">:</span>
<a id="__codelineno-0-596" name="__codelineno-0-596"></a>                <span class="n">random</span> <span class="o">=</span> <span class="kc">True</span>
<a id="__codelineno-0-597" name="__codelineno-0-597"></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">unweight</span><span class="p">:</span>
<a id="__codelineno-0-598" name="__codelineno-0-598"></a>            <span class="n">output</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;&lt;p&gt;Clone size unweighted: (all clone counts = 1)&lt;/p&gt;&quot;</span>
<a id="__codelineno-0-599" name="__codelineno-0-599"></a>
<a id="__codelineno-0-600" name="__codelineno-0-600"></a>        <span class="k">if</span> <span class="n">change_size</span><span class="p">:</span>
<a id="__codelineno-0-601" name="__codelineno-0-601"></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">by_umi</span><span class="p">:</span>
<a id="__codelineno-0-602" name="__codelineno-0-602"></a>                <span class="n">output</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;&lt;p&gt;Count by:  UMI (if exist)&lt;/p&gt;&quot;</span>
<a id="__codelineno-0-603" name="__codelineno-0-603"></a>            <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-604" name="__codelineno-0-604"></a>                <span class="n">output</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;&lt;p&gt;Count by: reads/counts&lt;/p&gt;&quot;</span>
<a id="__codelineno-0-605" name="__codelineno-0-605"></a>        <span class="k">if</span> <span class="n">random</span><span class="p">:</span>
<a id="__codelineno-0-606" name="__codelineno-0-606"></a>            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">seed</span><span class="p">,</span> <span class="nb">int</span><span class="p">):</span>
<a id="__codelineno-0-607" name="__codelineno-0-607"></a>                <span class="n">output</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;&lt;p&gt;Seed for random: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">seed</span><span class="si">}</span><span class="s2">&lt;/p&gt;&quot;</span>
<a id="__codelineno-0-608" name="__codelineno-0-608"></a>            <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-609" name="__codelineno-0-609"></a>                <span class="n">output</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;&lt;p&gt;Seed for random:</span><span class="se">\t</span><span class="s2">unset&lt;/p&gt;&quot;</span>
<a id="__codelineno-0-610" name="__codelineno-0-610"></a>                <span class="n">output</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;&lt;p&gt;Warning: filter contains random events. To obtain reproducible results, set seed in calcutations or manually (random.seed(some_int)) prior to applying the filter. Note only seed that is set as this object parameter will work for mix_tails&lt;/p&gt;&quot;</span>
<a id="__codelineno-0-611" name="__codelineno-0-611"></a>
<a id="__codelineno-0-612" name="__codelineno-0-612"></a>        <span class="k">return</span> <span class="n">output</span>
</code></pre></div></td></tr></table></div>
              </details>



  <div class="doc doc-children">










<div class="doc doc-object doc-function">


<h5 id="clone_filter.Filter.apply" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">apply</span><span class="p">(</span><span class="n">input_clonoset</span><span class="p">,</span> <span class="n">colnames</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>

</h5>


    <div class="doc doc-contents ">

        <p>Main method of the Filter object - application of it to a clonoset</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>input_clonoset</code>
            </td>
            <td>
                  <code><span title="pd.DataFrame">DataFrame</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>clonoset in the form of Pandas DataFrame in
MiXCR(3 or 4+ version), VDJtools or Bioadaptive formats.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>colnames</code>
            </td>
            <td>
                  <code><span title="dict">dict</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Dictionary of available specific column names.
Defaults to None - colnames imputed automatically.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
<th>Name</th>          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
<td><code>clonoset</code></td>            <td>
                  <code><span title="pd.DataFrame">DataFrame</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>clonoset after converting to common (VDJtools-like)
format and applying functionality filtration and downsampling or taking top</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>repseq/clone_filter.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-96"> 96</a></span>
<span class="normal"><a href="#__codelineno-0-97"> 97</a></span>
<span class="normal"><a href="#__codelineno-0-98"> 98</a></span>
<span class="normal"><a href="#__codelineno-0-99"> 99</a></span>
<span class="normal"><a href="#__codelineno-0-100">100</a></span>
<span class="normal"><a href="#__codelineno-0-101">101</a></span>
<span class="normal"><a href="#__codelineno-0-102">102</a></span>
<span class="normal"><a href="#__codelineno-0-103">103</a></span>
<span class="normal"><a href="#__codelineno-0-104">104</a></span>
<span class="normal"><a href="#__codelineno-0-105">105</a></span>
<span class="normal"><a href="#__codelineno-0-106">106</a></span>
<span class="normal"><a href="#__codelineno-0-107">107</a></span>
<span class="normal"><a href="#__codelineno-0-108">108</a></span>
<span class="normal"><a href="#__codelineno-0-109">109</a></span>
<span class="normal"><a href="#__codelineno-0-110">110</a></span>
<span class="normal"><a href="#__codelineno-0-111">111</a></span>
<span class="normal"><a href="#__codelineno-0-112">112</a></span>
<span class="normal"><a href="#__codelineno-0-113">113</a></span>
<span class="normal"><a href="#__codelineno-0-114">114</a></span>
<span class="normal"><a href="#__codelineno-0-115">115</a></span>
<span class="normal"><a href="#__codelineno-0-116">116</a></span>
<span class="normal"><a href="#__codelineno-0-117">117</a></span>
<span class="normal"><a href="#__codelineno-0-118">118</a></span>
<span class="normal"><a href="#__codelineno-0-119">119</a></span>
<span class="normal"><a href="#__codelineno-0-120">120</a></span>
<span class="normal"><a href="#__codelineno-0-121">121</a></span>
<span class="normal"><a href="#__codelineno-0-122">122</a></span>
<span class="normal"><a href="#__codelineno-0-123">123</a></span>
<span class="normal"><a href="#__codelineno-0-124">124</a></span>
<span class="normal"><a href="#__codelineno-0-125">125</a></span>
<span class="normal"><a href="#__codelineno-0-126">126</a></span>
<span class="normal"><a href="#__codelineno-0-127">127</a></span>
<span class="normal"><a href="#__codelineno-0-128">128</a></span>
<span class="normal"><a href="#__codelineno-0-129">129</a></span>
<span class="normal"><a href="#__codelineno-0-130">130</a></span>
<span class="normal"><a href="#__codelineno-0-131">131</a></span>
<span class="normal"><a href="#__codelineno-0-132">132</a></span>
<span class="normal"><a href="#__codelineno-0-133">133</a></span>
<span class="normal"><a href="#__codelineno-0-134">134</a></span>
<span class="normal"><a href="#__codelineno-0-135">135</a></span>
<span class="normal"><a href="#__codelineno-0-136">136</a></span>
<span class="normal"><a href="#__codelineno-0-137">137</a></span>
<span class="normal"><a href="#__codelineno-0-138">138</a></span>
<span class="normal"><a href="#__codelineno-0-139">139</a></span>
<span class="normal"><a href="#__codelineno-0-140">140</a></span>
<span class="normal"><a href="#__codelineno-0-141">141</a></span>
<span class="normal"><a href="#__codelineno-0-142">142</a></span>
<span class="normal"><a href="#__codelineno-0-143">143</a></span>
<span class="normal"><a href="#__codelineno-0-144">144</a></span>
<span class="normal"><a href="#__codelineno-0-145">145</a></span>
<span class="normal"><a href="#__codelineno-0-146">146</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-96" name="__codelineno-0-96"></a><span class="k">def</span><span class="w"> </span><span class="nf">apply</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">input_clonoset</span><span class="p">,</span> <span class="n">colnames</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<a id="__codelineno-0-97" name="__codelineno-0-97"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-98" name="__codelineno-0-98"></a><span class="sd">    Main method of the Filter object - application of it to a clonoset</span>
<a id="__codelineno-0-99" name="__codelineno-0-99"></a>
<a id="__codelineno-0-100" name="__codelineno-0-100"></a><span class="sd">    Args:</span>
<a id="__codelineno-0-101" name="__codelineno-0-101"></a><span class="sd">        input_clonoset (pd.DataFrame): clonoset in the form of Pandas DataFrame in</span>
<a id="__codelineno-0-102" name="__codelineno-0-102"></a><span class="sd">            MiXCR(3 or 4+ version), VDJtools or Bioadaptive formats.</span>
<a id="__codelineno-0-103" name="__codelineno-0-103"></a><span class="sd">        colnames (dict, optional): Dictionary of available specific column names.</span>
<a id="__codelineno-0-104" name="__codelineno-0-104"></a><span class="sd">            Defaults to None - colnames imputed automatically.</span>
<a id="__codelineno-0-105" name="__codelineno-0-105"></a>
<a id="__codelineno-0-106" name="__codelineno-0-106"></a><span class="sd">    Returns:</span>
<a id="__codelineno-0-107" name="__codelineno-0-107"></a><span class="sd">        clonoset (pd.DataFrame): clonoset after converting to common (VDJtools-like)</span>
<a id="__codelineno-0-108" name="__codelineno-0-108"></a><span class="sd">            format and applying functionality filtration and downsampling or taking top</span>
<a id="__codelineno-0-109" name="__codelineno-0-109"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-110" name="__codelineno-0-110"></a>
<a id="__codelineno-0-111" name="__codelineno-0-111"></a>    <span class="c1"># copy clonoset for not changing the original one</span>
<a id="__codelineno-0-112" name="__codelineno-0-112"></a>    <span class="n">clonoset</span> <span class="o">=</span> <span class="n">input_clonoset</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
<a id="__codelineno-0-113" name="__codelineno-0-113"></a>    <span class="k">if</span> <span class="n">colnames</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-114" name="__codelineno-0-114"></a>        <span class="n">colnames</span> <span class="o">=</span> <span class="n">get_column_names_from_clonoset</span><span class="p">(</span><span class="n">clonoset</span><span class="p">)</span>
<a id="__codelineno-0-115" name="__codelineno-0-115"></a>
<a id="__codelineno-0-116" name="__codelineno-0-116"></a>    <span class="c1"># create common columns: vdj-refPoints and VDJC-segments in common state</span>
<a id="__codelineno-0-117" name="__codelineno-0-117"></a>    <span class="n">clonoset</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_make_common_columns</span><span class="p">(</span><span class="n">clonoset</span><span class="p">,</span> <span class="n">colnames</span><span class="p">)</span>
<a id="__codelineno-0-118" name="__codelineno-0-118"></a>    <span class="n">colnames</span> <span class="o">=</span> <span class="n">get_column_names_from_clonoset</span><span class="p">(</span><span class="n">clonoset</span><span class="p">)</span>
<a id="__codelineno-0-119" name="__codelineno-0-119"></a>
<a id="__codelineno-0-120" name="__codelineno-0-120"></a>    <span class="c1"># converting to common VDJtools-like format and obtaining new colnames</span>
<a id="__codelineno-0-121" name="__codelineno-0-121"></a>    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">convert</span><span class="p">:</span>
<a id="__codelineno-0-122" name="__codelineno-0-122"></a>        <span class="n">clonoset</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_convert_clonoset</span><span class="p">(</span><span class="n">clonoset</span><span class="p">,</span> <span class="n">colnames</span><span class="p">)</span>
<a id="__codelineno-0-123" name="__codelineno-0-123"></a>        <span class="n">colnames</span> <span class="o">=</span> <span class="n">get_column_names_from_clonoset</span><span class="p">(</span><span class="n">clonoset</span><span class="p">)</span>
<a id="__codelineno-0-124" name="__codelineno-0-124"></a>
<a id="__codelineno-0-125" name="__codelineno-0-125"></a>    <span class="c1"># application of main filters</span>
<a id="__codelineno-0-126" name="__codelineno-0-126"></a>    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">functionality</span> <span class="o">!=</span> <span class="s2">&quot;a&quot;</span><span class="p">:</span>
<a id="__codelineno-0-127" name="__codelineno-0-127"></a>        <span class="n">clonoset</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_filter_by_functionality</span><span class="p">(</span><span class="n">clonoset</span><span class="p">,</span> <span class="n">colnames</span><span class="p">)</span>
<a id="__codelineno-0-128" name="__codelineno-0-128"></a>
<a id="__codelineno-0-129" name="__codelineno-0-129"></a>    <span class="n">clonoset</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_filter_by_count</span><span class="p">(</span><span class="n">clonoset</span><span class="p">,</span> <span class="n">colnames</span><span class="p">)</span>
<a id="__codelineno-0-130" name="__codelineno-0-130"></a>
<a id="__codelineno-0-131" name="__codelineno-0-131"></a>    <span class="n">clonoset</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_downsample</span><span class="p">(</span><span class="n">clonoset</span><span class="p">,</span> <span class="n">colnames</span><span class="p">)</span>
<a id="__codelineno-0-132" name="__codelineno-0-132"></a>    <span class="n">clonoset</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_top</span><span class="p">(</span><span class="n">clonoset</span><span class="p">,</span> <span class="n">colnames</span><span class="p">)</span>
<a id="__codelineno-0-133" name="__codelineno-0-133"></a>
<a id="__codelineno-0-134" name="__codelineno-0-134"></a>    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">unweight</span><span class="p">:</span>
<a id="__codelineno-0-135" name="__codelineno-0-135"></a>        <span class="n">clonoset</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_unweight</span><span class="p">(</span><span class="n">clonoset</span><span class="p">,</span> <span class="n">colnames</span><span class="p">)</span>
<a id="__codelineno-0-136" name="__codelineno-0-136"></a>    <span class="c1"># the fraction columns need to be recounted after filtering, as they</span>
<a id="__codelineno-0-137" name="__codelineno-0-137"></a>    <span class="c1"># remain the same as in the original clonoset before filtration</span>
<a id="__codelineno-0-138" name="__codelineno-0-138"></a>    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">recount_fractions</span><span class="p">:</span>
<a id="__codelineno-0-139" name="__codelineno-0-139"></a>        <span class="n">clonoset</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_recount_fractions_for_clonoset</span><span class="p">(</span><span class="n">clonoset</span><span class="p">,</span> <span class="n">colnames</span><span class="p">)</span>
<a id="__codelineno-0-140" name="__codelineno-0-140"></a>    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">pool_by</span><span class="p">:</span>
<a id="__codelineno-0-141" name="__codelineno-0-141"></a>        <span class="n">clonoset</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pool_clonoset</span><span class="p">(</span><span class="n">clonoset</span><span class="p">,</span> <span class="n">colnames</span><span class="p">)</span>
<a id="__codelineno-0-142" name="__codelineno-0-142"></a>    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">white_list</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
<a id="__codelineno-0-143" name="__codelineno-0-143"></a>        <span class="n">clonoset</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_filter_clonotypes</span><span class="p">(</span><span class="n">clonoset</span><span class="p">,</span> <span class="n">list_type</span><span class="o">=</span><span class="s2">&quot;white&quot;</span><span class="p">)</span>
<a id="__codelineno-0-144" name="__codelineno-0-144"></a>    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">black_list</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
<a id="__codelineno-0-145" name="__codelineno-0-145"></a>        <span class="n">clonoset</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_filter_clonotypes</span><span class="p">(</span><span class="n">clonoset</span><span class="p">,</span> <span class="n">list_type</span><span class="o">=</span><span class="s2">&quot;black&quot;</span><span class="p">)</span>
<a id="__codelineno-0-146" name="__codelineno-0-146"></a>    <span class="k">return</span> <span class="n">clonoset</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h5 id="clone_filter.Filter.spawn" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">spawn</span><span class="p">()</span></code>

</h5>


    <div class="doc doc-contents ">



    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>the copy of the filter. Necessary for parallel computing</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>repseq/clone_filter.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-78">78</a></span>
<span class="normal"><a href="#__codelineno-0-79">79</a></span>
<span class="normal"><a href="#__codelineno-0-80">80</a></span>
<span class="normal"><a href="#__codelineno-0-81">81</a></span>
<span class="normal"><a href="#__codelineno-0-82">82</a></span>
<span class="normal"><a href="#__codelineno-0-83">83</a></span>
<span class="normal"><a href="#__codelineno-0-84">84</a></span>
<span class="normal"><a href="#__codelineno-0-85">85</a></span>
<span class="normal"><a href="#__codelineno-0-86">86</a></span>
<span class="normal"><a href="#__codelineno-0-87">87</a></span>
<span class="normal"><a href="#__codelineno-0-88">88</a></span>
<span class="normal"><a href="#__codelineno-0-89">89</a></span>
<span class="normal"><a href="#__codelineno-0-90">90</a></span>
<span class="normal"><a href="#__codelineno-0-91">91</a></span>
<span class="normal"><a href="#__codelineno-0-92">92</a></span>
<span class="normal"><a href="#__codelineno-0-93">93</a></span>
<span class="normal"><a href="#__codelineno-0-94">94</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-78" name="__codelineno-0-78"></a><span class="k">def</span><span class="w"> </span><span class="nf">spawn</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a id="__codelineno-0-79" name="__codelineno-0-79"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-80" name="__codelineno-0-80"></a>
<a id="__codelineno-0-81" name="__codelineno-0-81"></a><span class="sd">    Returns:</span>
<a id="__codelineno-0-82" name="__codelineno-0-82"></a><span class="sd">        the copy of the filter. Necessary for parallel computing</span>
<a id="__codelineno-0-83" name="__codelineno-0-83"></a>
<a id="__codelineno-0-84" name="__codelineno-0-84"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-85" name="__codelineno-0-85"></a>    <span class="k">return</span> <span class="n">Filter</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">functionality</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">functionality</span><span class="p">,</span>
<a id="__codelineno-0-86" name="__codelineno-0-86"></a>                  <span class="n">downsample</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">downsample_size</span><span class="p">,</span> <span class="n">top</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">top</span><span class="p">,</span>
<a id="__codelineno-0-87" name="__codelineno-0-87"></a>                  <span class="n">by_umi</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">by_umi</span><span class="p">,</span> <span class="n">mix_tails</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">mix_tails</span><span class="p">,</span>
<a id="__codelineno-0-88" name="__codelineno-0-88"></a>                  <span class="n">count_threshold</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">count_threshold</span><span class="p">,</span> <span class="n">seed</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">seed</span><span class="p">,</span>
<a id="__codelineno-0-89" name="__codelineno-0-89"></a>                  <span class="n">unweight</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">unweight</span><span class="p">,</span>
<a id="__codelineno-0-90" name="__codelineno-0-90"></a>                  <span class="n">recount_fractions</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">recount_fractions</span><span class="p">,</span>
<a id="__codelineno-0-91" name="__codelineno-0-91"></a>                  <span class="n">white_list</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">white_list</span><span class="p">,</span>
<a id="__codelineno-0-92" name="__codelineno-0-92"></a>                  <span class="n">black_list</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">black_list</span><span class="p">,</span>
<a id="__codelineno-0-93" name="__codelineno-0-93"></a>                  <span class="n">ignore_small_clonosets</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">ignore_small_clonosets</span>
<a id="__codelineno-0-94" name="__codelineno-0-94"></a>                  <span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>




  </div>

    </div>

</div><h2 id="clonosets"><strong>clonosets</strong></h2>


<div class="doc doc-object doc-module">




    <div class="doc doc-contents first">










  <div class="doc doc-children">










<div class="doc doc-object doc-function">


<h4 id="clonosets.annotate_clonotypes_with_vdjdb" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">annotate_clonotypes_with_vdjdb</span><span class="p">(</span><span class="n">clonotypes_df</span><span class="p">,</span> <span class="n">drop_method</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">drop_meta</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">drop_cdr3fix</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span></code>

</h4>


    <div class="doc doc-contents ">

        <p>Uses entries from VDJdb database to annotate the clonotypes with the same V, J, and CDR3. In case of several matches,
the one with the highest vdjdb score is used.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>clonotypes_df</code>
            </td>
            <td>
                  <code><span title="pandas.DataFrame">DataFrame</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>A dataframe containing clonotypes. For instance, it can be made with 
<code>pool_clonotypes_from_clonosets_df</code> function from the Clustering module. </p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>drop_method</code>
            </td>
            <td>
                  <code><span title="bool">bool</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>if <code>True</code>, <code>Method</code> column is excluded from the annotation</p>
              </div>
            </td>
            <td>
                  <code>True</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>drop_meta</code>
            </td>
            <td>
                  <code><span title="bool">bool</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>if <code>True</code>, <code>Meta</code> column is excluded from the annotation</p>
              </div>
            </td>
            <td>
                  <code>True</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>drop_cdr3fix</code>
            </td>
            <td>
                  <code><span title="bool">bool</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>if <code>True</code>, <code>CDR3fix</code> column is excluded from the annotation</p>
              </div>
            </td>
            <td>
                  <code>True</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
<th>Name</th>          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
<td><code>annotated_clonotypes</code></td>            <td>
                  <code><span title="pandas.DataFrame">DataFrame</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>annotated clonotypes_df</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>repseq/clonosets.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-519">519</a></span>
<span class="normal"><a href="#__codelineno-0-520">520</a></span>
<span class="normal"><a href="#__codelineno-0-521">521</a></span>
<span class="normal"><a href="#__codelineno-0-522">522</a></span>
<span class="normal"><a href="#__codelineno-0-523">523</a></span>
<span class="normal"><a href="#__codelineno-0-524">524</a></span>
<span class="normal"><a href="#__codelineno-0-525">525</a></span>
<span class="normal"><a href="#__codelineno-0-526">526</a></span>
<span class="normal"><a href="#__codelineno-0-527">527</a></span>
<span class="normal"><a href="#__codelineno-0-528">528</a></span>
<span class="normal"><a href="#__codelineno-0-529">529</a></span>
<span class="normal"><a href="#__codelineno-0-530">530</a></span>
<span class="normal"><a href="#__codelineno-0-531">531</a></span>
<span class="normal"><a href="#__codelineno-0-532">532</a></span>
<span class="normal"><a href="#__codelineno-0-533">533</a></span>
<span class="normal"><a href="#__codelineno-0-534">534</a></span>
<span class="normal"><a href="#__codelineno-0-535">535</a></span>
<span class="normal"><a href="#__codelineno-0-536">536</a></span>
<span class="normal"><a href="#__codelineno-0-537">537</a></span>
<span class="normal"><a href="#__codelineno-0-538">538</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-519" name="__codelineno-0-519"></a><span class="k">def</span><span class="w"> </span><span class="nf">annotate_clonotypes_with_vdjdb</span><span class="p">(</span><span class="n">clonotypes_df</span><span class="p">,</span> <span class="n">drop_method</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">drop_meta</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">drop_cdr3fix</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
<a id="__codelineno-0-520" name="__codelineno-0-520"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-521" name="__codelineno-0-521"></a><span class="sd">    Uses entries from VDJdb database to annotate the clonotypes with the same V, J, and CDR3. In case of several matches,</span>
<a id="__codelineno-0-522" name="__codelineno-0-522"></a><span class="sd">    the one with the highest vdjdb score is used.</span>
<a id="__codelineno-0-523" name="__codelineno-0-523"></a>
<a id="__codelineno-0-524" name="__codelineno-0-524"></a><span class="sd">    Args:</span>
<a id="__codelineno-0-525" name="__codelineno-0-525"></a><span class="sd">        clonotypes_df (pd.DataFrame): A dataframe containing clonotypes. For instance, it can be made with </span>
<a id="__codelineno-0-526" name="__codelineno-0-526"></a><span class="sd">            `pool_clonotypes_from_clonosets_df` function from the Clustering module. </span>
<a id="__codelineno-0-527" name="__codelineno-0-527"></a><span class="sd">        drop_method (bool): if `True`, `Method` column is excluded from the annotation</span>
<a id="__codelineno-0-528" name="__codelineno-0-528"></a><span class="sd">        drop_meta (bool): if `True`, `Meta` column is excluded from the annotation</span>
<a id="__codelineno-0-529" name="__codelineno-0-529"></a><span class="sd">        drop_cdr3fix (bool): if `True`, `CDR3fix` column is excluded from the annotation</span>
<a id="__codelineno-0-530" name="__codelineno-0-530"></a>
<a id="__codelineno-0-531" name="__codelineno-0-531"></a><span class="sd">    Returns:</span>
<a id="__codelineno-0-532" name="__codelineno-0-532"></a><span class="sd">        annotated_clonotypes (pd.DataFrame): annotated clonotypes_df</span>
<a id="__codelineno-0-533" name="__codelineno-0-533"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-534" name="__codelineno-0-534"></a>    <span class="n">clonotypes_df_copy</span> <span class="o">=</span> <span class="n">clonotypes_df</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
<a id="__codelineno-0-535" name="__codelineno-0-535"></a>    <span class="n">vdjdb_whole</span> <span class="o">=</span> <span class="n">vdjdb</span><span class="p">(</span><span class="n">vdjdb_dataset</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">drop_method</span><span class="o">=</span><span class="n">drop_method</span><span class="p">,</span> <span class="n">drop_meta</span><span class="o">=</span><span class="n">drop_meta</span><span class="p">,</span> <span class="n">drop_cdr3fix</span><span class="o">=</span><span class="n">drop_cdr3fix</span><span class="p">)</span>
<a id="__codelineno-0-536" name="__codelineno-0-536"></a>    <span class="n">vdjdb_whole</span> <span class="o">=</span> <span class="n">vdjdb_whole</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="s1">&#39;score&#39;</span><span class="p">,</span> <span class="n">ascending</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span><span class="o">.</span><span class="n">drop_duplicates</span><span class="p">(</span><span class="n">subset</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;v&#39;</span><span class="p">,</span> <span class="s1">&#39;j&#39;</span><span class="p">,</span> <span class="s1">&#39;cdr3aa&#39;</span><span class="p">,</span> <span class="s1">&#39;epitope&#39;</span><span class="p">,</span> <span class="s1">&#39;epitope_gene&#39;</span><span class="p">,</span> <span class="s1">&#39;epitope_species&#39;</span><span class="p">])</span>
<a id="__codelineno-0-537" name="__codelineno-0-537"></a>    <span class="n">annotated_clonotypes</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">clonotypes_df_copy</span><span class="p">,</span> <span class="n">vdjdb_whole</span><span class="p">,</span> <span class="n">on</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;cdr3aa&#39;</span><span class="p">,</span> <span class="s1">&#39;v&#39;</span><span class="p">,</span> <span class="s1">&#39;j&#39;</span><span class="p">],</span> <span class="n">how</span><span class="o">=</span><span class="s1">&#39;left&#39;</span><span class="p">)</span>
<a id="__codelineno-0-538" name="__codelineno-0-538"></a>    <span class="k">return</span> <span class="n">annotated_clonotypes</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h4 id="clonosets.find_all_exported_clonosets" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">find_all_exported_clonosets</span><span class="p">(</span><span class="n">folders</span><span class="p">,</span> <span class="n">chain</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">show_offtarget</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">offtarget_threshold</span><span class="o">=</span><span class="mf">0.01</span><span class="p">)</span></code>

</h4>


    <div class="doc doc-contents ">

        <p>Main method of the Filter object - application of it to a clonoset</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>folders</code>
            </td>
            <td>
                  <code>path or list of paths</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>clonoset in the form of Pandas DataFrame in
MiXCR(3 or 4+ version), VDJtools or Bioadaptive formats.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>colnames</code>
            </td>
            <td>
                  <code><span title="dict">dict</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Dictionary of available specific column names.
Defaults to None - colnames imputed automatically.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
<th>Name</th>          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
<td><code>clonoset</code></td>            <td>
                  <code><span title="pandas.DataFrame">DataFrame</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>clonoset after converting to common (VDJtools-like)
format and applying functionality filtration and downsampling or taking top</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>repseq/clonosets.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-54">54</a></span>
<span class="normal"><a href="#__codelineno-0-55">55</a></span>
<span class="normal"><a href="#__codelineno-0-56">56</a></span>
<span class="normal"><a href="#__codelineno-0-57">57</a></span>
<span class="normal"><a href="#__codelineno-0-58">58</a></span>
<span class="normal"><a href="#__codelineno-0-59">59</a></span>
<span class="normal"><a href="#__codelineno-0-60">60</a></span>
<span class="normal"><a href="#__codelineno-0-61">61</a></span>
<span class="normal"><a href="#__codelineno-0-62">62</a></span>
<span class="normal"><a href="#__codelineno-0-63">63</a></span>
<span class="normal"><a href="#__codelineno-0-64">64</a></span>
<span class="normal"><a href="#__codelineno-0-65">65</a></span>
<span class="normal"><a href="#__codelineno-0-66">66</a></span>
<span class="normal"><a href="#__codelineno-0-67">67</a></span>
<span class="normal"><a href="#__codelineno-0-68">68</a></span>
<span class="normal"><a href="#__codelineno-0-69">69</a></span>
<span class="normal"><a href="#__codelineno-0-70">70</a></span>
<span class="normal"><a href="#__codelineno-0-71">71</a></span>
<span class="normal"><a href="#__codelineno-0-72">72</a></span>
<span class="normal"><a href="#__codelineno-0-73">73</a></span>
<span class="normal"><a href="#__codelineno-0-74">74</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-54" name="__codelineno-0-54"></a><span class="k">def</span><span class="w"> </span><span class="nf">find_all_exported_clonosets</span><span class="p">(</span><span class="n">folders</span><span class="p">,</span> <span class="n">chain</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">show_offtarget</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">offtarget_threshold</span><span class="o">=</span><span class="mf">0.01</span><span class="p">):</span>
<a id="__codelineno-0-55" name="__codelineno-0-55"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-56" name="__codelineno-0-56"></a><span class="sd">    Main method of the Filter object - application of it to a clonoset</span>
<a id="__codelineno-0-57" name="__codelineno-0-57"></a>
<a id="__codelineno-0-58" name="__codelineno-0-58"></a><span class="sd">    Args:</span>
<a id="__codelineno-0-59" name="__codelineno-0-59"></a><span class="sd">        folders (path or list of paths): clonoset in the form of Pandas DataFrame in</span>
<a id="__codelineno-0-60" name="__codelineno-0-60"></a><span class="sd">            MiXCR(3 or 4+ version), VDJtools or Bioadaptive formats.</span>
<a id="__codelineno-0-61" name="__codelineno-0-61"></a><span class="sd">        colnames (dict, optional): Dictionary of available specific column names.</span>
<a id="__codelineno-0-62" name="__codelineno-0-62"></a><span class="sd">            Defaults to None - colnames imputed automatically.</span>
<a id="__codelineno-0-63" name="__codelineno-0-63"></a>
<a id="__codelineno-0-64" name="__codelineno-0-64"></a><span class="sd">    Returns:</span>
<a id="__codelineno-0-65" name="__codelineno-0-65"></a><span class="sd">        clonoset (pd.DataFrame): clonoset after converting to common (VDJtools-like)</span>
<a id="__codelineno-0-66" name="__codelineno-0-66"></a><span class="sd">            format and applying functionality filtration and downsampling or taking top</span>
<a id="__codelineno-0-67" name="__codelineno-0-67"></a>
<a id="__codelineno-0-68" name="__codelineno-0-68"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-69" name="__codelineno-0-69"></a>    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">folders</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
<a id="__codelineno-0-70" name="__codelineno-0-70"></a>        <span class="n">folders</span> <span class="o">=</span> <span class="p">[</span><span class="n">folders</span><span class="p">]</span>
<a id="__codelineno-0-71" name="__codelineno-0-71"></a>    <span class="n">clonosets_dfs</span> <span class="o">=</span> <span class="p">[]</span>
<a id="__codelineno-0-72" name="__codelineno-0-72"></a>    <span class="k">for</span> <span class="n">folder</span> <span class="ow">in</span> <span class="n">folders</span><span class="p">:</span>
<a id="__codelineno-0-73" name="__codelineno-0-73"></a>        <span class="n">clonosets_dfs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">find_all_exported_clonosets_in_folder</span><span class="p">(</span><span class="n">folder</span><span class="p">,</span> <span class="n">chain</span><span class="o">=</span><span class="n">chain</span><span class="p">,</span> <span class="n">show_offtarget</span><span class="o">=</span><span class="n">show_offtarget</span><span class="p">,</span> <span class="n">offtarget_threshold</span><span class="o">=</span><span class="n">offtarget_threshold</span><span class="p">))</span>
<a id="__codelineno-0-74" name="__codelineno-0-74"></a>    <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">clonosets_dfs</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div><h2 id="clustering"><strong>clustering</strong></h2>


<div class="doc doc-object doc-module">




    <div class="doc doc-contents first">










  <div class="doc doc-children">









<div class="doc doc-object doc-class">



<h4 id="clustering.Node" class="doc doc-heading">
            <code>Node</code>


</h4>


    <div class="doc doc-contents ">









              <details class="quote">
                <summary>Source code in <code>repseq/clustering.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-23">23</a></span>
<span class="normal"><a href="#__codelineno-0-24">24</a></span>
<span class="normal"><a href="#__codelineno-0-25">25</a></span>
<span class="normal"><a href="#__codelineno-0-26">26</a></span>
<span class="normal"><a href="#__codelineno-0-27">27</a></span>
<span class="normal"><a href="#__codelineno-0-28">28</a></span>
<span class="normal"><a href="#__codelineno-0-29">29</a></span>
<span class="normal"><a href="#__codelineno-0-30">30</a></span>
<span class="normal"><a href="#__codelineno-0-31">31</a></span>
<span class="normal"><a href="#__codelineno-0-32">32</a></span>
<span class="normal"><a href="#__codelineno-0-33">33</a></span>
<span class="normal"><a href="#__codelineno-0-34">34</a></span>
<span class="normal"><a href="#__codelineno-0-35">35</a></span>
<span class="normal"><a href="#__codelineno-0-36">36</a></span>
<span class="normal"><a href="#__codelineno-0-37">37</a></span>
<span class="normal"><a href="#__codelineno-0-38">38</a></span>
<span class="normal"><a href="#__codelineno-0-39">39</a></span>
<span class="normal"><a href="#__codelineno-0-40">40</a></span>
<span class="normal"><a href="#__codelineno-0-41">41</a></span>
<span class="normal"><a href="#__codelineno-0-42">42</a></span>
<span class="normal"><a href="#__codelineno-0-43">43</a></span>
<span class="normal"><a href="#__codelineno-0-44">44</a></span>
<span class="normal"><a href="#__codelineno-0-45">45</a></span>
<span class="normal"><a href="#__codelineno-0-46">46</a></span>
<span class="normal"><a href="#__codelineno-0-47">47</a></span>
<span class="normal"><a href="#__codelineno-0-48">48</a></span>
<span class="normal"><a href="#__codelineno-0-49">49</a></span>
<span class="normal"><a href="#__codelineno-0-50">50</a></span>
<span class="normal"><a href="#__codelineno-0-51">51</a></span>
<span class="normal"><a href="#__codelineno-0-52">52</a></span>
<span class="normal"><a href="#__codelineno-0-53">53</a></span>
<span class="normal"><a href="#__codelineno-0-54">54</a></span>
<span class="normal"><a href="#__codelineno-0-55">55</a></span>
<span class="normal"><a href="#__codelineno-0-56">56</a></span>
<span class="normal"><a href="#__codelineno-0-57">57</a></span>
<span class="normal"><a href="#__codelineno-0-58">58</a></span>
<span class="normal"><a href="#__codelineno-0-59">59</a></span>
<span class="normal"><a href="#__codelineno-0-60">60</a></span>
<span class="normal"><a href="#__codelineno-0-61">61</a></span>
<span class="normal"><a href="#__codelineno-0-62">62</a></span>
<span class="normal"><a href="#__codelineno-0-63">63</a></span>
<span class="normal"><a href="#__codelineno-0-64">64</a></span>
<span class="normal"><a href="#__codelineno-0-65">65</a></span>
<span class="normal"><a href="#__codelineno-0-66">66</a></span>
<span class="normal"><a href="#__codelineno-0-67">67</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-23" name="__codelineno-0-23"></a><span class="k">class</span><span class="w"> </span><span class="nc">Node</span><span class="p">:</span>
<a id="__codelineno-0-24" name="__codelineno-0-24"></a>
<a id="__codelineno-0-25" name="__codelineno-0-25"></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node_id</span><span class="p">,</span> <span class="n">seq_nt</span><span class="p">,</span> <span class="n">seq_aa</span><span class="p">,</span> <span class="n">v</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">sample_id</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
<a id="__codelineno-0-26" name="__codelineno-0-26"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">id</span> <span class="o">=</span> <span class="n">node_id</span>
<a id="__codelineno-0-27" name="__codelineno-0-27"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">v</span> <span class="o">=</span> <span class="n">v</span>
<a id="__codelineno-0-28" name="__codelineno-0-28"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">j</span> <span class="o">=</span> <span class="n">j</span>
<a id="__codelineno-0-29" name="__codelineno-0-29"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">seq_aa</span> <span class="o">=</span> <span class="n">seq_aa</span>
<a id="__codelineno-0-30" name="__codelineno-0-30"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">seq_nt</span> <span class="o">=</span> <span class="n">seq_nt</span>
<a id="__codelineno-0-31" name="__codelineno-0-31"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">sample_id</span> <span class="o">=</span> <span class="n">sample_id</span>
<a id="__codelineno-0-32" name="__codelineno-0-32"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">size</span> <span class="o">=</span> <span class="n">size</span>
<a id="__codelineno-0-33" name="__codelineno-0-33"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">additional_properties</span> <span class="o">=</span> <span class="p">{}</span>
<a id="__codelineno-0-34" name="__codelineno-0-34"></a>
<a id="__codelineno-0-35" name="__codelineno-0-35"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">is_neighbour_of</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">,</span> <span class="n">mismatches</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">aa</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">check_v</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">check_j</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<a id="__codelineno-0-36" name="__codelineno-0-36"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;function compare two strings and return</span>
<a id="__codelineno-0-37" name="__codelineno-0-37"></a><span class="sd">        True if their are equal</span>
<a id="__codelineno-0-38" name="__codelineno-0-38"></a><span class="sd">            or if they have one mismatch and equal length</span>
<a id="__codelineno-0-39" name="__codelineno-0-39"></a><span class="sd">        False in all other conditions</span>
<a id="__codelineno-0-40" name="__codelineno-0-40"></a><span class="sd">        &quot;&quot;&quot;</span>
<a id="__codelineno-0-41" name="__codelineno-0-41"></a>
<a id="__codelineno-0-42" name="__codelineno-0-42"></a>        <span class="k">if</span> <span class="n">aa</span><span class="p">:</span>
<a id="__codelineno-0-43" name="__codelineno-0-43"></a>            <span class="n">string1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">seq_aa</span>
<a id="__codelineno-0-44" name="__codelineno-0-44"></a>            <span class="n">string2</span> <span class="o">=</span> <span class="n">other</span><span class="o">.</span><span class="n">seq_aa</span>
<a id="__codelineno-0-45" name="__codelineno-0-45"></a>        <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-46" name="__codelineno-0-46"></a>            <span class="n">string1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">seq_nt</span>
<a id="__codelineno-0-47" name="__codelineno-0-47"></a>            <span class="n">string2</span> <span class="o">=</span> <span class="n">other</span><span class="o">.</span><span class="n">seq_nt</span>
<a id="__codelineno-0-48" name="__codelineno-0-48"></a>        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">string1</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">string2</span><span class="p">):</span>
<a id="__codelineno-0-49" name="__codelineno-0-49"></a>             <span class="k">return</span> <span class="kc">False</span>
<a id="__codelineno-0-50" name="__codelineno-0-50"></a>        <span class="k">if</span> <span class="n">check_v</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">v</span> <span class="o">!=</span> <span class="n">other</span><span class="o">.</span><span class="n">v</span><span class="p">:</span>
<a id="__codelineno-0-51" name="__codelineno-0-51"></a>            <span class="k">return</span> <span class="kc">False</span>
<a id="__codelineno-0-52" name="__codelineno-0-52"></a>        <span class="k">if</span> <span class="n">check_j</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">j</span> <span class="o">!=</span> <span class="n">other</span><span class="o">.</span><span class="n">j</span><span class="p">:</span>
<a id="__codelineno-0-53" name="__codelineno-0-53"></a>            <span class="k">return</span> <span class="kc">False</span>
<a id="__codelineno-0-54" name="__codelineno-0-54"></a>        <span class="n">hamm_dist</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">([</span><span class="n">a</span> <span class="o">!=</span> <span class="n">b</span> <span class="k">for</span> <span class="n">a</span><span class="p">,</span><span class="n">b</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">string1</span><span class="p">,</span><span class="n">string2</span><span class="p">)])</span> 
<a id="__codelineno-0-55" name="__codelineno-0-55"></a>        <span class="k">if</span> <span class="n">hamm_dist</span> <span class="o">&gt;</span> <span class="n">mismatches</span><span class="p">:</span>
<a id="__codelineno-0-56" name="__codelineno-0-56"></a>            <span class="k">return</span> <span class="kc">False</span>     
<a id="__codelineno-0-57" name="__codelineno-0-57"></a>        <span class="k">return</span> <span class="kc">True</span>
<a id="__codelineno-0-58" name="__codelineno-0-58"></a>
<a id="__codelineno-0-59" name="__codelineno-0-59"></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a id="__codelineno-0-60" name="__codelineno-0-60"></a>        <span class="k">return</span> <span class="s2">&quot;</span><span class="si">{}</span><span class="s2">_</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">seq_aa</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
<a id="__codelineno-0-61" name="__codelineno-0-61"></a>
<a id="__codelineno-0-62" name="__codelineno-0-62"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">add_properties</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">metadata</span><span class="p">):</span>
<a id="__codelineno-0-63" name="__codelineno-0-63"></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">sample_id</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">metadata</span><span class="p">:</span>
<a id="__codelineno-0-64" name="__codelineno-0-64"></a>            <span class="k">for</span> <span class="nb">property</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">metadata</span><span class="p">[</span><span class="nb">list</span><span class="p">(</span><span class="n">metadata</span><span class="p">)[</span><span class="mi">0</span><span class="p">]]</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
<a id="__codelineno-0-65" name="__codelineno-0-65"></a>                <span class="bp">self</span><span class="o">.</span><span class="n">additional_properties</span><span class="p">[</span><span class="nb">property</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
<a id="__codelineno-0-66" name="__codelineno-0-66"></a>        <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-67" name="__codelineno-0-67"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">additional_properties</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">metadata</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">sample_id</span><span class="p">])</span>
</code></pre></div></td></tr></table></div>
              </details>



  <div class="doc doc-children">










<div class="doc doc-object doc-function">


<h5 id="clustering.Node.is_neighbour_of" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">is_neighbour_of</span><span class="p">(</span><span class="n">other</span><span class="p">,</span> <span class="n">mismatches</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">aa</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">check_v</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">check_j</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span></code>

</h5>


    <div class="doc doc-contents ">

        <p>function compare two strings and return
True if their are equal
    or if they have one mismatch and equal length
False in all other conditions</p>


            <details class="quote">
              <summary>Source code in <code>repseq/clustering.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-35">35</a></span>
<span class="normal"><a href="#__codelineno-0-36">36</a></span>
<span class="normal"><a href="#__codelineno-0-37">37</a></span>
<span class="normal"><a href="#__codelineno-0-38">38</a></span>
<span class="normal"><a href="#__codelineno-0-39">39</a></span>
<span class="normal"><a href="#__codelineno-0-40">40</a></span>
<span class="normal"><a href="#__codelineno-0-41">41</a></span>
<span class="normal"><a href="#__codelineno-0-42">42</a></span>
<span class="normal"><a href="#__codelineno-0-43">43</a></span>
<span class="normal"><a href="#__codelineno-0-44">44</a></span>
<span class="normal"><a href="#__codelineno-0-45">45</a></span>
<span class="normal"><a href="#__codelineno-0-46">46</a></span>
<span class="normal"><a href="#__codelineno-0-47">47</a></span>
<span class="normal"><a href="#__codelineno-0-48">48</a></span>
<span class="normal"><a href="#__codelineno-0-49">49</a></span>
<span class="normal"><a href="#__codelineno-0-50">50</a></span>
<span class="normal"><a href="#__codelineno-0-51">51</a></span>
<span class="normal"><a href="#__codelineno-0-52">52</a></span>
<span class="normal"><a href="#__codelineno-0-53">53</a></span>
<span class="normal"><a href="#__codelineno-0-54">54</a></span>
<span class="normal"><a href="#__codelineno-0-55">55</a></span>
<span class="normal"><a href="#__codelineno-0-56">56</a></span>
<span class="normal"><a href="#__codelineno-0-57">57</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-35" name="__codelineno-0-35"></a><span class="k">def</span><span class="w"> </span><span class="nf">is_neighbour_of</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">,</span> <span class="n">mismatches</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">aa</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">check_v</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">check_j</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<a id="__codelineno-0-36" name="__codelineno-0-36"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;function compare two strings and return</span>
<a id="__codelineno-0-37" name="__codelineno-0-37"></a><span class="sd">    True if their are equal</span>
<a id="__codelineno-0-38" name="__codelineno-0-38"></a><span class="sd">        or if they have one mismatch and equal length</span>
<a id="__codelineno-0-39" name="__codelineno-0-39"></a><span class="sd">    False in all other conditions</span>
<a id="__codelineno-0-40" name="__codelineno-0-40"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-41" name="__codelineno-0-41"></a>
<a id="__codelineno-0-42" name="__codelineno-0-42"></a>    <span class="k">if</span> <span class="n">aa</span><span class="p">:</span>
<a id="__codelineno-0-43" name="__codelineno-0-43"></a>        <span class="n">string1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">seq_aa</span>
<a id="__codelineno-0-44" name="__codelineno-0-44"></a>        <span class="n">string2</span> <span class="o">=</span> <span class="n">other</span><span class="o">.</span><span class="n">seq_aa</span>
<a id="__codelineno-0-45" name="__codelineno-0-45"></a>    <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-46" name="__codelineno-0-46"></a>        <span class="n">string1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">seq_nt</span>
<a id="__codelineno-0-47" name="__codelineno-0-47"></a>        <span class="n">string2</span> <span class="o">=</span> <span class="n">other</span><span class="o">.</span><span class="n">seq_nt</span>
<a id="__codelineno-0-48" name="__codelineno-0-48"></a>    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">string1</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">string2</span><span class="p">):</span>
<a id="__codelineno-0-49" name="__codelineno-0-49"></a>         <span class="k">return</span> <span class="kc">False</span>
<a id="__codelineno-0-50" name="__codelineno-0-50"></a>    <span class="k">if</span> <span class="n">check_v</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">v</span> <span class="o">!=</span> <span class="n">other</span><span class="o">.</span><span class="n">v</span><span class="p">:</span>
<a id="__codelineno-0-51" name="__codelineno-0-51"></a>        <span class="k">return</span> <span class="kc">False</span>
<a id="__codelineno-0-52" name="__codelineno-0-52"></a>    <span class="k">if</span> <span class="n">check_j</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">j</span> <span class="o">!=</span> <span class="n">other</span><span class="o">.</span><span class="n">j</span><span class="p">:</span>
<a id="__codelineno-0-53" name="__codelineno-0-53"></a>        <span class="k">return</span> <span class="kc">False</span>
<a id="__codelineno-0-54" name="__codelineno-0-54"></a>    <span class="n">hamm_dist</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">([</span><span class="n">a</span> <span class="o">!=</span> <span class="n">b</span> <span class="k">for</span> <span class="n">a</span><span class="p">,</span><span class="n">b</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">string1</span><span class="p">,</span><span class="n">string2</span><span class="p">)])</span> 
<a id="__codelineno-0-55" name="__codelineno-0-55"></a>    <span class="k">if</span> <span class="n">hamm_dist</span> <span class="o">&gt;</span> <span class="n">mismatches</span><span class="p">:</span>
<a id="__codelineno-0-56" name="__codelineno-0-56"></a>        <span class="k">return</span> <span class="kc">False</span>     
<a id="__codelineno-0-57" name="__codelineno-0-57"></a>    <span class="k">return</span> <span class="kc">True</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>




  </div>

    </div>

</div><h2 id="common_functions"><strong>common_functions</strong></h2>


<div class="doc doc-object doc-module">




    <div class="doc doc-contents first">










  <div class="doc doc-children">












  </div>

    </div>

</div><h2 id="constants"><strong>constants</strong></h2>


<div class="doc doc-object doc-module">




    <div class="doc doc-contents first">










  <div class="doc doc-children">












  </div>

    </div>

</div><h2 id="diffexp"><strong>diffexp</strong></h2>


<div class="doc doc-object doc-module">




    <div class="doc doc-contents first">










  <div class="doc doc-children">












  </div>

    </div>

</div><h2 id="intersections"><strong>intersections</strong></h2>


<div class="doc doc-object doc-module">




    <div class="doc doc-contents first">










  <div class="doc doc-children">










<div class="doc doc-object doc-function">


<h4 id="intersections.count_table" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">count_table</span><span class="p">(</span><span class="n">clonosets_df</span><span class="p">,</span> <span class="n">cl_filter</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">overlap_type</span><span class="o">=</span><span class="s1">&#39;aaV&#39;</span><span class="p">,</span> <span class="n">mismatches</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">strict_presence</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">by_freq</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span></code>

</h4>


    <div class="doc doc-contents ">

        <p>Creates a table that shows how many times each unique clonotype appears across different clonosets. It processes a given dataset of clonotypes (clonosets_df) 
and generates a frequency/count table based on a specified overlap type.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>clonosets_df</code>
            </td>
            <td>
                  <code><span title="pandas.DataFrame">DataFrame</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>contains three columns - <code>sample_id</code> and <code>filename</code> columns,
<code>filename</code> - full path to clonoset file. Clonoset file may be of MiXCR3/MiXCR4 or VDJtools format
sample_id's should be all unique in this DF</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>overlap_type</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>possible values are <code>aa</code>, <code>aaV</code>, <code>aaVJ</code>, <code>nt</code>, <code>ntV</code>, <code>ntVJ</code>. aa/nt define which CDR3 sequence
to use (amino acid or nucleotide). V/J in the overlap_type define whether to check V or J segments
to decide if clonotypes are equal</p>
              </div>
            </td>
            <td>
                  <code>&#39;aaV&#39;</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>mismatches</code>
            </td>
            <td>
                  <code><span title="int">int</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Max number of single-letter mismatches in clonotypes sequences 
for them to be treated similar, i.e. hamming distance.</p>
              </div>
            </td>
            <td>
                  <code>0</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>only_functional</code>
            </td>
            <td>
                  <code><span title="bool">bool</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>use only functional clonotypes (do not contain stop codons or
frameshifts in CDR3 sequences: * or _ symbol in CDR3aa sequence). The frequences are recounted to
1 after filtering of non-functional clonotypes</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>strict_presence (bool, default</code>
            </td>
            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>): if set to <code>True</code> and the clonotype is not found in the clonoset, it will not be counted, even when the <code>mismatches</code> option is not set to 0.
If <code>False</code>, mismatched sequences are counted even if the exact match does not exist.
    by_freq (bool): default is <code>True</code> - this means that the intersect metric is frequency of clonotype, 
but not its count</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>by_freq</code>
            </td>
            <td>
                  <code><span title="bool">bool</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>default is <code>True</code> - this means that the intersect metric is frequency of clonotype, 
but not its count</p>
              </div>
            </td>
            <td>
                  <code>False</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
<th>Name</th>          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
<td><code>df</code></td>            <td>
                  <code><span title="pandas.DataFrame">DataFrame</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>dataframe containing clonotype counts with sample names as columns and all possible clonotypes (given the overlap_type) as rows.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>repseq/intersections.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-83"> 83</a></span>
<span class="normal"><a href="#__codelineno-0-84"> 84</a></span>
<span class="normal"><a href="#__codelineno-0-85"> 85</a></span>
<span class="normal"><a href="#__codelineno-0-86"> 86</a></span>
<span class="normal"><a href="#__codelineno-0-87"> 87</a></span>
<span class="normal"><a href="#__codelineno-0-88"> 88</a></span>
<span class="normal"><a href="#__codelineno-0-89"> 89</a></span>
<span class="normal"><a href="#__codelineno-0-90"> 90</a></span>
<span class="normal"><a href="#__codelineno-0-91"> 91</a></span>
<span class="normal"><a href="#__codelineno-0-92"> 92</a></span>
<span class="normal"><a href="#__codelineno-0-93"> 93</a></span>
<span class="normal"><a href="#__codelineno-0-94"> 94</a></span>
<span class="normal"><a href="#__codelineno-0-95"> 95</a></span>
<span class="normal"><a href="#__codelineno-0-96"> 96</a></span>
<span class="normal"><a href="#__codelineno-0-97"> 97</a></span>
<span class="normal"><a href="#__codelineno-0-98"> 98</a></span>
<span class="normal"><a href="#__codelineno-0-99"> 99</a></span>
<span class="normal"><a href="#__codelineno-0-100">100</a></span>
<span class="normal"><a href="#__codelineno-0-101">101</a></span>
<span class="normal"><a href="#__codelineno-0-102">102</a></span>
<span class="normal"><a href="#__codelineno-0-103">103</a></span>
<span class="normal"><a href="#__codelineno-0-104">104</a></span>
<span class="normal"><a href="#__codelineno-0-105">105</a></span>
<span class="normal"><a href="#__codelineno-0-106">106</a></span>
<span class="normal"><a href="#__codelineno-0-107">107</a></span>
<span class="normal"><a href="#__codelineno-0-108">108</a></span>
<span class="normal"><a href="#__codelineno-0-109">109</a></span>
<span class="normal"><a href="#__codelineno-0-110">110</a></span>
<span class="normal"><a href="#__codelineno-0-111">111</a></span>
<span class="normal"><a href="#__codelineno-0-112">112</a></span>
<span class="normal"><a href="#__codelineno-0-113">113</a></span>
<span class="normal"><a href="#__codelineno-0-114">114</a></span>
<span class="normal"><a href="#__codelineno-0-115">115</a></span>
<span class="normal"><a href="#__codelineno-0-116">116</a></span>
<span class="normal"><a href="#__codelineno-0-117">117</a></span>
<span class="normal"><a href="#__codelineno-0-118">118</a></span>
<span class="normal"><a href="#__codelineno-0-119">119</a></span>
<span class="normal"><a href="#__codelineno-0-120">120</a></span>
<span class="normal"><a href="#__codelineno-0-121">121</a></span>
<span class="normal"><a href="#__codelineno-0-122">122</a></span>
<span class="normal"><a href="#__codelineno-0-123">123</a></span>
<span class="normal"><a href="#__codelineno-0-124">124</a></span>
<span class="normal"><a href="#__codelineno-0-125">125</a></span>
<span class="normal"><a href="#__codelineno-0-126">126</a></span>
<span class="normal"><a href="#__codelineno-0-127">127</a></span>
<span class="normal"><a href="#__codelineno-0-128">128</a></span>
<span class="normal"><a href="#__codelineno-0-129">129</a></span>
<span class="normal"><a href="#__codelineno-0-130">130</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-83" name="__codelineno-0-83"></a><span class="k">def</span><span class="w"> </span><span class="nf">count_table</span><span class="p">(</span><span class="n">clonosets_df</span><span class="p">,</span> <span class="n">cl_filter</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">overlap_type</span><span class="o">=</span><span class="s2">&quot;aaV&quot;</span><span class="p">,</span> <span class="n">mismatches</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">strict_presence</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">by_freq</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<a id="__codelineno-0-84" name="__codelineno-0-84"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-85" name="__codelineno-0-85"></a><span class="sd">    Creates a table that shows how many times each unique clonotype appears across different clonosets. It processes a given dataset of clonotypes (clonosets_df) </span>
<a id="__codelineno-0-86" name="__codelineno-0-86"></a><span class="sd">    and generates a frequency/count table based on a specified overlap type.</span>
<a id="__codelineno-0-87" name="__codelineno-0-87"></a>
<a id="__codelineno-0-88" name="__codelineno-0-88"></a><span class="sd">    Args:</span>
<a id="__codelineno-0-89" name="__codelineno-0-89"></a><span class="sd">        clonosets_df (pd.DataFrame): contains three columns - `sample_id` and `filename` columns,</span>
<a id="__codelineno-0-90" name="__codelineno-0-90"></a><span class="sd">            `filename` - full path to clonoset file. Clonoset file may be of MiXCR3/MiXCR4 or VDJtools format</span>
<a id="__codelineno-0-91" name="__codelineno-0-91"></a><span class="sd">            sample_id&#39;s should be all unique in this DF</span>
<a id="__codelineno-0-92" name="__codelineno-0-92"></a><span class="sd">        overlap_type (str): possible values are `aa`, `aaV`, `aaVJ`, `nt`, `ntV`, `ntVJ`. aa/nt define which CDR3 sequence</span>
<a id="__codelineno-0-93" name="__codelineno-0-93"></a><span class="sd">            to use (amino acid or nucleotide). V/J in the overlap_type define whether to check V or J segments</span>
<a id="__codelineno-0-94" name="__codelineno-0-94"></a><span class="sd">            to decide if clonotypes are equal</span>
<a id="__codelineno-0-95" name="__codelineno-0-95"></a><span class="sd">        mismatches (int): Max number of single-letter mismatches in clonotypes sequences </span>
<a id="__codelineno-0-96" name="__codelineno-0-96"></a><span class="sd">            for them to be treated similar, i.e. hamming distance.</span>
<a id="__codelineno-0-97" name="__codelineno-0-97"></a><span class="sd">        only_functional (bool): use only functional clonotypes (do not contain stop codons or</span>
<a id="__codelineno-0-98" name="__codelineno-0-98"></a><span class="sd">            frameshifts in CDR3 sequences: * or _ symbol in CDR3aa sequence). The frequences are recounted to</span>
<a id="__codelineno-0-99" name="__codelineno-0-99"></a><span class="sd">            1 after filtering of non-functional clonotypes</span>
<a id="__codelineno-0-100" name="__codelineno-0-100"></a><span class="sd">        strict_presence (bool, default:): if set to `True` and the clonotype is not found in the clonoset, it will not be counted, even when the `mismatches` option is not set to 0.</span>
<a id="__codelineno-0-101" name="__codelineno-0-101"></a><span class="sd">            If `False`, mismatched sequences are counted even if the exact match does not exist.</span>
<a id="__codelineno-0-102" name="__codelineno-0-102"></a><span class="sd">                by_freq (bool): default is `True` - this means that the intersect metric is frequency of clonotype, </span>
<a id="__codelineno-0-103" name="__codelineno-0-103"></a><span class="sd">            but not its count</span>
<a id="__codelineno-0-104" name="__codelineno-0-104"></a><span class="sd">        by_freq (bool): default is `True` - this means that the intersect metric is frequency of clonotype, </span>
<a id="__codelineno-0-105" name="__codelineno-0-105"></a><span class="sd">            but not its count</span>
<a id="__codelineno-0-106" name="__codelineno-0-106"></a>
<a id="__codelineno-0-107" name="__codelineno-0-107"></a><span class="sd">    Returns:</span>
<a id="__codelineno-0-108" name="__codelineno-0-108"></a><span class="sd">        df (pd.DataFrame): dataframe containing clonotype counts with sample names as columns and all possible clonotypes (given the overlap_type) as rows. </span>
<a id="__codelineno-0-109" name="__codelineno-0-109"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-110" name="__codelineno-0-110"></a>
<a id="__codelineno-0-111" name="__codelineno-0-111"></a>
<a id="__codelineno-0-112" name="__codelineno-0-112"></a>    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Creating clonotypes count table</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">+</span><span class="s2">&quot;-&quot;</span><span class="o">*</span><span class="mi">50</span><span class="p">)</span>
<a id="__codelineno-0-113" name="__codelineno-0-113"></a>    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Overlap type: </span><span class="si">{</span><span class="n">overlap_type</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-0-114" name="__codelineno-0-114"></a>    <span class="n">aa</span><span class="p">,</span> <span class="n">check_v</span><span class="p">,</span> <span class="n">check_j</span> <span class="o">=</span> <span class="n">overlap_type_to_flags</span><span class="p">(</span><span class="n">overlap_type</span><span class="p">)</span>
<a id="__codelineno-0-115" name="__codelineno-0-115"></a>    <span class="n">clonoset_dicts</span> <span class="o">=</span> <span class="n">convert_clonosets_to_compact_dicts</span><span class="p">(</span><span class="n">clonosets_df</span><span class="p">,</span> <span class="n">cl_filter</span><span class="o">=</span><span class="n">cl_filter</span><span class="p">,</span>
<a id="__codelineno-0-116" name="__codelineno-0-116"></a>                                                        <span class="n">overlap_type</span><span class="o">=</span><span class="n">overlap_type</span><span class="p">,</span> <span class="n">by_freq</span><span class="o">=</span><span class="n">by_freq</span><span class="p">,</span> <span class="n">strict</span><span class="o">=</span><span class="ow">not</span> <span class="nb">bool</span><span class="p">(</span><span class="n">mismatches</span><span class="p">))</span>
<a id="__codelineno-0-117" name="__codelineno-0-117"></a>    <span class="n">unique_clonotypes</span> <span class="o">=</span> <span class="n">find_unique_clonotypes_in_clonoset_dicts</span><span class="p">(</span><span class="n">clonoset_dicts</span><span class="p">)</span>
<a id="__codelineno-0-118" name="__codelineno-0-118"></a>
<a id="__codelineno-0-119" name="__codelineno-0-119"></a>    <span class="n">tasks</span> <span class="o">=</span> <span class="p">[]</span>
<a id="__codelineno-0-120" name="__codelineno-0-120"></a>    <span class="k">for</span> <span class="n">sample_id</span> <span class="ow">in</span> <span class="n">clonoset_dicts</span><span class="p">:</span>
<a id="__codelineno-0-121" name="__codelineno-0-121"></a>        <span class="n">task</span> <span class="o">=</span> <span class="p">[</span><span class="n">unique_clonotypes</span><span class="p">,</span> <span class="n">sample_id</span><span class="p">,</span> <span class="n">clonoset_dicts</span><span class="p">[</span><span class="n">sample_id</span><span class="p">],</span> <span class="n">mismatches</span><span class="p">,</span> <span class="n">strict_presence</span><span class="p">]</span>
<a id="__codelineno-0-122" name="__codelineno-0-122"></a>        <span class="n">tasks</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">task</span><span class="p">)</span>
<a id="__codelineno-0-123" name="__codelineno-0-123"></a>
<a id="__codelineno-0-124" name="__codelineno-0-124"></a>    <span class="n">results</span> <span class="o">=</span> <span class="n">run_parallel_calculation</span><span class="p">(</span><span class="n">count_table_mp</span><span class="p">,</span> <span class="n">tasks</span><span class="p">,</span> <span class="s2">&quot;Counting features&quot;</span><span class="p">,</span> <span class="n">object_name</span><span class="o">=</span><span class="s2">&quot;clonosets&quot;</span><span class="p">)</span>
<a id="__codelineno-0-125" name="__codelineno-0-125"></a>    <span class="n">result_dict</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
<a id="__codelineno-0-126" name="__codelineno-0-126"></a>    <span class="k">for</span> <span class="n">result</span> <span class="ow">in</span> <span class="n">results</span><span class="p">:</span>
<a id="__codelineno-0-127" name="__codelineno-0-127"></a>        <span class="n">result_dict</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
<a id="__codelineno-0-128" name="__codelineno-0-128"></a>    <span class="n">count_table</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">result_dict</span><span class="p">)</span>
<a id="__codelineno-0-129" name="__codelineno-0-129"></a>    <span class="n">count_table</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="n">unique_clonotypes</span>
<a id="__codelineno-0-130" name="__codelineno-0-130"></a>    <span class="k">return</span> <span class="n">count_table</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h4 id="intersections.count_table_by_cluster" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">count_table_by_cluster</span><span class="p">(</span><span class="n">clonosets_df</span><span class="p">,</span> <span class="n">clusters_list</span><span class="p">,</span> <span class="n">cl_filter</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">overlap_type</span><span class="o">=</span><span class="s1">&#39;aaV&#39;</span><span class="p">,</span> <span class="n">mismatches</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">by_freq</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span></code>

</h4>


    <div class="doc doc-contents ">

        <p>This function creates a table that shows the presence of clonotypes grouped into user-provided clusters across different clonosets. Instead of counting individual clonotypes, it 
calculates how many clonotypes from each cluster appear in each clonoset.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>clonosets_df</code>
            </td>
            <td>
                  <code><span title="pandas.DataFrame">DataFrame</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>contains three columns - <code>sample_id</code> and <code>filename</code> columns,
filename - full path to clonoset file. Clonoset file may be of MiXCR3/MiXCR4 or VDJtools format
sample_id's should be all unique in this DF</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>cluster_list</code>
            </td>
            <td>
                  <code>?</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>description</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>overlap_type</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>possible values are <code>aa</code>, <code>aaV</code>, <code>aaVJ</code>, <code>nt</code>, <code>ntV</code>, <code>ntVJ</code>. aa/nt define which CDR3 sequence
to use (amino acid or nucleotide). V/J in the overlap_type define whether to check V or J segments
to decide if clonotypes are equal</p>
              </div>
            </td>
            <td>
                  <code>&#39;aaV&#39;</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>mismatches</code>
            </td>
            <td>
                  <code><span title="int">int</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Max number of single-letter mismatches in clonotypes sequences 
for them to be treated similar, i.e. hamming distance.</p>
              </div>
            </td>
            <td>
                  <code>0</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>only_functional</code>
            </td>
            <td>
                  <code><span title="bool">bool</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>use only functional clonotypes (do not contain stop codons or
frameshifts in CDR3 sequences: * or _ symbol in CDR3aa sequence). The frequences are recounted to
1 after filtering of non-functional clonotypes</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
<th>Name</th>          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
<td><code>df</code></td>            <td>
                  <code><span title="pandas.DataFrame">DataFrame</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>dataframe with the following columns: description</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>repseq/intersections.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-162">162</a></span>
<span class="normal"><a href="#__codelineno-0-163">163</a></span>
<span class="normal"><a href="#__codelineno-0-164">164</a></span>
<span class="normal"><a href="#__codelineno-0-165">165</a></span>
<span class="normal"><a href="#__codelineno-0-166">166</a></span>
<span class="normal"><a href="#__codelineno-0-167">167</a></span>
<span class="normal"><a href="#__codelineno-0-168">168</a></span>
<span class="normal"><a href="#__codelineno-0-169">169</a></span>
<span class="normal"><a href="#__codelineno-0-170">170</a></span>
<span class="normal"><a href="#__codelineno-0-171">171</a></span>
<span class="normal"><a href="#__codelineno-0-172">172</a></span>
<span class="normal"><a href="#__codelineno-0-173">173</a></span>
<span class="normal"><a href="#__codelineno-0-174">174</a></span>
<span class="normal"><a href="#__codelineno-0-175">175</a></span>
<span class="normal"><a href="#__codelineno-0-176">176</a></span>
<span class="normal"><a href="#__codelineno-0-177">177</a></span>
<span class="normal"><a href="#__codelineno-0-178">178</a></span>
<span class="normal"><a href="#__codelineno-0-179">179</a></span>
<span class="normal"><a href="#__codelineno-0-180">180</a></span>
<span class="normal"><a href="#__codelineno-0-181">181</a></span>
<span class="normal"><a href="#__codelineno-0-182">182</a></span>
<span class="normal"><a href="#__codelineno-0-183">183</a></span>
<span class="normal"><a href="#__codelineno-0-184">184</a></span>
<span class="normal"><a href="#__codelineno-0-185">185</a></span>
<span class="normal"><a href="#__codelineno-0-186">186</a></span>
<span class="normal"><a href="#__codelineno-0-187">187</a></span>
<span class="normal"><a href="#__codelineno-0-188">188</a></span>
<span class="normal"><a href="#__codelineno-0-189">189</a></span>
<span class="normal"><a href="#__codelineno-0-190">190</a></span>
<span class="normal"><a href="#__codelineno-0-191">191</a></span>
<span class="normal"><a href="#__codelineno-0-192">192</a></span>
<span class="normal"><a href="#__codelineno-0-193">193</a></span>
<span class="normal"><a href="#__codelineno-0-194">194</a></span>
<span class="normal"><a href="#__codelineno-0-195">195</a></span>
<span class="normal"><a href="#__codelineno-0-196">196</a></span>
<span class="normal"><a href="#__codelineno-0-197">197</a></span>
<span class="normal"><a href="#__codelineno-0-198">198</a></span>
<span class="normal"><a href="#__codelineno-0-199">199</a></span>
<span class="normal"><a href="#__codelineno-0-200">200</a></span>
<span class="normal"><a href="#__codelineno-0-201">201</a></span>
<span class="normal"><a href="#__codelineno-0-202">202</a></span>
<span class="normal"><a href="#__codelineno-0-203">203</a></span>
<span class="normal"><a href="#__codelineno-0-204">204</a></span>
<span class="normal"><a href="#__codelineno-0-205">205</a></span>
<span class="normal"><a href="#__codelineno-0-206">206</a></span>
<span class="normal"><a href="#__codelineno-0-207">207</a></span>
<span class="normal"><a href="#__codelineno-0-208">208</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-162" name="__codelineno-0-162"></a><span class="k">def</span><span class="w"> </span><span class="nf">count_table_by_cluster</span><span class="p">(</span><span class="n">clonosets_df</span><span class="p">,</span> <span class="n">clusters_list</span><span class="p">,</span> <span class="n">cl_filter</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">overlap_type</span><span class="o">=</span><span class="s2">&quot;aaV&quot;</span><span class="p">,</span> <span class="n">mismatches</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">by_freq</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
<a id="__codelineno-0-163" name="__codelineno-0-163"></a>
<a id="__codelineno-0-164" name="__codelineno-0-164"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-165" name="__codelineno-0-165"></a><span class="sd">    This function creates a table that shows the presence of clonotypes grouped into user-provided clusters across different clonosets. Instead of counting individual clonotypes, it </span>
<a id="__codelineno-0-166" name="__codelineno-0-166"></a><span class="sd">    calculates how many clonotypes from each cluster appear in each clonoset.</span>
<a id="__codelineno-0-167" name="__codelineno-0-167"></a>
<a id="__codelineno-0-168" name="__codelineno-0-168"></a><span class="sd">    Args:</span>
<a id="__codelineno-0-169" name="__codelineno-0-169"></a><span class="sd">        clonosets_df (pd.DataFrame): contains three columns - `sample_id` and `filename` columns,</span>
<a id="__codelineno-0-170" name="__codelineno-0-170"></a><span class="sd">            filename - full path to clonoset file. Clonoset file may be of MiXCR3/MiXCR4 or VDJtools format</span>
<a id="__codelineno-0-171" name="__codelineno-0-171"></a><span class="sd">            sample_id&#39;s should be all unique in this DF</span>
<a id="__codelineno-0-172" name="__codelineno-0-172"></a><span class="sd">        cluster_list (?): description</span>
<a id="__codelineno-0-173" name="__codelineno-0-173"></a><span class="sd">        overlap_type (str): possible values are `aa`, `aaV`, `aaVJ`, `nt`, `ntV`, `ntVJ`. aa/nt define which CDR3 sequence</span>
<a id="__codelineno-0-174" name="__codelineno-0-174"></a><span class="sd">            to use (amino acid or nucleotide). V/J in the overlap_type define whether to check V or J segments</span>
<a id="__codelineno-0-175" name="__codelineno-0-175"></a><span class="sd">            to decide if clonotypes are equal</span>
<a id="__codelineno-0-176" name="__codelineno-0-176"></a><span class="sd">        mismatches (int): Max number of single-letter mismatches in clonotypes sequences </span>
<a id="__codelineno-0-177" name="__codelineno-0-177"></a><span class="sd">            for them to be treated similar, i.e. hamming distance.</span>
<a id="__codelineno-0-178" name="__codelineno-0-178"></a><span class="sd">        only_functional (bool): use only functional clonotypes (do not contain stop codons or</span>
<a id="__codelineno-0-179" name="__codelineno-0-179"></a><span class="sd">            frameshifts in CDR3 sequences: * or _ symbol in CDR3aa sequence). The frequences are recounted to</span>
<a id="__codelineno-0-180" name="__codelineno-0-180"></a><span class="sd">            1 after filtering of non-functional clonotypes</span>
<a id="__codelineno-0-181" name="__codelineno-0-181"></a>
<a id="__codelineno-0-182" name="__codelineno-0-182"></a><span class="sd">    Returns:</span>
<a id="__codelineno-0-183" name="__codelineno-0-183"></a><span class="sd">        df (pd.DataFrame): dataframe with the following columns: description</span>
<a id="__codelineno-0-184" name="__codelineno-0-184"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-185" name="__codelineno-0-185"></a>
<a id="__codelineno-0-186" name="__codelineno-0-186"></a>    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Creating clonotypes count table</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">+</span><span class="s2">&quot;-&quot;</span><span class="o">*</span><span class="mi">50</span><span class="p">)</span>
<a id="__codelineno-0-187" name="__codelineno-0-187"></a>    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Overlap type: </span><span class="si">{</span><span class="n">overlap_type</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-0-188" name="__codelineno-0-188"></a>
<a id="__codelineno-0-189" name="__codelineno-0-189"></a>    <span class="n">aa</span><span class="p">,</span> <span class="n">check_v</span><span class="p">,</span> <span class="n">check_j</span> <span class="o">=</span> <span class="n">overlap_type_to_flags</span><span class="p">(</span><span class="n">overlap_type</span><span class="p">)</span>
<a id="__codelineno-0-190" name="__codelineno-0-190"></a>
<a id="__codelineno-0-191" name="__codelineno-0-191"></a>    <span class="n">clonoset_dicts</span> <span class="o">=</span> <span class="n">convert_clonosets_to_compact_dicts</span><span class="p">(</span><span class="n">clonosets_df</span><span class="p">,</span> <span class="n">cl_filter</span><span class="o">=</span><span class="n">cl_filter</span><span class="p">,</span>
<a id="__codelineno-0-192" name="__codelineno-0-192"></a>                                                        <span class="n">overlap_type</span><span class="o">=</span><span class="n">overlap_type</span><span class="p">,</span> <span class="n">by_freq</span><span class="o">=</span><span class="n">by_freq</span><span class="p">,</span> <span class="n">strict</span><span class="o">=</span><span class="ow">not</span> <span class="nb">bool</span><span class="p">(</span><span class="n">mismatches</span><span class="p">))</span>
<a id="__codelineno-0-193" name="__codelineno-0-193"></a>
<a id="__codelineno-0-194" name="__codelineno-0-194"></a>    <span class="n">clonotypes_by_cluster</span> <span class="o">=</span> <span class="n">convert_clusters_to_clonotype_list</span><span class="p">(</span><span class="n">clusters_list</span><span class="p">,</span> <span class="n">aa</span><span class="p">,</span> <span class="n">check_v</span><span class="p">,</span> <span class="n">check_j</span><span class="p">,</span> <span class="n">mismatches</span><span class="p">)</span>
<a id="__codelineno-0-195" name="__codelineno-0-195"></a>
<a id="__codelineno-0-196" name="__codelineno-0-196"></a>    <span class="n">tasks</span> <span class="o">=</span> <span class="p">[]</span>
<a id="__codelineno-0-197" name="__codelineno-0-197"></a>    <span class="k">for</span> <span class="n">sample_id</span> <span class="ow">in</span> <span class="n">clonoset_dicts</span><span class="p">:</span>
<a id="__codelineno-0-198" name="__codelineno-0-198"></a>        <span class="n">task</span> <span class="o">=</span> <span class="p">[</span><span class="n">clonotypes_by_cluster</span><span class="p">,</span> <span class="n">sample_id</span><span class="p">,</span> <span class="n">clonoset_dicts</span><span class="p">[</span><span class="n">sample_id</span><span class="p">],</span> <span class="n">mismatches</span><span class="p">]</span>
<a id="__codelineno-0-199" name="__codelineno-0-199"></a>        <span class="n">tasks</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">task</span><span class="p">)</span>
<a id="__codelineno-0-200" name="__codelineno-0-200"></a>
<a id="__codelineno-0-201" name="__codelineno-0-201"></a>    <span class="n">results</span> <span class="o">=</span> <span class="n">run_parallel_calculation</span><span class="p">(</span><span class="n">count_table_by_cluster_mp</span><span class="p">,</span> <span class="n">tasks</span><span class="p">,</span> <span class="s2">&quot;Counting cluster presence&quot;</span><span class="p">,</span> <span class="n">object_name</span><span class="o">=</span><span class="s2">&quot;clonosets&quot;</span><span class="p">)</span>
<a id="__codelineno-0-202" name="__codelineno-0-202"></a>    <span class="n">result_dict</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
<a id="__codelineno-0-203" name="__codelineno-0-203"></a>    <span class="k">for</span> <span class="n">result</span> <span class="ow">in</span> <span class="n">results</span><span class="p">:</span>
<a id="__codelineno-0-204" name="__codelineno-0-204"></a>        <span class="n">result_dict</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
<a id="__codelineno-0-205" name="__codelineno-0-205"></a>    <span class="n">count_table</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">result_dict</span><span class="p">)</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;index&quot;</span><span class="p">:</span><span class="s2">&quot;feature_id&quot;</span><span class="p">})</span>
<a id="__codelineno-0-206" name="__codelineno-0-206"></a>    <span class="n">count_table</span><span class="p">[</span><span class="s2">&quot;feature_id&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">count_table</span><span class="p">[</span><span class="s2">&quot;feature_id&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;cluster_</span><span class="si">{</span><span class="n">x</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-0-207" name="__codelineno-0-207"></a>
<a id="__codelineno-0-208" name="__codelineno-0-208"></a>    <span class="k">return</span> <span class="n">count_table</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h4 id="intersections.count_table_with_custom_clonotypes" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">count_table_with_custom_clonotypes</span><span class="p">(</span><span class="n">clonosets_df</span><span class="p">,</span> <span class="n">clones_df</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">cl_filter</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">overlap_type</span><span class="o">=</span><span class="s1">&#39;aaV&#39;</span><span class="p">,</span> <span class="n">mismatches</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">strict_presence</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">by_freq</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span></code>

</h4>


    <div class="doc doc-contents ">



<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>clones_df</code>
            </td>
            <td>
                  <code><span title="pandas.DataFrame">DataFrame</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>a dataframe with clonotypes to look for in <code>clonosets_df</code>. Should have the following columns:</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>repseq/intersections.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-731">731</a></span>
<span class="normal"><a href="#__codelineno-0-732">732</a></span>
<span class="normal"><a href="#__codelineno-0-733">733</a></span>
<span class="normal"><a href="#__codelineno-0-734">734</a></span>
<span class="normal"><a href="#__codelineno-0-735">735</a></span>
<span class="normal"><a href="#__codelineno-0-736">736</a></span>
<span class="normal"><a href="#__codelineno-0-737">737</a></span>
<span class="normal"><a href="#__codelineno-0-738">738</a></span>
<span class="normal"><a href="#__codelineno-0-739">739</a></span>
<span class="normal"><a href="#__codelineno-0-740">740</a></span>
<span class="normal"><a href="#__codelineno-0-741">741</a></span>
<span class="normal"><a href="#__codelineno-0-742">742</a></span>
<span class="normal"><a href="#__codelineno-0-743">743</a></span>
<span class="normal"><a href="#__codelineno-0-744">744</a></span>
<span class="normal"><a href="#__codelineno-0-745">745</a></span>
<span class="normal"><a href="#__codelineno-0-746">746</a></span>
<span class="normal"><a href="#__codelineno-0-747">747</a></span>
<span class="normal"><a href="#__codelineno-0-748">748</a></span>
<span class="normal"><a href="#__codelineno-0-749">749</a></span>
<span class="normal"><a href="#__codelineno-0-750">750</a></span>
<span class="normal"><a href="#__codelineno-0-751">751</a></span>
<span class="normal"><a href="#__codelineno-0-752">752</a></span>
<span class="normal"><a href="#__codelineno-0-753">753</a></span>
<span class="normal"><a href="#__codelineno-0-754">754</a></span>
<span class="normal"><a href="#__codelineno-0-755">755</a></span>
<span class="normal"><a href="#__codelineno-0-756">756</a></span>
<span class="normal"><a href="#__codelineno-0-757">757</a></span>
<span class="normal"><a href="#__codelineno-0-758">758</a></span>
<span class="normal"><a href="#__codelineno-0-759">759</a></span>
<span class="normal"><a href="#__codelineno-0-760">760</a></span>
<span class="normal"><a href="#__codelineno-0-761">761</a></span>
<span class="normal"><a href="#__codelineno-0-762">762</a></span>
<span class="normal"><a href="#__codelineno-0-763">763</a></span>
<span class="normal"><a href="#__codelineno-0-764">764</a></span>
<span class="normal"><a href="#__codelineno-0-765">765</a></span>
<span class="normal"><a href="#__codelineno-0-766">766</a></span>
<span class="normal"><a href="#__codelineno-0-767">767</a></span>
<span class="normal"><a href="#__codelineno-0-768">768</a></span>
<span class="normal"><a href="#__codelineno-0-769">769</a></span>
<span class="normal"><a href="#__codelineno-0-770">770</a></span>
<span class="normal"><a href="#__codelineno-0-771">771</a></span>
<span class="normal"><a href="#__codelineno-0-772">772</a></span>
<span class="normal"><a href="#__codelineno-0-773">773</a></span>
<span class="normal"><a href="#__codelineno-0-774">774</a></span>
<span class="normal"><a href="#__codelineno-0-775">775</a></span>
<span class="normal"><a href="#__codelineno-0-776">776</a></span>
<span class="normal"><a href="#__codelineno-0-777">777</a></span>
<span class="normal"><a href="#__codelineno-0-778">778</a></span>
<span class="normal"><a href="#__codelineno-0-779">779</a></span>
<span class="normal"><a href="#__codelineno-0-780">780</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-731" name="__codelineno-0-731"></a><span class="k">def</span><span class="w"> </span><span class="nf">count_table_with_custom_clonotypes</span><span class="p">(</span><span class="n">clonosets_df</span><span class="p">,</span> <span class="n">clones_df</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">cl_filter</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">overlap_type</span><span class="o">=</span><span class="s2">&quot;aaV&quot;</span><span class="p">,</span> <span class="n">mismatches</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">strict_presence</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">by_freq</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<a id="__codelineno-0-732" name="__codelineno-0-732"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-733" name="__codelineno-0-733"></a><span class="sd">    Args:</span>
<a id="__codelineno-0-734" name="__codelineno-0-734"></a><span class="sd">        clones_df (pd.DataFrame): a dataframe with clonotypes to look for in `clonosets_df`. Should have the following columns:</span>
<a id="__codelineno-0-735" name="__codelineno-0-735"></a><span class="sd">        `cdr3aa`, `cdr3nt` (at least one of these two), `v`, `j` (could be none of those). For instance, your input might have only `cdr3aa` column.</span>
<a id="__codelineno-0-736" name="__codelineno-0-736"></a><span class="sd">        If `overlap_type` isn&#39;t specified, it is determined individually for each clonotype in `clones_df`. In this case, if a row corresponding to</span>
<a id="__codelineno-0-737" name="__codelineno-0-737"></a><span class="sd">        a particular clonotype has non-empty values in both `cdr3aa` and `cdr3nt` columns, `cdr3aa` is chosen.</span>
<a id="__codelineno-0-738" name="__codelineno-0-738"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-739" name="__codelineno-0-739"></a>
<a id="__codelineno-0-740" name="__codelineno-0-740"></a>    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Creating clonotypes count table</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">+</span><span class="s2">&quot;-&quot;</span><span class="o">*</span><span class="mi">50</span><span class="p">)</span>
<a id="__codelineno-0-741" name="__codelineno-0-741"></a>    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Overlap type: </span><span class="si">{</span><span class="n">overlap_type</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-0-742" name="__codelineno-0-742"></a>    <span class="n">aa</span><span class="p">,</span> <span class="n">check_v</span><span class="p">,</span> <span class="n">check_j</span> <span class="o">=</span> <span class="n">overlap_type_to_flags</span><span class="p">(</span><span class="n">overlap_type</span><span class="p">)</span>
<a id="__codelineno-0-743" name="__codelineno-0-743"></a>    <span class="n">clonoset_dicts</span> <span class="o">=</span> <span class="n">convert_clonosets_to_compact_dicts</span><span class="p">(</span><span class="n">clonosets_df</span><span class="p">,</span> <span class="n">cl_filter</span><span class="o">=</span><span class="n">cl_filter</span><span class="p">,</span>
<a id="__codelineno-0-744" name="__codelineno-0-744"></a>                                                        <span class="n">overlap_type</span><span class="o">=</span><span class="n">overlap_type</span><span class="p">,</span> <span class="n">by_freq</span><span class="o">=</span><span class="n">by_freq</span><span class="p">,</span> <span class="n">strict</span><span class="o">=</span><span class="ow">not</span> <span class="nb">bool</span><span class="p">(</span><span class="n">mismatches</span><span class="p">))</span>
<a id="__codelineno-0-745" name="__codelineno-0-745"></a>
<a id="__codelineno-0-746" name="__codelineno-0-746"></a>    <span class="k">if</span> <span class="n">clones_df</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-747" name="__codelineno-0-747"></a>        <span class="c1"># creating dummy counts</span>
<a id="__codelineno-0-748" name="__codelineno-0-748"></a>        <span class="n">clones_df_copy</span> <span class="o">=</span> <span class="n">clones_df</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
<a id="__codelineno-0-749" name="__codelineno-0-749"></a>        <span class="n">clones_df_copy</span><span class="p">[</span><span class="s1">&#39;count&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">clones_df</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])]</span>
<a id="__codelineno-0-750" name="__codelineno-0-750"></a>        <span class="n">clones_df_copy</span><span class="p">[</span><span class="s1">&#39;freq&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">clones_df</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])]</span>
<a id="__codelineno-0-751" name="__codelineno-0-751"></a>        <span class="n">clonotype_list_dict</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;clonotype_list&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">}</span>
<a id="__codelineno-0-752" name="__codelineno-0-752"></a>
<a id="__codelineno-0-753" name="__codelineno-0-753"></a>        <span class="n">clonotype_list_dict</span><span class="p">[</span><span class="s1">&#39;clonotype_list&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">prepare_clonoset_for_intersection</span><span class="p">(</span><span class="n">clones_df_copy</span><span class="p">,</span> 
<a id="__codelineno-0-754" name="__codelineno-0-754"></a>                                                                                <span class="n">overlap_type</span><span class="o">=</span><span class="n">overlap_type</span><span class="p">,</span>
<a id="__codelineno-0-755" name="__codelineno-0-755"></a>                                                                                <span class="n">len_vj_format</span><span class="o">=</span><span class="nb">bool</span><span class="p">(</span><span class="n">mismatches</span><span class="p">))</span>  
<a id="__codelineno-0-756" name="__codelineno-0-756"></a>
<a id="__codelineno-0-757" name="__codelineno-0-757"></a>        <span class="n">unique_clonotypes</span> <span class="o">=</span> <span class="n">find_unique_clonotypes_in_clonoset_dicts</span><span class="p">(</span><span class="n">clonotype_list_dict</span><span class="p">)</span>
<a id="__codelineno-0-758" name="__codelineno-0-758"></a>    <span class="k">else</span><span class="p">:</span> 
<a id="__codelineno-0-759" name="__codelineno-0-759"></a>        <span class="n">unique_clonotypes</span> <span class="o">=</span> <span class="n">find_unique_clonotypes_in_clonoset_dicts</span><span class="p">(</span><span class="n">clonoset_dicts</span><span class="p">)</span>
<a id="__codelineno-0-760" name="__codelineno-0-760"></a>
<a id="__codelineno-0-761" name="__codelineno-0-761"></a>    <span class="n">tasks</span> <span class="o">=</span> <span class="p">[]</span>
<a id="__codelineno-0-762" name="__codelineno-0-762"></a>    <span class="k">for</span> <span class="n">sample_id</span> <span class="ow">in</span> <span class="n">clonoset_dicts</span><span class="p">:</span>
<a id="__codelineno-0-763" name="__codelineno-0-763"></a>        <span class="n">task</span> <span class="o">=</span> <span class="p">[</span><span class="n">unique_clonotypes</span><span class="p">,</span> <span class="n">sample_id</span><span class="p">,</span> <span class="n">clonoset_dicts</span><span class="p">[</span><span class="n">sample_id</span><span class="p">],</span> <span class="n">mismatches</span><span class="p">,</span> <span class="n">strict_presence</span><span class="p">]</span>
<a id="__codelineno-0-764" name="__codelineno-0-764"></a>        <span class="n">tasks</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">task</span><span class="p">)</span>
<a id="__codelineno-0-765" name="__codelineno-0-765"></a>
<a id="__codelineno-0-766" name="__codelineno-0-766"></a>    <span class="n">results</span> <span class="o">=</span> <span class="n">run_parallel_calculation</span><span class="p">(</span><span class="n">count_table_mp</span><span class="p">,</span> <span class="n">tasks</span><span class="p">,</span> <span class="s2">&quot;Counting features&quot;</span><span class="p">,</span> <span class="n">object_name</span><span class="o">=</span><span class="s2">&quot;clonosets&quot;</span><span class="p">)</span>
<a id="__codelineno-0-767" name="__codelineno-0-767"></a>    <span class="n">result_dict</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
<a id="__codelineno-0-768" name="__codelineno-0-768"></a>    <span class="k">for</span> <span class="n">result</span> <span class="ow">in</span> <span class="n">results</span><span class="p">:</span>
<a id="__codelineno-0-769" name="__codelineno-0-769"></a>        <span class="n">result_dict</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
<a id="__codelineno-0-770" name="__codelineno-0-770"></a>    <span class="n">count_table</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">result_dict</span><span class="p">)</span>
<a id="__codelineno-0-771" name="__codelineno-0-771"></a>    <span class="k">if</span> <span class="n">aa</span><span class="p">:</span>
<a id="__codelineno-0-772" name="__codelineno-0-772"></a>        <span class="n">count_table</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;cdr3aa&#39;</span><span class="p">,</span> <span class="p">[</span><span class="n">ct</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">ct</span> <span class="ow">in</span> <span class="n">unique_clonotypes</span><span class="p">])</span>
<a id="__codelineno-0-773" name="__codelineno-0-773"></a>    <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-774" name="__codelineno-0-774"></a>        <span class="n">count_table</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;cdr3nt&#39;</span><span class="p">,</span> <span class="p">[</span><span class="n">ct</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">ct</span> <span class="ow">in</span> <span class="n">unique_clonotypes</span><span class="p">])</span>
<a id="__codelineno-0-775" name="__codelineno-0-775"></a>    <span class="k">if</span> <span class="n">check_v</span><span class="p">:</span>
<a id="__codelineno-0-776" name="__codelineno-0-776"></a>        <span class="n">count_table</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;v&#39;</span><span class="p">,</span> <span class="p">[</span><span class="n">ct</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">ct</span> <span class="ow">in</span> <span class="n">unique_clonotypes</span><span class="p">])</span>
<a id="__codelineno-0-777" name="__codelineno-0-777"></a>    <span class="k">if</span> <span class="n">check_j</span><span class="p">:</span>
<a id="__codelineno-0-778" name="__codelineno-0-778"></a>        <span class="n">count_table</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;j&#39;</span><span class="p">,</span> <span class="p">[</span><span class="n">ct</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="k">for</span> <span class="n">ct</span> <span class="ow">in</span> <span class="n">unique_clonotypes</span><span class="p">])</span>
<a id="__codelineno-0-779" name="__codelineno-0-779"></a>    <span class="n">count_table</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="n">unique_clonotypes</span>
<a id="__codelineno-0-780" name="__codelineno-0-780"></a>    <span class="k">return</span> <span class="n">count_table</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h4 id="intersections.find_intersecting_clonotypes" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">find_intersecting_clonotypes</span><span class="p">(</span><span class="n">clonosets_df</span><span class="p">,</span> <span class="n">cl_filter</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">overlap_type</span><span class="o">=</span><span class="s1">&#39;aaV&#39;</span><span class="p">,</span> <span class="n">mismatches</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">metric</span><span class="o">=</span><span class="s1">&#39;F2&#39;</span><span class="p">,</span> <span class="n">clonosets_df2</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">cl_filter2</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>

</h4>


    <div class="doc doc-contents ">

        <p>Calculating overlap distances between multiple repseq samples using F2 of F metrics
The result of this function may be used for heatmap+clusterization of samples or for MDS plots</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>clonosets_df</code>
            </td>
            <td>
                  <code><span title="pandas.DataFrame">DataFrame</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>contains three columns - <code>sample_id</code> and <code>filename</code> columns,
filename - full path to clonoset file. Clonoset file may be of MiXCR3/MiXCR4 or VDJtools format
sample_id's should be all unique in this DF</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>cl_filter</code>
            </td>
            <td>
                  <code><span title="repseq.clone_filter.Filter">Filter</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>clonoset filter - object from <code>clone_filter.py</code> module. It is applied to clonosets in <code>clonosets_df</code>.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>overlap_type</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>possible values are <code>aa</code>, <code>aaV</code>, <code>aaVJ</code>, <code>nt</code>, <code>ntV</code>, <code>ntVJ</code>. aa/nt define which CDR3 sequence
to use (amino acid or nucleotide). V/J in the overlap_type define whether to check V or J segments
to decide if clonotypes are equal</p>
              </div>
            </td>
            <td>
                  <code>&#39;aaV&#39;</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>mismatches</code>
            </td>
            <td>
                  <code><span title="int">int</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Max number of single-letter mismatches in clonotypes sequences 
for them to be treated similar, i.e. hamming distance.</p>
              </div>
            </td>
            <td>
                  <code>0</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>by_umi</code>
            </td>
            <td>
                  <code><span title="bool">bool</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>set =True for MiXCR4 clonosets to select count/frequency of clonotypes 
in UMI's if they exist in implemented protocol</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>metric</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>possible values - <code>F</code>, <code>F2</code> or <code>C</code>. Default <code>F2</code>. <code>F2</code> - sum of sqrt of product of 
similar clonotype frequencies in two clonosets. <code>F</code> - sqrt of the sum of frequency products.
<code>C</code> - total frequency of clonotypes in <code>sample1</code>, that are similar to clonotypes in <code>sample2</code></p>
              </div>
            </td>
            <td>
                  <code>&#39;F2&#39;</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>clonosets_df2</code>
            </td>
            <td>
                  <code><span title="pandas.DataFrame">DataFrame</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If <code>clonosets_df2</code> is None (default), samples within <code>clonosets_df</code> are compared with each other; 
Otherwise, the comparison is performed exclusively between samples from <code>clonosets_df</code> and <code>clonosets_df2</code>. </p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>cl_filter2</code>
            </td>
            <td>
                  <code><span title="repseq.clone_filter.Filter">Filter</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>clonoset filter - object from <code>clone_filter.py</code> module. It is applied to clonosets in <code>clonosets_df2</code>. 
If there are samples with non-unique sample_ids between the two dataframes, both filters will be applied to those samples.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
      </tbody>
    </table>
        <p>Important: similar clonotypes by <code>overlap_type</code> in one particular clonoset are NOT combined into one
and are treated as different clonotypes.</p>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
<th>Name</th>          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
<td><code>df</code></td>            <td>
                  <code><span title="pandas.DataFrame">DataFrame</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>dataframe with following columns: <code>clone</code>, <code>sample1_count</code>, <code>sample2_count</code>, <code>sample1</code>, <code>sample2</code>, <code>pair</code>. 
<code>clone</code> - is tuple, containing sequence (aa or nt), plus V or J if they are required by the metric
count columns contain freq/count of the clone in sample
pair column is made for easy separation of possibly huge DataFrame into overlapping pairs</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>repseq/intersections.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-495">495</a></span>
<span class="normal"><a href="#__codelineno-0-496">496</a></span>
<span class="normal"><a href="#__codelineno-0-497">497</a></span>
<span class="normal"><a href="#__codelineno-0-498">498</a></span>
<span class="normal"><a href="#__codelineno-0-499">499</a></span>
<span class="normal"><a href="#__codelineno-0-500">500</a></span>
<span class="normal"><a href="#__codelineno-0-501">501</a></span>
<span class="normal"><a href="#__codelineno-0-502">502</a></span>
<span class="normal"><a href="#__codelineno-0-503">503</a></span>
<span class="normal"><a href="#__codelineno-0-504">504</a></span>
<span class="normal"><a href="#__codelineno-0-505">505</a></span>
<span class="normal"><a href="#__codelineno-0-506">506</a></span>
<span class="normal"><a href="#__codelineno-0-507">507</a></span>
<span class="normal"><a href="#__codelineno-0-508">508</a></span>
<span class="normal"><a href="#__codelineno-0-509">509</a></span>
<span class="normal"><a href="#__codelineno-0-510">510</a></span>
<span class="normal"><a href="#__codelineno-0-511">511</a></span>
<span class="normal"><a href="#__codelineno-0-512">512</a></span>
<span class="normal"><a href="#__codelineno-0-513">513</a></span>
<span class="normal"><a href="#__codelineno-0-514">514</a></span>
<span class="normal"><a href="#__codelineno-0-515">515</a></span>
<span class="normal"><a href="#__codelineno-0-516">516</a></span>
<span class="normal"><a href="#__codelineno-0-517">517</a></span>
<span class="normal"><a href="#__codelineno-0-518">518</a></span>
<span class="normal"><a href="#__codelineno-0-519">519</a></span>
<span class="normal"><a href="#__codelineno-0-520">520</a></span>
<span class="normal"><a href="#__codelineno-0-521">521</a></span>
<span class="normal"><a href="#__codelineno-0-522">522</a></span>
<span class="normal"><a href="#__codelineno-0-523">523</a></span>
<span class="normal"><a href="#__codelineno-0-524">524</a></span>
<span class="normal"><a href="#__codelineno-0-525">525</a></span>
<span class="normal"><a href="#__codelineno-0-526">526</a></span>
<span class="normal"><a href="#__codelineno-0-527">527</a></span>
<span class="normal"><a href="#__codelineno-0-528">528</a></span>
<span class="normal"><a href="#__codelineno-0-529">529</a></span>
<span class="normal"><a href="#__codelineno-0-530">530</a></span>
<span class="normal"><a href="#__codelineno-0-531">531</a></span>
<span class="normal"><a href="#__codelineno-0-532">532</a></span>
<span class="normal"><a href="#__codelineno-0-533">533</a></span>
<span class="normal"><a href="#__codelineno-0-534">534</a></span>
<span class="normal"><a href="#__codelineno-0-535">535</a></span>
<span class="normal"><a href="#__codelineno-0-536">536</a></span>
<span class="normal"><a href="#__codelineno-0-537">537</a></span>
<span class="normal"><a href="#__codelineno-0-538">538</a></span>
<span class="normal"><a href="#__codelineno-0-539">539</a></span>
<span class="normal"><a href="#__codelineno-0-540">540</a></span>
<span class="normal"><a href="#__codelineno-0-541">541</a></span>
<span class="normal"><a href="#__codelineno-0-542">542</a></span>
<span class="normal"><a href="#__codelineno-0-543">543</a></span>
<span class="normal"><a href="#__codelineno-0-544">544</a></span>
<span class="normal"><a href="#__codelineno-0-545">545</a></span>
<span class="normal"><a href="#__codelineno-0-546">546</a></span>
<span class="normal"><a href="#__codelineno-0-547">547</a></span>
<span class="normal"><a href="#__codelineno-0-548">548</a></span>
<span class="normal"><a href="#__codelineno-0-549">549</a></span>
<span class="normal"><a href="#__codelineno-0-550">550</a></span>
<span class="normal"><a href="#__codelineno-0-551">551</a></span>
<span class="normal"><a href="#__codelineno-0-552">552</a></span>
<span class="normal"><a href="#__codelineno-0-553">553</a></span>
<span class="normal"><a href="#__codelineno-0-554">554</a></span>
<span class="normal"><a href="#__codelineno-0-555">555</a></span>
<span class="normal"><a href="#__codelineno-0-556">556</a></span>
<span class="normal"><a href="#__codelineno-0-557">557</a></span>
<span class="normal"><a href="#__codelineno-0-558">558</a></span>
<span class="normal"><a href="#__codelineno-0-559">559</a></span>
<span class="normal"><a href="#__codelineno-0-560">560</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-495" name="__codelineno-0-495"></a><span class="k">def</span><span class="w"> </span><span class="nf">find_intersecting_clonotypes</span><span class="p">(</span><span class="n">clonosets_df</span><span class="p">,</span> <span class="n">cl_filter</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">overlap_type</span><span class="o">=</span><span class="s2">&quot;aaV&quot;</span><span class="p">,</span> <span class="n">mismatches</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">metric</span><span class="o">=</span><span class="s2">&quot;F2&quot;</span><span class="p">,</span> <span class="n">clonosets_df2</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">cl_filter2</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<a id="__codelineno-0-496" name="__codelineno-0-496"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-497" name="__codelineno-0-497"></a><span class="sd">    Calculating overlap distances between multiple repseq samples using F2 of F metrics</span>
<a id="__codelineno-0-498" name="__codelineno-0-498"></a><span class="sd">    The result of this function may be used for heatmap+clusterization of samples or for MDS plots</span>
<a id="__codelineno-0-499" name="__codelineno-0-499"></a>
<a id="__codelineno-0-500" name="__codelineno-0-500"></a><span class="sd">    Args:</span>
<a id="__codelineno-0-501" name="__codelineno-0-501"></a><span class="sd">        clonosets_df (pd.DataFrame): contains three columns - `sample_id` and `filename` columns,</span>
<a id="__codelineno-0-502" name="__codelineno-0-502"></a><span class="sd">            filename - full path to clonoset file. Clonoset file may be of MiXCR3/MiXCR4 or VDJtools format</span>
<a id="__codelineno-0-503" name="__codelineno-0-503"></a><span class="sd">            sample_id&#39;s should be all unique in this DF</span>
<a id="__codelineno-0-504" name="__codelineno-0-504"></a><span class="sd">        cl_filter (Filter): clonoset filter - object from `clone_filter.py` module. It is applied to clonosets in `clonosets_df`.</span>
<a id="__codelineno-0-505" name="__codelineno-0-505"></a><span class="sd">        overlap_type (str): possible values are `aa`, `aaV`, `aaVJ`, `nt`, `ntV`, `ntVJ`. aa/nt define which CDR3 sequence</span>
<a id="__codelineno-0-506" name="__codelineno-0-506"></a><span class="sd">            to use (amino acid or nucleotide). V/J in the overlap_type define whether to check V or J segments</span>
<a id="__codelineno-0-507" name="__codelineno-0-507"></a><span class="sd">            to decide if clonotypes are equal</span>
<a id="__codelineno-0-508" name="__codelineno-0-508"></a><span class="sd">        mismatches (int): Max number of single-letter mismatches in clonotypes sequences </span>
<a id="__codelineno-0-509" name="__codelineno-0-509"></a><span class="sd">            for them to be treated similar, i.e. hamming distance.</span>
<a id="__codelineno-0-510" name="__codelineno-0-510"></a><span class="sd">        by_umi (bool): set =True for MiXCR4 clonosets to select count/frequency of clonotypes </span>
<a id="__codelineno-0-511" name="__codelineno-0-511"></a><span class="sd">            in UMI&#39;s if they exist in implemented protocol</span>
<a id="__codelineno-0-512" name="__codelineno-0-512"></a><span class="sd">        metric (str): possible values - `F`, `F2` or `C`. Default `F2`. `F2` - sum of sqrt of product of </span>
<a id="__codelineno-0-513" name="__codelineno-0-513"></a><span class="sd">            similar clonotype frequencies in two clonosets. `F` - sqrt of the sum of frequency products.</span>
<a id="__codelineno-0-514" name="__codelineno-0-514"></a><span class="sd">            `C` - total frequency of clonotypes in `sample1`, that are similar to clonotypes in `sample2`</span>
<a id="__codelineno-0-515" name="__codelineno-0-515"></a><span class="sd">        clonosets_df2 (pd.DataFrame): If `clonosets_df2` is None (default), samples within `clonosets_df` are compared with each other; </span>
<a id="__codelineno-0-516" name="__codelineno-0-516"></a><span class="sd">            Otherwise, the comparison is performed exclusively between samples from `clonosets_df` and `clonosets_df2`. </span>
<a id="__codelineno-0-517" name="__codelineno-0-517"></a><span class="sd">        cl_filter2 (Filter): clonoset filter - object from `clone_filter.py` module. It is applied to clonosets in `clonosets_df2`. </span>
<a id="__codelineno-0-518" name="__codelineno-0-518"></a><span class="sd">            If there are samples with non-unique sample_ids between the two dataframes, both filters will be applied to those samples.</span>
<a id="__codelineno-0-519" name="__codelineno-0-519"></a>
<a id="__codelineno-0-520" name="__codelineno-0-520"></a>
<a id="__codelineno-0-521" name="__codelineno-0-521"></a><span class="sd">    Important: similar clonotypes by `overlap_type` in one particular clonoset are NOT combined into one</span>
<a id="__codelineno-0-522" name="__codelineno-0-522"></a><span class="sd">    and are treated as different clonotypes.</span>
<a id="__codelineno-0-523" name="__codelineno-0-523"></a>
<a id="__codelineno-0-524" name="__codelineno-0-524"></a><span class="sd">    Returns:</span>
<a id="__codelineno-0-525" name="__codelineno-0-525"></a><span class="sd">        df (pd.DataFrame): dataframe with following columns: `clone`, `sample1_count`, `sample2_count`, `sample1`, `sample2`, `pair`. </span>
<a id="__codelineno-0-526" name="__codelineno-0-526"></a><span class="sd">            `clone` - is tuple, containing sequence (aa or nt), plus V or J if they are required by the metric</span>
<a id="__codelineno-0-527" name="__codelineno-0-527"></a><span class="sd">            count columns contain freq/count of the clone in sample</span>
<a id="__codelineno-0-528" name="__codelineno-0-528"></a><span class="sd">            pair column is made for easy separation of possibly huge DataFrame into overlapping pairs</span>
<a id="__codelineno-0-529" name="__codelineno-0-529"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-530" name="__codelineno-0-530"></a>
<a id="__codelineno-0-531" name="__codelineno-0-531"></a>
<a id="__codelineno-0-532" name="__codelineno-0-532"></a>    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Intersecting clones in clonosets</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">+</span><span class="s2">&quot;-&quot;</span><span class="o">*</span><span class="mi">50</span><span class="p">)</span>
<a id="__codelineno-0-533" name="__codelineno-0-533"></a>    <span class="n">aa</span><span class="p">,</span> <span class="n">check_v</span><span class="p">,</span> <span class="n">check_j</span> <span class="o">=</span> <span class="n">overlap_type_to_flags</span><span class="p">(</span><span class="n">overlap_type</span><span class="p">)</span>
<a id="__codelineno-0-534" name="__codelineno-0-534"></a>    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Overlap type: </span><span class="si">{</span><span class="n">overlap_type</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-0-535" name="__codelineno-0-535"></a>
<a id="__codelineno-0-536" name="__codelineno-0-536"></a>    <span class="n">clonoset_lists</span><span class="p">,</span> <span class="n">samples_total</span><span class="p">,</span> <span class="n">two_dataframes</span><span class="p">,</span> <span class="n">sample_list</span><span class="p">,</span> <span class="n">sample_list2</span> <span class="o">=</span> <span class="n">prepare_clonotypes_dfs_for_intersections</span><span class="p">(</span><span class="n">clonosets_df</span><span class="p">,</span> <span class="n">clonosets_df2</span><span class="p">,</span>
<a id="__codelineno-0-537" name="__codelineno-0-537"></a>                                                                                                                        <span class="n">cl_filter</span><span class="p">,</span> <span class="n">cl_filter2</span><span class="p">,</span>
<a id="__codelineno-0-538" name="__codelineno-0-538"></a>                                                                                                                        <span class="n">overlap_type</span><span class="p">,</span> <span class="n">strict</span><span class="o">=</span><span class="ow">not</span> <span class="nb">bool</span><span class="p">(</span><span class="n">mismatches</span><span class="p">))</span>
<a id="__codelineno-0-539" name="__codelineno-0-539"></a>
<a id="__codelineno-0-540" name="__codelineno-0-540"></a>    <span class="c1"># generating a set of tasks</span>
<a id="__codelineno-0-541" name="__codelineno-0-541"></a>
<a id="__codelineno-0-542" name="__codelineno-0-542"></a>    <span class="n">tasks</span> <span class="o">=</span> <span class="p">[]</span>
<a id="__codelineno-0-543" name="__codelineno-0-543"></a>
<a id="__codelineno-0-544" name="__codelineno-0-544"></a>    <span class="k">if</span> <span class="n">two_dataframes</span><span class="p">:</span>
<a id="__codelineno-0-545" name="__codelineno-0-545"></a>        <span class="k">for</span> <span class="n">sample1</span> <span class="ow">in</span> <span class="n">sample_list</span><span class="p">:</span>
<a id="__codelineno-0-546" name="__codelineno-0-546"></a>            <span class="k">for</span> <span class="n">sample2</span> <span class="ow">in</span> <span class="n">sample_list2</span><span class="p">:</span>
<a id="__codelineno-0-547" name="__codelineno-0-547"></a>                <span class="n">tasks</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">sample1</span><span class="p">,</span> <span class="n">sample2</span><span class="p">,</span> <span class="n">clonoset_lists</span><span class="p">,</span> <span class="n">check_v</span><span class="p">,</span> <span class="n">check_j</span><span class="p">,</span> <span class="n">mismatches</span><span class="p">))</span>        
<a id="__codelineno-0-548" name="__codelineno-0-548"></a>    <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-549" name="__codelineno-0-549"></a>        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">samples_total</span><span class="p">):</span>
<a id="__codelineno-0-550" name="__codelineno-0-550"></a>            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">samples_total</span><span class="p">):</span>
<a id="__codelineno-0-551" name="__codelineno-0-551"></a>                <span class="n">sample1</span> <span class="o">=</span> <span class="n">sample_list</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
<a id="__codelineno-0-552" name="__codelineno-0-552"></a>                <span class="n">sample2</span> <span class="o">=</span> <span class="n">sample_list</span><span class="p">[</span><span class="n">j</span><span class="p">]</span>
<a id="__codelineno-0-553" name="__codelineno-0-553"></a>                <span class="k">if</span> <span class="n">sample1</span> <span class="o">!=</span> <span class="n">sample2</span><span class="p">:</span>
<a id="__codelineno-0-554" name="__codelineno-0-554"></a>                    <span class="n">tasks</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">sample1</span><span class="p">,</span> <span class="n">sample2</span><span class="p">,</span> <span class="n">clonoset_lists</span><span class="p">,</span> <span class="n">check_v</span><span class="p">,</span> <span class="n">check_j</span><span class="p">,</span> <span class="n">mismatches</span><span class="p">))</span>
<a id="__codelineno-0-555" name="__codelineno-0-555"></a>
<a id="__codelineno-0-556" name="__codelineno-0-556"></a>
<a id="__codelineno-0-557" name="__codelineno-0-557"></a>    <span class="c1"># run calculation in parallel</span>
<a id="__codelineno-0-558" name="__codelineno-0-558"></a>    <span class="n">result_list</span> <span class="o">=</span> <span class="n">run_parallel_calculation</span><span class="p">(</span><span class="n">find_overlapping_clones_in_two_clone_dicts</span><span class="p">,</span> <span class="n">tasks</span><span class="p">,</span> <span class="s2">&quot;Intersecting clonosets&quot;</span><span class="p">,</span> <span class="n">object_name</span><span class="o">=</span><span class="s2">&quot;pairs&quot;</span><span class="p">)</span>
<a id="__codelineno-0-559" name="__codelineno-0-559"></a>
<a id="__codelineno-0-560" name="__codelineno-0-560"></a>    <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">result_list</span><span class="p">)</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h4 id="intersections.intersect_clones_in_samples_batch" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">intersect_clones_in_samples_batch</span><span class="p">(</span><span class="n">clonosets_df</span><span class="p">,</span> <span class="n">cl_filter</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">overlap_type</span><span class="o">=</span><span class="s1">&#39;aaV&#39;</span><span class="p">,</span> <span class="n">by_freq</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">clonosets_df2</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">cl_filter2</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>

</h4>


    <div class="doc doc-contents ">

        <p>Calculating frequencies of intersecting clonotypes between multiple repseq samples.
The result of this function may be used for scatterplots of frequencies/counts of 
overlapping clonotypes</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>clonosets_df</code>
            </td>
            <td>
                  <code><span title="pandas.DataFrame">DataFrame</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>contains three columns - <code>sample_id</code> and <code>filename</code> columns,
<code>filename</code> - full path to clonoset file. Clonoset file may be of MiXCR3/MiXCR4 or VDJtools format
sample_id's should be all unique in this DF</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>overlap_type</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>possible values are <code>aa</code>, <code>aaV</code>, <code>aaVJ</code>, <code>nt</code>, <code>ntV</code>, <code>ntVJ</code>. aa/nt define which CDR3 sequence
to use (amino acid or nucleotide). V/J in the overlap_type define whether to check V or J segments
to decide if clonotypes are equal</p>
              </div>
            </td>
            <td>
                  <code>&#39;aaV&#39;</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>by_umi</code>
            </td>
            <td>
                  <code><span title="bool">bool</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>set <code>=True</code> for MiXCR4 clonosets to select count/frequency of clonotypes 
in UMI's if they exist in implemented protocol</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>by_freq</code>
            </td>
            <td>
                  <code><span title="bool">bool</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>default is <code>True</code> - this means that the intersect metric is frequency of clonotype, 
but not its count</p>
              </div>
            </td>
            <td>
                  <code>True</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>only_functional</code>
            </td>
            <td>
                  <code><span title="bool">bool</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>use only functional clonotypes (do not contain stop codons or
frameshifts in CDR3 sequences: * or _ symbol in CDR3aa sequence). The frequences are recounted to
1 after filtering of non-functional clonotypes</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>
        <p>Important: when using particular overlap type, similar clonotypes in one particular clonoset are
combined into one with summation of counts/frequencies.</p>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
<th>Name</th>          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
<td><code>df</code></td>            <td>
                  <code><span title="pandas.DataFrame">DataFrame</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>dataframe with following columns: <code>clone</code>, <code>sample1_count</code>, <code>sample2_count</code>, <code>sample1</code>, <code>sample2</code>, <code>pair</code>
clone - is tuple, containing sequence (aa or nt), plus V or J if they are required by the metric
count columns contain freq/count of the clone in sample
pair column is made for easy separation of possibly huge DataFrame into overlapping pairs</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>repseq/intersections.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-20">20</a></span>
<span class="normal"><a href="#__codelineno-0-21">21</a></span>
<span class="normal"><a href="#__codelineno-0-22">22</a></span>
<span class="normal"><a href="#__codelineno-0-23">23</a></span>
<span class="normal"><a href="#__codelineno-0-24">24</a></span>
<span class="normal"><a href="#__codelineno-0-25">25</a></span>
<span class="normal"><a href="#__codelineno-0-26">26</a></span>
<span class="normal"><a href="#__codelineno-0-27">27</a></span>
<span class="normal"><a href="#__codelineno-0-28">28</a></span>
<span class="normal"><a href="#__codelineno-0-29">29</a></span>
<span class="normal"><a href="#__codelineno-0-30">30</a></span>
<span class="normal"><a href="#__codelineno-0-31">31</a></span>
<span class="normal"><a href="#__codelineno-0-32">32</a></span>
<span class="normal"><a href="#__codelineno-0-33">33</a></span>
<span class="normal"><a href="#__codelineno-0-34">34</a></span>
<span class="normal"><a href="#__codelineno-0-35">35</a></span>
<span class="normal"><a href="#__codelineno-0-36">36</a></span>
<span class="normal"><a href="#__codelineno-0-37">37</a></span>
<span class="normal"><a href="#__codelineno-0-38">38</a></span>
<span class="normal"><a href="#__codelineno-0-39">39</a></span>
<span class="normal"><a href="#__codelineno-0-40">40</a></span>
<span class="normal"><a href="#__codelineno-0-41">41</a></span>
<span class="normal"><a href="#__codelineno-0-42">42</a></span>
<span class="normal"><a href="#__codelineno-0-43">43</a></span>
<span class="normal"><a href="#__codelineno-0-44">44</a></span>
<span class="normal"><a href="#__codelineno-0-45">45</a></span>
<span class="normal"><a href="#__codelineno-0-46">46</a></span>
<span class="normal"><a href="#__codelineno-0-47">47</a></span>
<span class="normal"><a href="#__codelineno-0-48">48</a></span>
<span class="normal"><a href="#__codelineno-0-49">49</a></span>
<span class="normal"><a href="#__codelineno-0-50">50</a></span>
<span class="normal"><a href="#__codelineno-0-51">51</a></span>
<span class="normal"><a href="#__codelineno-0-52">52</a></span>
<span class="normal"><a href="#__codelineno-0-53">53</a></span>
<span class="normal"><a href="#__codelineno-0-54">54</a></span>
<span class="normal"><a href="#__codelineno-0-55">55</a></span>
<span class="normal"><a href="#__codelineno-0-56">56</a></span>
<span class="normal"><a href="#__codelineno-0-57">57</a></span>
<span class="normal"><a href="#__codelineno-0-58">58</a></span>
<span class="normal"><a href="#__codelineno-0-59">59</a></span>
<span class="normal"><a href="#__codelineno-0-60">60</a></span>
<span class="normal"><a href="#__codelineno-0-61">61</a></span>
<span class="normal"><a href="#__codelineno-0-62">62</a></span>
<span class="normal"><a href="#__codelineno-0-63">63</a></span>
<span class="normal"><a href="#__codelineno-0-64">64</a></span>
<span class="normal"><a href="#__codelineno-0-65">65</a></span>
<span class="normal"><a href="#__codelineno-0-66">66</a></span>
<span class="normal"><a href="#__codelineno-0-67">67</a></span>
<span class="normal"><a href="#__codelineno-0-68">68</a></span>
<span class="normal"><a href="#__codelineno-0-69">69</a></span>
<span class="normal"><a href="#__codelineno-0-70">70</a></span>
<span class="normal"><a href="#__codelineno-0-71">71</a></span>
<span class="normal"><a href="#__codelineno-0-72">72</a></span>
<span class="normal"><a href="#__codelineno-0-73">73</a></span>
<span class="normal"><a href="#__codelineno-0-74">74</a></span>
<span class="normal"><a href="#__codelineno-0-75">75</a></span>
<span class="normal"><a href="#__codelineno-0-76">76</a></span>
<span class="normal"><a href="#__codelineno-0-77">77</a></span>
<span class="normal"><a href="#__codelineno-0-78">78</a></span>
<span class="normal"><a href="#__codelineno-0-79">79</a></span>
<span class="normal"><a href="#__codelineno-0-80">80</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-20" name="__codelineno-0-20"></a><span class="k">def</span><span class="w"> </span><span class="nf">intersect_clones_in_samples_batch</span><span class="p">(</span><span class="n">clonosets_df</span><span class="p">,</span> <span class="n">cl_filter</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">overlap_type</span><span class="o">=</span><span class="s2">&quot;aaV&quot;</span><span class="p">,</span> <span class="n">by_freq</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">clonosets_df2</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">cl_filter2</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<a id="__codelineno-0-21" name="__codelineno-0-21"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-22" name="__codelineno-0-22"></a><span class="sd">    Calculating frequencies of intersecting clonotypes between multiple repseq samples.</span>
<a id="__codelineno-0-23" name="__codelineno-0-23"></a><span class="sd">    The result of this function may be used for scatterplots of frequencies/counts of </span>
<a id="__codelineno-0-24" name="__codelineno-0-24"></a><span class="sd">    overlapping clonotypes</span>
<a id="__codelineno-0-25" name="__codelineno-0-25"></a>
<a id="__codelineno-0-26" name="__codelineno-0-26"></a><span class="sd">    Args:</span>
<a id="__codelineno-0-27" name="__codelineno-0-27"></a><span class="sd">        clonosets_df (pd.DataFrame): contains three columns - `sample_id` and `filename` columns,</span>
<a id="__codelineno-0-28" name="__codelineno-0-28"></a><span class="sd">            `filename` - full path to clonoset file. Clonoset file may be of MiXCR3/MiXCR4 or VDJtools format</span>
<a id="__codelineno-0-29" name="__codelineno-0-29"></a><span class="sd">            sample_id&#39;s should be all unique in this DF</span>
<a id="__codelineno-0-30" name="__codelineno-0-30"></a><span class="sd">        overlap_type (str): possible values are `aa`, `aaV`, `aaVJ`, `nt`, `ntV`, `ntVJ`. aa/nt define which CDR3 sequence</span>
<a id="__codelineno-0-31" name="__codelineno-0-31"></a><span class="sd">            to use (amino acid or nucleotide). V/J in the overlap_type define whether to check V or J segments</span>
<a id="__codelineno-0-32" name="__codelineno-0-32"></a><span class="sd">            to decide if clonotypes are equal</span>
<a id="__codelineno-0-33" name="__codelineno-0-33"></a><span class="sd">        by_umi (bool): set `=True` for MiXCR4 clonosets to select count/frequency of clonotypes </span>
<a id="__codelineno-0-34" name="__codelineno-0-34"></a><span class="sd">            in UMI&#39;s if they exist in implemented protocol</span>
<a id="__codelineno-0-35" name="__codelineno-0-35"></a><span class="sd">        by_freq (bool): default is `True` - this means that the intersect metric is frequency of clonotype, </span>
<a id="__codelineno-0-36" name="__codelineno-0-36"></a><span class="sd">            but not its count</span>
<a id="__codelineno-0-37" name="__codelineno-0-37"></a><span class="sd">        only_functional (bool): use only functional clonotypes (do not contain stop codons or</span>
<a id="__codelineno-0-38" name="__codelineno-0-38"></a><span class="sd">            frameshifts in CDR3 sequences: * or _ symbol in CDR3aa sequence). The frequences are recounted to</span>
<a id="__codelineno-0-39" name="__codelineno-0-39"></a><span class="sd">            1 after filtering of non-functional clonotypes</span>
<a id="__codelineno-0-40" name="__codelineno-0-40"></a>
<a id="__codelineno-0-41" name="__codelineno-0-41"></a><span class="sd">    Important: when using particular overlap type, similar clonotypes in one particular clonoset are</span>
<a id="__codelineno-0-42" name="__codelineno-0-42"></a><span class="sd">    combined into one with summation of counts/frequencies.</span>
<a id="__codelineno-0-43" name="__codelineno-0-43"></a>
<a id="__codelineno-0-44" name="__codelineno-0-44"></a><span class="sd">    Returns:</span>
<a id="__codelineno-0-45" name="__codelineno-0-45"></a><span class="sd">        df (pd.DataFrame): dataframe with following columns: `clone`, `sample1_count`, `sample2_count`, `sample1`, `sample2`, `pair`</span>
<a id="__codelineno-0-46" name="__codelineno-0-46"></a><span class="sd">            clone - is tuple, containing sequence (aa or nt), plus V or J if they are required by the metric</span>
<a id="__codelineno-0-47" name="__codelineno-0-47"></a><span class="sd">            count columns contain freq/count of the clone in sample</span>
<a id="__codelineno-0-48" name="__codelineno-0-48"></a><span class="sd">            pair column is made for easy separation of possibly huge DataFrame into overlapping pairs</span>
<a id="__codelineno-0-49" name="__codelineno-0-49"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-50" name="__codelineno-0-50"></a>
<a id="__codelineno-0-51" name="__codelineno-0-51"></a>
<a id="__codelineno-0-52" name="__codelineno-0-52"></a>    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Intersecting clones in clonosets</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">+</span><span class="s2">&quot;-&quot;</span><span class="o">*</span><span class="mi">50</span><span class="p">)</span>
<a id="__codelineno-0-53" name="__codelineno-0-53"></a>    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Overlap type: </span><span class="si">{</span><span class="n">overlap_type</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-0-54" name="__codelineno-0-54"></a>
<a id="__codelineno-0-55" name="__codelineno-0-55"></a>    <span class="n">clonoset_lists</span><span class="p">,</span> <span class="n">samples_total</span><span class="p">,</span> <span class="n">two_dataframes</span><span class="p">,</span> <span class="n">sample_list</span><span class="p">,</span> <span class="n">sample_list2</span> <span class="o">=</span> <span class="n">prepare_clonotypes_dfs_for_intersections</span><span class="p">(</span><span class="n">clonosets_df</span><span class="p">,</span> <span class="n">clonosets_df2</span><span class="p">,</span>
<a id="__codelineno-0-56" name="__codelineno-0-56"></a>                                                                                                                        <span class="n">cl_filter</span><span class="p">,</span> <span class="n">cl_filter2</span><span class="p">,</span>
<a id="__codelineno-0-57" name="__codelineno-0-57"></a>                                                                                                                        <span class="n">overlap_type</span><span class="p">,</span> <span class="n">by_freq</span><span class="o">=</span><span class="n">by_freq</span><span class="p">,</span>
<a id="__codelineno-0-58" name="__codelineno-0-58"></a>                                                                                                                        <span class="n">strict</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<a id="__codelineno-0-59" name="__codelineno-0-59"></a>    <span class="c1"># generating a set of tasks</span>
<a id="__codelineno-0-60" name="__codelineno-0-60"></a>
<a id="__codelineno-0-61" name="__codelineno-0-61"></a>    <span class="n">tasks</span> <span class="o">=</span> <span class="p">[]</span>
<a id="__codelineno-0-62" name="__codelineno-0-62"></a>
<a id="__codelineno-0-63" name="__codelineno-0-63"></a>    <span class="k">if</span> <span class="n">two_dataframes</span><span class="p">:</span>
<a id="__codelineno-0-64" name="__codelineno-0-64"></a>        <span class="k">for</span> <span class="n">sample1</span> <span class="ow">in</span> <span class="n">sample_list</span><span class="p">:</span>
<a id="__codelineno-0-65" name="__codelineno-0-65"></a>            <span class="k">for</span> <span class="n">sample2</span> <span class="ow">in</span> <span class="n">sample_list2</span><span class="p">:</span>
<a id="__codelineno-0-66" name="__codelineno-0-66"></a>                <span class="n">tasks</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">sample1</span><span class="p">,</span> <span class="n">sample2</span><span class="p">,</span> <span class="n">clonoset_lists</span><span class="p">))</span>
<a id="__codelineno-0-67" name="__codelineno-0-67"></a>    <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-68" name="__codelineno-0-68"></a>        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">samples_total</span><span class="p">):</span>
<a id="__codelineno-0-69" name="__codelineno-0-69"></a>            <span class="n">sample1</span> <span class="o">=</span> <span class="n">sample_list</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
<a id="__codelineno-0-70" name="__codelineno-0-70"></a>            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">samples_total</span><span class="o">-</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">):</span>
<a id="__codelineno-0-71" name="__codelineno-0-71"></a>                <span class="n">sample2</span> <span class="o">=</span> <span class="n">sample_list</span><span class="p">[</span><span class="n">j</span><span class="o">+</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span>
<a id="__codelineno-0-72" name="__codelineno-0-72"></a>                <span class="n">tasks</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">sample1</span><span class="p">,</span> <span class="n">sample2</span><span class="p">,</span> <span class="n">clonoset_lists</span><span class="p">))</span>
<a id="__codelineno-0-73" name="__codelineno-0-73"></a>
<a id="__codelineno-0-74" name="__codelineno-0-74"></a>    <span class="n">results</span> <span class="o">=</span> <span class="n">run_parallel_calculation</span><span class="p">(</span><span class="n">intersect_two_clone_dicts</span><span class="p">,</span> <span class="n">tasks</span><span class="p">,</span> <span class="s2">&quot;Intersecting clonosets&quot;</span><span class="p">,</span> <span class="n">object_name</span><span class="o">=</span><span class="s2">&quot;pairs&quot;</span><span class="p">)</span>
<a id="__codelineno-0-75" name="__codelineno-0-75"></a>
<a id="__codelineno-0-76" name="__codelineno-0-76"></a>    <span class="c1"># df = pd.concat(results).index.set_names()</span>
<a id="__codelineno-0-77" name="__codelineno-0-77"></a>    <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">results</span><span class="p">)</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<a id="__codelineno-0-78" name="__codelineno-0-78"></a>    <span class="n">df</span> <span class="o">=</span> <span class="n">split_tuple_clone_column</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">overlap_type</span><span class="p">)</span>
<a id="__codelineno-0-79" name="__codelineno-0-79"></a>
<a id="__codelineno-0-80" name="__codelineno-0-80"></a>    <span class="k">return</span> <span class="n">df</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h4 id="intersections.overlap_distances" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">overlap_distances</span><span class="p">(</span><span class="n">clonosets_df</span><span class="p">,</span> <span class="n">cl_filter</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">overlap_type</span><span class="o">=</span><span class="s1">&#39;aaV&#39;</span><span class="p">,</span> <span class="n">mismatches</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">metric</span><span class="o">=</span><span class="s1">&#39;F2&#39;</span><span class="p">,</span> <span class="n">clonosets_df2</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">cl_filter2</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>

</h4>


    <div class="doc doc-contents ">

        <p>Calculating overlap distances between multiple repseq samples using F2 of F metrics
The result of this function may be used for heatmap+clusterization of samples or for MDS plots</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>clonosets_df</code>
            </td>
            <td>
                  <code><span title="pandas.DataFrame">DataFrame</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>contains three columns - <code>sample_id</code> and <code>filename</code> columns,
filename - full path to clonoset file. Clonoset file may be of MiXCR3/MiXCR4 or VDJtools format
sample_id's should be all unique in this DF</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>overlap_type</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>possible values are <code>aa</code>, <code>aaV</code>, <code>aaVJ</code>, <code>nt</code>, <code>ntV</code>, <code>ntVJ</code>. aa/nt define which CDR3 sequence
to use (amino acid or nucleotide). V/J in the overlap_type define whether to check V or J segments
to decide if clonotypes are equal</p>
              </div>
            </td>
            <td>
                  <code>&#39;aaV&#39;</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>mismatches</code>
            </td>
            <td>
                  <code><span title="int">int</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Max number of single-letter mismatches in clonotypes sequences 
for them to be treated similar, i.e. hamming distance.</p>
              </div>
            </td>
            <td>
                  <code>0</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>by_umi</code>
            </td>
            <td>
                  <code><span title="bool">bool</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>set =True for MiXCR4 clonosets to select count/frequency of clonotypes 
in UMI's if they exist in implemented protocol</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>metric</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>possible values - <code>F</code>, <code>F2</code> or <code>C</code>. Default <code>F2</code>. <code>F2</code> - sum of sqrt of product of 
similar clonotype frequencies in two clonosets. <code>F</code> - sqrt of the sum of frequency products.
<code>C</code> - total frequency of clonotypes in <code>sample1</code>, that are similar to clonotypes in <code>sample2</code></p>
              </div>
            </td>
            <td>
                  <code>&#39;F2&#39;</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>only_functional</code>
            </td>
            <td>
                  <code><span title="bool">bool</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>use only functional clonotypes (do not contain stop codons or
frameshifts in CDR3 sequences: * or _ symbol in CDR3aa sequence). The frequences are recounted to
1 after filtering of non-functional clonotypes</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


<details class="important" open>
  <summary>similar clonotypes by <code>overlap_type</code> in one particular clonoset will be combined into one</summary>
  <p>clonotype with sum for count.</p>
</details>

    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
<th>Name</th>          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
<td><code>df</code></td>            <td>
                  <code><span title="pandas.DataFrame">DataFrame</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>dataframe with following columns: <code>clone</code>, <code>sample1_count</code>, <code>sample2_count</code>, <code>sample1</code>, <code>sample2</code>, <code>pair</code>. 
<code>clone</code> - is tuple, containing sequence (aa or nt), plus V or J if they are required by the metric
count columns contain freq/count of the clone in sample
pair column is made for easy separation of possibly huge DataFrame into overlapping pairs</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>repseq/intersections.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-403">403</a></span>
<span class="normal"><a href="#__codelineno-0-404">404</a></span>
<span class="normal"><a href="#__codelineno-0-405">405</a></span>
<span class="normal"><a href="#__codelineno-0-406">406</a></span>
<span class="normal"><a href="#__codelineno-0-407">407</a></span>
<span class="normal"><a href="#__codelineno-0-408">408</a></span>
<span class="normal"><a href="#__codelineno-0-409">409</a></span>
<span class="normal"><a href="#__codelineno-0-410">410</a></span>
<span class="normal"><a href="#__codelineno-0-411">411</a></span>
<span class="normal"><a href="#__codelineno-0-412">412</a></span>
<span class="normal"><a href="#__codelineno-0-413">413</a></span>
<span class="normal"><a href="#__codelineno-0-414">414</a></span>
<span class="normal"><a href="#__codelineno-0-415">415</a></span>
<span class="normal"><a href="#__codelineno-0-416">416</a></span>
<span class="normal"><a href="#__codelineno-0-417">417</a></span>
<span class="normal"><a href="#__codelineno-0-418">418</a></span>
<span class="normal"><a href="#__codelineno-0-419">419</a></span>
<span class="normal"><a href="#__codelineno-0-420">420</a></span>
<span class="normal"><a href="#__codelineno-0-421">421</a></span>
<span class="normal"><a href="#__codelineno-0-422">422</a></span>
<span class="normal"><a href="#__codelineno-0-423">423</a></span>
<span class="normal"><a href="#__codelineno-0-424">424</a></span>
<span class="normal"><a href="#__codelineno-0-425">425</a></span>
<span class="normal"><a href="#__codelineno-0-426">426</a></span>
<span class="normal"><a href="#__codelineno-0-427">427</a></span>
<span class="normal"><a href="#__codelineno-0-428">428</a></span>
<span class="normal"><a href="#__codelineno-0-429">429</a></span>
<span class="normal"><a href="#__codelineno-0-430">430</a></span>
<span class="normal"><a href="#__codelineno-0-431">431</a></span>
<span class="normal"><a href="#__codelineno-0-432">432</a></span>
<span class="normal"><a href="#__codelineno-0-433">433</a></span>
<span class="normal"><a href="#__codelineno-0-434">434</a></span>
<span class="normal"><a href="#__codelineno-0-435">435</a></span>
<span class="normal"><a href="#__codelineno-0-436">436</a></span>
<span class="normal"><a href="#__codelineno-0-437">437</a></span>
<span class="normal"><a href="#__codelineno-0-438">438</a></span>
<span class="normal"><a href="#__codelineno-0-439">439</a></span>
<span class="normal"><a href="#__codelineno-0-440">440</a></span>
<span class="normal"><a href="#__codelineno-0-441">441</a></span>
<span class="normal"><a href="#__codelineno-0-442">442</a></span>
<span class="normal"><a href="#__codelineno-0-443">443</a></span>
<span class="normal"><a href="#__codelineno-0-444">444</a></span>
<span class="normal"><a href="#__codelineno-0-445">445</a></span>
<span class="normal"><a href="#__codelineno-0-446">446</a></span>
<span class="normal"><a href="#__codelineno-0-447">447</a></span>
<span class="normal"><a href="#__codelineno-0-448">448</a></span>
<span class="normal"><a href="#__codelineno-0-449">449</a></span>
<span class="normal"><a href="#__codelineno-0-450">450</a></span>
<span class="normal"><a href="#__codelineno-0-451">451</a></span>
<span class="normal"><a href="#__codelineno-0-452">452</a></span>
<span class="normal"><a href="#__codelineno-0-453">453</a></span>
<span class="normal"><a href="#__codelineno-0-454">454</a></span>
<span class="normal"><a href="#__codelineno-0-455">455</a></span>
<span class="normal"><a href="#__codelineno-0-456">456</a></span>
<span class="normal"><a href="#__codelineno-0-457">457</a></span>
<span class="normal"><a href="#__codelineno-0-458">458</a></span>
<span class="normal"><a href="#__codelineno-0-459">459</a></span>
<span class="normal"><a href="#__codelineno-0-460">460</a></span>
<span class="normal"><a href="#__codelineno-0-461">461</a></span>
<span class="normal"><a href="#__codelineno-0-462">462</a></span>
<span class="normal"><a href="#__codelineno-0-463">463</a></span>
<span class="normal"><a href="#__codelineno-0-464">464</a></span>
<span class="normal"><a href="#__codelineno-0-465">465</a></span>
<span class="normal"><a href="#__codelineno-0-466">466</a></span>
<span class="normal"><a href="#__codelineno-0-467">467</a></span>
<span class="normal"><a href="#__codelineno-0-468">468</a></span>
<span class="normal"><a href="#__codelineno-0-469">469</a></span>
<span class="normal"><a href="#__codelineno-0-470">470</a></span>
<span class="normal"><a href="#__codelineno-0-471">471</a></span>
<span class="normal"><a href="#__codelineno-0-472">472</a></span>
<span class="normal"><a href="#__codelineno-0-473">473</a></span>
<span class="normal"><a href="#__codelineno-0-474">474</a></span>
<span class="normal"><a href="#__codelineno-0-475">475</a></span>
<span class="normal"><a href="#__codelineno-0-476">476</a></span>
<span class="normal"><a href="#__codelineno-0-477">477</a></span>
<span class="normal"><a href="#__codelineno-0-478">478</a></span>
<span class="normal"><a href="#__codelineno-0-479">479</a></span>
<span class="normal"><a href="#__codelineno-0-480">480</a></span>
<span class="normal"><a href="#__codelineno-0-481">481</a></span>
<span class="normal"><a href="#__codelineno-0-482">482</a></span>
<span class="normal"><a href="#__codelineno-0-483">483</a></span>
<span class="normal"><a href="#__codelineno-0-484">484</a></span>
<span class="normal"><a href="#__codelineno-0-485">485</a></span>
<span class="normal"><a href="#__codelineno-0-486">486</a></span>
<span class="normal"><a href="#__codelineno-0-487">487</a></span>
<span class="normal"><a href="#__codelineno-0-488">488</a></span>
<span class="normal"><a href="#__codelineno-0-489">489</a></span>
<span class="normal"><a href="#__codelineno-0-490">490</a></span>
<span class="normal"><a href="#__codelineno-0-491">491</a></span>
<span class="normal"><a href="#__codelineno-0-492">492</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-403" name="__codelineno-0-403"></a><span class="k">def</span><span class="w"> </span><span class="nf">overlap_distances</span><span class="p">(</span><span class="n">clonosets_df</span><span class="p">,</span> <span class="n">cl_filter</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">overlap_type</span><span class="o">=</span><span class="s2">&quot;aaV&quot;</span><span class="p">,</span> <span class="n">mismatches</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">metric</span><span class="o">=</span><span class="s2">&quot;F2&quot;</span><span class="p">,</span> <span class="n">clonosets_df2</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">cl_filter2</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<a id="__codelineno-0-404" name="__codelineno-0-404"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-405" name="__codelineno-0-405"></a><span class="sd">    Calculating overlap distances between multiple repseq samples using F2 of F metrics</span>
<a id="__codelineno-0-406" name="__codelineno-0-406"></a><span class="sd">    The result of this function may be used for heatmap+clusterization of samples or for MDS plots</span>
<a id="__codelineno-0-407" name="__codelineno-0-407"></a>
<a id="__codelineno-0-408" name="__codelineno-0-408"></a><span class="sd">    Args:</span>
<a id="__codelineno-0-409" name="__codelineno-0-409"></a><span class="sd">        clonosets_df (pd.DataFrame): contains three columns - `sample_id` and `filename` columns,</span>
<a id="__codelineno-0-410" name="__codelineno-0-410"></a><span class="sd">            filename - full path to clonoset file. Clonoset file may be of MiXCR3/MiXCR4 or VDJtools format</span>
<a id="__codelineno-0-411" name="__codelineno-0-411"></a><span class="sd">            sample_id&#39;s should be all unique in this DF</span>
<a id="__codelineno-0-412" name="__codelineno-0-412"></a><span class="sd">        overlap_type (str): possible values are `aa`, `aaV`, `aaVJ`, `nt`, `ntV`, `ntVJ`. aa/nt define which CDR3 sequence</span>
<a id="__codelineno-0-413" name="__codelineno-0-413"></a><span class="sd">            to use (amino acid or nucleotide). V/J in the overlap_type define whether to check V or J segments</span>
<a id="__codelineno-0-414" name="__codelineno-0-414"></a><span class="sd">            to decide if clonotypes are equal</span>
<a id="__codelineno-0-415" name="__codelineno-0-415"></a><span class="sd">        mismatches (int): Max number of single-letter mismatches in clonotypes sequences </span>
<a id="__codelineno-0-416" name="__codelineno-0-416"></a><span class="sd">            for them to be treated similar, i.e. hamming distance.</span>
<a id="__codelineno-0-417" name="__codelineno-0-417"></a><span class="sd">        by_umi (bool): set =True for MiXCR4 clonosets to select count/frequency of clonotypes </span>
<a id="__codelineno-0-418" name="__codelineno-0-418"></a><span class="sd">            in UMI&#39;s if they exist in implemented protocol</span>
<a id="__codelineno-0-419" name="__codelineno-0-419"></a><span class="sd">        metric (str): possible values - `F`, `F2` or `C`. Default `F2`. `F2` - sum of sqrt of product of </span>
<a id="__codelineno-0-420" name="__codelineno-0-420"></a><span class="sd">            similar clonotype frequencies in two clonosets. `F` - sqrt of the sum of frequency products.</span>
<a id="__codelineno-0-421" name="__codelineno-0-421"></a><span class="sd">            `C` - total frequency of clonotypes in `sample1`, that are similar to clonotypes in `sample2`</span>
<a id="__codelineno-0-422" name="__codelineno-0-422"></a><span class="sd">        only_functional (bool): use only functional clonotypes (do not contain stop codons or</span>
<a id="__codelineno-0-423" name="__codelineno-0-423"></a><span class="sd">            frameshifts in CDR3 sequences: * or _ symbol in CDR3aa sequence). The frequences are recounted to</span>
<a id="__codelineno-0-424" name="__codelineno-0-424"></a><span class="sd">            1 after filtering of non-functional clonotypes</span>
<a id="__codelineno-0-425" name="__codelineno-0-425"></a>
<a id="__codelineno-0-426" name="__codelineno-0-426"></a><span class="sd">    Important: similar clonotypes by `overlap_type` in one particular clonoset will be combined into one</span>
<a id="__codelineno-0-427" name="__codelineno-0-427"></a><span class="sd">        clonotype with sum for count.</span>
<a id="__codelineno-0-428" name="__codelineno-0-428"></a>
<a id="__codelineno-0-429" name="__codelineno-0-429"></a><span class="sd">    Returns:</span>
<a id="__codelineno-0-430" name="__codelineno-0-430"></a><span class="sd">        df (pd.DataFrame): dataframe with following columns: `clone`, `sample1_count`, `sample2_count`, `sample1`, `sample2`, `pair`. </span>
<a id="__codelineno-0-431" name="__codelineno-0-431"></a><span class="sd">            `clone` - is tuple, containing sequence (aa or nt), plus V or J if they are required by the metric</span>
<a id="__codelineno-0-432" name="__codelineno-0-432"></a><span class="sd">            count columns contain freq/count of the clone in sample</span>
<a id="__codelineno-0-433" name="__codelineno-0-433"></a><span class="sd">            pair column is made for easy separation of possibly huge DataFrame into overlapping pairs</span>
<a id="__codelineno-0-434" name="__codelineno-0-434"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-435" name="__codelineno-0-435"></a>
<a id="__codelineno-0-436" name="__codelineno-0-436"></a>
<a id="__codelineno-0-437" name="__codelineno-0-437"></a>    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Intersecting clones in clonosets</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">+</span><span class="s2">&quot;-&quot;</span><span class="o">*</span><span class="mi">50</span><span class="p">)</span>
<a id="__codelineno-0-438" name="__codelineno-0-438"></a>    <span class="n">aa</span><span class="p">,</span> <span class="n">check_v</span><span class="p">,</span> <span class="n">check_j</span> <span class="o">=</span> <span class="n">overlap_type_to_flags</span><span class="p">(</span><span class="n">overlap_type</span><span class="p">)</span>
<a id="__codelineno-0-439" name="__codelineno-0-439"></a>    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Overlap type: </span><span class="si">{</span><span class="n">overlap_type</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-0-440" name="__codelineno-0-440"></a>
<a id="__codelineno-0-441" name="__codelineno-0-441"></a>    <span class="n">metric</span> <span class="o">=</span> <span class="n">metric</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span>
<a id="__codelineno-0-442" name="__codelineno-0-442"></a>    <span class="n">metrics</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;F&quot;</span><span class="p">,</span> <span class="s2">&quot;F2&quot;</span><span class="p">,</span> <span class="s2">&quot;C&quot;</span><span class="p">,</span> <span class="s2">&quot;BC&quot;</span><span class="p">,</span> <span class="s2">&quot;J&quot;</span><span class="p">,</span> <span class="s2">&quot;JSD&quot;</span><span class="p">]</span>
<a id="__codelineno-0-443" name="__codelineno-0-443"></a>    <span class="n">mismatch_metrics</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;F&quot;</span><span class="p">,</span> <span class="s2">&quot;C&quot;</span><span class="p">]</span>
<a id="__codelineno-0-444" name="__codelineno-0-444"></a>    <span class="n">non_symmetry_metrics</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;C&quot;</span><span class="p">]</span>
<a id="__codelineno-0-445" name="__codelineno-0-445"></a>    <span class="n">frequency_metrics</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;F&quot;</span><span class="p">,</span> <span class="s2">&quot;F2&quot;</span><span class="p">,</span> <span class="s2">&quot;C&quot;</span><span class="p">]</span>
<a id="__codelineno-0-446" name="__codelineno-0-446"></a>
<a id="__codelineno-0-447" name="__codelineno-0-447"></a>
<a id="__codelineno-0-448" name="__codelineno-0-448"></a>    <span class="k">if</span> <span class="n">metric</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">metrics</span><span class="p">:</span>
<a id="__codelineno-0-449" name="__codelineno-0-449"></a>        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Metric </span><span class="si">{</span><span class="n">metric</span><span class="si">}</span><span class="s2"> is not supported. Possible values: </span><span class="si">{</span><span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">metrics</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-0-450" name="__codelineno-0-450"></a>
<a id="__codelineno-0-451" name="__codelineno-0-451"></a>    <span class="k">if</span> <span class="n">mismatches</span> <span class="ow">and</span> <span class="n">metric</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">mismatch_metrics</span><span class="p">:</span>
<a id="__codelineno-0-452" name="__codelineno-0-452"></a>        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Metric </span><span class="si">{</span><span class="n">metric</span><span class="si">}</span><span class="s2"> does not allow mismatches. Mismatches only possible for: </span><span class="si">{</span><span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">mismatch_metrics</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-0-453" name="__codelineno-0-453"></a>
<a id="__codelineno-0-454" name="__codelineno-0-454"></a>    <span class="n">by_freq</span> <span class="o">=</span> <span class="n">metric</span> <span class="ow">in</span> <span class="n">frequency_metrics</span>
<a id="__codelineno-0-455" name="__codelineno-0-455"></a>
<a id="__codelineno-0-456" name="__codelineno-0-456"></a>    <span class="n">clonoset_lists</span><span class="p">,</span> <span class="n">samples_total</span><span class="p">,</span> <span class="n">two_dataframes</span><span class="p">,</span> <span class="n">sample_list</span><span class="p">,</span> <span class="n">sample_list2</span> <span class="o">=</span> <span class="n">prepare_clonotypes_dfs_for_intersections</span><span class="p">(</span><span class="n">clonosets_df</span><span class="p">,</span> <span class="n">clonosets_df2</span><span class="p">,</span>
<a id="__codelineno-0-457" name="__codelineno-0-457"></a>                                                                                                                        <span class="n">cl_filter</span><span class="p">,</span> <span class="n">cl_filter2</span><span class="p">,</span>
<a id="__codelineno-0-458" name="__codelineno-0-458"></a>                                                                                                                        <span class="n">overlap_type</span><span class="p">,</span> <span class="n">by_freq</span><span class="o">=</span><span class="n">by_freq</span><span class="p">)</span>
<a id="__codelineno-0-459" name="__codelineno-0-459"></a>
<a id="__codelineno-0-460" name="__codelineno-0-460"></a>    <span class="c1"># generating a set of tasks</span>
<a id="__codelineno-0-461" name="__codelineno-0-461"></a>
<a id="__codelineno-0-462" name="__codelineno-0-462"></a>    <span class="n">tasks</span> <span class="o">=</span> <span class="p">[]</span>
<a id="__codelineno-0-463" name="__codelineno-0-463"></a>
<a id="__codelineno-0-464" name="__codelineno-0-464"></a>    <span class="k">if</span> <span class="n">two_dataframes</span><span class="p">:</span>
<a id="__codelineno-0-465" name="__codelineno-0-465"></a>        <span class="k">for</span> <span class="n">sample1</span> <span class="ow">in</span> <span class="n">sample_list</span><span class="p">:</span>
<a id="__codelineno-0-466" name="__codelineno-0-466"></a>            <span class="k">for</span> <span class="n">sample2</span> <span class="ow">in</span> <span class="n">sample_list2</span><span class="p">:</span>
<a id="__codelineno-0-467" name="__codelineno-0-467"></a>                <span class="n">tasks</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">sample1</span><span class="p">,</span> <span class="n">sample2</span><span class="p">,</span> <span class="n">clonoset_lists</span><span class="p">,</span> <span class="n">mismatches</span><span class="p">,</span> <span class="n">metric</span><span class="p">))</span>        
<a id="__codelineno-0-468" name="__codelineno-0-468"></a>    <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-469" name="__codelineno-0-469"></a>        <span class="k">if</span> <span class="n">metric</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">non_symmetry_metrics</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">two_dataframes</span><span class="p">:</span>
<a id="__codelineno-0-470" name="__codelineno-0-470"></a>            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">samples_total</span><span class="p">):</span>
<a id="__codelineno-0-471" name="__codelineno-0-471"></a>                <span class="n">sample1</span> <span class="o">=</span> <span class="n">sample_list</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
<a id="__codelineno-0-472" name="__codelineno-0-472"></a>                <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">samples_total</span><span class="o">-</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">):</span>
<a id="__codelineno-0-473" name="__codelineno-0-473"></a>                    <span class="n">sample2</span> <span class="o">=</span> <span class="n">sample_list</span><span class="p">[</span><span class="n">j</span><span class="o">+</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span>
<a id="__codelineno-0-474" name="__codelineno-0-474"></a>                    <span class="n">tasks</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">sample1</span><span class="p">,</span> <span class="n">sample2</span><span class="p">,</span> <span class="n">clonoset_lists</span><span class="p">,</span> <span class="n">mismatches</span><span class="p">,</span> <span class="n">metric</span><span class="p">))</span>
<a id="__codelineno-0-475" name="__codelineno-0-475"></a>                <span class="k">if</span> <span class="n">metric</span> <span class="o">==</span> <span class="s2">&quot;F2&quot;</span><span class="p">:</span>
<a id="__codelineno-0-476" name="__codelineno-0-476"></a>                    <span class="n">tasks</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">sample1</span><span class="p">,</span> <span class="n">sample1</span><span class="p">,</span> <span class="n">clonoset_lists</span><span class="p">,</span> <span class="n">mismatches</span><span class="p">,</span> <span class="n">metric</span><span class="p">))</span>
<a id="__codelineno-0-477" name="__codelineno-0-477"></a>        <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-478" name="__codelineno-0-478"></a>            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">samples_total</span><span class="p">):</span>
<a id="__codelineno-0-479" name="__codelineno-0-479"></a>                <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">samples_total</span><span class="p">):</span>
<a id="__codelineno-0-480" name="__codelineno-0-480"></a>                    <span class="n">sample1</span> <span class="o">=</span> <span class="n">sample_list</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
<a id="__codelineno-0-481" name="__codelineno-0-481"></a>                    <span class="n">sample2</span> <span class="o">=</span> <span class="n">sample_list</span><span class="p">[</span><span class="n">j</span><span class="p">]</span>
<a id="__codelineno-0-482" name="__codelineno-0-482"></a>                    <span class="k">if</span> <span class="n">sample1</span> <span class="o">!=</span> <span class="n">sample2</span><span class="p">:</span>
<a id="__codelineno-0-483" name="__codelineno-0-483"></a>                        <span class="n">tasks</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">sample1</span><span class="p">,</span> <span class="n">sample2</span><span class="p">,</span> <span class="n">clonoset_lists</span><span class="p">,</span> <span class="n">mismatches</span><span class="p">,</span> <span class="n">metric</span><span class="p">))</span>
<a id="__codelineno-0-484" name="__codelineno-0-484"></a>
<a id="__codelineno-0-485" name="__codelineno-0-485"></a>
<a id="__codelineno-0-486" name="__codelineno-0-486"></a>    <span class="c1"># run calculation in parallel</span>
<a id="__codelineno-0-487" name="__codelineno-0-487"></a>    <span class="n">result_list</span> <span class="o">=</span> <span class="n">run_parallel_calculation</span><span class="p">(</span><span class="n">overlap_metric_two_clone_dicts</span><span class="p">,</span> <span class="n">tasks</span><span class="p">,</span> <span class="s2">&quot;Intersecting clonosets&quot;</span><span class="p">,</span> <span class="n">object_name</span><span class="o">=</span><span class="s2">&quot;pairs&quot;</span><span class="p">)</span>
<a id="__codelineno-0-488" name="__codelineno-0-488"></a>
<a id="__codelineno-0-489" name="__codelineno-0-489"></a>    <span class="k">if</span> <span class="ow">not</span> <span class="n">two_dataframes</span> <span class="ow">and</span> <span class="n">metric</span> <span class="o">!=</span> <span class="s2">&quot;C&quot;</span><span class="p">:</span>
<a id="__codelineno-0-490" name="__codelineno-0-490"></a>        <span class="n">result_list</span> <span class="o">=</span> <span class="n">result_list</span> <span class="o">+</span> <span class="p">[(</span><span class="n">result</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">result</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">result</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span> <span class="k">for</span> <span class="n">result</span> <span class="ow">in</span> <span class="n">result_list</span><span class="p">]</span>
<a id="__codelineno-0-491" name="__codelineno-0-491"></a>    <span class="n">overlap_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">result_list</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;sample1&quot;</span><span class="p">,</span> <span class="s2">&quot;sample2&quot;</span><span class="p">,</span> <span class="n">metric</span><span class="o">.</span><span class="n">lower</span><span class="p">()])</span><span class="o">.</span><span class="n">pivot_table</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="s2">&quot;sample1&quot;</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;sample2&quot;</span><span class="p">],</span> <span class="n">values</span><span class="o">=</span><span class="n">metric</span><span class="o">.</span><span class="n">lower</span><span class="p">())</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s2">&quot;sample1&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<a id="__codelineno-0-492" name="__codelineno-0-492"></a>    <span class="k">return</span> <span class="n">overlap_df</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h4 id="intersections.prepare_clonotypes_dfs_for_intersections" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">prepare_clonotypes_dfs_for_intersections</span><span class="p">(</span><span class="n">clonosets_df</span><span class="p">,</span> <span class="n">clonosets_df2</span><span class="p">,</span> <span class="n">cl_filter</span><span class="p">,</span> <span class="n">cl_filter2</span><span class="p">,</span> <span class="n">overlap_type</span><span class="p">,</span> <span class="n">by_freq</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">strict</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span></code>

</h4>


    <div class="doc doc-contents ">



<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>clonosets_df</code>
            </td>
            <td>
                  <code><span title="pandas.DataFrame">DataFrame</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p><em>description</em></p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>clonosets_df2</code>
            </td>
            <td>
                  <code><span title="pandas.DataFrame">DataFrame</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p><em>description</em></p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>cl_filter</code>
            </td>
            <td>
                  <code><span title="repseq.clone_filter.Filter">Filter</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p><em>description</em></p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>cl_filter2</code>
            </td>
            <td>
                  <code><span title="repseq.clone_filter.Filter">Filter</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p><em>description</em></p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>overlap_type</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p><em>description</em></p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>by_freq</code>
            </td>
            <td>
                  <code><span title="bool">bool</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p><em>description</em>. Defaults to True.</p>
              </div>
            </td>
            <td>
                  <code>True</code>
            </td>
          </tr>
      </tbody>
    </table>


<p><span class="doc-section-title">Raises:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="ValueError">ValueError</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p><em>description</em></p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                  <code><span title="ValueError">ValueError</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p><em>description</em></p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
<th>Name</th>          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
<td><code>clonoset_lists</code></td>            <td>
                  <code><span title="dict">dict</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>dict of </p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
<td><code>samples_total</code></td>            <td>
                  <code><span title="int">int</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
<td><code>two_dataframes</code></td>            <td>
                  <code><span title="bool">bool</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
<td><code>sample_list</code></td>            <td>
                  <code><span title="list">list</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
<td><code>sample_list2</code></td>            <td>
                  <code><span title="list">list</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>repseq/intersections.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-641">641</a></span>
<span class="normal"><a href="#__codelineno-0-642">642</a></span>
<span class="normal"><a href="#__codelineno-0-643">643</a></span>
<span class="normal"><a href="#__codelineno-0-644">644</a></span>
<span class="normal"><a href="#__codelineno-0-645">645</a></span>
<span class="normal"><a href="#__codelineno-0-646">646</a></span>
<span class="normal"><a href="#__codelineno-0-647">647</a></span>
<span class="normal"><a href="#__codelineno-0-648">648</a></span>
<span class="normal"><a href="#__codelineno-0-649">649</a></span>
<span class="normal"><a href="#__codelineno-0-650">650</a></span>
<span class="normal"><a href="#__codelineno-0-651">651</a></span>
<span class="normal"><a href="#__codelineno-0-652">652</a></span>
<span class="normal"><a href="#__codelineno-0-653">653</a></span>
<span class="normal"><a href="#__codelineno-0-654">654</a></span>
<span class="normal"><a href="#__codelineno-0-655">655</a></span>
<span class="normal"><a href="#__codelineno-0-656">656</a></span>
<span class="normal"><a href="#__codelineno-0-657">657</a></span>
<span class="normal"><a href="#__codelineno-0-658">658</a></span>
<span class="normal"><a href="#__codelineno-0-659">659</a></span>
<span class="normal"><a href="#__codelineno-0-660">660</a></span>
<span class="normal"><a href="#__codelineno-0-661">661</a></span>
<span class="normal"><a href="#__codelineno-0-662">662</a></span>
<span class="normal"><a href="#__codelineno-0-663">663</a></span>
<span class="normal"><a href="#__codelineno-0-664">664</a></span>
<span class="normal"><a href="#__codelineno-0-665">665</a></span>
<span class="normal"><a href="#__codelineno-0-666">666</a></span>
<span class="normal"><a href="#__codelineno-0-667">667</a></span>
<span class="normal"><a href="#__codelineno-0-668">668</a></span>
<span class="normal"><a href="#__codelineno-0-669">669</a></span>
<span class="normal"><a href="#__codelineno-0-670">670</a></span>
<span class="normal"><a href="#__codelineno-0-671">671</a></span>
<span class="normal"><a href="#__codelineno-0-672">672</a></span>
<span class="normal"><a href="#__codelineno-0-673">673</a></span>
<span class="normal"><a href="#__codelineno-0-674">674</a></span>
<span class="normal"><a href="#__codelineno-0-675">675</a></span>
<span class="normal"><a href="#__codelineno-0-676">676</a></span>
<span class="normal"><a href="#__codelineno-0-677">677</a></span>
<span class="normal"><a href="#__codelineno-0-678">678</a></span>
<span class="normal"><a href="#__codelineno-0-679">679</a></span>
<span class="normal"><a href="#__codelineno-0-680">680</a></span>
<span class="normal"><a href="#__codelineno-0-681">681</a></span>
<span class="normal"><a href="#__codelineno-0-682">682</a></span>
<span class="normal"><a href="#__codelineno-0-683">683</a></span>
<span class="normal"><a href="#__codelineno-0-684">684</a></span>
<span class="normal"><a href="#__codelineno-0-685">685</a></span>
<span class="normal"><a href="#__codelineno-0-686">686</a></span>
<span class="normal"><a href="#__codelineno-0-687">687</a></span>
<span class="normal"><a href="#__codelineno-0-688">688</a></span>
<span class="normal"><a href="#__codelineno-0-689">689</a></span>
<span class="normal"><a href="#__codelineno-0-690">690</a></span>
<span class="normal"><a href="#__codelineno-0-691">691</a></span>
<span class="normal"><a href="#__codelineno-0-692">692</a></span>
<span class="normal"><a href="#__codelineno-0-693">693</a></span>
<span class="normal"><a href="#__codelineno-0-694">694</a></span>
<span class="normal"><a href="#__codelineno-0-695">695</a></span>
<span class="normal"><a href="#__codelineno-0-696">696</a></span>
<span class="normal"><a href="#__codelineno-0-697">697</a></span>
<span class="normal"><a href="#__codelineno-0-698">698</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-641" name="__codelineno-0-641"></a><span class="k">def</span><span class="w"> </span><span class="nf">prepare_clonotypes_dfs_for_intersections</span><span class="p">(</span><span class="n">clonosets_df</span><span class="p">,</span> <span class="n">clonosets_df2</span><span class="p">,</span> <span class="n">cl_filter</span><span class="p">,</span> <span class="n">cl_filter2</span><span class="p">,</span> <span class="n">overlap_type</span><span class="p">,</span> <span class="n">by_freq</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">strict</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<a id="__codelineno-0-642" name="__codelineno-0-642"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-643" name="__codelineno-0-643"></a><span class="sd">    Args:</span>
<a id="__codelineno-0-644" name="__codelineno-0-644"></a><span class="sd">        clonosets_df (pd.DataFrame): _description_</span>
<a id="__codelineno-0-645" name="__codelineno-0-645"></a><span class="sd">        clonosets_df2 (pd.DataFrame): _description_</span>
<a id="__codelineno-0-646" name="__codelineno-0-646"></a><span class="sd">        cl_filter (Filter): _description_</span>
<a id="__codelineno-0-647" name="__codelineno-0-647"></a><span class="sd">        cl_filter2 (Filter): _description_</span>
<a id="__codelineno-0-648" name="__codelineno-0-648"></a><span class="sd">        overlap_type (str): _description_</span>
<a id="__codelineno-0-649" name="__codelineno-0-649"></a><span class="sd">        by_freq (bool, optional): _description_. Defaults to True.</span>
<a id="__codelineno-0-650" name="__codelineno-0-650"></a>
<a id="__codelineno-0-651" name="__codelineno-0-651"></a><span class="sd">    Raises:</span>
<a id="__codelineno-0-652" name="__codelineno-0-652"></a><span class="sd">        ValueError: _description_</span>
<a id="__codelineno-0-653" name="__codelineno-0-653"></a><span class="sd">        ValueError: _description_</span>
<a id="__codelineno-0-654" name="__codelineno-0-654"></a>
<a id="__codelineno-0-655" name="__codelineno-0-655"></a><span class="sd">    Returns:</span>
<a id="__codelineno-0-656" name="__codelineno-0-656"></a><span class="sd">        clonoset_lists (dict): dict of </span>
<a id="__codelineno-0-657" name="__codelineno-0-657"></a><span class="sd">        samples_total (int): </span>
<a id="__codelineno-0-658" name="__codelineno-0-658"></a><span class="sd">        two_dataframes (bool):</span>
<a id="__codelineno-0-659" name="__codelineno-0-659"></a><span class="sd">        sample_list (list):</span>
<a id="__codelineno-0-660" name="__codelineno-0-660"></a><span class="sd">        sample_list2 (list):</span>
<a id="__codelineno-0-661" name="__codelineno-0-661"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-662" name="__codelineno-0-662"></a>    <span class="c1"># output:</span>
<a id="__codelineno-0-663" name="__codelineno-0-663"></a>    <span class="c1">### clonoset_lists</span>
<a id="__codelineno-0-664" name="__codelineno-0-664"></a>
<a id="__codelineno-0-665" name="__codelineno-0-665"></a>    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">clonosets_df</span><span class="o">.</span><span class="n">sample_id</span><span class="o">.</span><span class="n">unique</span><span class="p">())</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">clonosets_df</span><span class="p">):</span>
<a id="__codelineno-0-666" name="__codelineno-0-666"></a>        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Input clonosets in DataFrame have non-unique sample_id&#39;s&quot;</span><span class="p">)</span>
<a id="__codelineno-0-667" name="__codelineno-0-667"></a>    <span class="n">clonosets_df_1</span> <span class="o">=</span> <span class="n">clonosets_df</span><span class="p">[[</span><span class="s2">&quot;sample_id&quot;</span><span class="p">,</span> <span class="s2">&quot;filename&quot;</span><span class="p">]]</span>
<a id="__codelineno-0-668" name="__codelineno-0-668"></a>    <span class="n">two_dataframes</span> <span class="o">=</span> <span class="kc">False</span>
<a id="__codelineno-0-669" name="__codelineno-0-669"></a>    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">clonosets_df2</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">):</span>
<a id="__codelineno-0-670" name="__codelineno-0-670"></a>        <span class="n">two_dataframes</span> <span class="o">=</span> <span class="kc">True</span>
<a id="__codelineno-0-671" name="__codelineno-0-671"></a>        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">clonosets_df2</span><span class="o">.</span><span class="n">sample_id</span><span class="o">.</span><span class="n">unique</span><span class="p">())</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">clonosets_df2</span><span class="p">):</span>
<a id="__codelineno-0-672" name="__codelineno-0-672"></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Input clonosets in DataFrame2 have non-unique sample_id&#39;s&quot;</span><span class="p">)</span>
<a id="__codelineno-0-673" name="__codelineno-0-673"></a>        <span class="n">clonosets_df_2</span> <span class="o">=</span> <span class="n">clonosets_df2</span><span class="p">[[</span><span class="s2">&quot;sample_id&quot;</span><span class="p">,</span> <span class="s2">&quot;filename&quot;</span><span class="p">]]</span>
<a id="__codelineno-0-674" name="__codelineno-0-674"></a>        <span class="n">intersecting_sample_ids</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">clonosets_df2</span><span class="o">.</span><span class="n">sample_id</span><span class="o">.</span><span class="n">unique</span><span class="p">())</span><span class="o">.</span><span class="n">intersection</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">clonosets_df</span><span class="o">.</span><span class="n">sample_id</span><span class="o">.</span><span class="n">unique</span><span class="p">()))</span>
<a id="__codelineno-0-675" name="__codelineno-0-675"></a>        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">intersecting_sample_ids</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">cl_filter2</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-676" name="__codelineno-0-676"></a>            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;WARNING! Some samples have the same sample_id in two sample_df&#39;s. The second filter will be applied to common samples&quot;</span><span class="p">)</span>
<a id="__codelineno-0-677" name="__codelineno-0-677"></a>
<a id="__codelineno-0-678" name="__codelineno-0-678"></a>
<a id="__codelineno-0-679" name="__codelineno-0-679"></a>    <span class="c1"># converting clonosets to compact lists of clonotypes separated by CDR3 lengths to dictionary based on overlap type and count/freq/umi</span>
<a id="__codelineno-0-680" name="__codelineno-0-680"></a>    <span class="n">clonoset_lists</span> <span class="o">=</span> <span class="n">convert_clonosets_to_compact_dicts</span><span class="p">(</span><span class="n">clonosets_df_1</span><span class="p">,</span> <span class="n">cl_filter</span><span class="o">=</span><span class="n">cl_filter</span><span class="p">,</span>
<a id="__codelineno-0-681" name="__codelineno-0-681"></a>                                                        <span class="n">overlap_type</span><span class="o">=</span><span class="n">overlap_type</span><span class="p">,</span> <span class="n">by_freq</span><span class="o">=</span><span class="n">by_freq</span><span class="p">,</span> <span class="n">strict</span><span class="o">=</span><span class="n">strict</span><span class="p">)</span>
<a id="__codelineno-0-682" name="__codelineno-0-682"></a>    <span class="k">if</span> <span class="n">two_dataframes</span><span class="p">:</span>
<a id="__codelineno-0-683" name="__codelineno-0-683"></a>        <span class="k">if</span> <span class="n">cl_filter2</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-684" name="__codelineno-0-684"></a>            <span class="n">cl_filter2</span> <span class="o">=</span> <span class="n">cl_filter</span>
<a id="__codelineno-0-685" name="__codelineno-0-685"></a>        <span class="n">clonoset_lists_2</span> <span class="o">=</span> <span class="n">convert_clonosets_to_compact_dicts</span><span class="p">(</span><span class="n">clonosets_df_2</span><span class="p">,</span> <span class="n">cl_filter</span><span class="o">=</span><span class="n">cl_filter2</span><span class="p">,</span>
<a id="__codelineno-0-686" name="__codelineno-0-686"></a>                                                        <span class="n">overlap_type</span><span class="o">=</span><span class="n">overlap_type</span><span class="p">,</span> <span class="n">by_freq</span><span class="o">=</span><span class="n">by_freq</span><span class="p">,</span> <span class="n">strict</span><span class="o">=</span><span class="n">strict</span><span class="p">)</span>
<a id="__codelineno-0-687" name="__codelineno-0-687"></a>        <span class="n">clonoset_lists</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">clonoset_lists_2</span><span class="p">)</span>
<a id="__codelineno-0-688" name="__codelineno-0-688"></a>
<a id="__codelineno-0-689" name="__codelineno-0-689"></a>    <span class="n">samples_total</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">clonosets_df_1</span><span class="p">)</span>
<a id="__codelineno-0-690" name="__codelineno-0-690"></a>    <span class="k">if</span> <span class="n">two_dataframes</span><span class="p">:</span>
<a id="__codelineno-0-691" name="__codelineno-0-691"></a>        <span class="n">samples_total</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">clonosets_df_1</span><span class="p">,</span> <span class="n">clonosets_df_2</span><span class="p">]))</span>
<a id="__codelineno-0-692" name="__codelineno-0-692"></a>
<a id="__codelineno-0-693" name="__codelineno-0-693"></a>    <span class="n">sample_list</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">clonosets_df_1</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="s2">&quot;sample_id&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">sample_id</span><span class="p">)</span>
<a id="__codelineno-0-694" name="__codelineno-0-694"></a>    <span class="n">sample_list2</span> <span class="o">=</span> <span class="kc">None</span>
<a id="__codelineno-0-695" name="__codelineno-0-695"></a>    <span class="k">if</span> <span class="n">two_dataframes</span><span class="p">:</span>
<a id="__codelineno-0-696" name="__codelineno-0-696"></a>        <span class="n">sample_list2</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">clonosets_df_2</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="s2">&quot;sample_id&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">sample_id</span><span class="p">)</span>
<a id="__codelineno-0-697" name="__codelineno-0-697"></a>
<a id="__codelineno-0-698" name="__codelineno-0-698"></a>    <span class="k">return</span> <span class="n">clonoset_lists</span><span class="p">,</span> <span class="n">samples_total</span><span class="p">,</span> <span class="n">two_dataframes</span><span class="p">,</span> <span class="n">sample_list</span><span class="p">,</span> <span class="n">sample_list2</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h4 id="intersections.tcrnet" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">tcrnet</span><span class="p">(</span><span class="n">clonosets_df_exp</span><span class="p">,</span> <span class="n">clonosets_df_control</span><span class="p">,</span> <span class="n">cl_filter</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">cl_filter_c</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">overlap_type</span><span class="o">=</span><span class="s1">&#39;aaVJ&#39;</span><span class="p">,</span> <span class="n">mismatches</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span></code>

</h4>


    <div class="doc doc-contents ">

        <p>This is an implementation of TCRnet (TCR neighbour enrichment test) algorithm.  It identifies similar clonotypes for the experimental dataset and the control one based on sequence 
similarity (allowing up to <code>mismatches</code> differences).  <br />
Args:
    clonosets_df_exp (pd.DataFrame): a DataFrame with experimental clonosets containing three columns - <code>sample_id</code> and <code>filename</code> columns,
        filename - full path to a clonoset file. Clonoset file may be of MiXCR3/MiXCR4 or VDJtools format
    clonosets_df_control (pd.DataFrame): a DataFrame with control clonosets containing three columns - <code>sample_id</code> and <code>filename</code> columns,
        filename - full path to clonoset file. Clonoset file may be of MiXCR3/MiXCR4 or VDJtools format
    cl_filter (repseq.clone_filter.Filter): A filter applied to the experimental dataset before processing
    cl_filter_c (repseq.clone_filter.Filter): A filter applied to the control dataset before processing
    overlap_type (str): possible values are <code>aa</code>, <code>aaV</code>, <code>aaVJ</code>, <code>nt</code>, <code>ntV</code>, <code>ntVJ</code>. aa/nt define which CDR3 sequence
        to use (amino acid or nucleotide). V/J in the overlap_type define whether to check V or J segments
        to decide if clonotypes are equal
    mismatches (int): Max number of single-letter mismatches in clonotype sequences 
        for them to be treated similar, i.e. hamming distance.</p>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
<th>Name</th>          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
<td><code>df</code></td>            <td>
                  <code><span title="pandas.DataFrame">DataFrame</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>dataframe with following columns: <code>fold</code>, <code>p_value_b</code>, <code>p_value_p</code>, <code>p_value_b_adj</code>, <code>p_value_p_adj</code>, <code>log10_b_adj</code>, <code>log10_p_adj</code>, <code>log2_fc</code>. <code>p</code> in <code>p_value</code> </p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
<td></td>            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>stands for <code>poisson</code>, <code>b</code> for <code>binomial</code>, <code>adj</code> for multiple testing correction, and <code>log2_fc</code>for log2 fold change</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>repseq/intersections.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-270">270</a></span>
<span class="normal"><a href="#__codelineno-0-271">271</a></span>
<span class="normal"><a href="#__codelineno-0-272">272</a></span>
<span class="normal"><a href="#__codelineno-0-273">273</a></span>
<span class="normal"><a href="#__codelineno-0-274">274</a></span>
<span class="normal"><a href="#__codelineno-0-275">275</a></span>
<span class="normal"><a href="#__codelineno-0-276">276</a></span>
<span class="normal"><a href="#__codelineno-0-277">277</a></span>
<span class="normal"><a href="#__codelineno-0-278">278</a></span>
<span class="normal"><a href="#__codelineno-0-279">279</a></span>
<span class="normal"><a href="#__codelineno-0-280">280</a></span>
<span class="normal"><a href="#__codelineno-0-281">281</a></span>
<span class="normal"><a href="#__codelineno-0-282">282</a></span>
<span class="normal"><a href="#__codelineno-0-283">283</a></span>
<span class="normal"><a href="#__codelineno-0-284">284</a></span>
<span class="normal"><a href="#__codelineno-0-285">285</a></span>
<span class="normal"><a href="#__codelineno-0-286">286</a></span>
<span class="normal"><a href="#__codelineno-0-287">287</a></span>
<span class="normal"><a href="#__codelineno-0-288">288</a></span>
<span class="normal"><a href="#__codelineno-0-289">289</a></span>
<span class="normal"><a href="#__codelineno-0-290">290</a></span>
<span class="normal"><a href="#__codelineno-0-291">291</a></span>
<span class="normal"><a href="#__codelineno-0-292">292</a></span>
<span class="normal"><a href="#__codelineno-0-293">293</a></span>
<span class="normal"><a href="#__codelineno-0-294">294</a></span>
<span class="normal"><a href="#__codelineno-0-295">295</a></span>
<span class="normal"><a href="#__codelineno-0-296">296</a></span>
<span class="normal"><a href="#__codelineno-0-297">297</a></span>
<span class="normal"><a href="#__codelineno-0-298">298</a></span>
<span class="normal"><a href="#__codelineno-0-299">299</a></span>
<span class="normal"><a href="#__codelineno-0-300">300</a></span>
<span class="normal"><a href="#__codelineno-0-301">301</a></span>
<span class="normal"><a href="#__codelineno-0-302">302</a></span>
<span class="normal"><a href="#__codelineno-0-303">303</a></span>
<span class="normal"><a href="#__codelineno-0-304">304</a></span>
<span class="normal"><a href="#__codelineno-0-305">305</a></span>
<span class="normal"><a href="#__codelineno-0-306">306</a></span>
<span class="normal"><a href="#__codelineno-0-307">307</a></span>
<span class="normal"><a href="#__codelineno-0-308">308</a></span>
<span class="normal"><a href="#__codelineno-0-309">309</a></span>
<span class="normal"><a href="#__codelineno-0-310">310</a></span>
<span class="normal"><a href="#__codelineno-0-311">311</a></span>
<span class="normal"><a href="#__codelineno-0-312">312</a></span>
<span class="normal"><a href="#__codelineno-0-313">313</a></span>
<span class="normal"><a href="#__codelineno-0-314">314</a></span>
<span class="normal"><a href="#__codelineno-0-315">315</a></span>
<span class="normal"><a href="#__codelineno-0-316">316</a></span>
<span class="normal"><a href="#__codelineno-0-317">317</a></span>
<span class="normal"><a href="#__codelineno-0-318">318</a></span>
<span class="normal"><a href="#__codelineno-0-319">319</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-270" name="__codelineno-0-270"></a><span class="k">def</span><span class="w"> </span><span class="nf">tcrnet</span><span class="p">(</span><span class="n">clonosets_df_exp</span><span class="p">,</span> <span class="n">clonosets_df_control</span><span class="p">,</span> <span class="n">cl_filter</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">cl_filter_c</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">overlap_type</span><span class="o">=</span><span class="s2">&quot;aaVJ&quot;</span><span class="p">,</span> <span class="n">mismatches</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
<a id="__codelineno-0-271" name="__codelineno-0-271"></a>
<a id="__codelineno-0-272" name="__codelineno-0-272"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-273" name="__codelineno-0-273"></a><span class="sd">    This is an implementation of TCRnet (TCR neighbour enrichment test) algorithm.  It identifies similar clonotypes for the experimental dataset and the control one based on sequence </span>
<a id="__codelineno-0-274" name="__codelineno-0-274"></a><span class="sd">    similarity (allowing up to `mismatches` differences).    </span>
<a id="__codelineno-0-275" name="__codelineno-0-275"></a><span class="sd">    Args:</span>
<a id="__codelineno-0-276" name="__codelineno-0-276"></a><span class="sd">        clonosets_df_exp (pd.DataFrame): a DataFrame with experimental clonosets containing three columns - `sample_id` and `filename` columns,</span>
<a id="__codelineno-0-277" name="__codelineno-0-277"></a><span class="sd">            filename - full path to a clonoset file. Clonoset file may be of MiXCR3/MiXCR4 or VDJtools format</span>
<a id="__codelineno-0-278" name="__codelineno-0-278"></a><span class="sd">        clonosets_df_control (pd.DataFrame): a DataFrame with control clonosets containing three columns - `sample_id` and `filename` columns,</span>
<a id="__codelineno-0-279" name="__codelineno-0-279"></a><span class="sd">            filename - full path to clonoset file. Clonoset file may be of MiXCR3/MiXCR4 or VDJtools format</span>
<a id="__codelineno-0-280" name="__codelineno-0-280"></a><span class="sd">        cl_filter (repseq.clone_filter.Filter): A filter applied to the experimental dataset before processing</span>
<a id="__codelineno-0-281" name="__codelineno-0-281"></a><span class="sd">        cl_filter_c (repseq.clone_filter.Filter): A filter applied to the control dataset before processing</span>
<a id="__codelineno-0-282" name="__codelineno-0-282"></a><span class="sd">        overlap_type (str): possible values are `aa`, `aaV`, `aaVJ`, `nt`, `ntV`, `ntVJ`. aa/nt define which CDR3 sequence</span>
<a id="__codelineno-0-283" name="__codelineno-0-283"></a><span class="sd">            to use (amino acid or nucleotide). V/J in the overlap_type define whether to check V or J segments</span>
<a id="__codelineno-0-284" name="__codelineno-0-284"></a><span class="sd">            to decide if clonotypes are equal</span>
<a id="__codelineno-0-285" name="__codelineno-0-285"></a><span class="sd">        mismatches (int): Max number of single-letter mismatches in clonotype sequences </span>
<a id="__codelineno-0-286" name="__codelineno-0-286"></a><span class="sd">            for them to be treated similar, i.e. hamming distance.</span>
<a id="__codelineno-0-287" name="__codelineno-0-287"></a>
<a id="__codelineno-0-288" name="__codelineno-0-288"></a><span class="sd">    Returns:</span>
<a id="__codelineno-0-289" name="__codelineno-0-289"></a><span class="sd">        df (pd.DataFrame): dataframe with following columns: `fold`, `p_value_b`, `p_value_p`, `p_value_b_adj`, `p_value_p_adj`, `log10_b_adj`, `log10_p_adj`, `log2_fc`. `p` in `p_value` </span>
<a id="__codelineno-0-290" name="__codelineno-0-290"></a><span class="sd">        stands for `poisson`, `b` for `binomial`, `adj` for multiple testing correction, and `log2_fc`for log2 fold change </span>
<a id="__codelineno-0-291" name="__codelineno-0-291"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-292" name="__codelineno-0-292"></a>
<a id="__codelineno-0-293" name="__codelineno-0-293"></a>    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Running TCRnet neighbour count</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">+</span><span class="s2">&quot;-&quot;</span><span class="o">*</span><span class="mi">50</span><span class="p">)</span>
<a id="__codelineno-0-294" name="__codelineno-0-294"></a>    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Overlap type: </span><span class="si">{</span><span class="n">overlap_type</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-0-295" name="__codelineno-0-295"></a>
<a id="__codelineno-0-296" name="__codelineno-0-296"></a>    <span class="n">clonoset_exp</span> <span class="o">=</span> <span class="n">pool_clonotypes_from_clonosets_df</span><span class="p">(</span><span class="n">clonosets_df_exp</span><span class="p">,</span> <span class="n">cl_filter</span><span class="o">=</span><span class="n">cl_filter</span><span class="p">)</span>
<a id="__codelineno-0-297" name="__codelineno-0-297"></a>    <span class="n">clonoset_exp_dict</span> <span class="o">=</span> <span class="n">prepare_clonoset_for_intersection</span><span class="p">(</span><span class="n">clonoset_exp</span><span class="p">,</span> <span class="n">overlap_type</span><span class="o">=</span><span class="n">overlap_type</span><span class="p">,</span> <span class="n">by_freq</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">len_vj_format</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<a id="__codelineno-0-298" name="__codelineno-0-298"></a>
<a id="__codelineno-0-299" name="__codelineno-0-299"></a>    <span class="n">unique_clonotypes</span> <span class="o">=</span> <span class="p">[(</span><span class="n">seq_count</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="o">*</span><span class="n">len_vj</span><span class="p">[</span><span class="mi">1</span><span class="p">:])</span> <span class="k">for</span> <span class="n">len_vj</span><span class="p">,</span> <span class="n">seq_counts</span> <span class="ow">in</span> <span class="n">clonoset_exp_dict</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">for</span> <span class="n">seq_count</span> <span class="ow">in</span> <span class="n">seq_counts</span><span class="p">]</span>
<a id="__codelineno-0-300" name="__codelineno-0-300"></a>
<a id="__codelineno-0-301" name="__codelineno-0-301"></a>    <span class="n">clonoset_control</span> <span class="o">=</span> <span class="n">pool_clonotypes_from_clonosets_df</span><span class="p">(</span><span class="n">clonosets_df_control</span><span class="p">,</span> <span class="n">cl_filter</span><span class="o">=</span><span class="n">cl_filter_c</span><span class="p">)</span>
<a id="__codelineno-0-302" name="__codelineno-0-302"></a>    <span class="n">clonoset_control_dict</span> <span class="o">=</span> <span class="n">prepare_clonoset_for_intersection</span><span class="p">(</span><span class="n">clonoset_control</span><span class="p">,</span> <span class="n">overlap_type</span><span class="o">=</span><span class="n">overlap_type</span><span class="p">,</span> <span class="n">by_freq</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">len_vj_format</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<a id="__codelineno-0-303" name="__codelineno-0-303"></a>
<a id="__codelineno-0-304" name="__codelineno-0-304"></a>
<a id="__codelineno-0-305" name="__codelineno-0-305"></a>    <span class="n">tasks</span> <span class="o">=</span> <span class="p">[]</span>
<a id="__codelineno-0-306" name="__codelineno-0-306"></a>    <span class="n">chunks</span> <span class="o">=</span> <span class="mi">40</span>
<a id="__codelineno-0-307" name="__codelineno-0-307"></a>    <span class="n">chunk_size</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">unique_clonotypes</span><span class="p">)</span><span class="o">//</span><span class="n">chunks</span><span class="o">+</span><span class="mi">1</span>
<a id="__codelineno-0-308" name="__codelineno-0-308"></a>    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">chunks</span><span class="p">):</span>
<a id="__codelineno-0-309" name="__codelineno-0-309"></a>        <span class="n">first</span> <span class="o">=</span> <span class="n">i</span><span class="o">*</span><span class="n">chunk_size</span>
<a id="__codelineno-0-310" name="__codelineno-0-310"></a>        <span class="n">last</span> <span class="o">=</span> <span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">chunk_size</span>
<a id="__codelineno-0-311" name="__codelineno-0-311"></a>        <span class="n">task</span> <span class="o">=</span> <span class="p">(</span><span class="n">unique_clonotypes</span><span class="p">[</span><span class="n">first</span><span class="p">:</span><span class="n">last</span><span class="p">],</span> <span class="n">clonoset_exp_dict</span><span class="p">,</span> <span class="n">clonoset_control_dict</span><span class="p">,</span> <span class="n">mismatches</span><span class="p">)</span>
<a id="__codelineno-0-312" name="__codelineno-0-312"></a>        <span class="n">tasks</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">task</span><span class="p">)</span>
<a id="__codelineno-0-313" name="__codelineno-0-313"></a>
<a id="__codelineno-0-314" name="__codelineno-0-314"></a>    <span class="n">results</span> <span class="o">=</span> <span class="n">run_parallel_calculation</span><span class="p">(</span><span class="n">tcrnet_mp</span><span class="p">,</span> <span class="n">tasks</span><span class="p">,</span> <span class="s2">&quot;Calc neighbours (TCRnet)&quot;</span><span class="p">,</span> <span class="n">object_name</span><span class="o">=</span><span class="s2">&quot;parts&quot;</span><span class="p">)</span>
<a id="__codelineno-0-315" name="__codelineno-0-315"></a>    <span class="n">results</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">itertools</span><span class="o">.</span><span class="n">chain</span><span class="o">.</span><span class="n">from_iterable</span><span class="p">(</span><span class="n">results</span><span class="p">))</span> <span class="c1"># unpack results from several workers</span>
<a id="__codelineno-0-316" name="__codelineno-0-316"></a>
<a id="__codelineno-0-317" name="__codelineno-0-317"></a>    <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">results</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;clone&quot;</span><span class="p">,</span> <span class="s2">&quot;count_exp&quot;</span><span class="p">,</span> <span class="s2">&quot;count_control&quot;</span><span class="p">,</span> <span class="s2">&quot;group_count_exp&quot;</span><span class="p">,</span> <span class="s2">&quot;group_count_control&quot;</span><span class="p">])</span>
<a id="__codelineno-0-318" name="__codelineno-0-318"></a>    <span class="n">df</span> <span class="o">=</span> <span class="n">tcrnet_stats_calc</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>
<a id="__codelineno-0-319" name="__codelineno-0-319"></a>    <span class="k">return</span> <span class="n">df</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div><h2 id="io"><strong>io</strong></h2>


<div class="doc doc-object doc-module">




    <div class="doc doc-contents first">










  <div class="doc doc-children">










<div class="doc doc-object doc-function">


<h4 id="io.open_json_report" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">open_json_report</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span></code>

</h4>


    <div class="doc doc-contents ">

        <p>Supporting function for <code>read_json_report</code>. Reads the last record from json file.</p>


            <details class="quote">
              <summary>Source code in <code>repseq/io.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-162">162</a></span>
<span class="normal"><a href="#__codelineno-0-163">163</a></span>
<span class="normal"><a href="#__codelineno-0-164">164</a></span>
<span class="normal"><a href="#__codelineno-0-165">165</a></span>
<span class="normal"><a href="#__codelineno-0-166">166</a></span>
<span class="normal"><a href="#__codelineno-0-167">167</a></span>
<span class="normal"><a href="#__codelineno-0-168">168</a></span>
<span class="normal"><a href="#__codelineno-0-169">169</a></span>
<span class="normal"><a href="#__codelineno-0-170">170</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-162" name="__codelineno-0-162"></a><span class="k">def</span><span class="w"> </span><span class="nf">open_json_report</span><span class="p">(</span><span class="n">filename</span><span class="p">):</span>
<a id="__codelineno-0-163" name="__codelineno-0-163"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-164" name="__codelineno-0-164"></a><span class="sd">    Supporting function for `read_json_report`. Reads the last record from json file.</span>
<a id="__codelineno-0-165" name="__codelineno-0-165"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-166" name="__codelineno-0-166"></a>
<a id="__codelineno-0-167" name="__codelineno-0-167"></a>    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span> <span class="k">as</span> <span class="n">data_file</span><span class="p">:</span>    
<a id="__codelineno-0-168" name="__codelineno-0-168"></a>        <span class="k">for</span> <span class="n">jsonObj</span> <span class="ow">in</span> <span class="n">data_file</span><span class="p">:</span>
<a id="__codelineno-0-169" name="__codelineno-0-169"></a>            <span class="n">report</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">jsonObj</span><span class="p">)</span>
<a id="__codelineno-0-170" name="__codelineno-0-170"></a>    <span class="k">return</span> <span class="n">report</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h4 id="io.read_clonoset" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">read_clonoset</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span></code>

</h4>


    <div class="doc doc-contents ">

        <p>Reads generic clonoset files. 
Easyly reads <code>csv</code>, <code>tsv</code>, <code>txt</code> or <code>gz</code> files.
Reads first found file inside <code>zip</code> files.
Clonosets should be in tab-separated format: MiXCR (v3 or v4), vdjtools, Bioadaptive</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>filename</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>path to clonoset file</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
<th>Name</th>          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
<td><code>clonoset</code></td>            <td>
                  <code><span title="pandas.DataFrame">DataFrame</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>DataFrame representation of clonoset in given file.
Bioadaptive clonosets are converted to vdjtools-like format.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>repseq/io.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-62"> 62</a></span>
<span class="normal"><a href="#__codelineno-0-63"> 63</a></span>
<span class="normal"><a href="#__codelineno-0-64"> 64</a></span>
<span class="normal"><a href="#__codelineno-0-65"> 65</a></span>
<span class="normal"><a href="#__codelineno-0-66"> 66</a></span>
<span class="normal"><a href="#__codelineno-0-67"> 67</a></span>
<span class="normal"><a href="#__codelineno-0-68"> 68</a></span>
<span class="normal"><a href="#__codelineno-0-69"> 69</a></span>
<span class="normal"><a href="#__codelineno-0-70"> 70</a></span>
<span class="normal"><a href="#__codelineno-0-71"> 71</a></span>
<span class="normal"><a href="#__codelineno-0-72"> 72</a></span>
<span class="normal"><a href="#__codelineno-0-73"> 73</a></span>
<span class="normal"><a href="#__codelineno-0-74"> 74</a></span>
<span class="normal"><a href="#__codelineno-0-75"> 75</a></span>
<span class="normal"><a href="#__codelineno-0-76"> 76</a></span>
<span class="normal"><a href="#__codelineno-0-77"> 77</a></span>
<span class="normal"><a href="#__codelineno-0-78"> 78</a></span>
<span class="normal"><a href="#__codelineno-0-79"> 79</a></span>
<span class="normal"><a href="#__codelineno-0-80"> 80</a></span>
<span class="normal"><a href="#__codelineno-0-81"> 81</a></span>
<span class="normal"><a href="#__codelineno-0-82"> 82</a></span>
<span class="normal"><a href="#__codelineno-0-83"> 83</a></span>
<span class="normal"><a href="#__codelineno-0-84"> 84</a></span>
<span class="normal"><a href="#__codelineno-0-85"> 85</a></span>
<span class="normal"><a href="#__codelineno-0-86"> 86</a></span>
<span class="normal"><a href="#__codelineno-0-87"> 87</a></span>
<span class="normal"><a href="#__codelineno-0-88"> 88</a></span>
<span class="normal"><a href="#__codelineno-0-89"> 89</a></span>
<span class="normal"><a href="#__codelineno-0-90"> 90</a></span>
<span class="normal"><a href="#__codelineno-0-91"> 91</a></span>
<span class="normal"><a href="#__codelineno-0-92"> 92</a></span>
<span class="normal"><a href="#__codelineno-0-93"> 93</a></span>
<span class="normal"><a href="#__codelineno-0-94"> 94</a></span>
<span class="normal"><a href="#__codelineno-0-95"> 95</a></span>
<span class="normal"><a href="#__codelineno-0-96"> 96</a></span>
<span class="normal"><a href="#__codelineno-0-97"> 97</a></span>
<span class="normal"><a href="#__codelineno-0-98"> 98</a></span>
<span class="normal"><a href="#__codelineno-0-99"> 99</a></span>
<span class="normal"><a href="#__codelineno-0-100">100</a></span>
<span class="normal"><a href="#__codelineno-0-101">101</a></span>
<span class="normal"><a href="#__codelineno-0-102">102</a></span>
<span class="normal"><a href="#__codelineno-0-103">103</a></span>
<span class="normal"><a href="#__codelineno-0-104">104</a></span>
<span class="normal"><a href="#__codelineno-0-105">105</a></span>
<span class="normal"><a href="#__codelineno-0-106">106</a></span>
<span class="normal"><a href="#__codelineno-0-107">107</a></span>
<span class="normal"><a href="#__codelineno-0-108">108</a></span>
<span class="normal"><a href="#__codelineno-0-109">109</a></span>
<span class="normal"><a href="#__codelineno-0-110">110</a></span>
<span class="normal"><a href="#__codelineno-0-111">111</a></span>
<span class="normal"><a href="#__codelineno-0-112">112</a></span>
<span class="normal"><a href="#__codelineno-0-113">113</a></span>
<span class="normal"><a href="#__codelineno-0-114">114</a></span>
<span class="normal"><a href="#__codelineno-0-115">115</a></span>
<span class="normal"><a href="#__codelineno-0-116">116</a></span>
<span class="normal"><a href="#__codelineno-0-117">117</a></span>
<span class="normal"><a href="#__codelineno-0-118">118</a></span>
<span class="normal"><a href="#__codelineno-0-119">119</a></span>
<span class="normal"><a href="#__codelineno-0-120">120</a></span>
<span class="normal"><a href="#__codelineno-0-121">121</a></span>
<span class="normal"><a href="#__codelineno-0-122">122</a></span>
<span class="normal"><a href="#__codelineno-0-123">123</a></span>
<span class="normal"><a href="#__codelineno-0-124">124</a></span>
<span class="normal"><a href="#__codelineno-0-125">125</a></span>
<span class="normal"><a href="#__codelineno-0-126">126</a></span>
<span class="normal"><a href="#__codelineno-0-127">127</a></span>
<span class="normal"><a href="#__codelineno-0-128">128</a></span>
<span class="normal"><a href="#__codelineno-0-129">129</a></span>
<span class="normal"><a href="#__codelineno-0-130">130</a></span>
<span class="normal"><a href="#__codelineno-0-131">131</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-62" name="__codelineno-0-62"></a><span class="k">def</span><span class="w"> </span><span class="nf">read_clonoset</span><span class="p">(</span><span class="n">filename</span><span class="p">):</span>
<a id="__codelineno-0-63" name="__codelineno-0-63"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-64" name="__codelineno-0-64"></a><span class="sd">    Reads generic clonoset files. </span>
<a id="__codelineno-0-65" name="__codelineno-0-65"></a><span class="sd">    Easyly reads `csv`, `tsv`, `txt` or `gz` files.</span>
<a id="__codelineno-0-66" name="__codelineno-0-66"></a><span class="sd">    Reads first found file inside `zip` files.</span>
<a id="__codelineno-0-67" name="__codelineno-0-67"></a><span class="sd">    Clonosets should be in tab-separated format: MiXCR (v3 or v4), vdjtools, Bioadaptive</span>
<a id="__codelineno-0-68" name="__codelineno-0-68"></a>
<a id="__codelineno-0-69" name="__codelineno-0-69"></a><span class="sd">    Args:</span>
<a id="__codelineno-0-70" name="__codelineno-0-70"></a><span class="sd">        filename (str): path to clonoset file</span>
<a id="__codelineno-0-71" name="__codelineno-0-71"></a>
<a id="__codelineno-0-72" name="__codelineno-0-72"></a><span class="sd">    Returns:</span>
<a id="__codelineno-0-73" name="__codelineno-0-73"></a><span class="sd">        clonoset (pd.DataFrame): DataFrame representation of clonoset in given file.</span>
<a id="__codelineno-0-74" name="__codelineno-0-74"></a><span class="sd">            Bioadaptive clonosets are converted to vdjtools-like format.</span>
<a id="__codelineno-0-75" name="__codelineno-0-75"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-76" name="__codelineno-0-76"></a>
<a id="__codelineno-0-77" name="__codelineno-0-77"></a>
<a id="__codelineno-0-78" name="__codelineno-0-78"></a>    <span class="n">file_name</span><span class="p">,</span> <span class="n">file_extension</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
<a id="__codelineno-0-79" name="__codelineno-0-79"></a>
<a id="__codelineno-0-80" name="__codelineno-0-80"></a>    <span class="n">d_types_mixcr</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;cloneId&#39;</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="s1">&#39;readCount&#39;</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="s1">&#39;readFraction&#39;</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
<a id="__codelineno-0-81" name="__codelineno-0-81"></a>                    <span class="s1">&#39;uniqueUMICount&#39;</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="s1">&#39;uniqueUMIFraction&#39;</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
<a id="__codelineno-0-82" name="__codelineno-0-82"></a>                    <span class="s1">&#39;uniqueMoleculeCount&#39;</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="s1">&#39;uniqueMoleculeFraction&#39;</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
<a id="__codelineno-0-83" name="__codelineno-0-83"></a>                    <span class="s1">&#39;cloneCount&#39;</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="s1">&#39;cloneFraction&#39;</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
<a id="__codelineno-0-84" name="__codelineno-0-84"></a>                    <span class="s1">&#39;targetSequences&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="s1">&#39;targetQualities&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
<a id="__codelineno-0-85" name="__codelineno-0-85"></a>                    <span class="s1">&#39;allVHitsWithScore&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="s1">&#39;allDHitsWithScore&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
<a id="__codelineno-0-86" name="__codelineno-0-86"></a>                    <span class="s1">&#39;allJHitsWithScore&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="s1">&#39;allCHitsWithScore&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
<a id="__codelineno-0-87" name="__codelineno-0-87"></a>                    <span class="s1">&#39;allVAlignments&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="s1">&#39;allDAlignments&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
<a id="__codelineno-0-88" name="__codelineno-0-88"></a>                    <span class="s1">&#39;allJAlignments&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="s1">&#39;allCAlignments&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
<a id="__codelineno-0-89" name="__codelineno-0-89"></a>                    <span class="s1">&#39;nSeqFR1&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="s1">&#39;minQualFR1&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
<a id="__codelineno-0-90" name="__codelineno-0-90"></a>                    <span class="s1">&#39;nSeqCDR1&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="s1">&#39;minQualCDR1&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
<a id="__codelineno-0-91" name="__codelineno-0-91"></a>                    <span class="s1">&#39;nSeqFR2&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="s1">&#39;minQualFR2&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
<a id="__codelineno-0-92" name="__codelineno-0-92"></a>                    <span class="s1">&#39;nSeqCDR2&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="s1">&#39;minQualCDR2&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
<a id="__codelineno-0-93" name="__codelineno-0-93"></a>                    <span class="s1">&#39;nSeqFR3&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="s1">&#39;minQualFR3&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
<a id="__codelineno-0-94" name="__codelineno-0-94"></a>                    <span class="s1">&#39;nSeqCDR3&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="s1">&#39;minQualCDR3&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
<a id="__codelineno-0-95" name="__codelineno-0-95"></a>                    <span class="s1">&#39;nSeqFR4&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="s1">&#39;minQualFR4&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
<a id="__codelineno-0-96" name="__codelineno-0-96"></a>                    <span class="s1">&#39;aaSeqFR1&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="s1">&#39;aaSeqCDR1&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
<a id="__codelineno-0-97" name="__codelineno-0-97"></a>                    <span class="s1">&#39;aaSeqFR2&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="s1">&#39;aaSeqCDR2&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
<a id="__codelineno-0-98" name="__codelineno-0-98"></a>                    <span class="s1">&#39;aaSeqFR3&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="s1">&#39;aaSeqCDR3&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
<a id="__codelineno-0-99" name="__codelineno-0-99"></a>                    <span class="s1">&#39;aaSeqFR4&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="s1">&#39;refPoints&#39;</span><span class="p">:</span> <span class="nb">str</span>
<a id="__codelineno-0-100" name="__codelineno-0-100"></a>                    <span class="p">}</span>
<a id="__codelineno-0-101" name="__codelineno-0-101"></a>
<a id="__codelineno-0-102" name="__codelineno-0-102"></a>    <span class="n">d_types_vdjtools</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;cdr3aa&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="s1">&#39;cdr3nt&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
<a id="__codelineno-0-103" name="__codelineno-0-103"></a>                        <span class="s1">&#39;v&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="s1">&#39;d&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="s1">&#39;j&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
<a id="__codelineno-0-104" name="__codelineno-0-104"></a>                        <span class="s1">&#39;CDR3aa&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="s1">&#39;CDR3nt&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
<a id="__codelineno-0-105" name="__codelineno-0-105"></a>                        <span class="s1">&#39;V&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="s1">&#39;D&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="s1">&#39;J&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
<a id="__codelineno-0-106" name="__codelineno-0-106"></a>                        <span class="s1">&#39;C&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="s2">&quot;frequency&quot;</span><span class="p">:</span> <span class="nb">float</span><span class="c1">#,</span>
<a id="__codelineno-0-107" name="__codelineno-0-107"></a>                        <span class="c1">#&#39;count&#39;: int, &#39;freq&#39;: float#,</span>
<a id="__codelineno-0-108" name="__codelineno-0-108"></a>                        <span class="c1">#&#39;VEnd&#39;:int, &#39;DStart&#39;:int, &#39;DEnd&#39;:int, &quot;JStart&quot;:int</span>
<a id="__codelineno-0-109" name="__codelineno-0-109"></a>                        <span class="p">}</span>
<a id="__codelineno-0-110" name="__codelineno-0-110"></a>
<a id="__codelineno-0-111" name="__codelineno-0-111"></a>    <span class="n">d_types_bioadaptive</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;nucleotide&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="s1">&#39;aminoAcid&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
<a id="__codelineno-0-112" name="__codelineno-0-112"></a>                            <span class="s1">&#39;count (templates/reads)&#39;</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
<a id="__codelineno-0-113" name="__codelineno-0-113"></a>                            <span class="s1">&#39;frequencyCount (%)&#39;</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
<a id="__codelineno-0-114" name="__codelineno-0-114"></a>                            <span class="s1">&#39;count&#39;</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
<a id="__codelineno-0-115" name="__codelineno-0-115"></a>                            <span class="s1">&#39;frequencyCount&#39;</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
<a id="__codelineno-0-116" name="__codelineno-0-116"></a>                            <span class="s1">&#39;vGeneName&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="s1">&#39;dGeneName&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
<a id="__codelineno-0-117" name="__codelineno-0-117"></a>                            <span class="s1">&#39;jGeneName&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="s1">&#39;cdr3Length&#39;</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
<a id="__codelineno-0-118" name="__codelineno-0-118"></a>                            <span class="s1">&#39;n1Index&#39;</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span><span class="s1">&#39;dIndex&#39;</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
<a id="__codelineno-0-119" name="__codelineno-0-119"></a>                            <span class="s1">&#39;n2Index&#39;</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span><span class="s1">&#39;jIndex&#39;</span><span class="p">:</span> <span class="nb">int</span>
<a id="__codelineno-0-120" name="__codelineno-0-120"></a>                            <span class="p">}</span>
<a id="__codelineno-0-121" name="__codelineno-0-121"></a>
<a id="__codelineno-0-122" name="__codelineno-0-122"></a>
<a id="__codelineno-0-123" name="__codelineno-0-123"></a>    <span class="n">datatypes</span> <span class="o">=</span> <span class="p">{</span><span class="o">**</span><span class="n">d_types_mixcr</span><span class="p">,</span><span class="o">**</span><span class="n">d_types_vdjtools</span><span class="p">,</span> <span class="o">**</span><span class="n">d_types_bioadaptive</span><span class="p">}</span>
<a id="__codelineno-0-124" name="__codelineno-0-124"></a>    <span class="k">if</span> <span class="n">file_extension</span> <span class="o">==</span> <span class="s2">&quot;.zip&quot;</span><span class="p">:</span>
<a id="__codelineno-0-125" name="__codelineno-0-125"></a>        <span class="n">archive</span> <span class="o">=</span> <span class="n">zipfile</span><span class="o">.</span><span class="n">ZipFile</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span>
<a id="__codelineno-0-126" name="__codelineno-0-126"></a>        <span class="n">inner_filename</span> <span class="o">=</span> <span class="n">zipfile</span><span class="o">.</span><span class="n">ZipFile</span><span class="o">.</span><span class="n">namelist</span><span class="p">(</span><span class="n">archive</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
<a id="__codelineno-0-127" name="__codelineno-0-127"></a>        <span class="n">filename</span> <span class="o">=</span> <span class="n">archive</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">inner_filename</span><span class="p">)</span>
<a id="__codelineno-0-128" name="__codelineno-0-128"></a>    <span class="n">clonoset</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="s2">&quot;</span><span class="se">\t</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">datatypes</span><span class="p">)</span>
<a id="__codelineno-0-129" name="__codelineno-0-129"></a>    <span class="k">if</span> <span class="s2">&quot;nucleotide&quot;</span> <span class="ow">in</span> <span class="n">clonoset</span><span class="o">.</span><span class="n">columns</span> <span class="ow">and</span> <span class="s2">&quot;aminoAcid&quot;</span> <span class="ow">in</span> <span class="n">clonoset</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
<a id="__codelineno-0-130" name="__codelineno-0-130"></a>        <span class="n">clonoset</span> <span class="o">=</span> <span class="n">convert_bioadaptive_clonoset</span><span class="p">(</span><span class="n">clonoset</span><span class="p">)</span>
<a id="__codelineno-0-131" name="__codelineno-0-131"></a>    <span class="k">return</span> <span class="n">clonoset</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h4 id="io.read_json_report" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">read_json_report</span><span class="p">(</span><span class="n">sample_id</span><span class="p">,</span> <span class="n">folder</span><span class="p">,</span> <span class="n">report_type</span><span class="p">)</span></code>

</h4>


    <div class="doc doc-contents ">

        <p>Reads MiXCR4 json reports into a Python mixed data structure.
This function takes the last json record, if for example MiXCR adds up several records 
to json file (it happens, when the program is rerun several times on the same data).
Program also includes cases when Sample-barcodes are used.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>sample_id</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>sample_id used when running the MiXCR program</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>folder</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>folder in which the MiXCR output is stored</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>report_type</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>align, refine, assemble</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
<th>Name</th>          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
<td><code>report</code></td>            <td>
                  <code><span title="dict">dict</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>mixed dict/list python structure, representing the json report</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>repseq/io.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-133">133</a></span>
<span class="normal"><a href="#__codelineno-0-134">134</a></span>
<span class="normal"><a href="#__codelineno-0-135">135</a></span>
<span class="normal"><a href="#__codelineno-0-136">136</a></span>
<span class="normal"><a href="#__codelineno-0-137">137</a></span>
<span class="normal"><a href="#__codelineno-0-138">138</a></span>
<span class="normal"><a href="#__codelineno-0-139">139</a></span>
<span class="normal"><a href="#__codelineno-0-140">140</a></span>
<span class="normal"><a href="#__codelineno-0-141">141</a></span>
<span class="normal"><a href="#__codelineno-0-142">142</a></span>
<span class="normal"><a href="#__codelineno-0-143">143</a></span>
<span class="normal"><a href="#__codelineno-0-144">144</a></span>
<span class="normal"><a href="#__codelineno-0-145">145</a></span>
<span class="normal"><a href="#__codelineno-0-146">146</a></span>
<span class="normal"><a href="#__codelineno-0-147">147</a></span>
<span class="normal"><a href="#__codelineno-0-148">148</a></span>
<span class="normal"><a href="#__codelineno-0-149">149</a></span>
<span class="normal"><a href="#__codelineno-0-150">150</a></span>
<span class="normal"><a href="#__codelineno-0-151">151</a></span>
<span class="normal"><a href="#__codelineno-0-152">152</a></span>
<span class="normal"><a href="#__codelineno-0-153">153</a></span>
<span class="normal"><a href="#__codelineno-0-154">154</a></span>
<span class="normal"><a href="#__codelineno-0-155">155</a></span>
<span class="normal"><a href="#__codelineno-0-156">156</a></span>
<span class="normal"><a href="#__codelineno-0-157">157</a></span>
<span class="normal"><a href="#__codelineno-0-158">158</a></span>
<span class="normal"><a href="#__codelineno-0-159">159</a></span>
<span class="normal"><a href="#__codelineno-0-160">160</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-133" name="__codelineno-0-133"></a><span class="k">def</span><span class="w"> </span><span class="nf">read_json_report</span><span class="p">(</span><span class="n">sample_id</span><span class="p">,</span> <span class="n">folder</span><span class="p">,</span> <span class="n">report_type</span><span class="p">):</span>
<a id="__codelineno-0-134" name="__codelineno-0-134"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-135" name="__codelineno-0-135"></a><span class="sd">    Reads MiXCR4 json reports into a Python mixed data structure.</span>
<a id="__codelineno-0-136" name="__codelineno-0-136"></a><span class="sd">    This function takes the last json record, if for example MiXCR adds up several records </span>
<a id="__codelineno-0-137" name="__codelineno-0-137"></a><span class="sd">    to json file (it happens, when the program is rerun several times on the same data).</span>
<a id="__codelineno-0-138" name="__codelineno-0-138"></a><span class="sd">    Program also includes cases when Sample-barcodes are used.</span>
<a id="__codelineno-0-139" name="__codelineno-0-139"></a>
<a id="__codelineno-0-140" name="__codelineno-0-140"></a><span class="sd">    Args:</span>
<a id="__codelineno-0-141" name="__codelineno-0-141"></a><span class="sd">        sample_id (str): sample_id used when running the MiXCR program</span>
<a id="__codelineno-0-142" name="__codelineno-0-142"></a><span class="sd">        folder (str): folder in which the MiXCR output is stored</span>
<a id="__codelineno-0-143" name="__codelineno-0-143"></a><span class="sd">        report_type (str): align, refine, assemble</span>
<a id="__codelineno-0-144" name="__codelineno-0-144"></a>
<a id="__codelineno-0-145" name="__codelineno-0-145"></a><span class="sd">    Returns:</span>
<a id="__codelineno-0-146" name="__codelineno-0-146"></a><span class="sd">        report (dict): mixed dict/list python structure, representing the json report</span>
<a id="__codelineno-0-147" name="__codelineno-0-147"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-148" name="__codelineno-0-148"></a>
<a id="__codelineno-0-149" name="__codelineno-0-149"></a>
<a id="__codelineno-0-150" name="__codelineno-0-150"></a>    <span class="n">filename</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">folder</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">sample_id</span><span class="si">}</span><span class="s2">.</span><span class="si">{</span><span class="n">report_type</span><span class="si">}</span><span class="s2">.report.json&quot;</span><span class="p">)</span>
<a id="__codelineno-0-151" name="__codelineno-0-151"></a>    <span class="k">if</span> <span class="s2">&quot;.&quot;</span> <span class="ow">in</span> <span class="n">sample_id</span><span class="p">:</span>
<a id="__codelineno-0-152" name="__codelineno-0-152"></a>        <span class="n">sample_id2</span> <span class="o">=</span> <span class="s2">&quot;.&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">sample_id</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">)[:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
<a id="__codelineno-0-153" name="__codelineno-0-153"></a>        <span class="n">filename2</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">folder</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">sample_id2</span><span class="si">}</span><span class="s2">.</span><span class="si">{</span><span class="n">report_type</span><span class="si">}</span><span class="s2">.report.json&quot;</span><span class="p">)</span>
<a id="__codelineno-0-154" name="__codelineno-0-154"></a>        <span class="k">try</span><span class="p">:</span>
<a id="__codelineno-0-155" name="__codelineno-0-155"></a>            <span class="n">report</span> <span class="o">=</span> <span class="n">open_json_report</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
<a id="__codelineno-0-156" name="__codelineno-0-156"></a>        <span class="k">except</span> <span class="ne">FileNotFoundError</span><span class="p">:</span>
<a id="__codelineno-0-157" name="__codelineno-0-157"></a>            <span class="n">report</span> <span class="o">=</span> <span class="n">open_json_report</span><span class="p">(</span><span class="n">filename2</span><span class="p">)</span>
<a id="__codelineno-0-158" name="__codelineno-0-158"></a>    <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-159" name="__codelineno-0-159"></a>        <span class="n">report</span> <span class="o">=</span> <span class="n">open_json_report</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
<a id="__codelineno-0-160" name="__codelineno-0-160"></a>    <span class="k">return</span> <span class="n">report</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h4 id="io.read_yaml_metadata" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">read_yaml_metadata</span><span class="p">(</span><span class="n">folder</span><span class="p">,</span> <span class="n">filename</span><span class="o">=</span><span class="s1">&#39;metadata.yaml&#39;</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span></code>

</h4>


    <div class="doc doc-contents ">

        <p>Reads NGSiK metadata from a given folder and converts to <code>pd.DataFrame</code>. By default 
it searches for <code>metadata.yaml</code> file in this folder and extracts the table.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>folder</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>path to NGSiK folder</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>filename</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>NGSiK metadata filename</p>
              </div>
            </td>
            <td>
                  <code>&#39;metadata.yaml&#39;</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>verbose</code>
            </td>
            <td>
                  <code><span title="bool">bool</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>verbosity for </p>
              </div>
            </td>
            <td>
                  <code>True</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
<th>Name</th>          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
<td><code>sample_df</code></td>            <td>
                  <code><span title="pandas.DataFrame">DataFrame</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>extracted DataFrame from metadata</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>repseq/io.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-11">11</a></span>
<span class="normal"><a href="#__codelineno-0-12">12</a></span>
<span class="normal"><a href="#__codelineno-0-13">13</a></span>
<span class="normal"><a href="#__codelineno-0-14">14</a></span>
<span class="normal"><a href="#__codelineno-0-15">15</a></span>
<span class="normal"><a href="#__codelineno-0-16">16</a></span>
<span class="normal"><a href="#__codelineno-0-17">17</a></span>
<span class="normal"><a href="#__codelineno-0-18">18</a></span>
<span class="normal"><a href="#__codelineno-0-19">19</a></span>
<span class="normal"><a href="#__codelineno-0-20">20</a></span>
<span class="normal"><a href="#__codelineno-0-21">21</a></span>
<span class="normal"><a href="#__codelineno-0-22">22</a></span>
<span class="normal"><a href="#__codelineno-0-23">23</a></span>
<span class="normal"><a href="#__codelineno-0-24">24</a></span>
<span class="normal"><a href="#__codelineno-0-25">25</a></span>
<span class="normal"><a href="#__codelineno-0-26">26</a></span>
<span class="normal"><a href="#__codelineno-0-27">27</a></span>
<span class="normal"><a href="#__codelineno-0-28">28</a></span>
<span class="normal"><a href="#__codelineno-0-29">29</a></span>
<span class="normal"><a href="#__codelineno-0-30">30</a></span>
<span class="normal"><a href="#__codelineno-0-31">31</a></span>
<span class="normal"><a href="#__codelineno-0-32">32</a></span>
<span class="normal"><a href="#__codelineno-0-33">33</a></span>
<span class="normal"><a href="#__codelineno-0-34">34</a></span>
<span class="normal"><a href="#__codelineno-0-35">35</a></span>
<span class="normal"><a href="#__codelineno-0-36">36</a></span>
<span class="normal"><a href="#__codelineno-0-37">37</a></span>
<span class="normal"><a href="#__codelineno-0-38">38</a></span>
<span class="normal"><a href="#__codelineno-0-39">39</a></span>
<span class="normal"><a href="#__codelineno-0-40">40</a></span>
<span class="normal"><a href="#__codelineno-0-41">41</a></span>
<span class="normal"><a href="#__codelineno-0-42">42</a></span>
<span class="normal"><a href="#__codelineno-0-43">43</a></span>
<span class="normal"><a href="#__codelineno-0-44">44</a></span>
<span class="normal"><a href="#__codelineno-0-45">45</a></span>
<span class="normal"><a href="#__codelineno-0-46">46</a></span>
<span class="normal"><a href="#__codelineno-0-47">47</a></span>
<span class="normal"><a href="#__codelineno-0-48">48</a></span>
<span class="normal"><a href="#__codelineno-0-49">49</a></span>
<span class="normal"><a href="#__codelineno-0-50">50</a></span>
<span class="normal"><a href="#__codelineno-0-51">51</a></span>
<span class="normal"><a href="#__codelineno-0-52">52</a></span>
<span class="normal"><a href="#__codelineno-0-53">53</a></span>
<span class="normal"><a href="#__codelineno-0-54">54</a></span>
<span class="normal"><a href="#__codelineno-0-55">55</a></span>
<span class="normal"><a href="#__codelineno-0-56">56</a></span>
<span class="normal"><a href="#__codelineno-0-57">57</a></span>
<span class="normal"><a href="#__codelineno-0-58">58</a></span>
<span class="normal"><a href="#__codelineno-0-59">59</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-11" name="__codelineno-0-11"></a><span class="k">def</span><span class="w"> </span><span class="nf">read_yaml_metadata</span><span class="p">(</span><span class="n">folder</span><span class="p">,</span> <span class="n">filename</span><span class="o">=</span><span class="s2">&quot;metadata.yaml&quot;</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
<a id="__codelineno-0-12" name="__codelineno-0-12"></a>
<a id="__codelineno-0-13" name="__codelineno-0-13"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-14" name="__codelineno-0-14"></a><span class="sd">    Reads NGSiK metadata from a given folder and converts to `pd.DataFrame`. By default </span>
<a id="__codelineno-0-15" name="__codelineno-0-15"></a><span class="sd">    it searches for `metadata.yaml` file in this folder and extracts the table.</span>
<a id="__codelineno-0-16" name="__codelineno-0-16"></a>
<a id="__codelineno-0-17" name="__codelineno-0-17"></a><span class="sd">    Args:</span>
<a id="__codelineno-0-18" name="__codelineno-0-18"></a><span class="sd">        folder (str): path to NGSiK folder</span>
<a id="__codelineno-0-19" name="__codelineno-0-19"></a><span class="sd">        filename (str): NGSiK metadata filename</span>
<a id="__codelineno-0-20" name="__codelineno-0-20"></a><span class="sd">        verbose (bool): verbosity for </span>
<a id="__codelineno-0-21" name="__codelineno-0-21"></a>
<a id="__codelineno-0-22" name="__codelineno-0-22"></a><span class="sd">    Returns:</span>
<a id="__codelineno-0-23" name="__codelineno-0-23"></a><span class="sd">        sample_df (pd.DataFrame): extracted DataFrame from metadata</span>
<a id="__codelineno-0-24" name="__codelineno-0-24"></a>
<a id="__codelineno-0-25" name="__codelineno-0-25"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-26" name="__codelineno-0-26"></a>
<a id="__codelineno-0-27" name="__codelineno-0-27"></a>
<a id="__codelineno-0-28" name="__codelineno-0-28"></a>    <span class="n">most_important_columns</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;sample_id&quot;</span><span class="p">,</span> <span class="s2">&quot;R1&quot;</span><span class="p">,</span> <span class="s2">&quot;R2&quot;</span><span class="p">,</span><span class="s2">&quot;libraryPerson&quot;</span><span class="p">,</span> <span class="s2">&quot;projectPerson&quot;</span><span class="p">,</span> <span class="s2">&quot;projectName&quot;</span><span class="p">,</span> <span class="s2">&quot;species&quot;</span><span class="p">,</span> <span class="s2">&quot;miNNNPattern&quot;</span><span class="p">,</span> <span class="s2">&quot;SMPL&quot;</span><span class="p">,</span> <span class="s2">&quot;mix_id&quot;</span><span class="p">,</span> <span class="s2">&quot;preset&quot;</span><span class="p">,</span> <span class="s2">&quot;startingMaterial&quot;</span><span class="p">,</span> <span class="s2">&quot;libraryType&quot;</span><span class="p">]</span>
<a id="__codelineno-0-29" name="__codelineno-0-29"></a>    <span class="n">yaml_filename</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">folder</span><span class="p">,</span> <span class="n">filename</span><span class="p">)</span>
<a id="__codelineno-0-30" name="__codelineno-0-30"></a>
<a id="__codelineno-0-31" name="__codelineno-0-31"></a>    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">yaml_filename</span><span class="p">):</span>
<a id="__codelineno-0-32" name="__codelineno-0-32"></a>        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">yaml_filename</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">stream</span><span class="p">:</span>
<a id="__codelineno-0-33" name="__codelineno-0-33"></a>            <span class="k">try</span><span class="p">:</span>
<a id="__codelineno-0-34" name="__codelineno-0-34"></a>                <span class="n">metadata_dict</span> <span class="o">=</span><span class="n">yaml</span><span class="o">.</span><span class="n">safe_load</span><span class="p">(</span><span class="n">stream</span><span class="p">)</span>
<a id="__codelineno-0-35" name="__codelineno-0-35"></a>        <span class="c1">#         pd.io.json.json_normalize(metadata_dict, &quot;file&quot;, &quot;samples&quot;, errors=&#39;ignore&#39;)</span>
<a id="__codelineno-0-36" name="__codelineno-0-36"></a>            <span class="k">except</span> <span class="n">yaml</span><span class="o">.</span><span class="n">YAMLError</span> <span class="k">as</span> <span class="n">exc</span><span class="p">:</span>
<a id="__codelineno-0-37" name="__codelineno-0-37"></a>                <span class="nb">print</span><span class="p">(</span><span class="n">exc</span><span class="p">)</span>
<a id="__codelineno-0-38" name="__codelineno-0-38"></a>
<a id="__codelineno-0-39" name="__codelineno-0-39"></a>        <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">json_normalize</span><span class="p">(</span><span class="n">metadata_dict</span><span class="p">)</span>
<a id="__codelineno-0-40" name="__codelineno-0-40"></a>        <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">explode</span><span class="p">(</span><span class="s2">&quot;file&quot;</span><span class="p">)</span>
<a id="__codelineno-0-41" name="__codelineno-0-41"></a>        <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">df</span><span class="o">.</span><span class="n">drop</span><span class="p">([</span><span class="s1">&#39;file&#39;</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">),</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;file&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">)],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<a id="__codelineno-0-42" name="__codelineno-0-42"></a>        <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">explode</span><span class="p">(</span><span class="s2">&quot;samples&quot;</span><span class="p">)</span>
<a id="__codelineno-0-43" name="__codelineno-0-43"></a>        <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">df</span><span class="o">.</span><span class="n">drop</span><span class="p">([</span><span class="s1">&#39;samples&#39;</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">),</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;samples&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">)],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<a id="__codelineno-0-44" name="__codelineno-0-44"></a>        <span class="k">if</span> <span class="s1">&#39;patternGroupValues&#39;</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
<a id="__codelineno-0-45" name="__codelineno-0-45"></a>            <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">df</span><span class="o">.</span><span class="n">drop</span><span class="p">([</span><span class="s1">&#39;patternGroupValues&#39;</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">),</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;patternGroupValues&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">)],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<a id="__codelineno-0-46" name="__codelineno-0-46"></a>        <span class="n">df</span><span class="p">[</span><span class="s2">&quot;R1&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;R1&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">folder</span><span class="p">,</span> <span class="n">x</span><span class="p">))</span>
<a id="__codelineno-0-47" name="__codelineno-0-47"></a>        <span class="n">df</span><span class="p">[</span><span class="s2">&quot;R2&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;R2&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">folder</span><span class="p">,</span> <span class="n">x</span><span class="p">))</span>
<a id="__codelineno-0-48" name="__codelineno-0-48"></a>        <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;sample_id&quot;</span><span class="p">})</span>
<a id="__codelineno-0-49" name="__codelineno-0-49"></a>
<a id="__codelineno-0-50" name="__codelineno-0-50"></a>        <span class="k">for</span> <span class="n">col_name</span> <span class="ow">in</span> <span class="n">most_important_columns</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]:</span>
<a id="__codelineno-0-51" name="__codelineno-0-51"></a>            <span class="k">if</span> <span class="n">col_name</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
<a id="__codelineno-0-52" name="__codelineno-0-52"></a>                <span class="n">first_column</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">col_name</span><span class="p">)</span> 
<a id="__codelineno-0-53" name="__codelineno-0-53"></a>                <span class="n">df</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">col_name</span><span class="p">,</span> <span class="n">first_column</span><span class="p">)</span>
<a id="__codelineno-0-54" name="__codelineno-0-54"></a>
<a id="__codelineno-0-55" name="__codelineno-0-55"></a>        <span class="k">return</span> <span class="n">df</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<a id="__codelineno-0-56" name="__codelineno-0-56"></a>    <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-57" name="__codelineno-0-57"></a>        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
<a id="__codelineno-0-58" name="__codelineno-0-58"></a>            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Metadata file &#39;</span><span class="si">{</span><span class="n">yaml_filename</span><span class="si">}</span><span class="s2">&#39; not found. Nothing to return&quot;</span><span class="p">)</span>
<a id="__codelineno-0-59" name="__codelineno-0-59"></a>        <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">()</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h4 id="io.vdjdb" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">vdjdb</span><span class="p">(</span><span class="n">vdjdb_dataset</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">drop_method</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">drop_meta</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">drop_cdr3fix</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span></code>

</h4>


    <div class="doc doc-contents ">

        <p>Reads VDJdb datasets and adjusts column names. If <code>vdjdb_dataset</code> is <code>None</code>, the latest version of the whole database is downloaded.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>vdjdb_dataset</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>path to a file exported from VDJdb database in .tsv format. 
If set to <code>None</code> (default), all entries from VDJdb will be downloaded.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>drop_method</code>
            </td>
            <td>
                  <code><span title="bool">bool</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>if <code>True</code>, <code>Method</code> column is excluded</p>
              </div>
            </td>
            <td>
                  <code>True</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>drop_meta</code>
            </td>
            <td>
                  <code><span title="bool">bool</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>if <code>True</code>, <code>Meta</code> column is excluded</p>
              </div>
            </td>
            <td>
                  <code>True</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>drop_cdr3fix</code>
            </td>
            <td>
                  <code><span title="bool">bool</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>if <code>True</code>, <code>CDR3fix</code> column is excluded</p>
              </div>
            </td>
            <td>
                  <code>True</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
<th>Name</th>          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
<td><code>vdjdb_df</code></td>            <td>
                  <code><span title="pandas.DataFrame">DataFrame</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>DataFrame representation of VDJdb entries</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>repseq/io.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-309">309</a></span>
<span class="normal"><a href="#__codelineno-0-310">310</a></span>
<span class="normal"><a href="#__codelineno-0-311">311</a></span>
<span class="normal"><a href="#__codelineno-0-312">312</a></span>
<span class="normal"><a href="#__codelineno-0-313">313</a></span>
<span class="normal"><a href="#__codelineno-0-314">314</a></span>
<span class="normal"><a href="#__codelineno-0-315">315</a></span>
<span class="normal"><a href="#__codelineno-0-316">316</a></span>
<span class="normal"><a href="#__codelineno-0-317">317</a></span>
<span class="normal"><a href="#__codelineno-0-318">318</a></span>
<span class="normal"><a href="#__codelineno-0-319">319</a></span>
<span class="normal"><a href="#__codelineno-0-320">320</a></span>
<span class="normal"><a href="#__codelineno-0-321">321</a></span>
<span class="normal"><a href="#__codelineno-0-322">322</a></span>
<span class="normal"><a href="#__codelineno-0-323">323</a></span>
<span class="normal"><a href="#__codelineno-0-324">324</a></span>
<span class="normal"><a href="#__codelineno-0-325">325</a></span>
<span class="normal"><a href="#__codelineno-0-326">326</a></span>
<span class="normal"><a href="#__codelineno-0-327">327</a></span>
<span class="normal"><a href="#__codelineno-0-328">328</a></span>
<span class="normal"><a href="#__codelineno-0-329">329</a></span>
<span class="normal"><a href="#__codelineno-0-330">330</a></span>
<span class="normal"><a href="#__codelineno-0-331">331</a></span>
<span class="normal"><a href="#__codelineno-0-332">332</a></span>
<span class="normal"><a href="#__codelineno-0-333">333</a></span>
<span class="normal"><a href="#__codelineno-0-334">334</a></span>
<span class="normal"><a href="#__codelineno-0-335">335</a></span>
<span class="normal"><a href="#__codelineno-0-336">336</a></span>
<span class="normal"><a href="#__codelineno-0-337">337</a></span>
<span class="normal"><a href="#__codelineno-0-338">338</a></span>
<span class="normal"><a href="#__codelineno-0-339">339</a></span>
<span class="normal"><a href="#__codelineno-0-340">340</a></span>
<span class="normal"><a href="#__codelineno-0-341">341</a></span>
<span class="normal"><a href="#__codelineno-0-342">342</a></span>
<span class="normal"><a href="#__codelineno-0-343">343</a></span>
<span class="normal"><a href="#__codelineno-0-344">344</a></span>
<span class="normal"><a href="#__codelineno-0-345">345</a></span>
<span class="normal"><a href="#__codelineno-0-346">346</a></span>
<span class="normal"><a href="#__codelineno-0-347">347</a></span>
<span class="normal"><a href="#__codelineno-0-348">348</a></span>
<span class="normal"><a href="#__codelineno-0-349">349</a></span>
<span class="normal"><a href="#__codelineno-0-350">350</a></span>
<span class="normal"><a href="#__codelineno-0-351">351</a></span>
<span class="normal"><a href="#__codelineno-0-352">352</a></span>
<span class="normal"><a href="#__codelineno-0-353">353</a></span>
<span class="normal"><a href="#__codelineno-0-354">354</a></span>
<span class="normal"><a href="#__codelineno-0-355">355</a></span>
<span class="normal"><a href="#__codelineno-0-356">356</a></span>
<span class="normal"><a href="#__codelineno-0-357">357</a></span>
<span class="normal"><a href="#__codelineno-0-358">358</a></span>
<span class="normal"><a href="#__codelineno-0-359">359</a></span>
<span class="normal"><a href="#__codelineno-0-360">360</a></span>
<span class="normal"><a href="#__codelineno-0-361">361</a></span>
<span class="normal"><a href="#__codelineno-0-362">362</a></span>
<span class="normal"><a href="#__codelineno-0-363">363</a></span>
<span class="normal"><a href="#__codelineno-0-364">364</a></span>
<span class="normal"><a href="#__codelineno-0-365">365</a></span>
<span class="normal"><a href="#__codelineno-0-366">366</a></span>
<span class="normal"><a href="#__codelineno-0-367">367</a></span>
<span class="normal"><a href="#__codelineno-0-368">368</a></span>
<span class="normal"><a href="#__codelineno-0-369">369</a></span>
<span class="normal"><a href="#__codelineno-0-370">370</a></span>
<span class="normal"><a href="#__codelineno-0-371">371</a></span>
<span class="normal"><a href="#__codelineno-0-372">372</a></span>
<span class="normal"><a href="#__codelineno-0-373">373</a></span>
<span class="normal"><a href="#__codelineno-0-374">374</a></span>
<span class="normal"><a href="#__codelineno-0-375">375</a></span>
<span class="normal"><a href="#__codelineno-0-376">376</a></span>
<span class="normal"><a href="#__codelineno-0-377">377</a></span>
<span class="normal"><a href="#__codelineno-0-378">378</a></span>
<span class="normal"><a href="#__codelineno-0-379">379</a></span>
<span class="normal"><a href="#__codelineno-0-380">380</a></span>
<span class="normal"><a href="#__codelineno-0-381">381</a></span>
<span class="normal"><a href="#__codelineno-0-382">382</a></span>
<span class="normal"><a href="#__codelineno-0-383">383</a></span>
<span class="normal"><a href="#__codelineno-0-384">384</a></span>
<span class="normal"><a href="#__codelineno-0-385">385</a></span>
<span class="normal"><a href="#__codelineno-0-386">386</a></span>
<span class="normal"><a href="#__codelineno-0-387">387</a></span>
<span class="normal"><a href="#__codelineno-0-388">388</a></span>
<span class="normal"><a href="#__codelineno-0-389">389</a></span>
<span class="normal"><a href="#__codelineno-0-390">390</a></span>
<span class="normal"><a href="#__codelineno-0-391">391</a></span>
<span class="normal"><a href="#__codelineno-0-392">392</a></span>
<span class="normal"><a href="#__codelineno-0-393">393</a></span>
<span class="normal"><a href="#__codelineno-0-394">394</a></span>
<span class="normal"><a href="#__codelineno-0-395">395</a></span>
<span class="normal"><a href="#__codelineno-0-396">396</a></span>
<span class="normal"><a href="#__codelineno-0-397">397</a></span>
<span class="normal"><a href="#__codelineno-0-398">398</a></span>
<span class="normal"><a href="#__codelineno-0-399">399</a></span>
<span class="normal"><a href="#__codelineno-0-400">400</a></span>
<span class="normal"><a href="#__codelineno-0-401">401</a></span>
<span class="normal"><a href="#__codelineno-0-402">402</a></span>
<span class="normal"><a href="#__codelineno-0-403">403</a></span>
<span class="normal"><a href="#__codelineno-0-404">404</a></span>
<span class="normal"><a href="#__codelineno-0-405">405</a></span>
<span class="normal"><a href="#__codelineno-0-406">406</a></span>
<span class="normal"><a href="#__codelineno-0-407">407</a></span>
<span class="normal"><a href="#__codelineno-0-408">408</a></span>
<span class="normal"><a href="#__codelineno-0-409">409</a></span>
<span class="normal"><a href="#__codelineno-0-410">410</a></span>
<span class="normal"><a href="#__codelineno-0-411">411</a></span>
<span class="normal"><a href="#__codelineno-0-412">412</a></span>
<span class="normal"><a href="#__codelineno-0-413">413</a></span>
<span class="normal"><a href="#__codelineno-0-414">414</a></span>
<span class="normal"><a href="#__codelineno-0-415">415</a></span>
<span class="normal"><a href="#__codelineno-0-416">416</a></span>
<span class="normal"><a href="#__codelineno-0-417">417</a></span>
<span class="normal"><a href="#__codelineno-0-418">418</a></span>
<span class="normal"><a href="#__codelineno-0-419">419</a></span>
<span class="normal"><a href="#__codelineno-0-420">420</a></span>
<span class="normal"><a href="#__codelineno-0-421">421</a></span>
<span class="normal"><a href="#__codelineno-0-422">422</a></span>
<span class="normal"><a href="#__codelineno-0-423">423</a></span>
<span class="normal"><a href="#__codelineno-0-424">424</a></span>
<span class="normal"><a href="#__codelineno-0-425">425</a></span>
<span class="normal"><a href="#__codelineno-0-426">426</a></span>
<span class="normal"><a href="#__codelineno-0-427">427</a></span>
<span class="normal"><a href="#__codelineno-0-428">428</a></span>
<span class="normal"><a href="#__codelineno-0-429">429</a></span>
<span class="normal"><a href="#__codelineno-0-430">430</a></span>
<span class="normal"><a href="#__codelineno-0-431">431</a></span>
<span class="normal"><a href="#__codelineno-0-432">432</a></span>
<span class="normal"><a href="#__codelineno-0-433">433</a></span>
<span class="normal"><a href="#__codelineno-0-434">434</a></span>
<span class="normal"><a href="#__codelineno-0-435">435</a></span>
<span class="normal"><a href="#__codelineno-0-436">436</a></span>
<span class="normal"><a href="#__codelineno-0-437">437</a></span>
<span class="normal"><a href="#__codelineno-0-438">438</a></span>
<span class="normal"><a href="#__codelineno-0-439">439</a></span>
<span class="normal"><a href="#__codelineno-0-440">440</a></span>
<span class="normal"><a href="#__codelineno-0-441">441</a></span>
<span class="normal"><a href="#__codelineno-0-442">442</a></span>
<span class="normal"><a href="#__codelineno-0-443">443</a></span>
<span class="normal"><a href="#__codelineno-0-444">444</a></span>
<span class="normal"><a href="#__codelineno-0-445">445</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-309" name="__codelineno-0-309"></a><span class="k">def</span><span class="w"> </span><span class="nf">vdjdb</span><span class="p">(</span><span class="n">vdjdb_dataset</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">drop_method</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">drop_meta</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">drop_cdr3fix</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
<a id="__codelineno-0-310" name="__codelineno-0-310"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-311" name="__codelineno-0-311"></a><span class="sd">    Reads VDJdb datasets and adjusts column names. If `vdjdb_dataset` is `None`, the latest version of the whole database is downloaded.</span>
<a id="__codelineno-0-312" name="__codelineno-0-312"></a>
<a id="__codelineno-0-313" name="__codelineno-0-313"></a><span class="sd">    Args:</span>
<a id="__codelineno-0-314" name="__codelineno-0-314"></a><span class="sd">        vdjdb_dataset (str): path to a file exported from VDJdb database in .tsv format. </span>
<a id="__codelineno-0-315" name="__codelineno-0-315"></a><span class="sd">            If set to `None` (default), all entries from VDJdb will be downloaded.</span>
<a id="__codelineno-0-316" name="__codelineno-0-316"></a><span class="sd">        drop_method (bool): if `True`, `Method` column is excluded</span>
<a id="__codelineno-0-317" name="__codelineno-0-317"></a><span class="sd">        drop_meta (bool): if `True`, `Meta` column is excluded</span>
<a id="__codelineno-0-318" name="__codelineno-0-318"></a><span class="sd">        drop_cdr3fix (bool): if `True`, `CDR3fix` column is excluded</span>
<a id="__codelineno-0-319" name="__codelineno-0-319"></a>
<a id="__codelineno-0-320" name="__codelineno-0-320"></a><span class="sd">    Returns:</span>
<a id="__codelineno-0-321" name="__codelineno-0-321"></a><span class="sd">        vdjdb_df (pd.DataFrame): DataFrame representation of VDJdb entries</span>
<a id="__codelineno-0-322" name="__codelineno-0-322"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-323" name="__codelineno-0-323"></a>    <span class="k">if</span> <span class="n">vdjdb_dataset</span><span class="p">:</span>
<a id="__codelineno-0-324" name="__codelineno-0-324"></a>        <span class="n">vdjdb_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">vdjdb_dataset</span><span class="p">,</span> <span class="n">delimiter</span><span class="o">=</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">&#39;</span><span class="p">)</span>
<a id="__codelineno-0-325" name="__codelineno-0-325"></a>        <span class="n">renaming_dict</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;complex.id&#39;</span><span class="p">:</span> <span class="s1">&#39;complex_id&#39;</span><span class="p">,</span>
<a id="__codelineno-0-326" name="__codelineno-0-326"></a>                    <span class="s1">&#39;Gene&#39;</span><span class="p">:</span> <span class="s1">&#39;chain&#39;</span><span class="p">,</span>
<a id="__codelineno-0-327" name="__codelineno-0-327"></a>                    <span class="s1">&#39;CDR3&#39;</span><span class="p">:</span> <span class="s1">&#39;cdr3aa&#39;</span><span class="p">,</span>
<a id="__codelineno-0-328" name="__codelineno-0-328"></a>                    <span class="s1">&#39;V&#39;</span><span class="p">:</span> <span class="s1">&#39;v&#39;</span><span class="p">,</span>
<a id="__codelineno-0-329" name="__codelineno-0-329"></a>                    <span class="s1">&#39;J&#39;</span><span class="p">:</span> <span class="s1">&#39;j&#39;</span><span class="p">,</span>
<a id="__codelineno-0-330" name="__codelineno-0-330"></a>                    <span class="s1">&#39;Species&#39;</span><span class="p">:</span> <span class="s1">&#39;species&#39;</span><span class="p">,</span>
<a id="__codelineno-0-331" name="__codelineno-0-331"></a>                    <span class="s1">&#39;MHC A&#39;</span><span class="p">:</span> <span class="s1">&#39;mhc_a&#39;</span><span class="p">,</span>
<a id="__codelineno-0-332" name="__codelineno-0-332"></a>                    <span class="s1">&#39;MHC B&#39;</span><span class="p">:</span> <span class="s1">&#39;mhc_b&#39;</span><span class="p">,</span>
<a id="__codelineno-0-333" name="__codelineno-0-333"></a>                    <span class="s1">&#39;MHC class&#39;</span><span class="p">:</span> <span class="s1">&#39;mhc_class&#39;</span><span class="p">,</span>  
<a id="__codelineno-0-334" name="__codelineno-0-334"></a>                    <span class="s1">&#39;Epitope&#39;</span><span class="p">:</span> <span class="s1">&#39;epitope&#39;</span><span class="p">,</span>
<a id="__codelineno-0-335" name="__codelineno-0-335"></a>                    <span class="s1">&#39;Epitope gene&#39;</span><span class="p">:</span> <span class="s1">&#39;epitope_gene&#39;</span><span class="p">,</span>
<a id="__codelineno-0-336" name="__codelineno-0-336"></a>                    <span class="s1">&#39;Epitope species&#39;</span><span class="p">:</span> <span class="s1">&#39;epitope_species&#39;</span><span class="p">,</span>
<a id="__codelineno-0-337" name="__codelineno-0-337"></a>                    <span class="s1">&#39;Reference&#39;</span><span class="p">:</span> <span class="s1">&#39;reference&#39;</span><span class="p">,</span>
<a id="__codelineno-0-338" name="__codelineno-0-338"></a>                    <span class="s1">&#39;Score&#39;</span><span class="p">:</span> <span class="s1">&#39;score&#39;</span><span class="p">,</span>
<a id="__codelineno-0-339" name="__codelineno-0-339"></a>                    <span class="s1">&#39;Method&#39;</span><span class="p">:</span> <span class="s1">&#39;method&#39;</span><span class="p">,</span>
<a id="__codelineno-0-340" name="__codelineno-0-340"></a>                    <span class="s1">&#39;Meta&#39;</span><span class="p">:</span> <span class="s1">&#39;meta&#39;</span><span class="p">,</span>
<a id="__codelineno-0-341" name="__codelineno-0-341"></a>                    <span class="s1">&#39;CDR3fix&#39;</span><span class="p">:</span> <span class="s1">&#39;cdr3fix&#39;</span><span class="p">}</span>
<a id="__codelineno-0-342" name="__codelineno-0-342"></a>    <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-343" name="__codelineno-0-343"></a>        <span class="n">renaming_dict</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;complex.id&#39;</span><span class="p">:</span> <span class="s1">&#39;complex_id&#39;</span><span class="p">,</span>
<a id="__codelineno-0-344" name="__codelineno-0-344"></a>                    <span class="s1">&#39;gene&#39;</span><span class="p">:</span> <span class="s1">&#39;gene&#39;</span><span class="p">,</span>
<a id="__codelineno-0-345" name="__codelineno-0-345"></a>                    <span class="s1">&#39;cdr3&#39;</span><span class="p">:</span> <span class="s1">&#39;cdr3aa&#39;</span><span class="p">,</span>
<a id="__codelineno-0-346" name="__codelineno-0-346"></a>                    <span class="s1">&#39;v.segm&#39;</span><span class="p">:</span> <span class="s1">&#39;v&#39;</span><span class="p">,</span>
<a id="__codelineno-0-347" name="__codelineno-0-347"></a>                    <span class="s1">&#39;j.segm&#39;</span><span class="p">:</span> <span class="s1">&#39;j&#39;</span><span class="p">,</span>
<a id="__codelineno-0-348" name="__codelineno-0-348"></a>                    <span class="s1">&#39;species&#39;</span><span class="p">:</span> <span class="s1">&#39;species&#39;</span><span class="p">,</span>
<a id="__codelineno-0-349" name="__codelineno-0-349"></a>                    <span class="s1">&#39;mhc.a&#39;</span><span class="p">:</span> <span class="s1">&#39;mhc_a&#39;</span><span class="p">,</span>
<a id="__codelineno-0-350" name="__codelineno-0-350"></a>                    <span class="s1">&#39;mhc.b&#39;</span><span class="p">:</span> <span class="s1">&#39;mhc_b&#39;</span><span class="p">,</span>
<a id="__codelineno-0-351" name="__codelineno-0-351"></a>                    <span class="s1">&#39;mhc.class&#39;</span><span class="p">:</span> <span class="s1">&#39;mhc_class&#39;</span><span class="p">,</span>
<a id="__codelineno-0-352" name="__codelineno-0-352"></a>                    <span class="s1">&#39;antigen.epitope&#39;</span><span class="p">:</span> <span class="s1">&#39;epitope&#39;</span><span class="p">,</span>
<a id="__codelineno-0-353" name="__codelineno-0-353"></a>                    <span class="s1">&#39;antigen.gene&#39;</span><span class="p">:</span> <span class="s1">&#39;epitope_gene&#39;</span><span class="p">,</span>
<a id="__codelineno-0-354" name="__codelineno-0-354"></a>                    <span class="s1">&#39;antigen.species&#39;</span><span class="p">:</span> <span class="s1">&#39;epitope_species&#39;</span><span class="p">,</span>
<a id="__codelineno-0-355" name="__codelineno-0-355"></a>                    <span class="s1">&#39;reference.id&#39;</span><span class="p">:</span> <span class="s1">&#39;reference_id&#39;</span><span class="p">,</span>
<a id="__codelineno-0-356" name="__codelineno-0-356"></a>                    <span class="s1">&#39;method&#39;</span><span class="p">:</span> <span class="s1">&#39;method&#39;</span><span class="p">,</span>
<a id="__codelineno-0-357" name="__codelineno-0-357"></a>                    <span class="s1">&#39;meta&#39;</span><span class="p">:</span> <span class="s1">&#39;meta&#39;</span><span class="p">,</span>
<a id="__codelineno-0-358" name="__codelineno-0-358"></a>                    <span class="s1">&#39;cdr3fix&#39;</span><span class="p">:</span> <span class="s1">&#39;cdr3fix&#39;</span><span class="p">,</span>
<a id="__codelineno-0-359" name="__codelineno-0-359"></a>                    <span class="s1">&#39;vdjdb.score&#39;</span><span class="p">:</span> <span class="s1">&#39;score&#39;</span><span class="p">}</span>
<a id="__codelineno-0-360" name="__codelineno-0-360"></a>        <span class="n">api_url</span> <span class="o">=</span> <span class="s2">&quot;https://api.github.com/repos/antigenomics/vdjdb-db/releases/latest&quot;</span>
<a id="__codelineno-0-361" name="__codelineno-0-361"></a>        <span class="n">response</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">api_url</span><span class="p">)</span>
<a id="__codelineno-0-362" name="__codelineno-0-362"></a>        <span class="n">vdjdb_release</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">json</span><span class="p">()[</span><span class="s1">&#39;assets&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;browser_download_url&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">content</span>
<a id="__codelineno-0-363" name="__codelineno-0-363"></a>        <span class="k">with</span> <span class="n">zipfile</span><span class="o">.</span><span class="n">ZipFile</span><span class="p">(</span><span class="n">io</span><span class="o">.</span><span class="n">BytesIO</span><span class="p">(</span><span class="n">vdjdb_release</span><span class="p">))</span> <span class="k">as</span> <span class="n">zf</span><span class="p">:</span>
<a id="__codelineno-0-364" name="__codelineno-0-364"></a>            <span class="n">filename</span> <span class="o">=</span> <span class="p">[</span><span class="n">name</span> <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">zf</span><span class="o">.</span><span class="n">namelist</span><span class="p">()</span> <span class="k">if</span> <span class="n">name</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;vdjdb.txt&#39;</span><span class="p">)][</span><span class="mi">0</span><span class="p">]</span>
<a id="__codelineno-0-365" name="__codelineno-0-365"></a>            <span class="k">with</span> <span class="n">zf</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
<a id="__codelineno-0-366" name="__codelineno-0-366"></a>                <span class="n">vdjdb_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">delimiter</span><span class="o">=</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span>
<a id="__codelineno-0-367" name="__codelineno-0-367"></a>                                            <span class="s1">&#39;web.method&#39;</span><span class="p">,</span> 
<a id="__codelineno-0-368" name="__codelineno-0-368"></a>                                            <span class="s1">&#39;web.method.seq&#39;</span><span class="p">,</span> 
<a id="__codelineno-0-369" name="__codelineno-0-369"></a>                                            <span class="s1">&#39;web.cdr3fix.unmp&#39;</span><span class="p">,</span> 
<a id="__codelineno-0-370" name="__codelineno-0-370"></a>                                            <span class="s1">&#39;web.cdr3fix.unmp&#39;</span><span class="p">,</span>
<a id="__codelineno-0-371" name="__codelineno-0-371"></a>                                            <span class="s1">&#39;web.cdr3fix.nc&#39;</span><span class="p">])</span>
<a id="__codelineno-0-372" name="__codelineno-0-372"></a>    <span class="n">vdjdb_df</span> <span class="o">=</span> <span class="n">vdjdb_df</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="n">renaming_dict</span><span class="p">)</span>
<a id="__codelineno-0-373" name="__codelineno-0-373"></a>    <span class="k">if</span> <span class="ow">not</span> <span class="n">drop_method</span><span class="p">:</span>
<a id="__codelineno-0-374" name="__codelineno-0-374"></a>        <span class="n">method</span> <span class="o">=</span> <span class="n">vdjdb_df</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;method&#39;</span><span class="p">)</span>
<a id="__codelineno-0-375" name="__codelineno-0-375"></a>        <span class="n">method_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="o">.</span><span class="n">from_dict</span><span class="p">([</span><span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">d</span><span class="p">)</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">method</span><span class="p">])</span>
<a id="__codelineno-0-376" name="__codelineno-0-376"></a>        <span class="n">vdjdb_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">vdjdb_df</span><span class="p">,</span> <span class="n">method_df</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<a id="__codelineno-0-377" name="__codelineno-0-377"></a>        <span class="c1"># since entries are added manually, frequency isn&#39;t uniform</span>
<a id="__codelineno-0-378" name="__codelineno-0-378"></a>        <span class="n">freqs</span> <span class="o">=</span> <span class="n">vdjdb_df</span><span class="p">[</span><span class="s1">&#39;frequency&#39;</span><span class="p">]</span>
<a id="__codelineno-0-379" name="__codelineno-0-379"></a>
<a id="__codelineno-0-380" name="__codelineno-0-380"></a>        <span class="n">is_fraction</span> <span class="o">=</span> <span class="n">freqs</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">contains</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;^\d+\s*/\s*\d+$&#39;</span><span class="p">,</span> <span class="n">na</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<a id="__codelineno-0-381" name="__codelineno-0-381"></a>        <span class="n">fractions</span> <span class="o">=</span> <span class="n">freqs</span><span class="p">[</span><span class="n">is_fraction</span><span class="p">]</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">extract</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;(\d+)\s*/\s*(\d+)&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span>
<a id="__codelineno-0-382" name="__codelineno-0-382"></a>        <span class="n">fraction_values</span> <span class="o">=</span> <span class="n">fractions</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">/</span> <span class="n">fractions</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
<a id="__codelineno-0-383" name="__codelineno-0-383"></a>
<a id="__codelineno-0-384" name="__codelineno-0-384"></a>        <span class="n">is_percent</span> <span class="o">=</span> <span class="n">freqs</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;%&#39;</span><span class="p">,</span> <span class="n">na</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<a id="__codelineno-0-385" name="__codelineno-0-385"></a>        <span class="n">percent_values</span> <span class="o">=</span> <span class="n">freqs</span><span class="p">[</span><span class="n">is_percent</span><span class="p">]</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">rstrip</span><span class="p">(</span><span class="s1">&#39;%&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span> <span class="o">/</span> <span class="mi">100</span>
<a id="__codelineno-0-386" name="__codelineno-0-386"></a>
<a id="__codelineno-0-387" name="__codelineno-0-387"></a>        <span class="n">is_number</span> <span class="o">=</span> <span class="n">freqs</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;^\d*\.?\d+$&#39;</span><span class="p">,</span> <span class="n">na</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<a id="__codelineno-0-388" name="__codelineno-0-388"></a>        <span class="n">number_values</span> <span class="o">=</span> <span class="n">freqs</span><span class="p">[</span><span class="n">is_number</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span>
<a id="__codelineno-0-389" name="__codelineno-0-389"></a>
<a id="__codelineno-0-390" name="__codelineno-0-390"></a>        <span class="n">frequencies</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">pd</span><span class="o">.</span><span class="n">NA</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="n">freqs</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>
<a id="__codelineno-0-391" name="__codelineno-0-391"></a>        <span class="n">frequencies</span><span class="p">[</span><span class="n">is_fraction</span><span class="p">]</span> <span class="o">=</span> <span class="n">fraction_values</span><span class="o">.</span><span class="n">values</span>
<a id="__codelineno-0-392" name="__codelineno-0-392"></a>        <span class="n">frequencies</span><span class="p">[</span><span class="n">is_percent</span><span class="p">]</span> <span class="o">=</span> <span class="n">percent_values</span><span class="o">.</span><span class="n">values</span>
<a id="__codelineno-0-393" name="__codelineno-0-393"></a>        <span class="n">frequencies</span><span class="p">[</span><span class="n">is_number</span><span class="p">]</span> <span class="o">=</span> <span class="n">number_values</span><span class="o">.</span><span class="n">values</span>
<a id="__codelineno-0-394" name="__codelineno-0-394"></a>        <span class="n">vdjdb_df</span><span class="p">[</span><span class="s1">&#39;frequency&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">frequencies</span>
<a id="__codelineno-0-395" name="__codelineno-0-395"></a>    <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-396" name="__codelineno-0-396"></a>        <span class="n">vdjdb_df</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;method&#39;</span><span class="p">)</span>
<a id="__codelineno-0-397" name="__codelineno-0-397"></a>
<a id="__codelineno-0-398" name="__codelineno-0-398"></a>    <span class="k">if</span> <span class="ow">not</span> <span class="n">drop_meta</span><span class="p">:</span>
<a id="__codelineno-0-399" name="__codelineno-0-399"></a>        <span class="n">meta</span> <span class="o">=</span> <span class="n">vdjdb_df</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;meta&#39;</span><span class="p">)</span>
<a id="__codelineno-0-400" name="__codelineno-0-400"></a>        <span class="n">meta_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="o">.</span><span class="n">from_dict</span><span class="p">([</span><span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">d</span><span class="p">)</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">meta</span><span class="p">])</span>
<a id="__codelineno-0-401" name="__codelineno-0-401"></a>        <span class="n">meta_df</span> <span class="o">=</span> <span class="n">meta_df</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span>
<a id="__codelineno-0-402" name="__codelineno-0-402"></a>                                                                <span class="p">{</span><span class="s1">&#39;study.id&#39;</span><span class="p">:</span> <span class="s1">&#39;study_id&#39;</span><span class="p">,</span>
<a id="__codelineno-0-403" name="__codelineno-0-403"></a>                                                                <span class="s1">&#39;cell.subset&#39;</span><span class="p">:</span> <span class="s1">&#39;cell_subset&#39;</span><span class="p">,</span>
<a id="__codelineno-0-404" name="__codelineno-0-404"></a>                                                                <span class="s1">&#39;subject.cohort&#39;</span><span class="p">:</span> <span class="s1">&#39;subject_cohort&#39;</span><span class="p">,</span>
<a id="__codelineno-0-405" name="__codelineno-0-405"></a>                                                                <span class="s1">&#39;subject.id&#39;</span><span class="p">:</span> <span class="s1">&#39;subject_id&#39;</span><span class="p">,</span>
<a id="__codelineno-0-406" name="__codelineno-0-406"></a>                                                                <span class="s1">&#39;replica.id&#39;</span><span class="p">:</span> <span class="s1">&#39;replica_id&#39;</span><span class="p">,</span>
<a id="__codelineno-0-407" name="__codelineno-0-407"></a>                                                                <span class="s1">&#39;clone.id&#39;</span><span class="p">:</span> <span class="s1">&#39;clone_id&#39;</span><span class="p">,</span>
<a id="__codelineno-0-408" name="__codelineno-0-408"></a>                                                                <span class="s1">&#39;epitope.id&#39;</span><span class="p">:</span> <span class="s1">&#39;epitope_id&#39;</span><span class="p">,</span>
<a id="__codelineno-0-409" name="__codelineno-0-409"></a>                                                                <span class="s1">&#39;tissue&#39;</span><span class="p">:</span> <span class="s1">&#39;tissue&#39;</span><span class="p">,</span>
<a id="__codelineno-0-410" name="__codelineno-0-410"></a>                                                                <span class="s1">&#39;donor.MHC&#39;</span><span class="p">:</span> <span class="s1">&#39;donor_mhc&#39;</span><span class="p">,</span>
<a id="__codelineno-0-411" name="__codelineno-0-411"></a>                                                                <span class="s1">&#39;donor.MHC.method&#39;</span><span class="p">:</span> <span class="s1">&#39;donor_mhc_method&#39;</span><span class="p">,</span>
<a id="__codelineno-0-412" name="__codelineno-0-412"></a>                                                                <span class="s1">&#39;structure.id&#39;</span><span class="p">:</span> <span class="s1">&#39;structure_id&#39;</span><span class="p">,</span>
<a id="__codelineno-0-413" name="__codelineno-0-413"></a>                                                                <span class="s1">&#39;samples.found&#39;</span><span class="p">:</span> <span class="s1">&#39;samples_found&#39;</span><span class="p">,</span>
<a id="__codelineno-0-414" name="__codelineno-0-414"></a>                                                                <span class="s1">&#39;studies.found&#39;</span><span class="p">:</span> <span class="s1">&#39;studies_found&#39;</span><span class="p">})</span>
<a id="__codelineno-0-415" name="__codelineno-0-415"></a>        <span class="n">vdjdb_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">vdjdb_df</span><span class="p">,</span> <span class="n">meta_df</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<a id="__codelineno-0-416" name="__codelineno-0-416"></a>    <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-417" name="__codelineno-0-417"></a>        <span class="n">vdjdb_df</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;meta&#39;</span><span class="p">)</span>
<a id="__codelineno-0-418" name="__codelineno-0-418"></a>
<a id="__codelineno-0-419" name="__codelineno-0-419"></a>    <span class="k">if</span> <span class="ow">not</span> <span class="n">drop_cdr3fix</span><span class="p">:</span>
<a id="__codelineno-0-420" name="__codelineno-0-420"></a>        <span class="n">cdr3fix</span> <span class="o">=</span> <span class="n">vdjdb_df</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;cdr3fix&#39;</span><span class="p">)</span>
<a id="__codelineno-0-421" name="__codelineno-0-421"></a>        <span class="n">cdr3fix_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="o">.</span><span class="n">from_dict</span><span class="p">([</span><span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">d</span><span class="p">)</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">cdr3fix</span><span class="p">])</span>
<a id="__codelineno-0-422" name="__codelineno-0-422"></a>        <span class="n">cdr3fix_df</span> <span class="o">=</span> <span class="n">cdr3fix_df</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;cdr3&#39;</span><span class="p">:</span> <span class="s1">&#39;cdr3aa_new&#39;</span><span class="p">,</span>
<a id="__codelineno-0-423" name="__codelineno-0-423"></a>                                                                         <span class="s1">&#39;cdr3_old&#39;</span><span class="p">:</span> <span class="s1">&#39;cdr3aa_old&#39;</span><span class="p">})</span>
<a id="__codelineno-0-424" name="__codelineno-0-424"></a>        <span class="n">vdjdb_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">vdjdb_df</span><span class="p">,</span> <span class="n">cdr3fix_df</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<a id="__codelineno-0-425" name="__codelineno-0-425"></a>    <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-426" name="__codelineno-0-426"></a>        <span class="n">vdjdb_df</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;cdr3fix&#39;</span><span class="p">)</span>
<a id="__codelineno-0-427" name="__codelineno-0-427"></a>    <span class="n">order</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;complex_id&#39;</span><span class="p">,</span> <span class="s1">&#39;chain&#39;</span><span class="p">,</span> <span class="s1">&#39;cdr3aa&#39;</span><span class="p">,</span> <span class="s1">&#39;v&#39;</span><span class="p">,</span> <span class="s1">&#39;j&#39;</span><span class="p">,</span> <span class="s1">&#39;species&#39;</span><span class="p">,</span> <span class="s1">&#39;mhc_a&#39;</span><span class="p">,</span> <span class="s1">&#39;mhc_b&#39;</span><span class="p">,</span>
<a id="__codelineno-0-428" name="__codelineno-0-428"></a>       <span class="s1">&#39;mhc_class&#39;</span><span class="p">,</span> <span class="s1">&#39;epitope&#39;</span><span class="p">,</span> <span class="s1">&#39;epitope_gene&#39;</span><span class="p">,</span> <span class="s1">&#39;epitope_species&#39;</span><span class="p">,</span> <span class="s1">&#39;reference&#39;</span><span class="p">,</span>
<a id="__codelineno-0-429" name="__codelineno-0-429"></a>       <span class="s1">&#39;score&#39;</span><span class="p">,</span> <span class="s1">&#39;identification&#39;</span><span class="p">,</span> <span class="s1">&#39;frequency&#39;</span><span class="p">,</span> <span class="s1">&#39;singlecell&#39;</span><span class="p">,</span> <span class="s1">&#39;sequencing&#39;</span><span class="p">,</span>
<a id="__codelineno-0-430" name="__codelineno-0-430"></a>       <span class="s1">&#39;verification&#39;</span><span class="p">,</span> <span class="s1">&#39;study_id&#39;</span><span class="p">,</span> <span class="s1">&#39;cell_subset&#39;</span><span class="p">,</span> <span class="s1">&#39;subject_cohort&#39;</span><span class="p">,</span>
<a id="__codelineno-0-431" name="__codelineno-0-431"></a>       <span class="s1">&#39;subject_id&#39;</span><span class="p">,</span> <span class="s1">&#39;replica_id&#39;</span><span class="p">,</span> <span class="s1">&#39;clone_id&#39;</span><span class="p">,</span> <span class="s1">&#39;epitope_id&#39;</span><span class="p">,</span> <span class="s1">&#39;tissue&#39;</span><span class="p">,</span>
<a id="__codelineno-0-432" name="__codelineno-0-432"></a>       <span class="s1">&#39;donor_mhc&#39;</span><span class="p">,</span> <span class="s1">&#39;donor_mhc_method&#39;</span><span class="p">,</span> <span class="s1">&#39;structure_id&#39;</span><span class="p">,</span> <span class="s1">&#39;samples_found&#39;</span><span class="p">,</span>
<a id="__codelineno-0-433" name="__codelineno-0-433"></a>       <span class="s1">&#39;studies_found&#39;</span><span class="p">,</span> <span class="s1">&#39;cdr3aa_new&#39;</span><span class="p">,</span> <span class="s1">&#39;cdr3aa_old&#39;</span><span class="p">,</span> <span class="s1">&#39;fixNeeded&#39;</span><span class="p">,</span> <span class="s1">&#39;good&#39;</span><span class="p">,</span>
<a id="__codelineno-0-434" name="__codelineno-0-434"></a>       <span class="s1">&#39;jCanonical&#39;</span><span class="p">,</span> <span class="s1">&#39;jFixType&#39;</span><span class="p">,</span> <span class="s1">&#39;jId&#39;</span><span class="p">,</span> <span class="s1">&#39;jStart&#39;</span><span class="p">,</span> <span class="s1">&#39;vCanonical&#39;</span><span class="p">,</span> <span class="s1">&#39;vEnd&#39;</span><span class="p">,</span>
<a id="__codelineno-0-435" name="__codelineno-0-435"></a>       <span class="s1">&#39;vFixType&#39;</span><span class="p">,</span> <span class="s1">&#39;vId&#39;</span><span class="p">]</span>
<a id="__codelineno-0-436" name="__codelineno-0-436"></a>    <span class="n">existing_columns</span> <span class="o">=</span> <span class="p">[</span><span class="n">col</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">order</span> <span class="k">if</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">vdjdb_df</span><span class="o">.</span><span class="n">columns</span><span class="p">]</span>
<a id="__codelineno-0-437" name="__codelineno-0-437"></a>    <span class="n">vdjdb_df</span><span class="p">[</span><span class="s1">&#39;v&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">vdjdb_df</span><span class="p">[</span><span class="s1">&#39;v&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">extract_segment</span><span class="p">(</span><span class="n">x</span><span class="p">))</span>
<a id="__codelineno-0-438" name="__codelineno-0-438"></a>    <span class="n">vdjdb_df</span><span class="p">[</span><span class="s1">&#39;j&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">vdjdb_df</span><span class="p">[</span><span class="s1">&#39;j&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">extract_segment</span><span class="p">(</span><span class="n">x</span><span class="p">))</span>
<a id="__codelineno-0-439" name="__codelineno-0-439"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">to_numeric</span><span class="p">(</span><span class="n">s</span><span class="p">):</span>
<a id="__codelineno-0-440" name="__codelineno-0-440"></a>        <span class="k">try</span><span class="p">:</span>
<a id="__codelineno-0-441" name="__codelineno-0-441"></a>            <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_numeric</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
<a id="__codelineno-0-442" name="__codelineno-0-442"></a>        <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
<a id="__codelineno-0-443" name="__codelineno-0-443"></a>            <span class="k">return</span> <span class="n">s</span>
<a id="__codelineno-0-444" name="__codelineno-0-444"></a>    <span class="n">vdjdb_df</span> <span class="o">=</span> <span class="n">vdjdb_df</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">to_numeric</span><span class="p">)</span>
<a id="__codelineno-0-445" name="__codelineno-0-445"></a>    <span class="k">return</span> <span class="n">vdjdb_df</span><span class="p">[</span><span class="n">existing_columns</span><span class="p">]</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div><h2 id="logo"><strong>logo</strong></h2>


<div class="doc doc-object doc-module">




    <div class="doc doc-contents first">










  <div class="doc doc-children">












  </div>

    </div>

</div><h2 id="migec"><strong>migec</strong></h2>


<div class="doc doc-object doc-module">




    <div class="doc doc-contents first">










  <div class="doc doc-children">












  </div>

    </div>

</div><h2 id="minnn"><strong>minnn</strong></h2>


<div class="doc doc-object doc-module">




    <div class="doc doc-contents first">










  <div class="doc doc-children">












  </div>

    </div>

</div><h2 id="mixcr"><strong>mixcr</strong></h2>


<div class="doc doc-object doc-module">




    <div class="doc doc-contents first">










  <div class="doc doc-children">










<div class="doc doc-object doc-function">


<h4 id="mixcr.get_processing_table" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">get_processing_table</span><span class="p">(</span><span class="n">folder</span><span class="p">,</span> <span class="n">show_offtarget</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">offtarget_chain_threshold</span><span class="o">=</span><span class="mf">0.01</span><span class="p">)</span></code>

</h4>


    <div class="doc doc-contents ">

        <p>Searches for clonosets in the the folder, extracts their sample_id's and shows main
processing stats in a table format. By default does not show "off-target" clonosets - 
those having less than 1% (default, may be overriden) of reads for the sample_id.
For example, you have sequenced TRB sample, but there is found 0.5% (by read count) 
of TRA chains for the same sample_id, then the clonoset will not be shown in the table.
You can specify <code>show_offtarget=True</code> to display all found chains in the table or 
outherwise set a higher value for <code>offtarget_chain_threshold</code> (<code>0.01</code> by default).</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>folder</code>
            </td>
            <td>
                  <code><span title="str">str</span> or <span title="list">list</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>folder or list of folders in which to look for clonosets and
processing stats</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>show_offtarget</code>
            </td>
            <td>
                  <code><span title="bool">bool</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>add offtarget chains to the stats</p>
              </div>
            </td>
            <td>
                  <code>False</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>offtarget_chain_threshold</code>
            </td>
            <td>
                  <code><span title="float">float</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>threshold for off-target chains</p>
              </div>
            </td>
            <td>
                  <code>0.01</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
<th>Name</th>          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
<td><code>df</code></td>            <td>
                  <code><span title="pandas.DataFrame">DataFrame</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>dataframe, containing <code>sample_id</code>, <code>extracted_chain</code> and 
different processing stats columns. There may be several rows with the same 
<code>sample_id</code>, with each found <code>extracted_chain</code></p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>repseq/mixcr.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-265">265</a></span>
<span class="normal"><a href="#__codelineno-0-266">266</a></span>
<span class="normal"><a href="#__codelineno-0-267">267</a></span>
<span class="normal"><a href="#__codelineno-0-268">268</a></span>
<span class="normal"><a href="#__codelineno-0-269">269</a></span>
<span class="normal"><a href="#__codelineno-0-270">270</a></span>
<span class="normal"><a href="#__codelineno-0-271">271</a></span>
<span class="normal"><a href="#__codelineno-0-272">272</a></span>
<span class="normal"><a href="#__codelineno-0-273">273</a></span>
<span class="normal"><a href="#__codelineno-0-274">274</a></span>
<span class="normal"><a href="#__codelineno-0-275">275</a></span>
<span class="normal"><a href="#__codelineno-0-276">276</a></span>
<span class="normal"><a href="#__codelineno-0-277">277</a></span>
<span class="normal"><a href="#__codelineno-0-278">278</a></span>
<span class="normal"><a href="#__codelineno-0-279">279</a></span>
<span class="normal"><a href="#__codelineno-0-280">280</a></span>
<span class="normal"><a href="#__codelineno-0-281">281</a></span>
<span class="normal"><a href="#__codelineno-0-282">282</a></span>
<span class="normal"><a href="#__codelineno-0-283">283</a></span>
<span class="normal"><a href="#__codelineno-0-284">284</a></span>
<span class="normal"><a href="#__codelineno-0-285">285</a></span>
<span class="normal"><a href="#__codelineno-0-286">286</a></span>
<span class="normal"><a href="#__codelineno-0-287">287</a></span>
<span class="normal"><a href="#__codelineno-0-288">288</a></span>
<span class="normal"><a href="#__codelineno-0-289">289</a></span>
<span class="normal"><a href="#__codelineno-0-290">290</a></span>
<span class="normal"><a href="#__codelineno-0-291">291</a></span>
<span class="normal"><a href="#__codelineno-0-292">292</a></span>
<span class="normal"><a href="#__codelineno-0-293">293</a></span>
<span class="normal"><a href="#__codelineno-0-294">294</a></span>
<span class="normal"><a href="#__codelineno-0-295">295</a></span>
<span class="normal"><a href="#__codelineno-0-296">296</a></span>
<span class="normal"><a href="#__codelineno-0-297">297</a></span>
<span class="normal"><a href="#__codelineno-0-298">298</a></span>
<span class="normal"><a href="#__codelineno-0-299">299</a></span>
<span class="normal"><a href="#__codelineno-0-300">300</a></span>
<span class="normal"><a href="#__codelineno-0-301">301</a></span>
<span class="normal"><a href="#__codelineno-0-302">302</a></span>
<span class="normal"><a href="#__codelineno-0-303">303</a></span>
<span class="normal"><a href="#__codelineno-0-304">304</a></span>
<span class="normal"><a href="#__codelineno-0-305">305</a></span>
<span class="normal"><a href="#__codelineno-0-306">306</a></span>
<span class="normal"><a href="#__codelineno-0-307">307</a></span>
<span class="normal"><a href="#__codelineno-0-308">308</a></span>
<span class="normal"><a href="#__codelineno-0-309">309</a></span>
<span class="normal"><a href="#__codelineno-0-310">310</a></span>
<span class="normal"><a href="#__codelineno-0-311">311</a></span>
<span class="normal"><a href="#__codelineno-0-312">312</a></span>
<span class="normal"><a href="#__codelineno-0-313">313</a></span>
<span class="normal"><a href="#__codelineno-0-314">314</a></span>
<span class="normal"><a href="#__codelineno-0-315">315</a></span>
<span class="normal"><a href="#__codelineno-0-316">316</a></span>
<span class="normal"><a href="#__codelineno-0-317">317</a></span>
<span class="normal"><a href="#__codelineno-0-318">318</a></span>
<span class="normal"><a href="#__codelineno-0-319">319</a></span>
<span class="normal"><a href="#__codelineno-0-320">320</a></span>
<span class="normal"><a href="#__codelineno-0-321">321</a></span>
<span class="normal"><a href="#__codelineno-0-322">322</a></span>
<span class="normal"><a href="#__codelineno-0-323">323</a></span>
<span class="normal"><a href="#__codelineno-0-324">324</a></span>
<span class="normal"><a href="#__codelineno-0-325">325</a></span>
<span class="normal"><a href="#__codelineno-0-326">326</a></span>
<span class="normal"><a href="#__codelineno-0-327">327</a></span>
<span class="normal"><a href="#__codelineno-0-328">328</a></span>
<span class="normal"><a href="#__codelineno-0-329">329</a></span>
<span class="normal"><a href="#__codelineno-0-330">330</a></span>
<span class="normal"><a href="#__codelineno-0-331">331</a></span>
<span class="normal"><a href="#__codelineno-0-332">332</a></span>
<span class="normal"><a href="#__codelineno-0-333">333</a></span>
<span class="normal"><a href="#__codelineno-0-334">334</a></span>
<span class="normal"><a href="#__codelineno-0-335">335</a></span>
<span class="normal"><a href="#__codelineno-0-336">336</a></span>
<span class="normal"><a href="#__codelineno-0-337">337</a></span>
<span class="normal"><a href="#__codelineno-0-338">338</a></span>
<span class="normal"><a href="#__codelineno-0-339">339</a></span>
<span class="normal"><a href="#__codelineno-0-340">340</a></span>
<span class="normal"><a href="#__codelineno-0-341">341</a></span>
<span class="normal"><a href="#__codelineno-0-342">342</a></span>
<span class="normal"><a href="#__codelineno-0-343">343</a></span>
<span class="normal"><a href="#__codelineno-0-344">344</a></span>
<span class="normal"><a href="#__codelineno-0-345">345</a></span>
<span class="normal"><a href="#__codelineno-0-346">346</a></span>
<span class="normal"><a href="#__codelineno-0-347">347</a></span>
<span class="normal"><a href="#__codelineno-0-348">348</a></span>
<span class="normal"><a href="#__codelineno-0-349">349</a></span>
<span class="normal"><a href="#__codelineno-0-350">350</a></span>
<span class="normal"><a href="#__codelineno-0-351">351</a></span>
<span class="normal"><a href="#__codelineno-0-352">352</a></span>
<span class="normal"><a href="#__codelineno-0-353">353</a></span>
<span class="normal"><a href="#__codelineno-0-354">354</a></span>
<span class="normal"><a href="#__codelineno-0-355">355</a></span>
<span class="normal"><a href="#__codelineno-0-356">356</a></span>
<span class="normal"><a href="#__codelineno-0-357">357</a></span>
<span class="normal"><a href="#__codelineno-0-358">358</a></span>
<span class="normal"><a href="#__codelineno-0-359">359</a></span>
<span class="normal"><a href="#__codelineno-0-360">360</a></span>
<span class="normal"><a href="#__codelineno-0-361">361</a></span>
<span class="normal"><a href="#__codelineno-0-362">362</a></span>
<span class="normal"><a href="#__codelineno-0-363">363</a></span>
<span class="normal"><a href="#__codelineno-0-364">364</a></span>
<span class="normal"><a href="#__codelineno-0-365">365</a></span>
<span class="normal"><a href="#__codelineno-0-366">366</a></span>
<span class="normal"><a href="#__codelineno-0-367">367</a></span>
<span class="normal"><a href="#__codelineno-0-368">368</a></span>
<span class="normal"><a href="#__codelineno-0-369">369</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-265" name="__codelineno-0-265"></a><span class="k">def</span><span class="w"> </span><span class="nf">get_processing_table</span><span class="p">(</span><span class="n">folder</span><span class="p">,</span> <span class="n">show_offtarget</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">offtarget_chain_threshold</span><span class="o">=</span><span class="mf">0.01</span><span class="p">):</span>
<a id="__codelineno-0-266" name="__codelineno-0-266"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-267" name="__codelineno-0-267"></a><span class="sd">    Searches for clonosets in the the folder, extracts their sample_id&#39;s and shows main</span>
<a id="__codelineno-0-268" name="__codelineno-0-268"></a><span class="sd">    processing stats in a table format. By default does not show &quot;off-target&quot; clonosets - </span>
<a id="__codelineno-0-269" name="__codelineno-0-269"></a><span class="sd">    those having less than 1% (default, may be overriden) of reads for the sample_id.</span>
<a id="__codelineno-0-270" name="__codelineno-0-270"></a><span class="sd">    For example, you have sequenced TRB sample, but there is found 0.5% (by read count) </span>
<a id="__codelineno-0-271" name="__codelineno-0-271"></a><span class="sd">    of TRA chains for the same sample_id, then the clonoset will not be shown in the table.</span>
<a id="__codelineno-0-272" name="__codelineno-0-272"></a><span class="sd">    You can specify `show_offtarget=True` to display all found chains in the table or </span>
<a id="__codelineno-0-273" name="__codelineno-0-273"></a><span class="sd">    outherwise set a higher value for `offtarget_chain_threshold` (`0.01` by default).</span>
<a id="__codelineno-0-274" name="__codelineno-0-274"></a>
<a id="__codelineno-0-275" name="__codelineno-0-275"></a><span class="sd">    Args:</span>
<a id="__codelineno-0-276" name="__codelineno-0-276"></a><span class="sd">        folder (str or list): folder or list of folders in which to look for clonosets and</span>
<a id="__codelineno-0-277" name="__codelineno-0-277"></a><span class="sd">            processing stats</span>
<a id="__codelineno-0-278" name="__codelineno-0-278"></a><span class="sd">        show_offtarget (bool): add offtarget chains to the stats</span>
<a id="__codelineno-0-279" name="__codelineno-0-279"></a><span class="sd">        offtarget_chain_threshold (float): threshold for off-target chains</span>
<a id="__codelineno-0-280" name="__codelineno-0-280"></a>
<a id="__codelineno-0-281" name="__codelineno-0-281"></a><span class="sd">    Returns:</span>
<a id="__codelineno-0-282" name="__codelineno-0-282"></a><span class="sd">        df (pd.DataFrame): dataframe, containing `sample_id`, `extracted_chain` and </span>
<a id="__codelineno-0-283" name="__codelineno-0-283"></a><span class="sd">            different processing stats columns. There may be several rows with the same </span>
<a id="__codelineno-0-284" name="__codelineno-0-284"></a><span class="sd">            `sample_id`, with each found `extracted_chain`</span>
<a id="__codelineno-0-285" name="__codelineno-0-285"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-286" name="__codelineno-0-286"></a>
<a id="__codelineno-0-287" name="__codelineno-0-287"></a>    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">folder</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
<a id="__codelineno-0-288" name="__codelineno-0-288"></a>        <span class="n">tables</span> <span class="o">=</span> <span class="p">[]</span>
<a id="__codelineno-0-289" name="__codelineno-0-289"></a>        <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">folder</span><span class="p">:</span>
<a id="__codelineno-0-290" name="__codelineno-0-290"></a>            <span class="n">table</span> <span class="o">=</span> <span class="n">get_processing_table</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">show_offtarget</span><span class="o">=</span><span class="n">show_offtarget</span><span class="p">)</span>
<a id="__codelineno-0-291" name="__codelineno-0-291"></a>            <span class="n">tables</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">table</span><span class="p">)</span>
<a id="__codelineno-0-292" name="__codelineno-0-292"></a>        <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">tables</span><span class="p">)</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="s2">&quot;sample_id&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<a id="__codelineno-0-293" name="__codelineno-0-293"></a>
<a id="__codelineno-0-294" name="__codelineno-0-294"></a>    <span class="n">results</span> <span class="o">=</span> <span class="p">[]</span>
<a id="__codelineno-0-295" name="__codelineno-0-295"></a>    <span class="n">clonosets</span> <span class="o">=</span> <span class="n">find_all_exported_clonosets_in_folder</span><span class="p">(</span><span class="n">folder</span><span class="p">,</span> <span class="n">chain</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
<a id="__codelineno-0-296" name="__codelineno-0-296"></a>
<a id="__codelineno-0-297" name="__codelineno-0-297"></a>    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">clonosets</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>
<a id="__codelineno-0-298" name="__codelineno-0-298"></a>        <span class="n">sample_id</span> <span class="o">=</span> <span class="n">r</span><span class="p">[</span><span class="s2">&quot;sample_id&quot;</span><span class="p">]</span>
<a id="__codelineno-0-299" name="__codelineno-0-299"></a>        <span class="n">chain</span> <span class="o">=</span> <span class="n">r</span><span class="p">[</span><span class="s2">&quot;chain&quot;</span><span class="p">]</span>
<a id="__codelineno-0-300" name="__codelineno-0-300"></a>        <span class="n">align_report</span> <span class="o">=</span> <span class="n">read_json_report</span><span class="p">(</span><span class="n">sample_id</span><span class="p">,</span> <span class="n">folder</span><span class="p">,</span> <span class="s2">&quot;align&quot;</span><span class="p">)</span>
<a id="__codelineno-0-301" name="__codelineno-0-301"></a>
<a id="__codelineno-0-302" name="__codelineno-0-302"></a>        <span class="k">try</span><span class="p">:</span>
<a id="__codelineno-0-303" name="__codelineno-0-303"></a>            <span class="n">refine_report</span> <span class="o">=</span> <span class="n">read_json_report</span><span class="p">(</span><span class="n">sample_id</span><span class="p">,</span> <span class="n">folder</span><span class="p">,</span> <span class="s2">&quot;refine&quot;</span><span class="p">)</span>
<a id="__codelineno-0-304" name="__codelineno-0-304"></a>            <span class="n">umi</span> <span class="o">=</span> <span class="kc">True</span>
<a id="__codelineno-0-305" name="__codelineno-0-305"></a>        <span class="k">except</span> <span class="ne">FileNotFoundError</span><span class="p">:</span>
<a id="__codelineno-0-306" name="__codelineno-0-306"></a>            <span class="n">umi</span> <span class="o">=</span> <span class="kc">False</span>
<a id="__codelineno-0-307" name="__codelineno-0-307"></a>
<a id="__codelineno-0-308" name="__codelineno-0-308"></a>        <span class="n">assemble_report</span> <span class="o">=</span> <span class="n">read_json_report</span><span class="p">(</span><span class="n">sample_id</span><span class="p">,</span> <span class="n">folder</span><span class="p">,</span> <span class="s2">&quot;assemble&quot;</span><span class="p">)</span>
<a id="__codelineno-0-309" name="__codelineno-0-309"></a>
<a id="__codelineno-0-310" name="__codelineno-0-310"></a>        <span class="c1"># print(sample_id, chain)</span>
<a id="__codelineno-0-311" name="__codelineno-0-311"></a>        <span class="n">clonoset</span> <span class="o">=</span> <span class="n">read_clonoset</span><span class="p">(</span><span class="n">r</span><span class="o">.</span><span class="n">filename</span><span class="p">)</span>
<a id="__codelineno-0-312" name="__codelineno-0-312"></a>        <span class="n">clonoset_f</span> <span class="o">=</span> <span class="n">filter_nonfunctional_clones</span><span class="p">(</span><span class="n">clonoset</span><span class="p">)</span>
<a id="__codelineno-0-313" name="__codelineno-0-313"></a>
<a id="__codelineno-0-314" name="__codelineno-0-314"></a>        <span class="c1"># align report</span>
<a id="__codelineno-0-315" name="__codelineno-0-315"></a>        <span class="n">Rt</span><span class="o">=</span><span class="n">align_report</span><span class="p">[</span><span class="s2">&quot;totalReadsProcessed&quot;</span><span class="p">]</span>
<a id="__codelineno-0-316" name="__codelineno-0-316"></a>        <span class="n">Ru</span><span class="o">=</span><span class="n">align_report</span><span class="p">[</span><span class="s2">&quot;totalReadsProcessed&quot;</span><span class="p">]</span><span class="o">-</span><span class="n">align_report</span><span class="p">[</span><span class="s2">&quot;notAlignedReasons&quot;</span><span class="p">][</span><span class="s2">&quot;NoBarcode&quot;</span><span class="p">]</span>
<a id="__codelineno-0-317" name="__codelineno-0-317"></a>        <span class="n">Ru_pc</span> <span class="o">=</span> <span class="nb">round</span><span class="p">(</span><span class="n">Ru</span><span class="o">/</span><span class="n">Rt</span><span class="o">*</span><span class="mi">100</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
<a id="__codelineno-0-318" name="__codelineno-0-318"></a>        <span class="n">Ra</span><span class="o">=</span><span class="n">align_report</span><span class="p">[</span><span class="s2">&quot;aligned&quot;</span><span class="p">]</span>
<a id="__codelineno-0-319" name="__codelineno-0-319"></a>        <span class="n">Ra_pc</span> <span class="o">=</span> <span class="nb">round</span><span class="p">(</span><span class="n">Ra</span><span class="o">/</span><span class="n">Rt</span><span class="o">*</span><span class="mi">100</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
<a id="__codelineno-0-320" name="__codelineno-0-320"></a>        <span class="n">Roa</span> <span class="o">=</span> <span class="n">align_report</span><span class="p">[</span><span class="s2">&quot;overlappedAligned&quot;</span><span class="p">]</span>
<a id="__codelineno-0-321" name="__codelineno-0-321"></a>        <span class="n">Roa_pc</span> <span class="o">=</span> <span class="nb">round</span><span class="p">(</span><span class="n">Roa</span><span class="o">/</span><span class="n">Ra</span><span class="o">*</span><span class="mi">100</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
<a id="__codelineno-0-322" name="__codelineno-0-322"></a>
<a id="__codelineno-0-323" name="__codelineno-0-323"></a>        <span class="k">if</span> <span class="n">umi</span><span class="p">:</span>
<a id="__codelineno-0-324" name="__codelineno-0-324"></a>        <span class="c1">#Ra2=refine_report[&quot;correctionReport&quot;][&quot;inputRecords&quot;] ##### differs from Ra, but D.Bolotin did not explain why</span>
<a id="__codelineno-0-325" name="__codelineno-0-325"></a>
<a id="__codelineno-0-326" name="__codelineno-0-326"></a>            <span class="n">UMIa</span><span class="o">=</span><span class="n">refine_report</span><span class="p">[</span><span class="s2">&quot;correctionReport&quot;</span><span class="p">][</span><span class="s2">&quot;steps&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="s2">&quot;inputDiversity&quot;</span><span class="p">]</span>
<a id="__codelineno-0-327" name="__codelineno-0-327"></a>            <span class="n">UMIc</span><span class="o">=</span><span class="n">refine_report</span><span class="p">[</span><span class="s2">&quot;correctionReport&quot;</span><span class="p">][</span><span class="s2">&quot;steps&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="s2">&quot;outputDiversity&quot;</span><span class="p">]</span>
<a id="__codelineno-0-328" name="__codelineno-0-328"></a>            <span class="k">try</span><span class="p">:</span>
<a id="__codelineno-0-329" name="__codelineno-0-329"></a>                <span class="n">UMIf</span><span class="o">=</span><span class="n">refine_report</span><span class="p">[</span><span class="s2">&quot;correctionReport&quot;</span><span class="p">][</span><span class="s2">&quot;filterReport&quot;</span><span class="p">][</span><span class="s2">&quot;numberOfGroupsAccepted&quot;</span><span class="p">]</span>
<a id="__codelineno-0-330" name="__codelineno-0-330"></a>            <span class="k">except</span> <span class="ne">TypeError</span><span class="p">:</span>
<a id="__codelineno-0-331" name="__codelineno-0-331"></a>                <span class="n">UMIf</span><span class="o">=</span><span class="n">UMIc</span>
<a id="__codelineno-0-332" name="__codelineno-0-332"></a>            <span class="n">Rf</span><span class="o">=</span><span class="n">refine_report</span><span class="p">[</span><span class="s2">&quot;correctionReport&quot;</span><span class="p">][</span><span class="s2">&quot;outputRecords&quot;</span><span class="p">]</span>
<a id="__codelineno-0-333" name="__codelineno-0-333"></a>            <span class="k">try</span><span class="p">:</span>
<a id="__codelineno-0-334" name="__codelineno-0-334"></a>                <span class="n">overseq_threshold</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">refine_report</span><span class="p">[</span><span class="s2">&quot;correctionReport&quot;</span><span class="p">][</span><span class="s2">&quot;filterReport&quot;</span><span class="p">][</span><span class="s2">&quot;operatorReports&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="s2">&quot;operatorReport&quot;</span><span class="p">][</span><span class="s2">&quot;threshold&quot;</span><span class="p">])</span>
<a id="__codelineno-0-335" name="__codelineno-0-335"></a>            <span class="k">except</span> <span class="ne">TypeError</span><span class="p">:</span>
<a id="__codelineno-0-336" name="__codelineno-0-336"></a>                <span class="n">overseq_threshold</span> <span class="o">=</span> <span class="kc">None</span>
<a id="__codelineno-0-337" name="__codelineno-0-337"></a>            <span class="n">reads_per_umi</span> <span class="o">=</span> <span class="nb">round</span><span class="p">(</span><span class="n">Rf</span><span class="o">/</span><span class="n">UMIf</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
<a id="__codelineno-0-338" name="__codelineno-0-338"></a>        <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-339" name="__codelineno-0-339"></a>            <span class="n">UMIa</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
<a id="__codelineno-0-340" name="__codelineno-0-340"></a>            <span class="n">UMIc</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
<a id="__codelineno-0-341" name="__codelineno-0-341"></a>            <span class="n">UMIf</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
<a id="__codelineno-0-342" name="__codelineno-0-342"></a>            <span class="n">Rf</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
<a id="__codelineno-0-343" name="__codelineno-0-343"></a>            <span class="n">overseq_threshold</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
<a id="__codelineno-0-344" name="__codelineno-0-344"></a>            <span class="n">reads_per_umi</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
<a id="__codelineno-0-345" name="__codelineno-0-345"></a>
<a id="__codelineno-0-346" name="__codelineno-0-346"></a>        <span class="n">Ct</span><span class="o">=</span><span class="n">assemble_report</span><span class="p">[</span><span class="s2">&quot;clones&quot;</span><span class="p">]</span>
<a id="__codelineno-0-347" name="__codelineno-0-347"></a>        <span class="n">Rcl</span><span class="o">=</span><span class="n">assemble_report</span><span class="p">[</span><span class="s2">&quot;readsInClones&quot;</span><span class="p">]</span>
<a id="__codelineno-0-348" name="__codelineno-0-348"></a>
<a id="__codelineno-0-349" name="__codelineno-0-349"></a>        <span class="n">Ctc</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">clonoset</span><span class="p">)</span>
<a id="__codelineno-0-350" name="__codelineno-0-350"></a>        <span class="n">Rclc</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">clonoset</span><span class="o">.</span><span class="n">readCount</span><span class="o">.</span><span class="n">sum</span><span class="p">())</span>
<a id="__codelineno-0-351" name="__codelineno-0-351"></a>
<a id="__codelineno-0-352" name="__codelineno-0-352"></a>        <span class="n">Cfunc</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">clonoset_f</span><span class="p">)</span>
<a id="__codelineno-0-353" name="__codelineno-0-353"></a>        <span class="n">Rfunc</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">clonoset_f</span><span class="o">.</span><span class="n">readCount</span><span class="o">.</span><span class="n">sum</span><span class="p">())</span>
<a id="__codelineno-0-354" name="__codelineno-0-354"></a>        <span class="k">if</span> <span class="n">umi</span><span class="p">:</span>
<a id="__codelineno-0-355" name="__codelineno-0-355"></a>            <span class="n">UMIcl</span><span class="o">=</span><span class="n">clonoset</span><span class="o">.</span><span class="n">uniqueMoleculeCount</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
<a id="__codelineno-0-356" name="__codelineno-0-356"></a>            <span class="n">UMIfunc</span><span class="o">=</span><span class="n">clonoset_f</span><span class="o">.</span><span class="n">uniqueMoleculeCount</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
<a id="__codelineno-0-357" name="__codelineno-0-357"></a>        <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-358" name="__codelineno-0-358"></a>            <span class="n">UMIcl</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span>
<a id="__codelineno-0-359" name="__codelineno-0-359"></a>            <span class="n">UMIfunc</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span>
<a id="__codelineno-0-360" name="__codelineno-0-360"></a>        <span class="k">if</span> <span class="n">umi</span> <span class="ow">and</span> <span class="n">overseq_threshold</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-361" name="__codelineno-0-361"></a>            <span class="n">reads_per_umi</span> <span class="o">=</span> <span class="nb">round</span><span class="p">(</span><span class="n">Rclc</span><span class="o">/</span><span class="n">UMIcl</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
<a id="__codelineno-0-362" name="__codelineno-0-362"></a>
<a id="__codelineno-0-363" name="__codelineno-0-363"></a>        <span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">sample_id</span><span class="p">,</span> <span class="n">chain</span><span class="p">,</span> <span class="n">Rt</span><span class="p">,</span> <span class="n">Ru_pc</span><span class="p">,</span> <span class="n">Ra_pc</span><span class="p">,</span> <span class="n">Roa_pc</span><span class="p">,</span> <span class="n">UMIa</span><span class="p">,</span> <span class="n">UMIc</span><span class="p">,</span> <span class="n">overseq_threshold</span><span class="p">,</span> <span class="n">Rf</span><span class="p">,</span> <span class="n">UMIf</span><span class="p">,</span> <span class="n">reads_per_umi</span><span class="p">,</span> <span class="n">Ct</span><span class="p">,</span> <span class="n">Rcl</span><span class="p">,</span> <span class="n">Ctc</span><span class="p">,</span> <span class="n">Rclc</span><span class="p">,</span> <span class="n">Cfunc</span><span class="p">,</span> <span class="n">Rfunc</span><span class="p">,</span> <span class="n">UMIcl</span><span class="p">,</span> <span class="n">UMIfunc</span><span class="p">])</span>
<a id="__codelineno-0-364" name="__codelineno-0-364"></a>    <span class="n">result_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">results</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;sample_id&quot;</span><span class="p">,</span> <span class="s2">&quot;extracted_chain&quot;</span><span class="p">,</span> <span class="s2">&quot;reads_total&quot;</span><span class="p">,</span> <span class="s2">&quot;reads_with_umi_pc&quot;</span><span class="p">,</span> <span class="s2">&quot;reads_aligned_pc&quot;</span><span class="p">,</span> <span class="s2">&quot;reads_overlapped_aln_pc&quot;</span><span class="p">,</span>
<a id="__codelineno-0-365" name="__codelineno-0-365"></a>                                               <span class="s2">&quot;total_umi&quot;</span><span class="p">,</span> <span class="s2">&quot;umi_after_correction&quot;</span><span class="p">,</span> <span class="s2">&quot;overseq_threshold&quot;</span><span class="p">,</span> <span class="s2">&quot;reads_after_filter&quot;</span><span class="p">,</span> <span class="s2">&quot;umi_after_filter&quot;</span><span class="p">,</span>
<a id="__codelineno-0-366" name="__codelineno-0-366"></a>                                               <span class="s2">&quot;reads_per_umi&quot;</span><span class="p">,</span> <span class="s2">&quot;clones_total&quot;</span><span class="p">,</span> <span class="s2">&quot;reads_in_clones_total&quot;</span><span class="p">,</span> <span class="s2">&quot;clones&quot;</span><span class="p">,</span> <span class="s2">&quot;reads_in_clones&quot;</span><span class="p">,</span> <span class="s2">&quot;clones_func&quot;</span><span class="p">,</span> <span class="s2">&quot;reads_in_func_clones&quot;</span><span class="p">,</span> <span class="s2">&quot;umi_in_clones&quot;</span><span class="p">,</span> <span class="s2">&quot;umi_in_func_clones&quot;</span><span class="p">])</span>
<a id="__codelineno-0-367" name="__codelineno-0-367"></a>    <span class="k">if</span> <span class="ow">not</span> <span class="n">show_offtarget</span><span class="p">:</span>
<a id="__codelineno-0-368" name="__codelineno-0-368"></a>        <span class="n">result_df</span> <span class="o">=</span> <span class="n">result_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">result_df</span><span class="o">.</span><span class="n">reads_in_clones</span><span class="o">/</span><span class="n">result_df</span><span class="o">.</span><span class="n">reads_in_clones_total</span> <span class="o">&gt;</span> <span class="n">offtarget_chain_threshold</span><span class="p">]</span>
<a id="__codelineno-0-369" name="__codelineno-0-369"></a>    <span class="k">return</span> <span class="n">result_df</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="s2">&quot;sample_id&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h4 id="mixcr.mixcr4_analyze_batch" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">mixcr4_analyze_batch</span><span class="p">(</span><span class="n">sample_df</span><span class="p">,</span> <span class="n">output_folder</span><span class="p">,</span> <span class="n">command_template</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">mixcr_path</span><span class="o">=</span><span class="s1">&#39;mixcr&#39;</span><span class="p">,</span> <span class="n">memory</span><span class="o">=</span><span class="mi">32</span><span class="p">,</span> <span class="n">time_estimate</span><span class="o">=</span><span class="mf">1.5</span><span class="p">,</span> <span class="n">custom_tag_pattern_column</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>

</h4>


    <div class="doc doc-contents ">

        <p>Function for batch runs of MiXCR software using SLURM.
For each record in the given <code>sample_df</code> this function creates a SLURM-script in
<code>~/temp/slurm</code> folder and adds them to SLURM-queue. All the <code>stdout</code> logs are also 
put to <code>~/temp/slurm</code> folder. In case of troubles check the latest logs in this folder. 
By default this function uses <code>mixcr analyze</code> command for MiLab Hum RNA TCR Kit (with UMI). 
To change the command template use <code>command_template</code> parameter</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>sample_df</code>
            </td>
            <td>
                  <code><span title="pandas.DataFrame">DataFrame</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>DataFrame, containing 'sample_id' column and 
'R1' and 'R2' columns, containing paths (recommended full paths) to raw read files</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>output_folder</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>path to output folder</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>command_template</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>MiXCR command template 
(default: 'mixcr analyze milab-human-rna-tcr-umi-multiplex -f r1 r2 output_prefix').
May be used as an example. Note that <code>mixcr analyze</code> and <code>r1 r2 output_prefix</code> are 
"magical" parts of the template that should be kept as-is in the template, so change 
only the part in-between these parts.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>mixcr_path</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>path to MiXCR binary</p>
              </div>
            </td>
            <td>
                  <code>&#39;mixcr&#39;</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>memory</code>
            </td>
            <td>
                  <code><span title="int">int</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>required OOM in GB</p>
              </div>
            </td>
            <td>
                  <code>32</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>time_estimate</code>
            </td>
            <td>
                  <code><span title="numeric">numeric</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>time estimate in hours for the calculation. It
is the limit for SLURM task</p>
              </div>
            </td>
            <td>
                  <code>1.5</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>None</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>repseq/mixcr.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-16"> 16</a></span>
<span class="normal"><a href="#__codelineno-0-17"> 17</a></span>
<span class="normal"><a href="#__codelineno-0-18"> 18</a></span>
<span class="normal"><a href="#__codelineno-0-19"> 19</a></span>
<span class="normal"><a href="#__codelineno-0-20"> 20</a></span>
<span class="normal"><a href="#__codelineno-0-21"> 21</a></span>
<span class="normal"><a href="#__codelineno-0-22"> 22</a></span>
<span class="normal"><a href="#__codelineno-0-23"> 23</a></span>
<span class="normal"><a href="#__codelineno-0-24"> 24</a></span>
<span class="normal"><a href="#__codelineno-0-25"> 25</a></span>
<span class="normal"><a href="#__codelineno-0-26"> 26</a></span>
<span class="normal"><a href="#__codelineno-0-27"> 27</a></span>
<span class="normal"><a href="#__codelineno-0-28"> 28</a></span>
<span class="normal"><a href="#__codelineno-0-29"> 29</a></span>
<span class="normal"><a href="#__codelineno-0-30"> 30</a></span>
<span class="normal"><a href="#__codelineno-0-31"> 31</a></span>
<span class="normal"><a href="#__codelineno-0-32"> 32</a></span>
<span class="normal"><a href="#__codelineno-0-33"> 33</a></span>
<span class="normal"><a href="#__codelineno-0-34"> 34</a></span>
<span class="normal"><a href="#__codelineno-0-35"> 35</a></span>
<span class="normal"><a href="#__codelineno-0-36"> 36</a></span>
<span class="normal"><a href="#__codelineno-0-37"> 37</a></span>
<span class="normal"><a href="#__codelineno-0-38"> 38</a></span>
<span class="normal"><a href="#__codelineno-0-39"> 39</a></span>
<span class="normal"><a href="#__codelineno-0-40"> 40</a></span>
<span class="normal"><a href="#__codelineno-0-41"> 41</a></span>
<span class="normal"><a href="#__codelineno-0-42"> 42</a></span>
<span class="normal"><a href="#__codelineno-0-43"> 43</a></span>
<span class="normal"><a href="#__codelineno-0-44"> 44</a></span>
<span class="normal"><a href="#__codelineno-0-45"> 45</a></span>
<span class="normal"><a href="#__codelineno-0-46"> 46</a></span>
<span class="normal"><a href="#__codelineno-0-47"> 47</a></span>
<span class="normal"><a href="#__codelineno-0-48"> 48</a></span>
<span class="normal"><a href="#__codelineno-0-49"> 49</a></span>
<span class="normal"><a href="#__codelineno-0-50"> 50</a></span>
<span class="normal"><a href="#__codelineno-0-51"> 51</a></span>
<span class="normal"><a href="#__codelineno-0-52"> 52</a></span>
<span class="normal"><a href="#__codelineno-0-53"> 53</a></span>
<span class="normal"><a href="#__codelineno-0-54"> 54</a></span>
<span class="normal"><a href="#__codelineno-0-55"> 55</a></span>
<span class="normal"><a href="#__codelineno-0-56"> 56</a></span>
<span class="normal"><a href="#__codelineno-0-57"> 57</a></span>
<span class="normal"><a href="#__codelineno-0-58"> 58</a></span>
<span class="normal"><a href="#__codelineno-0-59"> 59</a></span>
<span class="normal"><a href="#__codelineno-0-60"> 60</a></span>
<span class="normal"><a href="#__codelineno-0-61"> 61</a></span>
<span class="normal"><a href="#__codelineno-0-62"> 62</a></span>
<span class="normal"><a href="#__codelineno-0-63"> 63</a></span>
<span class="normal"><a href="#__codelineno-0-64"> 64</a></span>
<span class="normal"><a href="#__codelineno-0-65"> 65</a></span>
<span class="normal"><a href="#__codelineno-0-66"> 66</a></span>
<span class="normal"><a href="#__codelineno-0-67"> 67</a></span>
<span class="normal"><a href="#__codelineno-0-68"> 68</a></span>
<span class="normal"><a href="#__codelineno-0-69"> 69</a></span>
<span class="normal"><a href="#__codelineno-0-70"> 70</a></span>
<span class="normal"><a href="#__codelineno-0-71"> 71</a></span>
<span class="normal"><a href="#__codelineno-0-72"> 72</a></span>
<span class="normal"><a href="#__codelineno-0-73"> 73</a></span>
<span class="normal"><a href="#__codelineno-0-74"> 74</a></span>
<span class="normal"><a href="#__codelineno-0-75"> 75</a></span>
<span class="normal"><a href="#__codelineno-0-76"> 76</a></span>
<span class="normal"><a href="#__codelineno-0-77"> 77</a></span>
<span class="normal"><a href="#__codelineno-0-78"> 78</a></span>
<span class="normal"><a href="#__codelineno-0-79"> 79</a></span>
<span class="normal"><a href="#__codelineno-0-80"> 80</a></span>
<span class="normal"><a href="#__codelineno-0-81"> 81</a></span>
<span class="normal"><a href="#__codelineno-0-82"> 82</a></span>
<span class="normal"><a href="#__codelineno-0-83"> 83</a></span>
<span class="normal"><a href="#__codelineno-0-84"> 84</a></span>
<span class="normal"><a href="#__codelineno-0-85"> 85</a></span>
<span class="normal"><a href="#__codelineno-0-86"> 86</a></span>
<span class="normal"><a href="#__codelineno-0-87"> 87</a></span>
<span class="normal"><a href="#__codelineno-0-88"> 88</a></span>
<span class="normal"><a href="#__codelineno-0-89"> 89</a></span>
<span class="normal"><a href="#__codelineno-0-90"> 90</a></span>
<span class="normal"><a href="#__codelineno-0-91"> 91</a></span>
<span class="normal"><a href="#__codelineno-0-92"> 92</a></span>
<span class="normal"><a href="#__codelineno-0-93"> 93</a></span>
<span class="normal"><a href="#__codelineno-0-94"> 94</a></span>
<span class="normal"><a href="#__codelineno-0-95"> 95</a></span>
<span class="normal"><a href="#__codelineno-0-96"> 96</a></span>
<span class="normal"><a href="#__codelineno-0-97"> 97</a></span>
<span class="normal"><a href="#__codelineno-0-98"> 98</a></span>
<span class="normal"><a href="#__codelineno-0-99"> 99</a></span>
<span class="normal"><a href="#__codelineno-0-100">100</a></span>
<span class="normal"><a href="#__codelineno-0-101">101</a></span>
<span class="normal"><a href="#__codelineno-0-102">102</a></span>
<span class="normal"><a href="#__codelineno-0-103">103</a></span>
<span class="normal"><a href="#__codelineno-0-104">104</a></span>
<span class="normal"><a href="#__codelineno-0-105">105</a></span>
<span class="normal"><a href="#__codelineno-0-106">106</a></span>
<span class="normal"><a href="#__codelineno-0-107">107</a></span>
<span class="normal"><a href="#__codelineno-0-108">108</a></span>
<span class="normal"><a href="#__codelineno-0-109">109</a></span>
<span class="normal"><a href="#__codelineno-0-110">110</a></span>
<span class="normal"><a href="#__codelineno-0-111">111</a></span>
<span class="normal"><a href="#__codelineno-0-112">112</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-16" name="__codelineno-0-16"></a><span class="k">def</span><span class="w"> </span><span class="nf">mixcr4_analyze_batch</span><span class="p">(</span><span class="n">sample_df</span><span class="p">,</span> <span class="n">output_folder</span><span class="p">,</span> <span class="n">command_template</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-17" name="__codelineno-0-17"></a>                         <span class="n">mixcr_path</span><span class="o">=</span><span class="s2">&quot;mixcr&quot;</span><span class="p">,</span> <span class="n">memory</span><span class="o">=</span><span class="mi">32</span><span class="p">,</span> <span class="n">time_estimate</span><span class="o">=</span><span class="mf">1.5</span><span class="p">,</span> <span class="n">custom_tag_pattern_column</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<a id="__codelineno-0-18" name="__codelineno-0-18"></a>
<a id="__codelineno-0-19" name="__codelineno-0-19"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-20" name="__codelineno-0-20"></a><span class="sd">    Function for batch runs of MiXCR software using SLURM.</span>
<a id="__codelineno-0-21" name="__codelineno-0-21"></a><span class="sd">    For each record in the given `sample_df` this function creates a SLURM-script in</span>
<a id="__codelineno-0-22" name="__codelineno-0-22"></a><span class="sd">    `~/temp/slurm` folder and adds them to SLURM-queue. All the `stdout` logs are also </span>
<a id="__codelineno-0-23" name="__codelineno-0-23"></a><span class="sd">    put to `~/temp/slurm` folder. In case of troubles check the latest logs in this folder. </span>
<a id="__codelineno-0-24" name="__codelineno-0-24"></a><span class="sd">    By default this function uses `mixcr analyze` command for MiLab Hum RNA TCR Kit (with UMI). </span>
<a id="__codelineno-0-25" name="__codelineno-0-25"></a><span class="sd">    To change the command template use `command_template` parameter</span>
<a id="__codelineno-0-26" name="__codelineno-0-26"></a>
<a id="__codelineno-0-27" name="__codelineno-0-27"></a><span class="sd">    Args:</span>
<a id="__codelineno-0-28" name="__codelineno-0-28"></a><span class="sd">        sample_df (pd.DataFrame): DataFrame, containing &#39;sample_id&#39; column and </span>
<a id="__codelineno-0-29" name="__codelineno-0-29"></a><span class="sd">            &#39;R1&#39; and &#39;R2&#39; columns, containing paths (recommended full paths) to raw read files</span>
<a id="__codelineno-0-30" name="__codelineno-0-30"></a><span class="sd">        output_folder (str): path to output folder</span>
<a id="__codelineno-0-31" name="__codelineno-0-31"></a><span class="sd">        command_template (str): MiXCR command template </span>
<a id="__codelineno-0-32" name="__codelineno-0-32"></a><span class="sd">            (default: &#39;mixcr analyze milab-human-rna-tcr-umi-multiplex -f r1 r2 output_prefix&#39;).</span>
<a id="__codelineno-0-33" name="__codelineno-0-33"></a><span class="sd">            May be used as an example. Note that `mixcr analyze` and `r1 r2 output_prefix` are </span>
<a id="__codelineno-0-34" name="__codelineno-0-34"></a><span class="sd">            &quot;magical&quot; parts of the template that should be kept as-is in the template, so change </span>
<a id="__codelineno-0-35" name="__codelineno-0-35"></a><span class="sd">            only the part in-between these parts.</span>
<a id="__codelineno-0-36" name="__codelineno-0-36"></a><span class="sd">        mixcr_path (str): path to MiXCR binary</span>
<a id="__codelineno-0-37" name="__codelineno-0-37"></a><span class="sd">        memory (int): required OOM in GB</span>
<a id="__codelineno-0-38" name="__codelineno-0-38"></a><span class="sd">        time_estimate (numeric): time estimate in hours for the calculation. It</span>
<a id="__codelineno-0-39" name="__codelineno-0-39"></a><span class="sd">            is the limit for SLURM task</span>
<a id="__codelineno-0-40" name="__codelineno-0-40"></a>
<a id="__codelineno-0-41" name="__codelineno-0-41"></a><span class="sd">    Returns:</span>
<a id="__codelineno-0-42" name="__codelineno-0-42"></a><span class="sd">        None</span>
<a id="__codelineno-0-43" name="__codelineno-0-43"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-44" name="__codelineno-0-44"></a>    <span class="n">max_memory</span> <span class="o">=</span> <span class="mi">1500</span>
<a id="__codelineno-0-45" name="__codelineno-0-45"></a>    <span class="n">min_memory</span> <span class="o">=</span> <span class="mi">16</span>
<a id="__codelineno-0-46" name="__codelineno-0-46"></a>
<a id="__codelineno-0-47" name="__codelineno-0-47"></a>    <span class="n">program_name</span><span class="o">=</span><span class="s2">&quot;MIXCR4 Analyze Batch&quot;</span>
<a id="__codelineno-0-48" name="__codelineno-0-48"></a>    <span class="n">samples_num</span> <span class="o">=</span> <span class="n">sample_df</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<a id="__codelineno-0-49" name="__codelineno-0-49"></a>
<a id="__codelineno-0-50" name="__codelineno-0-50"></a>    <span class="c1"># by default use the most popular preset for MiLaboratory Human TCR UMI MULTIPLEX Kit</span>
<a id="__codelineno-0-51" name="__codelineno-0-51"></a>    <span class="n">default_command_template</span> <span class="o">=</span> <span class="s2">&quot;mixcr analyze milab-human-rna-tcr-umi-multiplex -f r1 r2 output_prefix&quot;</span>
<a id="__codelineno-0-52" name="__codelineno-0-52"></a>    <span class="k">if</span> <span class="n">command_template</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-53" name="__codelineno-0-53"></a>        <span class="n">command_template</span> <span class="o">=</span> <span class="n">default_command_template</span>
<a id="__codelineno-0-54" name="__codelineno-0-54"></a>
<a id="__codelineno-0-55" name="__codelineno-0-55"></a>    <span class="c1"># cut placeholders from command template</span>
<a id="__codelineno-0-56" name="__codelineno-0-56"></a>    <span class="n">remove_list</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;mixcr&quot;</span><span class="p">,</span> <span class="s2">&quot;r1&quot;</span><span class="p">,</span> <span class="s2">&quot;r2&quot;</span><span class="p">,</span> <span class="s2">&quot;output_prefix&quot;</span><span class="p">]</span>
<a id="__codelineno-0-57" name="__codelineno-0-57"></a>    <span class="n">command_template</span> <span class="o">=</span> <span class="s1">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">w</span> <span class="k">for</span> <span class="n">w</span> <span class="ow">in</span> <span class="n">command_template</span><span class="o">.</span><span class="n">split</span><span class="p">()</span> <span class="k">if</span> <span class="n">w</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">remove_list</span><span class="p">])</span>
<a id="__codelineno-0-58" name="__codelineno-0-58"></a>
<a id="__codelineno-0-59" name="__codelineno-0-59"></a>    <span class="c1"># check input for custom tag pattern</span>
<a id="__codelineno-0-60" name="__codelineno-0-60"></a>    <span class="n">custom_tag_pattern</span> <span class="o">=</span> <span class="kc">False</span>
<a id="__codelineno-0-61" name="__codelineno-0-61"></a>    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">custom_tag_pattern_column</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
<a id="__codelineno-0-62" name="__codelineno-0-62"></a>        <span class="k">if</span> <span class="n">custom_tag_pattern_column</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">sample_df</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
<a id="__codelineno-0-63" name="__codelineno-0-63"></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Specified tag-pattern columns &#39;</span><span class="si">{</span><span class="n">custom_tag_pattern_column</span><span class="si">}</span><span class="s2">&#39; is not present in sample_df&quot;</span><span class="p">)</span>
<a id="__codelineno-0-64" name="__codelineno-0-64"></a>        <span class="k">if</span> <span class="s2">&quot;--tag-pattern&quot;</span> <span class="ow">in</span> <span class="n">command_template</span><span class="o">.</span><span class="n">split</span><span class="p">():</span>
<a id="__codelineno-0-65" name="__codelineno-0-65"></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Please, remove &#39;--tag-pattern&#39; option from command_template, when you use custom tag-pattern&quot;</span><span class="p">)</span>
<a id="__codelineno-0-66" name="__codelineno-0-66"></a>        <span class="n">custom_tag_pattern</span> <span class="o">=</span> <span class="kc">True</span>
<a id="__codelineno-0-67" name="__codelineno-0-67"></a>
<a id="__codelineno-0-68" name="__codelineno-0-68"></a>    <span class="c1"># Create output dir if does not exist</span>
<a id="__codelineno-0-69" name="__codelineno-0-69"></a>    <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">output_folder</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<a id="__codelineno-0-70" name="__codelineno-0-70"></a>
<a id="__codelineno-0-71" name="__codelineno-0-71"></a>    <span class="c1"># default mixcr analyze slurm parameters. They are quite excessive, works fine.</span>
<a id="__codelineno-0-72" name="__codelineno-0-72"></a>    <span class="c1"># time_estimate=1.5</span>
<a id="__codelineno-0-73" name="__codelineno-0-73"></a>    <span class="n">cpus</span><span class="o">=</span><span class="mi">40</span>
<a id="__codelineno-0-74" name="__codelineno-0-74"></a>    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">memory</span><span class="p">,</span> <span class="nb">int</span><span class="p">):</span>
<a id="__codelineno-0-75" name="__codelineno-0-75"></a>        <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;memory parameter must be an integer&quot;</span><span class="p">)</span>
<a id="__codelineno-0-76" name="__codelineno-0-76"></a>    <span class="k">if</span> <span class="n">memory</span> <span class="o">&lt;</span> <span class="n">min_memory</span><span class="p">:</span>
<a id="__codelineno-0-77" name="__codelineno-0-77"></a>        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">memory</span><span class="si">}</span><span class="s2"> &lt; than limit (</span><span class="si">{</span><span class="n">min_memory</span><span class="si">}</span><span class="s2">), using </span><span class="si">{</span><span class="n">min_memory</span><span class="si">}</span><span class="s2"> GB&quot;</span><span class="p">)</span>
<a id="__codelineno-0-78" name="__codelineno-0-78"></a>        <span class="n">memory</span> <span class="o">=</span> <span class="n">min_memory</span>
<a id="__codelineno-0-79" name="__codelineno-0-79"></a>    <span class="k">if</span> <span class="n">memory</span> <span class="o">&gt;</span> <span class="n">max_memory</span><span class="p">:</span>
<a id="__codelineno-0-80" name="__codelineno-0-80"></a>        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">memory</span><span class="si">}</span><span class="s2"> &gt; than limit (</span><span class="si">{</span><span class="n">max_memory</span><span class="si">}</span><span class="s2">), using </span><span class="si">{</span><span class="n">max_memory</span><span class="si">}</span><span class="s2"> GB&quot;</span><span class="p">)</span>
<a id="__codelineno-0-81" name="__codelineno-0-81"></a>        <span class="n">memory</span> <span class="o">=</span> <span class="n">max_memory</span>
<a id="__codelineno-0-82" name="__codelineno-0-82"></a>
<a id="__codelineno-0-83" name="__codelineno-0-83"></a>
<a id="__codelineno-0-84" name="__codelineno-0-84"></a>    <span class="c1"># create slurm batch file for progress tracking</span>
<a id="__codelineno-0-85" name="__codelineno-0-85"></a>    <span class="n">slurm_batch_filename</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">output_folder</span><span class="p">,</span> <span class="s2">&quot;mixcr_analyze_slurm_batch.log&quot;</span><span class="p">)</span>
<a id="__codelineno-0-86" name="__codelineno-0-86"></a>    <span class="n">create_slurm_batch_file</span><span class="p">(</span><span class="n">slurm_batch_filename</span><span class="p">,</span> <span class="n">program_name</span><span class="p">,</span> <span class="n">samples_num</span><span class="p">)</span>
<a id="__codelineno-0-87" name="__codelineno-0-87"></a>
<a id="__codelineno-0-88" name="__codelineno-0-88"></a>    <span class="c1"># main cycle by samples</span>
<a id="__codelineno-0-89" name="__codelineno-0-89"></a>    <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">r</span> <span class="ow">in</span> <span class="n">sample_df</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>
<a id="__codelineno-0-90" name="__codelineno-0-90"></a>        <span class="n">sample_id</span> <span class="o">=</span> <span class="n">r</span><span class="p">[</span><span class="s2">&quot;sample_id&quot;</span><span class="p">]</span>
<a id="__codelineno-0-91" name="__codelineno-0-91"></a>        <span class="n">r1</span> <span class="o">=</span> <span class="n">r</span><span class="p">[</span><span class="s2">&quot;R1&quot;</span><span class="p">]</span>
<a id="__codelineno-0-92" name="__codelineno-0-92"></a>        <span class="n">r2</span> <span class="o">=</span> <span class="n">r</span><span class="p">[</span><span class="s2">&quot;R2&quot;</span><span class="p">]</span>
<a id="__codelineno-0-93" name="__codelineno-0-93"></a>    <span class="c1">#   output_prefix = os.path.join(output_folder, sample_id)</span>
<a id="__codelineno-0-94" name="__codelineno-0-94"></a>        <span class="n">output_prefix</span> <span class="o">=</span> <span class="n">sample_id</span>
<a id="__codelineno-0-95" name="__codelineno-0-95"></a>        <span class="k">if</span> <span class="n">custom_tag_pattern</span><span class="p">:</span>
<a id="__codelineno-0-96" name="__codelineno-0-96"></a>            <span class="n">tag_pattern</span> <span class="o">=</span> <span class="n">r</span><span class="p">[</span><span class="n">custom_tag_pattern_column</span><span class="p">]</span>
<a id="__codelineno-0-97" name="__codelineno-0-97"></a>            <span class="n">command</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">mixcr_path</span><span class="si">}</span><span class="s1"> -Xmx</span><span class="si">{</span><span class="n">memory</span><span class="si">}</span><span class="s1">g </span><span class="si">{</span><span class="n">command_template</span><span class="si">}</span><span class="s1"> --tag-pattern &quot;</span><span class="si">{</span><span class="n">tag_pattern</span><span class="si">}</span><span class="s1">&quot; </span><span class="si">{</span><span class="n">r1</span><span class="si">}</span><span class="s1"> </span><span class="si">{</span><span class="n">r2</span><span class="si">}</span><span class="s1"> </span><span class="si">{</span><span class="n">output_prefix</span><span class="si">}</span><span class="s1">&#39;</span>
<a id="__codelineno-0-98" name="__codelineno-0-98"></a>        <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-99" name="__codelineno-0-99"></a>            <span class="n">command</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">mixcr_path</span><span class="si">}</span><span class="s1"> -Xmx</span><span class="si">{</span><span class="n">memory</span><span class="si">}</span><span class="s1">g </span><span class="si">{</span><span class="n">command_template</span><span class="si">}</span><span class="s1"> </span><span class="si">{</span><span class="n">r1</span><span class="si">}</span><span class="s1"> </span><span class="si">{</span><span class="n">r2</span><span class="si">}</span><span class="s1"> </span><span class="si">{</span><span class="n">output_prefix</span><span class="si">}</span><span class="s1">&#39;</span>
<a id="__codelineno-0-100" name="__codelineno-0-100"></a>        <span class="n">command</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;cd </span><span class="si">{</span><span class="n">output_folder</span><span class="si">}</span><span class="s2">; &quot;</span> <span class="o">+</span> <span class="n">command</span>
<a id="__codelineno-0-101" name="__codelineno-0-101"></a>        <span class="n">jobname</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;mixcr_analyze_</span><span class="si">{</span><span class="n">sample_id</span><span class="si">}</span><span class="s2">&quot;</span>
<a id="__codelineno-0-102" name="__codelineno-0-102"></a>
<a id="__codelineno-0-103" name="__codelineno-0-103"></a>        <span class="c1"># for batch task finish tracking:</span>
<a id="__codelineno-0-104" name="__codelineno-0-104"></a>        <span class="n">command</span> <span class="o">+=</span> <span class="sa">f</span><span class="s1">&#39;; echo &quot;</span><span class="si">{</span><span class="n">jobname</span><span class="si">}</span><span class="s1"> finished&quot; &gt;&gt; </span><span class="si">{</span><span class="n">slurm_batch_filename</span><span class="si">}</span><span class="s1">&#39;</span>
<a id="__codelineno-0-105" name="__codelineno-0-105"></a>
<a id="__codelineno-0-106" name="__codelineno-0-106"></a>        <span class="c1"># create slurm script and add job to queue, print stdout of sbatch</span>
<a id="__codelineno-0-107" name="__codelineno-0-107"></a>        <span class="n">stdout</span><span class="p">,</span> <span class="n">stderr</span> <span class="o">=</span> <span class="n">run_slurm_command_from_jupyter</span><span class="p">(</span><span class="n">command</span><span class="p">,</span> <span class="n">jobname</span><span class="p">,</span> <span class="n">cpus</span><span class="p">,</span> <span class="n">time_estimate</span><span class="p">,</span> <span class="n">memory</span><span class="p">)</span>
<a id="__codelineno-0-108" name="__codelineno-0-108"></a>        <span class="nb">print</span><span class="p">(</span><span class="n">stdout</span><span class="p">,</span> <span class="n">stderr</span><span class="p">)</span>
<a id="__codelineno-0-109" name="__codelineno-0-109"></a>
<a id="__codelineno-0-110" name="__codelineno-0-110"></a>    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">samples_num</span><span class="si">}</span><span class="s2"> tasks added to slurm queue</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-0-111" name="__codelineno-0-111"></a>    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;To see running progress bar run this function in the next jupyter cell:</span><span class="se">\n</span><span class="s1">slurm.check_slurm_progress(&quot;</span><span class="si">{</span><span class="n">slurm_batch_filename</span><span class="si">}</span><span class="s1">&quot;, loop=True)&#39;</span><span class="p">)</span>
<a id="__codelineno-0-112" name="__codelineno-0-112"></a>    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;To see current progress:</span><span class="se">\n</span><span class="s1">slurm.check_slurm_progress(&quot;</span><span class="si">{</span><span class="n">slurm_batch_filename</span><span class="si">}</span><span class="s1">&quot;)&#39;</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h4 id="mixcr.mixcr4_reports" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">mixcr4_reports</span><span class="p">(</span><span class="n">folder</span><span class="p">,</span> <span class="n">mixcr_path</span><span class="o">=</span><span class="s1">&#39;mixcr&#39;</span><span class="p">)</span></code>

</h4>


    <div class="doc doc-contents ">

        <p>runs <code>mixcr exportQc</code> commands - <code>align</code>, <code>chainUsage</code> and <code>tags</code> in a given folder 
for all <code>.clns</code> filenames. <code>align</code> and <code>chainUsage</code> are run twice to create both 
<code>svg</code> and <code>pdf</code> files.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>folder</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>folder in which to run the <code>mixcr exportQc</code> commands</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>mixcr_path</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>path to MiXCR binary</p>
              </div>
            </td>
            <td>
                  <code>&#39;mixcr&#39;</code>
            </td>
          </tr>
      </tbody>
    </table>
        <p>Returns:
    None</p>


            <details class="quote">
              <summary>Source code in <code>repseq/mixcr.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-208">208</a></span>
<span class="normal"><a href="#__codelineno-0-209">209</a></span>
<span class="normal"><a href="#__codelineno-0-210">210</a></span>
<span class="normal"><a href="#__codelineno-0-211">211</a></span>
<span class="normal"><a href="#__codelineno-0-212">212</a></span>
<span class="normal"><a href="#__codelineno-0-213">213</a></span>
<span class="normal"><a href="#__codelineno-0-214">214</a></span>
<span class="normal"><a href="#__codelineno-0-215">215</a></span>
<span class="normal"><a href="#__codelineno-0-216">216</a></span>
<span class="normal"><a href="#__codelineno-0-217">217</a></span>
<span class="normal"><a href="#__codelineno-0-218">218</a></span>
<span class="normal"><a href="#__codelineno-0-219">219</a></span>
<span class="normal"><a href="#__codelineno-0-220">220</a></span>
<span class="normal"><a href="#__codelineno-0-221">221</a></span>
<span class="normal"><a href="#__codelineno-0-222">222</a></span>
<span class="normal"><a href="#__codelineno-0-223">223</a></span>
<span class="normal"><a href="#__codelineno-0-224">224</a></span>
<span class="normal"><a href="#__codelineno-0-225">225</a></span>
<span class="normal"><a href="#__codelineno-0-226">226</a></span>
<span class="normal"><a href="#__codelineno-0-227">227</a></span>
<span class="normal"><a href="#__codelineno-0-228">228</a></span>
<span class="normal"><a href="#__codelineno-0-229">229</a></span>
<span class="normal"><a href="#__codelineno-0-230">230</a></span>
<span class="normal"><a href="#__codelineno-0-231">231</a></span>
<span class="normal"><a href="#__codelineno-0-232">232</a></span>
<span class="normal"><a href="#__codelineno-0-233">233</a></span>
<span class="normal"><a href="#__codelineno-0-234">234</a></span>
<span class="normal"><a href="#__codelineno-0-235">235</a></span>
<span class="normal"><a href="#__codelineno-0-236">236</a></span>
<span class="normal"><a href="#__codelineno-0-237">237</a></span>
<span class="normal"><a href="#__codelineno-0-238">238</a></span>
<span class="normal"><a href="#__codelineno-0-239">239</a></span>
<span class="normal"><a href="#__codelineno-0-240">240</a></span>
<span class="normal"><a href="#__codelineno-0-241">241</a></span>
<span class="normal"><a href="#__codelineno-0-242">242</a></span>
<span class="normal"><a href="#__codelineno-0-243">243</a></span>
<span class="normal"><a href="#__codelineno-0-244">244</a></span>
<span class="normal"><a href="#__codelineno-0-245">245</a></span>
<span class="normal"><a href="#__codelineno-0-246">246</a></span>
<span class="normal"><a href="#__codelineno-0-247">247</a></span>
<span class="normal"><a href="#__codelineno-0-248">248</a></span>
<span class="normal"><a href="#__codelineno-0-249">249</a></span>
<span class="normal"><a href="#__codelineno-0-250">250</a></span>
<span class="normal"><a href="#__codelineno-0-251">251</a></span>
<span class="normal"><a href="#__codelineno-0-252">252</a></span>
<span class="normal"><a href="#__codelineno-0-253">253</a></span>
<span class="normal"><a href="#__codelineno-0-254">254</a></span>
<span class="normal"><a href="#__codelineno-0-255">255</a></span>
<span class="normal"><a href="#__codelineno-0-256">256</a></span>
<span class="normal"><a href="#__codelineno-0-257">257</a></span>
<span class="normal"><a href="#__codelineno-0-258">258</a></span>
<span class="normal"><a href="#__codelineno-0-259">259</a></span>
<span class="normal"><a href="#__codelineno-0-260">260</a></span>
<span class="normal"><a href="#__codelineno-0-261">261</a></span>
<span class="normal"><a href="#__codelineno-0-262">262</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-208" name="__codelineno-0-208"></a><span class="k">def</span><span class="w"> </span><span class="nf">mixcr4_reports</span><span class="p">(</span><span class="n">folder</span><span class="p">,</span> <span class="n">mixcr_path</span><span class="o">=</span><span class="s2">&quot;mixcr&quot;</span><span class="p">):</span>
<a id="__codelineno-0-209" name="__codelineno-0-209"></a>
<a id="__codelineno-0-210" name="__codelineno-0-210"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-211" name="__codelineno-0-211"></a><span class="sd">    runs `mixcr exportQc` commands - `align`, `chainUsage` and `tags` in a given folder </span>
<a id="__codelineno-0-212" name="__codelineno-0-212"></a><span class="sd">    for all `.clns` filenames. `align` and `chainUsage` are run twice to create both </span>
<a id="__codelineno-0-213" name="__codelineno-0-213"></a><span class="sd">    `svg` and `pdf` files.</span>
<a id="__codelineno-0-214" name="__codelineno-0-214"></a>
<a id="__codelineno-0-215" name="__codelineno-0-215"></a><span class="sd">    Args:</span>
<a id="__codelineno-0-216" name="__codelineno-0-216"></a><span class="sd">        folder (str): folder in which to run the `mixcr exportQc` commands</span>
<a id="__codelineno-0-217" name="__codelineno-0-217"></a><span class="sd">        mixcr_path (str): path to MiXCR binary</span>
<a id="__codelineno-0-218" name="__codelineno-0-218"></a><span class="sd">    Returns:</span>
<a id="__codelineno-0-219" name="__codelineno-0-219"></a><span class="sd">        None</span>
<a id="__codelineno-0-220" name="__codelineno-0-220"></a>
<a id="__codelineno-0-221" name="__codelineno-0-221"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-222" name="__codelineno-0-222"></a>
<a id="__codelineno-0-223" name="__codelineno-0-223"></a>
<a id="__codelineno-0-224" name="__codelineno-0-224"></a>    <span class="n">program_name</span><span class="o">=</span><span class="s2">&quot;MIXCR4.3 Reports&quot;</span>
<a id="__codelineno-0-225" name="__codelineno-0-225"></a>    <span class="n">time_estimate</span><span class="o">=</span><span class="mi">1</span>
<a id="__codelineno-0-226" name="__codelineno-0-226"></a>    <span class="n">cpus</span><span class="o">=</span><span class="mi">40</span>
<a id="__codelineno-0-227" name="__codelineno-0-227"></a>    <span class="n">memory</span><span class="o">=</span><span class="mi">32</span>
<a id="__codelineno-0-228" name="__codelineno-0-228"></a>
<a id="__codelineno-0-229" name="__codelineno-0-229"></a>    <span class="c1"># clns_filenames = os.path.join(folder, &quot;*.clns&quot;)</span>
<a id="__codelineno-0-230" name="__codelineno-0-230"></a>    <span class="c1"># align_filename = os.path.join(folder, &quot;alignQc.png&quot;)</span>
<a id="__codelineno-0-231" name="__codelineno-0-231"></a>    <span class="c1"># chains_filename = os.path.join(folder, &quot;chainsQc.png&quot;)</span>
<a id="__codelineno-0-232" name="__codelineno-0-232"></a>    <span class="c1"># tags_filename = os.path.join(folder, &quot;tagsQc.pdf&quot;)</span>
<a id="__codelineno-0-233" name="__codelineno-0-233"></a>    <span class="n">clns_filenames</span> <span class="o">=</span> <span class="s2">&quot;*.clns&quot;</span>
<a id="__codelineno-0-234" name="__codelineno-0-234"></a>    <span class="n">align_filename</span> <span class="o">=</span> <span class="s2">&quot;alignQc.svg&quot;</span>
<a id="__codelineno-0-235" name="__codelineno-0-235"></a>    <span class="n">chains_filename</span> <span class="o">=</span> <span class="s2">&quot;chainsQc.svg&quot;</span>
<a id="__codelineno-0-236" name="__codelineno-0-236"></a>    <span class="n">align_filename_pdf</span> <span class="o">=</span> <span class="s2">&quot;alignQc.pdf&quot;</span>
<a id="__codelineno-0-237" name="__codelineno-0-237"></a>    <span class="n">chains_filename_pdf</span> <span class="o">=</span> <span class="s2">&quot;chainsQc.pdf&quot;</span>
<a id="__codelineno-0-238" name="__codelineno-0-238"></a>    <span class="n">tags_filename</span> <span class="o">=</span> <span class="s2">&quot;tagsQc.pdf&quot;</span>
<a id="__codelineno-0-239" name="__codelineno-0-239"></a>    <span class="c1">#tables_filename = os.path.join(folder, &quot;tables.tsv&quot;)</span>
<a id="__codelineno-0-240" name="__codelineno-0-240"></a>    <span class="c1">#preproc_filename = os.path.join(folder, &quot;preproc_tables.tsv&quot;)</span>
<a id="__codelineno-0-241" name="__codelineno-0-241"></a>    <span class="c1">#postanalysis_filename = os.path.join(folder, &quot;postanalysis.json&quot;)</span>
<a id="__codelineno-0-242" name="__codelineno-0-242"></a>
<a id="__codelineno-0-243" name="__codelineno-0-243"></a>
<a id="__codelineno-0-244" name="__codelineno-0-244"></a>
<a id="__codelineno-0-245" name="__codelineno-0-245"></a>    <span class="n">commands</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;alignQc&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;cd </span><span class="si">{</span><span class="n">folder</span><span class="si">}</span><span class="s2">; </span><span class="si">{</span><span class="n">mixcr_path</span><span class="si">}</span><span class="s2"> -Xmx32g exportQc align -f </span><span class="si">{</span><span class="n">clns_filenames</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">align_filename</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
<a id="__codelineno-0-246" name="__codelineno-0-246"></a>                <span class="s2">&quot;chainUsage&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;cd </span><span class="si">{</span><span class="n">folder</span><span class="si">}</span><span class="s2">; </span><span class="si">{</span><span class="n">mixcr_path</span><span class="si">}</span><span class="s2"> -Xmx32g exportQc chainUsage -f </span><span class="si">{</span><span class="n">clns_filenames</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">chains_filename</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
<a id="__codelineno-0-247" name="__codelineno-0-247"></a>                <span class="s2">&quot;alignQcPDF&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;cd </span><span class="si">{</span><span class="n">folder</span><span class="si">}</span><span class="s2">; </span><span class="si">{</span><span class="n">mixcr_path</span><span class="si">}</span><span class="s2"> -Xmx32g exportQc align -f </span><span class="si">{</span><span class="n">clns_filenames</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">align_filename_pdf</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
<a id="__codelineno-0-248" name="__codelineno-0-248"></a>                <span class="s2">&quot;chainUsagePDF&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;cd </span><span class="si">{</span><span class="n">folder</span><span class="si">}</span><span class="s2">; </span><span class="si">{</span><span class="n">mixcr_path</span><span class="si">}</span><span class="s2"> -Xmx32g exportQc chainUsage -f </span><span class="si">{</span><span class="n">clns_filenames</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">chains_filename_pdf</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
<a id="__codelineno-0-249" name="__codelineno-0-249"></a>                <span class="s2">&quot;tagsQc&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;cd </span><span class="si">{</span><span class="n">folder</span><span class="si">}</span><span class="s2">; </span><span class="si">{</span><span class="n">mixcr_path</span><span class="si">}</span><span class="s2"> -Xmx32g exportQc tags -f </span><span class="si">{</span><span class="n">clns_filenames</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">tags_filename</span><span class="si">}</span><span class="s2">&quot;</span><span class="c1">#,</span>
<a id="__codelineno-0-250" name="__codelineno-0-250"></a>                <span class="c1">#&quot;postanalysis&quot;: f&quot;{MIXCR} -Xmx32g postanalysis individual -f --default-downsampling none --default-weight-function umi --only-productive --tables {tables_filename} --preproc-tables {preproc_filename} {clns_filenames} {postanalysis_filename}&quot;</span>
<a id="__codelineno-0-251" name="__codelineno-0-251"></a>               <span class="p">}</span>
<a id="__codelineno-0-252" name="__codelineno-0-252"></a>
<a id="__codelineno-0-253" name="__codelineno-0-253"></a>
<a id="__codelineno-0-254" name="__codelineno-0-254"></a>    <span class="n">commands_num</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">commands</span><span class="p">)</span>
<a id="__codelineno-0-255" name="__codelineno-0-255"></a>
<a id="__codelineno-0-256" name="__codelineno-0-256"></a>    <span class="n">slurm_batch_filename</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">folder</span><span class="p">,</span> <span class="s2">&quot;mixcr_reports_slurm_batch.log&quot;</span><span class="p">)</span>
<a id="__codelineno-0-257" name="__codelineno-0-257"></a>    <span class="n">create_slurm_batch_file</span><span class="p">(</span><span class="n">slurm_batch_filename</span><span class="p">,</span> <span class="n">program_name</span><span class="p">,</span> <span class="n">commands_num</span><span class="p">)</span>
<a id="__codelineno-0-258" name="__codelineno-0-258"></a>
<a id="__codelineno-0-259" name="__codelineno-0-259"></a>    <span class="k">for</span> <span class="n">jobname</span><span class="p">,</span> <span class="n">command</span> <span class="ow">in</span> <span class="n">commands</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
<a id="__codelineno-0-260" name="__codelineno-0-260"></a>        <span class="n">command</span> <span class="o">+=</span> <span class="sa">f</span><span class="s1">&#39;; echo &quot;</span><span class="si">{</span><span class="n">jobname</span><span class="si">}</span><span class="s1"> finished&quot; &gt;&gt; </span><span class="si">{</span><span class="n">slurm_batch_filename</span><span class="si">}</span><span class="s1">&#39;</span>
<a id="__codelineno-0-261" name="__codelineno-0-261"></a>        <span class="n">stdout</span><span class="p">,</span> <span class="n">stderr</span> <span class="o">=</span> <span class="n">run_slurm_command_from_jupyter</span><span class="p">(</span><span class="n">command</span><span class="p">,</span> <span class="n">jobname</span><span class="p">,</span> <span class="n">cpus</span><span class="p">,</span> <span class="n">time_estimate</span><span class="p">,</span> <span class="n">memory</span><span class="p">)</span>
<a id="__codelineno-0-262" name="__codelineno-0-262"></a>        <span class="nb">print</span><span class="p">(</span><span class="n">stdout</span><span class="p">,</span> <span class="n">stderr</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h4 id="mixcr.mixcr_7genes_run_batch" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">mixcr_7genes_run_batch</span><span class="p">(</span><span class="n">sample_df</span><span class="p">,</span> <span class="n">output_folder</span><span class="p">,</span> <span class="n">mixcr_path</span><span class="o">=</span><span class="s1">&#39;mixcr&#39;</span><span class="p">,</span> <span class="n">memory</span><span class="o">=</span><span class="mi">32</span><span class="p">,</span> <span class="n">time_estimate</span><span class="o">=</span><span class="mf">1.5</span><span class="p">)</span></code>

</h4>


    <div class="doc doc-contents ">

        <p>Function for batch runs of the MiXCR software using the SLURM <code>mixcr analyze</code> command and the <code>Human 7GENES DNA Multiplex</code> MiXCR built-in preset. 
Incomplete rearrangements obtained by this kit are also included. For each incomplete rearrangement, unaligned reads from the previous 
step are iteratively processed. Each output is stored in a subdirectory named after the corresponding rearrangement.
For each record in the given <code>sample_df</code>, this function creates a SLURM script in the <code>~/temp/slurm</code> folder and adds it to the SLURM queue. 
All <code>stdout</code> logs are also saved to the <code>~/temp/slurm</code> folder. In case of troubles, check the latest logs in this folder. </p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>sample_df</code>
            </td>
            <td>
                  <code><span title="pandas.DataFrame">DataFrame</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>DataFrame containing a 'sample_id' column and 
'R1' and 'R2' columns containing paths (recommended full paths) to raw read files.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>output_folder</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Path to the output folder.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>mixcr_path</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Path to the MiXCR binary.</p>
              </div>
            </td>
            <td>
                  <code>&#39;mixcr&#39;</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>memory</code>
            </td>
            <td>
                  <code><span title="int">int</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Required OOM in GB.</p>
              </div>
            </td>
            <td>
                  <code>32</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>time_estimate</code>
            </td>
            <td>
                  <code><span title="numeric">numeric</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Time estimate in hours for the calculation; it 
is the limit for the SLURM task.</p>
              </div>
            </td>
            <td>
                  <code>1.5</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>None</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>repseq/mixcr.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-115">115</a></span>
<span class="normal"><a href="#__codelineno-0-116">116</a></span>
<span class="normal"><a href="#__codelineno-0-117">117</a></span>
<span class="normal"><a href="#__codelineno-0-118">118</a></span>
<span class="normal"><a href="#__codelineno-0-119">119</a></span>
<span class="normal"><a href="#__codelineno-0-120">120</a></span>
<span class="normal"><a href="#__codelineno-0-121">121</a></span>
<span class="normal"><a href="#__codelineno-0-122">122</a></span>
<span class="normal"><a href="#__codelineno-0-123">123</a></span>
<span class="normal"><a href="#__codelineno-0-124">124</a></span>
<span class="normal"><a href="#__codelineno-0-125">125</a></span>
<span class="normal"><a href="#__codelineno-0-126">126</a></span>
<span class="normal"><a href="#__codelineno-0-127">127</a></span>
<span class="normal"><a href="#__codelineno-0-128">128</a></span>
<span class="normal"><a href="#__codelineno-0-129">129</a></span>
<span class="normal"><a href="#__codelineno-0-130">130</a></span>
<span class="normal"><a href="#__codelineno-0-131">131</a></span>
<span class="normal"><a href="#__codelineno-0-132">132</a></span>
<span class="normal"><a href="#__codelineno-0-133">133</a></span>
<span class="normal"><a href="#__codelineno-0-134">134</a></span>
<span class="normal"><a href="#__codelineno-0-135">135</a></span>
<span class="normal"><a href="#__codelineno-0-136">136</a></span>
<span class="normal"><a href="#__codelineno-0-137">137</a></span>
<span class="normal"><a href="#__codelineno-0-138">138</a></span>
<span class="normal"><a href="#__codelineno-0-139">139</a></span>
<span class="normal"><a href="#__codelineno-0-140">140</a></span>
<span class="normal"><a href="#__codelineno-0-141">141</a></span>
<span class="normal"><a href="#__codelineno-0-142">142</a></span>
<span class="normal"><a href="#__codelineno-0-143">143</a></span>
<span class="normal"><a href="#__codelineno-0-144">144</a></span>
<span class="normal"><a href="#__codelineno-0-145">145</a></span>
<span class="normal"><a href="#__codelineno-0-146">146</a></span>
<span class="normal"><a href="#__codelineno-0-147">147</a></span>
<span class="normal"><a href="#__codelineno-0-148">148</a></span>
<span class="normal"><a href="#__codelineno-0-149">149</a></span>
<span class="normal"><a href="#__codelineno-0-150">150</a></span>
<span class="normal"><a href="#__codelineno-0-151">151</a></span>
<span class="normal"><a href="#__codelineno-0-152">152</a></span>
<span class="normal"><a href="#__codelineno-0-153">153</a></span>
<span class="normal"><a href="#__codelineno-0-154">154</a></span>
<span class="normal"><a href="#__codelineno-0-155">155</a></span>
<span class="normal"><a href="#__codelineno-0-156">156</a></span>
<span class="normal"><a href="#__codelineno-0-157">157</a></span>
<span class="normal"><a href="#__codelineno-0-158">158</a></span>
<span class="normal"><a href="#__codelineno-0-159">159</a></span>
<span class="normal"><a href="#__codelineno-0-160">160</a></span>
<span class="normal"><a href="#__codelineno-0-161">161</a></span>
<span class="normal"><a href="#__codelineno-0-162">162</a></span>
<span class="normal"><a href="#__codelineno-0-163">163</a></span>
<span class="normal"><a href="#__codelineno-0-164">164</a></span>
<span class="normal"><a href="#__codelineno-0-165">165</a></span>
<span class="normal"><a href="#__codelineno-0-166">166</a></span>
<span class="normal"><a href="#__codelineno-0-167">167</a></span>
<span class="normal"><a href="#__codelineno-0-168">168</a></span>
<span class="normal"><a href="#__codelineno-0-169">169</a></span>
<span class="normal"><a href="#__codelineno-0-170">170</a></span>
<span class="normal"><a href="#__codelineno-0-171">171</a></span>
<span class="normal"><a href="#__codelineno-0-172">172</a></span>
<span class="normal"><a href="#__codelineno-0-173">173</a></span>
<span class="normal"><a href="#__codelineno-0-174">174</a></span>
<span class="normal"><a href="#__codelineno-0-175">175</a></span>
<span class="normal"><a href="#__codelineno-0-176">176</a></span>
<span class="normal"><a href="#__codelineno-0-177">177</a></span>
<span class="normal"><a href="#__codelineno-0-178">178</a></span>
<span class="normal"><a href="#__codelineno-0-179">179</a></span>
<span class="normal"><a href="#__codelineno-0-180">180</a></span>
<span class="normal"><a href="#__codelineno-0-181">181</a></span>
<span class="normal"><a href="#__codelineno-0-182">182</a></span>
<span class="normal"><a href="#__codelineno-0-183">183</a></span>
<span class="normal"><a href="#__codelineno-0-184">184</a></span>
<span class="normal"><a href="#__codelineno-0-185">185</a></span>
<span class="normal"><a href="#__codelineno-0-186">186</a></span>
<span class="normal"><a href="#__codelineno-0-187">187</a></span>
<span class="normal"><a href="#__codelineno-0-188">188</a></span>
<span class="normal"><a href="#__codelineno-0-189">189</a></span>
<span class="normal"><a href="#__codelineno-0-190">190</a></span>
<span class="normal"><a href="#__codelineno-0-191">191</a></span>
<span class="normal"><a href="#__codelineno-0-192">192</a></span>
<span class="normal"><a href="#__codelineno-0-193">193</a></span>
<span class="normal"><a href="#__codelineno-0-194">194</a></span>
<span class="normal"><a href="#__codelineno-0-195">195</a></span>
<span class="normal"><a href="#__codelineno-0-196">196</a></span>
<span class="normal"><a href="#__codelineno-0-197">197</a></span>
<span class="normal"><a href="#__codelineno-0-198">198</a></span>
<span class="normal"><a href="#__codelineno-0-199">199</a></span>
<span class="normal"><a href="#__codelineno-0-200">200</a></span>
<span class="normal"><a href="#__codelineno-0-201">201</a></span>
<span class="normal"><a href="#__codelineno-0-202">202</a></span>
<span class="normal"><a href="#__codelineno-0-203">203</a></span>
<span class="normal"><a href="#__codelineno-0-204">204</a></span>
<span class="normal"><a href="#__codelineno-0-205">205</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-115" name="__codelineno-0-115"></a><span class="k">def</span><span class="w"> </span><span class="nf">mixcr_7genes_run_batch</span><span class="p">(</span><span class="n">sample_df</span><span class="p">,</span> <span class="n">output_folder</span><span class="p">,</span> <span class="n">mixcr_path</span><span class="o">=</span><span class="s2">&quot;mixcr&quot;</span><span class="p">,</span> <span class="n">memory</span><span class="o">=</span><span class="mi">32</span><span class="p">,</span> <span class="n">time_estimate</span><span class="o">=</span><span class="mf">1.5</span><span class="p">):</span>
<a id="__codelineno-0-116" name="__codelineno-0-116"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-117" name="__codelineno-0-117"></a><span class="sd">    Function for batch runs of the MiXCR software using the SLURM `mixcr analyze` command and the `Human 7GENES DNA Multiplex` MiXCR built-in preset. </span>
<a id="__codelineno-0-118" name="__codelineno-0-118"></a><span class="sd">    Incomplete rearrangements obtained by this kit are also included. For each incomplete rearrangement, unaligned reads from the previous </span>
<a id="__codelineno-0-119" name="__codelineno-0-119"></a><span class="sd">    step are iteratively processed. Each output is stored in a subdirectory named after the corresponding rearrangement.</span>
<a id="__codelineno-0-120" name="__codelineno-0-120"></a><span class="sd">    For each record in the given `sample_df`, this function creates a SLURM script in the `~/temp/slurm` folder and adds it to the SLURM queue. </span>
<a id="__codelineno-0-121" name="__codelineno-0-121"></a><span class="sd">    All `stdout` logs are also saved to the `~/temp/slurm` folder. In case of troubles, check the latest logs in this folder. </span>
<a id="__codelineno-0-122" name="__codelineno-0-122"></a>
<a id="__codelineno-0-123" name="__codelineno-0-123"></a><span class="sd">    Args:</span>
<a id="__codelineno-0-124" name="__codelineno-0-124"></a><span class="sd">        sample_df (pd.DataFrame): DataFrame containing a &#39;sample_id&#39; column and </span>
<a id="__codelineno-0-125" name="__codelineno-0-125"></a><span class="sd">            &#39;R1&#39; and &#39;R2&#39; columns containing paths (recommended full paths) to raw read files.</span>
<a id="__codelineno-0-126" name="__codelineno-0-126"></a><span class="sd">        output_folder (str): Path to the output folder.</span>
<a id="__codelineno-0-127" name="__codelineno-0-127"></a><span class="sd">        mixcr_path (str): Path to the MiXCR binary.</span>
<a id="__codelineno-0-128" name="__codelineno-0-128"></a><span class="sd">        memory (int): Required OOM in GB.</span>
<a id="__codelineno-0-129" name="__codelineno-0-129"></a><span class="sd">        time_estimate (numeric): Time estimate in hours for the calculation; it </span>
<a id="__codelineno-0-130" name="__codelineno-0-130"></a><span class="sd">            is the limit for the SLURM task.</span>
<a id="__codelineno-0-131" name="__codelineno-0-131"></a>
<a id="__codelineno-0-132" name="__codelineno-0-132"></a><span class="sd">    Returns:</span>
<a id="__codelineno-0-133" name="__codelineno-0-133"></a><span class="sd">        None</span>
<a id="__codelineno-0-134" name="__codelineno-0-134"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-135" name="__codelineno-0-135"></a>    <span class="c1"># default mixcr analyze slurm parameters. They are quite excessive, works fine.</span>
<a id="__codelineno-0-136" name="__codelineno-0-136"></a>    <span class="n">max_memory</span> <span class="o">=</span> <span class="mi">1500</span>
<a id="__codelineno-0-137" name="__codelineno-0-137"></a>    <span class="n">min_memory</span> <span class="o">=</span> <span class="mi">16</span>
<a id="__codelineno-0-138" name="__codelineno-0-138"></a>    <span class="n">cpus</span><span class="o">=</span><span class="mi">40</span>
<a id="__codelineno-0-139" name="__codelineno-0-139"></a>
<a id="__codelineno-0-140" name="__codelineno-0-140"></a>    <span class="n">program_name</span><span class="o">=</span><span class="s2">&quot;MIXCR4 Analyze 7genes Batch&quot;</span>
<a id="__codelineno-0-141" name="__codelineno-0-141"></a>    <span class="n">samples_num</span> <span class="o">=</span> <span class="n">sample_df</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<a id="__codelineno-0-142" name="__codelineno-0-142"></a>
<a id="__codelineno-0-143" name="__codelineno-0-143"></a>    <span class="c1"># Create output dir if does not exist</span>
<a id="__codelineno-0-144" name="__codelineno-0-144"></a>    <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">output_folder</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<a id="__codelineno-0-145" name="__codelineno-0-145"></a>
<a id="__codelineno-0-146" name="__codelineno-0-146"></a>
<a id="__codelineno-0-147" name="__codelineno-0-147"></a>    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">memory</span><span class="p">,</span> <span class="nb">int</span><span class="p">):</span>
<a id="__codelineno-0-148" name="__codelineno-0-148"></a>        <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;memory parameter must be an integer&quot;</span><span class="p">)</span>
<a id="__codelineno-0-149" name="__codelineno-0-149"></a>    <span class="k">if</span> <span class="n">memory</span> <span class="o">&lt;</span> <span class="n">min_memory</span><span class="p">:</span>
<a id="__codelineno-0-150" name="__codelineno-0-150"></a>        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">memory</span><span class="si">}</span><span class="s2"> &lt; than limit (</span><span class="si">{</span><span class="n">min_memory</span><span class="si">}</span><span class="s2">), using </span><span class="si">{</span><span class="n">min_memory</span><span class="si">}</span><span class="s2"> GB&quot;</span><span class="p">)</span>
<a id="__codelineno-0-151" name="__codelineno-0-151"></a>        <span class="n">memory</span> <span class="o">=</span> <span class="n">min_memory</span>
<a id="__codelineno-0-152" name="__codelineno-0-152"></a>    <span class="k">if</span> <span class="n">memory</span> <span class="o">&gt;</span> <span class="n">max_memory</span><span class="p">:</span>
<a id="__codelineno-0-153" name="__codelineno-0-153"></a>        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">memory</span><span class="si">}</span><span class="s2"> &gt; than limit (</span><span class="si">{</span><span class="n">max_memory</span><span class="si">}</span><span class="s2">), using </span><span class="si">{</span><span class="n">max_memory</span><span class="si">}</span><span class="s2"> GB&quot;</span><span class="p">)</span>
<a id="__codelineno-0-154" name="__codelineno-0-154"></a>        <span class="n">memory</span> <span class="o">=</span> <span class="n">max_memory</span>
<a id="__codelineno-0-155" name="__codelineno-0-155"></a>
<a id="__codelineno-0-156" name="__codelineno-0-156"></a>    <span class="c1"># create slurm batch file for progress tracking</span>
<a id="__codelineno-0-157" name="__codelineno-0-157"></a>    <span class="n">slurm_batch_filename</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">output_folder</span><span class="p">,</span> <span class="s2">&quot;mixcr_analyze_slurm_batch.log&quot;</span><span class="p">)</span>
<a id="__codelineno-0-158" name="__codelineno-0-158"></a>    <span class="n">create_slurm_batch_file</span><span class="p">(</span><span class="n">slurm_batch_filename</span><span class="p">,</span> <span class="n">program_name</span><span class="p">,</span> <span class="n">samples_num</span><span class="p">)</span>
<a id="__codelineno-0-159" name="__codelineno-0-159"></a>
<a id="__codelineno-0-160" name="__codelineno-0-160"></a>    <span class="n">list_of_incomplete_rearrangements</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;DJ_TRB&quot;</span><span class="p">,</span> <span class="s2">&quot;VDD_TRD&quot;</span><span class="p">,</span> <span class="s2">&quot;DDJ_TRD&quot;</span><span class="p">,</span> <span class="s2">&quot;DD_TRD&quot;</span><span class="p">,</span> <span class="s2">&quot;DJ_IGH&quot;</span><span class="p">,</span> <span class="s2">&quot;VKDE_IGK&quot;</span><span class="p">,</span> <span class="s2">&quot;CINTRON_KDE_IGK&quot;</span><span class="p">]</span>
<a id="__codelineno-0-161" name="__codelineno-0-161"></a>
<a id="__codelineno-0-162" name="__codelineno-0-162"></a>    <span class="c1"># main cycle by samples</span>
<a id="__codelineno-0-163" name="__codelineno-0-163"></a>    <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">r</span> <span class="ow">in</span> <span class="n">sample_df</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>
<a id="__codelineno-0-164" name="__codelineno-0-164"></a>        <span class="n">sample_id</span> <span class="o">=</span> <span class="n">r</span><span class="p">[</span><span class="s2">&quot;sample_id&quot;</span><span class="p">]</span>
<a id="__codelineno-0-165" name="__codelineno-0-165"></a>        <span class="n">r1</span> <span class="o">=</span> <span class="n">r</span><span class="p">[</span><span class="s2">&quot;R1&quot;</span><span class="p">]</span>
<a id="__codelineno-0-166" name="__codelineno-0-166"></a>        <span class="n">r2</span> <span class="o">=</span> <span class="n">r</span><span class="p">[</span><span class="s2">&quot;R2&quot;</span><span class="p">]</span>
<a id="__codelineno-0-167" name="__codelineno-0-167"></a>        <span class="n">output_prefix</span> <span class="o">=</span> <span class="n">sample_id</span>
<a id="__codelineno-0-168" name="__codelineno-0-168"></a>
<a id="__codelineno-0-169" name="__codelineno-0-169"></a>        <span class="n">R1na</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">sample_id</span><span class="si">}</span><span class="s2">_R1_not_aligned.fastq.gz&quot;</span>
<a id="__codelineno-0-170" name="__codelineno-0-170"></a>        <span class="n">R2na</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">sample_id</span><span class="si">}</span><span class="s2">_R2_not_aligned.fastq.gz&quot;</span>
<a id="__codelineno-0-171" name="__codelineno-0-171"></a>
<a id="__codelineno-0-172" name="__codelineno-0-172"></a>        <span class="n">commands</span> <span class="o">=</span> <span class="p">[</span><span class="sa">f</span><span class="s2">&quot;cd </span><span class="si">{</span><span class="n">output_folder</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">]</span>
<a id="__codelineno-0-173" name="__codelineno-0-173"></a>
<a id="__codelineno-0-174" name="__codelineno-0-174"></a>        <span class="n">first_command</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">mixcr_path</span><span class="si">}</span><span class="s1"> -Xmx</span><span class="si">{</span><span class="n">memory</span><span class="si">}</span><span class="s1">g analyze milab-human-dna-xcr-7genes-multiplex -f --not-aligned-R1 </span><span class="si">{</span><span class="n">R1na</span><span class="si">}</span><span class="s1"> --not-aligned-R2 </span><span class="si">{</span><span class="n">R2na</span><span class="si">}</span><span class="s1"> </span><span class="si">{</span><span class="n">r1</span><span class="si">}</span><span class="s1"> </span><span class="si">{</span><span class="n">r2</span><span class="si">}</span><span class="s1"> </span><span class="si">{</span><span class="n">output_prefix</span><span class="si">}</span><span class="s1">&#39;</span>
<a id="__codelineno-0-175" name="__codelineno-0-175"></a>        <span class="n">commands</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">first_command</span><span class="p">)</span>
<a id="__codelineno-0-176" name="__codelineno-0-176"></a>
<a id="__codelineno-0-177" name="__codelineno-0-177"></a>        <span class="k">for</span> <span class="n">rearrangement</span> <span class="ow">in</span> <span class="n">list_of_incomplete_rearrangements</span><span class="p">:</span>
<a id="__codelineno-0-178" name="__codelineno-0-178"></a>
<a id="__codelineno-0-179" name="__codelineno-0-179"></a>            <span class="c1"># swap r and Rna so we would not implement copy of R_na</span>
<a id="__codelineno-0-180" name="__codelineno-0-180"></a>            <span class="n">r1</span><span class="p">,</span> <span class="n">R1na</span> <span class="o">=</span> <span class="n">R1na</span><span class="p">,</span> <span class="n">r1</span>
<a id="__codelineno-0-181" name="__codelineno-0-181"></a>            <span class="n">r2</span><span class="p">,</span> <span class="n">R2na</span> <span class="o">=</span> <span class="n">R2na</span><span class="p">,</span> <span class="n">r2</span>
<a id="__codelineno-0-182" name="__codelineno-0-182"></a>
<a id="__codelineno-0-183" name="__codelineno-0-183"></a>            <span class="n">output_prefix</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">rearrangement</span><span class="p">,</span> <span class="n">sample_id</span><span class="p">)</span>
<a id="__codelineno-0-184" name="__codelineno-0-184"></a>
<a id="__codelineno-0-185" name="__codelineno-0-185"></a>            <span class="n">R1na</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">output_prefix</span><span class="si">}</span><span class="s2">_R1_not_aligned.fastq.gz&quot;</span>
<a id="__codelineno-0-186" name="__codelineno-0-186"></a>            <span class="n">R2na</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">output_prefix</span><span class="si">}</span><span class="s2">_R2_not_aligned.fastq.gz&quot;</span>
<a id="__codelineno-0-187" name="__codelineno-0-187"></a>
<a id="__codelineno-0-188" name="__codelineno-0-188"></a>            <span class="n">i_r_command</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">mixcr_path</span><span class="si">}</span><span class="s1"> -Xmx</span><span class="si">{</span><span class="n">memory</span><span class="si">}</span><span class="s1">g analyze generic-amplicon -f --species hs --library </span><span class="si">{</span><span class="n">rearrangement</span><span class="si">}</span><span class="s1"> --assemble-clonotypes-by CDR3 --dna --floating-left-alignment-boundary --floating-right-alignment-boundary J -MexportClones.splitFilesBy=[] --not-aligned-R1 </span><span class="si">{</span><span class="n">R1na</span><span class="si">}</span><span class="s1"> --not-aligned-R2 </span><span class="si">{</span><span class="n">R2na</span><span class="si">}</span><span class="s1"> </span><span class="si">{</span><span class="n">r1</span><span class="si">}</span><span class="s1"> </span><span class="si">{</span><span class="n">r2</span><span class="si">}</span><span class="s1"> </span><span class="si">{</span><span class="n">output_prefix</span><span class="si">}</span><span class="s1">&#39;</span>
<a id="__codelineno-0-189" name="__codelineno-0-189"></a>            <span class="n">commands</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">i_r_command</span><span class="p">)</span>
<a id="__codelineno-0-190" name="__codelineno-0-190"></a>
<a id="__codelineno-0-191" name="__codelineno-0-191"></a>        <span class="n">jobname</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;mixcr_analyze_</span><span class="si">{</span><span class="n">sample_id</span><span class="si">}</span><span class="s2">&quot;</span>
<a id="__codelineno-0-192" name="__codelineno-0-192"></a>
<a id="__codelineno-0-193" name="__codelineno-0-193"></a>        <span class="c1"># for batch task finish tracking:</span>
<a id="__codelineno-0-194" name="__codelineno-0-194"></a>        <span class="n">commands</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;echo &quot;</span><span class="si">{</span><span class="n">jobname</span><span class="si">}</span><span class="s1"> finished&quot; &gt;&gt; </span><span class="si">{</span><span class="n">slurm_batch_filename</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
<a id="__codelineno-0-195" name="__codelineno-0-195"></a>
<a id="__codelineno-0-196" name="__codelineno-0-196"></a>        <span class="c1"># join commands by &amp;&amp; so that next command runs if previous was finished without error and add new lines to the script</span>
<a id="__codelineno-0-197" name="__codelineno-0-197"></a>        <span class="n">command</span> <span class="o">=</span> <span class="s2">&quot; &amp;&amp; </span><span class="se">\\</span><span class="s2"> </span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">commands</span><span class="p">)</span>
<a id="__codelineno-0-198" name="__codelineno-0-198"></a>
<a id="__codelineno-0-199" name="__codelineno-0-199"></a>        <span class="c1"># create slurm script and add job to queue, print stdout of sbatch</span>
<a id="__codelineno-0-200" name="__codelineno-0-200"></a>        <span class="n">stdout</span><span class="p">,</span> <span class="n">stderr</span> <span class="o">=</span> <span class="n">run_slurm_command_from_jupyter</span><span class="p">(</span><span class="n">command</span><span class="p">,</span> <span class="n">jobname</span><span class="p">,</span> <span class="n">cpus</span><span class="p">,</span> <span class="n">time_estimate</span><span class="p">,</span> <span class="n">memory</span><span class="p">)</span>
<a id="__codelineno-0-201" name="__codelineno-0-201"></a>        <span class="nb">print</span><span class="p">(</span><span class="n">stdout</span><span class="p">,</span> <span class="n">stderr</span><span class="p">)</span>
<a id="__codelineno-0-202" name="__codelineno-0-202"></a>        <span class="c1"># print(command)</span>
<a id="__codelineno-0-203" name="__codelineno-0-203"></a>    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">samples_num</span><span class="si">}</span><span class="s2"> tasks added to slurm queue</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-0-204" name="__codelineno-0-204"></a>    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;To see running progress bar run this function in the next jupyter cell:</span><span class="se">\n</span><span class="s1">slurm.check_slurm_progress(&quot;</span><span class="si">{</span><span class="n">slurm_batch_filename</span><span class="si">}</span><span class="s1">&quot;, loop=True)&#39;</span><span class="p">)</span>
<a id="__codelineno-0-205" name="__codelineno-0-205"></a>    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;To see current progress:</span><span class="se">\n</span><span class="s1">slurm.check_slurm_progress(&quot;</span><span class="si">{</span><span class="n">slurm_batch_filename</span><span class="si">}</span><span class="s1">&quot;)&#39;</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h4 id="mixcr.show_report_images" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">show_report_images</span><span class="p">(</span><span class="n">folder</span><span class="p">)</span></code>

</h4>


    <div class="doc doc-contents ">

        <p>This function displays QC images <code>alignQc.svg</code> and <code>chainsQc.svg</code> in Jupyter Notebook.
This pictures may be generated by <code>mixcr4_reports</code> function.
In case there are no <code>.svg</code> images, the <code>.png</code> images are shown.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>folder</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>folder in which to look for QC images.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>None</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>repseq/mixcr.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-372">372</a></span>
<span class="normal"><a href="#__codelineno-0-373">373</a></span>
<span class="normal"><a href="#__codelineno-0-374">374</a></span>
<span class="normal"><a href="#__codelineno-0-375">375</a></span>
<span class="normal"><a href="#__codelineno-0-376">376</a></span>
<span class="normal"><a href="#__codelineno-0-377">377</a></span>
<span class="normal"><a href="#__codelineno-0-378">378</a></span>
<span class="normal"><a href="#__codelineno-0-379">379</a></span>
<span class="normal"><a href="#__codelineno-0-380">380</a></span>
<span class="normal"><a href="#__codelineno-0-381">381</a></span>
<span class="normal"><a href="#__codelineno-0-382">382</a></span>
<span class="normal"><a href="#__codelineno-0-383">383</a></span>
<span class="normal"><a href="#__codelineno-0-384">384</a></span>
<span class="normal"><a href="#__codelineno-0-385">385</a></span>
<span class="normal"><a href="#__codelineno-0-386">386</a></span>
<span class="normal"><a href="#__codelineno-0-387">387</a></span>
<span class="normal"><a href="#__codelineno-0-388">388</a></span>
<span class="normal"><a href="#__codelineno-0-389">389</a></span>
<span class="normal"><a href="#__codelineno-0-390">390</a></span>
<span class="normal"><a href="#__codelineno-0-391">391</a></span>
<span class="normal"><a href="#__codelineno-0-392">392</a></span>
<span class="normal"><a href="#__codelineno-0-393">393</a></span>
<span class="normal"><a href="#__codelineno-0-394">394</a></span>
<span class="normal"><a href="#__codelineno-0-395">395</a></span>
<span class="normal"><a href="#__codelineno-0-396">396</a></span>
<span class="normal"><a href="#__codelineno-0-397">397</a></span>
<span class="normal"><a href="#__codelineno-0-398">398</a></span>
<span class="normal"><a href="#__codelineno-0-399">399</a></span>
<span class="normal"><a href="#__codelineno-0-400">400</a></span>
<span class="normal"><a href="#__codelineno-0-401">401</a></span>
<span class="normal"><a href="#__codelineno-0-402">402</a></span>
<span class="normal"><a href="#__codelineno-0-403">403</a></span>
<span class="normal"><a href="#__codelineno-0-404">404</a></span>
<span class="normal"><a href="#__codelineno-0-405">405</a></span>
<span class="normal"><a href="#__codelineno-0-406">406</a></span>
<span class="normal"><a href="#__codelineno-0-407">407</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-372" name="__codelineno-0-372"></a><span class="k">def</span><span class="w"> </span><span class="nf">show_report_images</span><span class="p">(</span><span class="n">folder</span><span class="p">):</span>
<a id="__codelineno-0-373" name="__codelineno-0-373"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-374" name="__codelineno-0-374"></a><span class="sd">    This function displays QC images `alignQc.svg` and `chainsQc.svg` in Jupyter Notebook.</span>
<a id="__codelineno-0-375" name="__codelineno-0-375"></a><span class="sd">    This pictures may be generated by `mixcr4_reports` function.</span>
<a id="__codelineno-0-376" name="__codelineno-0-376"></a><span class="sd">    In case there are no `.svg` images, the `.png` images are shown.</span>
<a id="__codelineno-0-377" name="__codelineno-0-377"></a>
<a id="__codelineno-0-378" name="__codelineno-0-378"></a><span class="sd">    Args:</span>
<a id="__codelineno-0-379" name="__codelineno-0-379"></a><span class="sd">        folder (str): folder in which to look for QC images.</span>
<a id="__codelineno-0-380" name="__codelineno-0-380"></a>
<a id="__codelineno-0-381" name="__codelineno-0-381"></a><span class="sd">    Returns:</span>
<a id="__codelineno-0-382" name="__codelineno-0-382"></a><span class="sd">        None</span>
<a id="__codelineno-0-383" name="__codelineno-0-383"></a>
<a id="__codelineno-0-384" name="__codelineno-0-384"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-385" name="__codelineno-0-385"></a>
<a id="__codelineno-0-386" name="__codelineno-0-386"></a>    <span class="n">svg_align_filename</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">folder</span><span class="p">,</span> <span class="s2">&quot;alignQc.svg&quot;</span><span class="p">)</span>
<a id="__codelineno-0-387" name="__codelineno-0-387"></a>    <span class="n">svg_chain_filename</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">folder</span><span class="p">,</span> <span class="s2">&quot;chainsQc.svg&quot;</span><span class="p">)</span>
<a id="__codelineno-0-388" name="__codelineno-0-388"></a>    <span class="n">png_align_filename</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">folder</span><span class="p">,</span> <span class="s2">&quot;alignQc.png&quot;</span><span class="p">)</span>
<a id="__codelineno-0-389" name="__codelineno-0-389"></a>    <span class="n">png_chain_filename</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">folder</span><span class="p">,</span> <span class="s2">&quot;chainsQc.png&quot;</span><span class="p">)</span>
<a id="__codelineno-0-390" name="__codelineno-0-390"></a>
<a id="__codelineno-0-391" name="__codelineno-0-391"></a>    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">svg_align_filename</span><span class="p">):</span>
<a id="__codelineno-0-392" name="__codelineno-0-392"></a>        <span class="nb">print</span><span class="p">(</span><span class="n">svg_align_filename</span><span class="p">)</span>
<a id="__codelineno-0-393" name="__codelineno-0-393"></a>        <span class="n">display</span><span class="p">(</span><span class="n">SVG</span><span class="p">(</span><span class="n">filename</span><span class="o">=</span><span class="n">svg_align_filename</span><span class="p">))</span>
<a id="__codelineno-0-394" name="__codelineno-0-394"></a>    <span class="k">elif</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">png_align_filename</span><span class="p">):</span>
<a id="__codelineno-0-395" name="__codelineno-0-395"></a>        <span class="nb">print</span><span class="p">(</span><span class="n">png_align_filename</span><span class="p">)</span>
<a id="__codelineno-0-396" name="__codelineno-0-396"></a>        <span class="n">display</span><span class="p">(</span><span class="n">Image</span><span class="p">(</span><span class="n">filename</span><span class="o">=</span><span class="n">png_align_filename</span><span class="p">))</span>
<a id="__codelineno-0-397" name="__codelineno-0-397"></a>    <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-398" name="__codelineno-0-398"></a>        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;No alignQc image found (svg or png)&quot;</span><span class="p">)</span>
<a id="__codelineno-0-399" name="__codelineno-0-399"></a>
<a id="__codelineno-0-400" name="__codelineno-0-400"></a>    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">svg_chain_filename</span><span class="p">):</span>
<a id="__codelineno-0-401" name="__codelineno-0-401"></a>        <span class="nb">print</span><span class="p">(</span><span class="n">svg_chain_filename</span><span class="p">)</span>
<a id="__codelineno-0-402" name="__codelineno-0-402"></a>        <span class="n">display</span><span class="p">(</span><span class="n">SVG</span><span class="p">(</span><span class="n">filename</span><span class="o">=</span><span class="n">svg_chain_filename</span><span class="p">))</span>
<a id="__codelineno-0-403" name="__codelineno-0-403"></a>    <span class="k">elif</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">png_chain_filename</span><span class="p">):</span>
<a id="__codelineno-0-404" name="__codelineno-0-404"></a>        <span class="nb">print</span><span class="p">(</span><span class="n">png_chain_filename</span><span class="p">)</span>
<a id="__codelineno-0-405" name="__codelineno-0-405"></a>        <span class="n">display</span><span class="p">(</span><span class="n">Image</span><span class="p">(</span><span class="n">filename</span><span class="o">=</span><span class="n">png_chain_filename</span><span class="p">))</span>
<a id="__codelineno-0-406" name="__codelineno-0-406"></a>    <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-407" name="__codelineno-0-407"></a>        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;No chainQc image found (svg or png)&quot;</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h4 id="mixcr.show_report_images_new" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">show_report_images_new</span><span class="p">(</span><span class="n">folder</span><span class="p">,</span> <span class="n">chart_type</span><span class="o">=</span><span class="s1">&#39;summary&#39;</span><span class="p">,</span> <span class="n">count_type</span><span class="o">=</span><span class="s1">&#39;percent&#39;</span><span class="p">,</span> <span class="n">output_file</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>

</h4>


    <div class="doc doc-contents ">

        <p>Shows quality control reports in MiXCR-like style</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>folder</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>folder in which to look for QC images.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>chart_type</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Possible values are <code>summary</code> (corresponds to <code>mixcr exportQc align</code>, 
<code>chains</code> (<code>mixcr exportQc chainUsage</code>)</p>
              </div>
            </td>
            <td>
                  <code>&#39;summary&#39;</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>count_type</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>possible values are: <code>percent</code>, <code>abs</code></p>
              </div>
            </td>
            <td>
                  <code>&#39;percent&#39;</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>output_file</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>filename ending with '.png' to save an output plot to</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>None</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>repseq/mixcr.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-410">410</a></span>
<span class="normal"><a href="#__codelineno-0-411">411</a></span>
<span class="normal"><a href="#__codelineno-0-412">412</a></span>
<span class="normal"><a href="#__codelineno-0-413">413</a></span>
<span class="normal"><a href="#__codelineno-0-414">414</a></span>
<span class="normal"><a href="#__codelineno-0-415">415</a></span>
<span class="normal"><a href="#__codelineno-0-416">416</a></span>
<span class="normal"><a href="#__codelineno-0-417">417</a></span>
<span class="normal"><a href="#__codelineno-0-418">418</a></span>
<span class="normal"><a href="#__codelineno-0-419">419</a></span>
<span class="normal"><a href="#__codelineno-0-420">420</a></span>
<span class="normal"><a href="#__codelineno-0-421">421</a></span>
<span class="normal"><a href="#__codelineno-0-422">422</a></span>
<span class="normal"><a href="#__codelineno-0-423">423</a></span>
<span class="normal"><a href="#__codelineno-0-424">424</a></span>
<span class="normal"><a href="#__codelineno-0-425">425</a></span>
<span class="normal"><a href="#__codelineno-0-426">426</a></span>
<span class="normal"><a href="#__codelineno-0-427">427</a></span>
<span class="normal"><a href="#__codelineno-0-428">428</a></span>
<span class="normal"><a href="#__codelineno-0-429">429</a></span>
<span class="normal"><a href="#__codelineno-0-430">430</a></span>
<span class="normal"><a href="#__codelineno-0-431">431</a></span>
<span class="normal"><a href="#__codelineno-0-432">432</a></span>
<span class="normal"><a href="#__codelineno-0-433">433</a></span>
<span class="normal"><a href="#__codelineno-0-434">434</a></span>
<span class="normal"><a href="#__codelineno-0-435">435</a></span>
<span class="normal"><a href="#__codelineno-0-436">436</a></span>
<span class="normal"><a href="#__codelineno-0-437">437</a></span>
<span class="normal"><a href="#__codelineno-0-438">438</a></span>
<span class="normal"><a href="#__codelineno-0-439">439</a></span>
<span class="normal"><a href="#__codelineno-0-440">440</a></span>
<span class="normal"><a href="#__codelineno-0-441">441</a></span>
<span class="normal"><a href="#__codelineno-0-442">442</a></span>
<span class="normal"><a href="#__codelineno-0-443">443</a></span>
<span class="normal"><a href="#__codelineno-0-444">444</a></span>
<span class="normal"><a href="#__codelineno-0-445">445</a></span>
<span class="normal"><a href="#__codelineno-0-446">446</a></span>
<span class="normal"><a href="#__codelineno-0-447">447</a></span>
<span class="normal"><a href="#__codelineno-0-448">448</a></span>
<span class="normal"><a href="#__codelineno-0-449">449</a></span>
<span class="normal"><a href="#__codelineno-0-450">450</a></span>
<span class="normal"><a href="#__codelineno-0-451">451</a></span>
<span class="normal"><a href="#__codelineno-0-452">452</a></span>
<span class="normal"><a href="#__codelineno-0-453">453</a></span>
<span class="normal"><a href="#__codelineno-0-454">454</a></span>
<span class="normal"><a href="#__codelineno-0-455">455</a></span>
<span class="normal"><a href="#__codelineno-0-456">456</a></span>
<span class="normal"><a href="#__codelineno-0-457">457</a></span>
<span class="normal"><a href="#__codelineno-0-458">458</a></span>
<span class="normal"><a href="#__codelineno-0-459">459</a></span>
<span class="normal"><a href="#__codelineno-0-460">460</a></span>
<span class="normal"><a href="#__codelineno-0-461">461</a></span>
<span class="normal"><a href="#__codelineno-0-462">462</a></span>
<span class="normal"><a href="#__codelineno-0-463">463</a></span>
<span class="normal"><a href="#__codelineno-0-464">464</a></span>
<span class="normal"><a href="#__codelineno-0-465">465</a></span>
<span class="normal"><a href="#__codelineno-0-466">466</a></span>
<span class="normal"><a href="#__codelineno-0-467">467</a></span>
<span class="normal"><a href="#__codelineno-0-468">468</a></span>
<span class="normal"><a href="#__codelineno-0-469">469</a></span>
<span class="normal"><a href="#__codelineno-0-470">470</a></span>
<span class="normal"><a href="#__codelineno-0-471">471</a></span>
<span class="normal"><a href="#__codelineno-0-472">472</a></span>
<span class="normal"><a href="#__codelineno-0-473">473</a></span>
<span class="normal"><a href="#__codelineno-0-474">474</a></span>
<span class="normal"><a href="#__codelineno-0-475">475</a></span>
<span class="normal"><a href="#__codelineno-0-476">476</a></span>
<span class="normal"><a href="#__codelineno-0-477">477</a></span>
<span class="normal"><a href="#__codelineno-0-478">478</a></span>
<span class="normal"><a href="#__codelineno-0-479">479</a></span>
<span class="normal"><a href="#__codelineno-0-480">480</a></span>
<span class="normal"><a href="#__codelineno-0-481">481</a></span>
<span class="normal"><a href="#__codelineno-0-482">482</a></span>
<span class="normal"><a href="#__codelineno-0-483">483</a></span>
<span class="normal"><a href="#__codelineno-0-484">484</a></span>
<span class="normal"><a href="#__codelineno-0-485">485</a></span>
<span class="normal"><a href="#__codelineno-0-486">486</a></span>
<span class="normal"><a href="#__codelineno-0-487">487</a></span>
<span class="normal"><a href="#__codelineno-0-488">488</a></span>
<span class="normal"><a href="#__codelineno-0-489">489</a></span>
<span class="normal"><a href="#__codelineno-0-490">490</a></span>
<span class="normal"><a href="#__codelineno-0-491">491</a></span>
<span class="normal"><a href="#__codelineno-0-492">492</a></span>
<span class="normal"><a href="#__codelineno-0-493">493</a></span>
<span class="normal"><a href="#__codelineno-0-494">494</a></span>
<span class="normal"><a href="#__codelineno-0-495">495</a></span>
<span class="normal"><a href="#__codelineno-0-496">496</a></span>
<span class="normal"><a href="#__codelineno-0-497">497</a></span>
<span class="normal"><a href="#__codelineno-0-498">498</a></span>
<span class="normal"><a href="#__codelineno-0-499">499</a></span>
<span class="normal"><a href="#__codelineno-0-500">500</a></span>
<span class="normal"><a href="#__codelineno-0-501">501</a></span>
<span class="normal"><a href="#__codelineno-0-502">502</a></span>
<span class="normal"><a href="#__codelineno-0-503">503</a></span>
<span class="normal"><a href="#__codelineno-0-504">504</a></span>
<span class="normal"><a href="#__codelineno-0-505">505</a></span>
<span class="normal"><a href="#__codelineno-0-506">506</a></span>
<span class="normal"><a href="#__codelineno-0-507">507</a></span>
<span class="normal"><a href="#__codelineno-0-508">508</a></span>
<span class="normal"><a href="#__codelineno-0-509">509</a></span>
<span class="normal"><a href="#__codelineno-0-510">510</a></span>
<span class="normal"><a href="#__codelineno-0-511">511</a></span>
<span class="normal"><a href="#__codelineno-0-512">512</a></span>
<span class="normal"><a href="#__codelineno-0-513">513</a></span>
<span class="normal"><a href="#__codelineno-0-514">514</a></span>
<span class="normal"><a href="#__codelineno-0-515">515</a></span>
<span class="normal"><a href="#__codelineno-0-516">516</a></span>
<span class="normal"><a href="#__codelineno-0-517">517</a></span>
<span class="normal"><a href="#__codelineno-0-518">518</a></span>
<span class="normal"><a href="#__codelineno-0-519">519</a></span>
<span class="normal"><a href="#__codelineno-0-520">520</a></span>
<span class="normal"><a href="#__codelineno-0-521">521</a></span>
<span class="normal"><a href="#__codelineno-0-522">522</a></span>
<span class="normal"><a href="#__codelineno-0-523">523</a></span>
<span class="normal"><a href="#__codelineno-0-524">524</a></span>
<span class="normal"><a href="#__codelineno-0-525">525</a></span>
<span class="normal"><a href="#__codelineno-0-526">526</a></span>
<span class="normal"><a href="#__codelineno-0-527">527</a></span>
<span class="normal"><a href="#__codelineno-0-528">528</a></span>
<span class="normal"><a href="#__codelineno-0-529">529</a></span>
<span class="normal"><a href="#__codelineno-0-530">530</a></span>
<span class="normal"><a href="#__codelineno-0-531">531</a></span>
<span class="normal"><a href="#__codelineno-0-532">532</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-410" name="__codelineno-0-410"></a><span class="k">def</span><span class="w"> </span><span class="nf">show_report_images_new</span><span class="p">(</span><span class="n">folder</span><span class="p">,</span> <span class="n">chart_type</span><span class="o">=</span><span class="s1">&#39;summary&#39;</span><span class="p">,</span> <span class="n">count_type</span><span class="o">=</span><span class="s1">&#39;percent&#39;</span><span class="p">,</span> <span class="n">output_file</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<a id="__codelineno-0-411" name="__codelineno-0-411"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-412" name="__codelineno-0-412"></a><span class="sd">    Shows quality control reports in MiXCR-like style</span>
<a id="__codelineno-0-413" name="__codelineno-0-413"></a>
<a id="__codelineno-0-414" name="__codelineno-0-414"></a><span class="sd">    Args:</span>
<a id="__codelineno-0-415" name="__codelineno-0-415"></a><span class="sd">        folder (str): folder in which to look for QC images.</span>
<a id="__codelineno-0-416" name="__codelineno-0-416"></a><span class="sd">        chart_type (str): Possible values are `summary` (corresponds to `mixcr exportQc align`, </span>
<a id="__codelineno-0-417" name="__codelineno-0-417"></a><span class="sd">            `chains` (`mixcr exportQc chainUsage`)</span>
<a id="__codelineno-0-418" name="__codelineno-0-418"></a><span class="sd">        count_type (str): possible values are: `percent`, `abs`</span>
<a id="__codelineno-0-419" name="__codelineno-0-419"></a><span class="sd">        output_file (str): filename ending with &#39;.png&#39; to save an output plot to</span>
<a id="__codelineno-0-420" name="__codelineno-0-420"></a>
<a id="__codelineno-0-421" name="__codelineno-0-421"></a><span class="sd">    Returns:</span>
<a id="__codelineno-0-422" name="__codelineno-0-422"></a><span class="sd">        None</span>
<a id="__codelineno-0-423" name="__codelineno-0-423"></a>
<a id="__codelineno-0-424" name="__codelineno-0-424"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-425" name="__codelineno-0-425"></a>    <span class="n">CHAIN_VARIANTS</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;IGH&#39;</span><span class="p">,</span> <span class="s1">&#39;IGK&#39;</span><span class="p">,</span> <span class="s1">&#39;IGL&#39;</span><span class="p">,</span> <span class="s1">&#39;TRA&#39;</span><span class="p">,</span> <span class="s1">&#39;TRB&#39;</span><span class="p">,</span> <span class="s1">&#39;TRD&#39;</span><span class="p">,</span> <span class="s1">&#39;TRL&#39;</span><span class="p">]</span>
<a id="__codelineno-0-426" name="__codelineno-0-426"></a>    <span class="n">files</span> <span class="o">=</span> <span class="p">[]</span>
<a id="__codelineno-0-427" name="__codelineno-0-427"></a>    <span class="k">try</span><span class="p">:</span>
<a id="__codelineno-0-428" name="__codelineno-0-428"></a>        <span class="n">all_files</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">folder</span><span class="p">)</span>
<a id="__codelineno-0-429" name="__codelineno-0-429"></a>        <span class="n">files</span> <span class="o">=</span> <span class="p">[]</span>
<a id="__codelineno-0-430" name="__codelineno-0-430"></a>        <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">all_files</span><span class="p">:</span>
<a id="__codelineno-0-431" name="__codelineno-0-431"></a>            <span class="n">match</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;(.+)\.([a-zA-Z0-9_]+)\.report\.json&quot;</span><span class="p">,</span> <span class="n">f</span><span class="p">)</span>
<a id="__codelineno-0-432" name="__codelineno-0-432"></a>            <span class="k">if</span> <span class="n">match</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-433" name="__codelineno-0-433"></a>                <span class="n">sample_id</span> <span class="o">=</span> <span class="n">match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<a id="__codelineno-0-434" name="__codelineno-0-434"></a>                <span class="n">report_type</span> <span class="o">=</span> <span class="n">match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
<a id="__codelineno-0-435" name="__codelineno-0-435"></a>                <span class="n">files</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">sample_id</span><span class="p">,</span> <span class="n">report_type</span><span class="p">])</span>
<a id="__codelineno-0-436" name="__codelineno-0-436"></a>            <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-437" name="__codelineno-0-437"></a>                <span class="k">continue</span>
<a id="__codelineno-0-438" name="__codelineno-0-438"></a>    <span class="k">except</span> <span class="ne">FileNotFoundError</span><span class="p">:</span>
<a id="__codelineno-0-439" name="__codelineno-0-439"></a>        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;No such file or directory&#39;</span><span class="p">)</span>
<a id="__codelineno-0-440" name="__codelineno-0-440"></a>    <span class="n">df_list</span> <span class="o">=</span> <span class="p">[]</span>
<a id="__codelineno-0-441" name="__codelineno-0-441"></a>    <span class="k">for</span> <span class="n">file</span> <span class="ow">in</span> <span class="n">files</span><span class="p">:</span>
<a id="__codelineno-0-442" name="__codelineno-0-442"></a>        <span class="n">report_type</span> <span class="o">=</span> <span class="n">file</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
<a id="__codelineno-0-443" name="__codelineno-0-443"></a>        <span class="k">if</span> <span class="n">report_type</span> <span class="o">==</span> <span class="s1">&#39;align&#39;</span><span class="p">:</span>
<a id="__codelineno-0-444" name="__codelineno-0-444"></a>            <span class="n">json_report_contents</span> <span class="o">=</span> <span class="n">read_json_report</span><span class="p">(</span><span class="n">file</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">folder</span><span class="p">,</span> <span class="n">report_type</span><span class="o">=</span><span class="n">report_type</span><span class="p">)</span>
<a id="__codelineno-0-445" name="__codelineno-0-445"></a>            <span class="n">align_data</span> <span class="o">=</span> <span class="n">json_report_contents</span><span class="p">[</span><span class="s1">&#39;notAlignedReasons&#39;</span><span class="p">]</span>
<a id="__codelineno-0-446" name="__codelineno-0-446"></a>            <span class="n">chain_usage_data</span> <span class="o">=</span> <span class="n">json_report_contents</span><span class="p">[</span><span class="s1">&#39;chainUsage&#39;</span><span class="p">][</span><span class="s1">&#39;chains&#39;</span><span class="p">]</span>
<a id="__codelineno-0-447" name="__codelineno-0-447"></a>
<a id="__codelineno-0-448" name="__codelineno-0-448"></a>            <span class="k">if</span> <span class="n">chart_type</span> <span class="o">==</span> <span class="s1">&#39;summary&#39;</span><span class="p">:</span>
<a id="__codelineno-0-449" name="__codelineno-0-449"></a>                <span class="n">renaming_dict</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;NoHits&#39;</span><span class="p">:</span> <span class="s1">&#39;No hits (not TCR/IG?)&#39;</span><span class="p">,</span>
<a id="__codelineno-0-450" name="__codelineno-0-450"></a>                                <span class="s1">&#39;NoCDR3Parts&#39;</span><span class="p">:</span> <span class="s1">&#39;No CDR3 parts&#39;</span><span class="p">,</span>
<a id="__codelineno-0-451" name="__codelineno-0-451"></a>                                <span class="s1">&#39;NoVHits&#39;</span><span class="p">:</span> <span class="s1">&#39;No V hits&#39;</span><span class="p">,</span>
<a id="__codelineno-0-452" name="__codelineno-0-452"></a>                                <span class="s1">&#39;NoJHits&#39;</span><span class="p">:</span> <span class="s1">&#39;No J hits&#39;</span><span class="p">,</span>
<a id="__codelineno-0-453" name="__codelineno-0-453"></a>                                <span class="s1">&#39;VAndJOnDifferentTargets&#39;</span><span class="p">:</span> <span class="s1">&#39;No target with both V and J&#39;</span><span class="p">,</span>
<a id="__codelineno-0-454" name="__codelineno-0-454"></a>                                <span class="s1">&#39;LowTotalScore&#39;</span><span class="p">:</span> <span class="s1">&#39;Low total score&#39;</span><span class="p">,</span>
<a id="__codelineno-0-455" name="__codelineno-0-455"></a>                                <span class="s1">&#39;NoBarcode&#39;</span><span class="p">:</span> <span class="s1">&#39;Absent barcode&#39;</span><span class="p">,</span>
<a id="__codelineno-0-456" name="__codelineno-0-456"></a>                                <span class="s1">&#39;SampleNotMatched&#39;</span><span class="p">:</span> <span class="s1">&#39;Sample not matched&#39;</span><span class="p">,</span>
<a id="__codelineno-0-457" name="__codelineno-0-457"></a>                                <span class="p">}</span>
<a id="__codelineno-0-458" name="__codelineno-0-458"></a>                <span class="n">align_df</span> <span class="o">=</span> <span class="p">{}</span>
<a id="__codelineno-0-459" name="__codelineno-0-459"></a>                <span class="k">for</span> <span class="n">old</span><span class="p">,</span> <span class="n">new</span> <span class="ow">in</span> <span class="n">renaming_dict</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
<a id="__codelineno-0-460" name="__codelineno-0-460"></a>                    <span class="n">align_df</span><span class="p">[</span><span class="n">new</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">align_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">old</span><span class="p">,</span> <span class="mi">0</span><span class="p">)]</span>
<a id="__codelineno-0-461" name="__codelineno-0-461"></a>                <span class="n">align_df</span><span class="p">[</span><span class="s1">&#39;Successfully aligned&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">json_report_contents</span><span class="p">[</span><span class="s1">&#39;aligned&#39;</span><span class="p">]</span>
<a id="__codelineno-0-462" name="__codelineno-0-462"></a>                <span class="n">df_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">align_df</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="p">[</span><span class="n">file</span><span class="p">[</span><span class="mi">0</span><span class="p">]]))</span> 
<a id="__codelineno-0-463" name="__codelineno-0-463"></a>
<a id="__codelineno-0-464" name="__codelineno-0-464"></a>            <span class="k">elif</span> <span class="n">chart_type</span> <span class="o">==</span> <span class="s1">&#39;chains&#39;</span><span class="p">:</span>
<a id="__codelineno-0-465" name="__codelineno-0-465"></a>                <span class="n">align_df</span> <span class="o">=</span> <span class="p">{}</span>
<a id="__codelineno-0-466" name="__codelineno-0-466"></a>                <span class="k">for</span> <span class="n">chain</span><span class="p">,</span> <span class="n">data</span> <span class="ow">in</span> <span class="n">chain_usage_data</span><span class="o">.</span><span class="n">items</span><span class="p">():</span> 
<a id="__codelineno-0-467" name="__codelineno-0-467"></a>                    <span class="n">align_df</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="n">chain</span><span class="p">:</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;total&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;nonFunctional&#39;</span><span class="p">],</span>
<a id="__codelineno-0-468" name="__codelineno-0-468"></a>                                <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">chain</span><span class="si">}</span><span class="s1"> (stops)&#39;</span><span class="p">:</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;hasStops&#39;</span><span class="p">],</span>
<a id="__codelineno-0-469" name="__codelineno-0-469"></a>                                <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">chain</span><span class="si">}</span><span class="s1"> (OOF)&#39;</span><span class="p">:</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;isOOF&#39;</span><span class="p">]})</span>
<a id="__codelineno-0-470" name="__codelineno-0-470"></a>                <span class="n">df_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">align_df</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="p">[</span><span class="n">file</span><span class="p">[</span><span class="mi">0</span><span class="p">]]))</span>
<a id="__codelineno-0-471" name="__codelineno-0-471"></a>    <span class="n">results</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">df_list</span><span class="p">)</span>
<a id="__codelineno-0-472" name="__codelineno-0-472"></a>    <span class="n">results</span> <span class="o">=</span> <span class="n">results</span><span class="o">.</span><span class="n">sort_index</span><span class="p">(</span><span class="n">ascending</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<a id="__codelineno-0-473" name="__codelineno-0-473"></a>    <span class="k">if</span> <span class="n">count_type</span> <span class="o">==</span> <span class="s1">&#39;percent&#39;</span><span class="p">:</span>
<a id="__codelineno-0-474" name="__codelineno-0-474"></a>        <span class="n">results</span> <span class="o">=</span>  <span class="n">results</span><span class="o">.</span><span class="n">div</span><span class="p">(</span><span class="n">results</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span> <span class="o">*</span> <span class="mi">100</span>
<a id="__codelineno-0-475" name="__codelineno-0-475"></a>    <span class="k">if</span> <span class="n">chart_type</span> <span class="o">==</span> <span class="s1">&#39;summary&#39;</span><span class="p">:</span>
<a id="__codelineno-0-476" name="__codelineno-0-476"></a>        <span class="n">order</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;Successfully aligned&#39;</span><span class="p">,</span> 
<a id="__codelineno-0-477" name="__codelineno-0-477"></a>                 <span class="s1">&#39;No hits (not TCR/IG?)&#39;</span><span class="p">,</span> 
<a id="__codelineno-0-478" name="__codelineno-0-478"></a>                 <span class="s1">&#39;No CDR3 parts&#39;</span><span class="p">,</span> 
<a id="__codelineno-0-479" name="__codelineno-0-479"></a>                 <span class="s1">&#39;No V hits&#39;</span><span class="p">,</span> 
<a id="__codelineno-0-480" name="__codelineno-0-480"></a>                 <span class="s1">&#39;No J hits&#39;</span><span class="p">,</span> 
<a id="__codelineno-0-481" name="__codelineno-0-481"></a>                 <span class="s1">&#39;No target with both V and J&#39;</span><span class="p">,</span> 
<a id="__codelineno-0-482" name="__codelineno-0-482"></a>                 <span class="s1">&#39;Low total score&#39;</span><span class="p">,</span> 
<a id="__codelineno-0-483" name="__codelineno-0-483"></a>                 <span class="s1">&#39;Absent barcode&#39;</span><span class="p">]</span> 
<a id="__codelineno-0-484" name="__codelineno-0-484"></a>        <span class="n">colors</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;#3ecd8d&#39;</span><span class="p">,</span> <span class="s1">&#39;#fed470&#39;</span><span class="p">,</span> <span class="s1">&#39;#fda163&#39;</span><span class="p">,</span> <span class="s1">&#39;#f36c5a&#39;</span><span class="p">,</span> <span class="s1">&#39;#d64470&#39;</span><span class="p">,</span> <span class="s1">&#39;#a03080&#39;</span><span class="p">,</span> <span class="s1">&#39;#702084&#39;</span><span class="p">,</span> <span class="s1">&#39;#451777&#39;</span><span class="p">]</span>
<a id="__codelineno-0-485" name="__codelineno-0-485"></a>        <span class="n">colormap</span> <span class="o">=</span> <span class="n">ListedColormap</span><span class="p">(</span><span class="n">colors</span><span class="o">=</span><span class="n">colors</span><span class="p">,</span>
<a id="__codelineno-0-486" name="__codelineno-0-486"></a>                                    <span class="n">name</span><span class="o">=</span><span class="s1">&#39;mixcr&#39;</span><span class="p">)</span>
<a id="__codelineno-0-487" name="__codelineno-0-487"></a>    <span class="k">elif</span> <span class="n">chart_type</span> <span class="o">==</span> <span class="s1">&#39;chains&#39;</span><span class="p">:</span>
<a id="__codelineno-0-488" name="__codelineno-0-488"></a>        <span class="n">order</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">results</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span>
<a id="__codelineno-0-489" name="__codelineno-0-489"></a>        <span class="n">colors</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;#c26a27&#39;</span><span class="p">,</span> <span class="s1">&#39;#ff9429&#39;</span><span class="p">,</span> <span class="s1">&#39;#ffcb8f&#39;</span><span class="p">,</span> <span class="s1">&#39;#a324b2&#39;</span><span class="p">,</span> <span class="s1">&#39;#e553e5&#39;</span><span class="p">,</span> <span class="s1">&#39;#faaafa&#39;</span><span class="p">,</span> <span class="s1">&#39;#ad3757&#39;</span><span class="p">,</span> <span class="s1">&#39;#f05670&#39;</span><span class="p">,</span> <span class="s1">&#39;#ffadba&#39;</span><span class="p">,</span> 
<a id="__codelineno-0-490" name="__codelineno-0-490"></a>                                  <span class="s1">&#39;#105bcc&#39;</span><span class="p">,</span> <span class="s1">&#39;#2d93fa&#39;</span><span class="p">,</span> <span class="s1">&#39;#99ccff&#39;</span><span class="p">,</span> <span class="s1">&#39;#198020&#39;</span><span class="p">,</span> <span class="s1">&#39;#42b842&#39;</span><span class="p">,</span> <span class="s1">&#39;#99e099&#39;</span><span class="p">,</span> <span class="s1">&#39;#068a94&#39;</span><span class="p">,</span> <span class="s1">&#39;#27c2c2&#39;</span><span class="p">,</span> <span class="s1">&#39;#90e0e0&#39;</span><span class="p">,</span> 
<a id="__codelineno-0-491" name="__codelineno-0-491"></a>                                <span class="s1">&#39;#5f31cc&#39;</span><span class="p">,</span> <span class="s1">&#39;#845cff&#39;</span><span class="p">,</span> <span class="s1">&#39;#c1adff&#39;</span><span class="p">]</span>
<a id="__codelineno-0-492" name="__codelineno-0-492"></a>        <span class="n">all_variants</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;IGH&#39;</span><span class="p">,</span> <span class="s1">&#39;IGH (stops)&#39;</span><span class="p">,</span> <span class="s1">&#39;IGH (OOF)&#39;</span><span class="p">,</span> <span class="s1">&#39;IGK&#39;</span><span class="p">,</span> <span class="s1">&#39;IGK (stops)&#39;</span><span class="p">,</span> <span class="s1">&#39;IGK (OOF)&#39;</span><span class="p">,</span> <span class="s1">&#39;IGL&#39;</span><span class="p">,</span> <span class="s1">&#39;IGL (stops)&#39;</span><span class="p">,</span> <span class="s1">&#39;IGL (OOF)&#39;</span><span class="p">,</span> <span class="s1">&#39;TRA&#39;</span><span class="p">,</span> <span class="s1">&#39;TRA (stops)&#39;</span><span class="p">,</span> <span class="s1">&#39;TRA (OOF)&#39;</span><span class="p">,</span> <span class="s1">&#39;TRB&#39;</span><span class="p">,</span> <span class="s1">&#39;TRB (stops)&#39;</span><span class="p">,</span> <span class="s1">&#39;TRB (OOF)&#39;</span><span class="p">,</span> <span class="s1">&#39;TRD&#39;</span><span class="p">,</span> <span class="s1">&#39;TRD (stops)&#39;</span><span class="p">,</span> <span class="s1">&#39;TRD (OOF)&#39;</span><span class="p">,</span> <span class="s1">&#39;TRG&#39;</span><span class="p">,</span> <span class="s1">&#39;TRG (stops)&#39;</span><span class="p">,</span> <span class="s1">&#39;TRG (OOF)&#39;</span><span class="p">]</span>
<a id="__codelineno-0-493" name="__codelineno-0-493"></a>        <span class="c1"># colormap = ListedColormap(colors=[colors[i] for i in range(len(colors)) if all_variants[i] in results.columns],</span>
<a id="__codelineno-0-494" name="__codelineno-0-494"></a>                                    <span class="c1">#   name=&#39;mixcr&#39;)        </span>
<a id="__codelineno-0-495" name="__codelineno-0-495"></a>        <span class="n">colors</span> <span class="o">=</span> <span class="p">[</span><span class="n">colors</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">colors</span><span class="p">))</span> <span class="k">if</span> <span class="n">all_variants</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="ow">in</span> <span class="n">results</span><span class="o">.</span><span class="n">columns</span><span class="p">]</span>
<a id="__codelineno-0-496" name="__codelineno-0-496"></a>    <span class="n">results</span> <span class="o">=</span> <span class="n">results</span><span class="p">[</span><span class="n">order</span><span class="p">]</span>
<a id="__codelineno-0-497" name="__codelineno-0-497"></a>    <span class="n">size</span> <span class="o">=</span> <span class="n">results</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<a id="__codelineno-0-498" name="__codelineno-0-498"></a>    <span class="c1"># ax = results.plot.barh(width=0.85, figsize=(9, size * 0.5),  stacked=True, colormap=colormap)</span>
<a id="__codelineno-0-499" name="__codelineno-0-499"></a>    <span class="n">bar_height</span> <span class="o">=</span> <span class="mf">0.85</span>
<a id="__codelineno-0-500" name="__codelineno-0-500"></a>    <span class="n">min_size</span> <span class="o">=</span> <span class="mi">7</span>
<a id="__codelineno-0-501" name="__codelineno-0-501"></a>    <span class="n">min_size_2</span> <span class="o">=</span> <span class="mi">10</span>
<a id="__codelineno-0-502" name="__codelineno-0-502"></a>    <span class="n">plot_rows</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">size</span><span class="p">,</span> <span class="n">min_size</span><span class="p">)</span>
<a id="__codelineno-0-503" name="__codelineno-0-503"></a>    <span class="k">if</span> <span class="n">size</span> <span class="o">&gt;</span> <span class="n">min_size</span><span class="p">:</span>
<a id="__codelineno-0-504" name="__codelineno-0-504"></a>            <span class="n">plot_rows</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">size</span><span class="p">,</span> <span class="n">min_size_2</span><span class="p">)</span>
<a id="__codelineno-0-505" name="__codelineno-0-505"></a>    <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">9</span><span class="p">,</span> <span class="n">plot_rows</span> <span class="o">*</span> <span class="n">bar_height</span> <span class="o">*</span> <span class="mf">0.5</span><span class="p">),</span> <span class="n">dpi</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">constrained_layout</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<a id="__codelineno-0-506" name="__codelineno-0-506"></a>    <span class="n">ax</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="o">-</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">results</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="mf">0.5</span><span class="p">)</span>
<a id="__codelineno-0-507" name="__codelineno-0-507"></a>    <span class="n">bottom</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">results</span><span class="p">))</span>
<a id="__codelineno-0-508" name="__codelineno-0-508"></a>    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">column</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">results</span><span class="o">.</span><span class="n">columns</span><span class="p">):</span>
<a id="__codelineno-0-509" name="__codelineno-0-509"></a>        <span class="n">values</span> <span class="o">=</span> <span class="n">results</span><span class="p">[</span><span class="n">column</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
<a id="__codelineno-0-510" name="__codelineno-0-510"></a>        <span class="n">ax</span><span class="o">.</span><span class="n">barh</span><span class="p">(</span>
<a id="__codelineno-0-511" name="__codelineno-0-511"></a>            <span class="n">y</span><span class="o">=</span><span class="n">results</span><span class="o">.</span><span class="n">index</span><span class="p">,</span>
<a id="__codelineno-0-512" name="__codelineno-0-512"></a>            <span class="n">width</span><span class="o">=</span><span class="n">values</span><span class="p">,</span>
<a id="__codelineno-0-513" name="__codelineno-0-513"></a>            <span class="n">height</span><span class="o">=</span><span class="n">bar_height</span><span class="p">,</span>
<a id="__codelineno-0-514" name="__codelineno-0-514"></a>            <span class="n">left</span><span class="o">=</span><span class="n">bottom</span><span class="p">,</span>
<a id="__codelineno-0-515" name="__codelineno-0-515"></a>            <span class="n">label</span><span class="o">=</span><span class="n">column</span><span class="p">,</span>
<a id="__codelineno-0-516" name="__codelineno-0-516"></a>            <span class="n">color</span><span class="o">=</span><span class="n">colors</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
<a id="__codelineno-0-517" name="__codelineno-0-517"></a>        <span class="p">)</span>
<a id="__codelineno-0-518" name="__codelineno-0-518"></a>        <span class="n">bottom</span> <span class="o">=</span> <span class="p">[</span><span class="n">b</span> <span class="o">+</span> <span class="n">v</span> <span class="k">for</span> <span class="n">b</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">bottom</span><span class="p">,</span> <span class="n">values</span><span class="p">)]</span>
<a id="__codelineno-0-519" name="__codelineno-0-519"></a>    <span class="k">if</span> <span class="n">count_type</span> <span class="o">==</span> <span class="s1">&#39;percent&#39;</span><span class="p">:</span>
<a id="__codelineno-0-520" name="__codelineno-0-520"></a>        <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;%&#39;</span><span class="p">)</span>
<a id="__codelineno-0-521" name="__codelineno-0-521"></a>    <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-522" name="__codelineno-0-522"></a>        <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;read count&#39;</span><span class="p">)</span>
<a id="__codelineno-0-523" name="__codelineno-0-523"></a>    <span class="k">if</span> <span class="n">chart_type</span> <span class="o">==</span> <span class="s1">&#39;summary&#39;</span><span class="p">:</span>
<a id="__codelineno-0-524" name="__codelineno-0-524"></a>        <span class="n">fig</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s1">&#39;outside upper center&#39;</span><span class="p">,</span>  <span class="n">title</span><span class="o">=</span><span class="s1">&#39;Alignments rate&#39;</span><span class="p">,</span> <span class="n">ncol</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">frameon</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<a id="__codelineno-0-525" name="__codelineno-0-525"></a>    <span class="k">elif</span> <span class="n">chart_type</span> <span class="o">==</span> <span class="s1">&#39;chains&#39;</span><span class="p">:</span>
<a id="__codelineno-0-526" name="__codelineno-0-526"></a>        <span class="n">fig</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s1">&#39;outside upper center&#39;</span><span class="p">,</span>  <span class="n">title</span><span class="o">=</span><span class="s1">&#39;Clonal chain usage&#39;</span><span class="p">,</span> <span class="n">ncol</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">frameon</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<a id="__codelineno-0-527" name="__codelineno-0-527"></a>    <span class="c1"># plt.tight_layout()</span>
<a id="__codelineno-0-528" name="__codelineno-0-528"></a>    <span class="n">sns</span><span class="o">.</span><span class="n">despine</span><span class="p">(</span><span class="n">left</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">bottom</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<a id="__codelineno-0-529" name="__codelineno-0-529"></a>    <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
<a id="__codelineno-0-530" name="__codelineno-0-530"></a>    <span class="k">if</span> <span class="n">output_file</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-531" name="__codelineno-0-531"></a>        <span class="n">ax</span><span class="o">.</span><span class="n">get_figure</span><span class="p">()</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">output_file</span><span class="p">,</span> <span class="n">bbox_inches</span><span class="o">=</span><span class="s1">&#39;tight&#39;</span><span class="p">)</span>
<a id="__codelineno-0-532" name="__codelineno-0-532"></a>    <span class="k">return</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div><h2 id="pgen_calculation"><strong>pgen_calculation</strong></h2>


<div class="doc doc-object doc-function">




    <div class="doc doc-contents first">

        <p>calculates probability of clonotype generation using OLGA model</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>clonosets_df</code>
            </td>
            <td>
                  <code><span title="pandas.DataFrame">DataFrame</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>An output of read_clonoset() function </p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>overlap_type</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Possible values are <code>aa</code>, <code>aaV</code>, <code>aaVJ</code>, <code>nt</code>, <code>ntV</code>, <code>ntVJ</code>. aa/nt define which CDR3 sequence
to use (amino acid or nucleotide). V/J in the overlap_type define whether to check V or J segments
to decide if clonotypes are equal</p>
              </div>
            </td>
            <td>
                  <code>&#39;aaVJ&#39;</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>mismatches</code>
            </td>
            <td>
                  <code><span title="int">int</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>number of mismatches in heighbors CDR3 sequence, default=1</p>
              </div>
            </td>
            <td>
                  <code>1</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>generation_model</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>generation model used by OLGA. Possible values are <code>human_B_heavy</code>, <code>human_B_kappa</code>, 
<code>human_B_lambda</code>, <code>human_T_alpha</code>, <code>human_T_beta</code>, <code>mouse_T_alpha</code>, <code>mouse_T_beta</code>, default='human_T_beta'</p>
              </div>
            </td>
            <td>
                  <code>&#39;human_T_beta&#39;</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
<th>Name</th>          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
<td><code>clonosets_df</code></td>            <td>
                  <code><span title="pandas.DataFrame">DataFrame</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>a dataframe with calculated p_gens for each clonotype</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>repseq/pgen_calculation.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-16"> 16</a></span>
<span class="normal"><a href="#__codelineno-0-17"> 17</a></span>
<span class="normal"><a href="#__codelineno-0-18"> 18</a></span>
<span class="normal"><a href="#__codelineno-0-19"> 19</a></span>
<span class="normal"><a href="#__codelineno-0-20"> 20</a></span>
<span class="normal"><a href="#__codelineno-0-21"> 21</a></span>
<span class="normal"><a href="#__codelineno-0-22"> 22</a></span>
<span class="normal"><a href="#__codelineno-0-23"> 23</a></span>
<span class="normal"><a href="#__codelineno-0-24"> 24</a></span>
<span class="normal"><a href="#__codelineno-0-25"> 25</a></span>
<span class="normal"><a href="#__codelineno-0-26"> 26</a></span>
<span class="normal"><a href="#__codelineno-0-27"> 27</a></span>
<span class="normal"><a href="#__codelineno-0-28"> 28</a></span>
<span class="normal"><a href="#__codelineno-0-29"> 29</a></span>
<span class="normal"><a href="#__codelineno-0-30"> 30</a></span>
<span class="normal"><a href="#__codelineno-0-31"> 31</a></span>
<span class="normal"><a href="#__codelineno-0-32"> 32</a></span>
<span class="normal"><a href="#__codelineno-0-33"> 33</a></span>
<span class="normal"><a href="#__codelineno-0-34"> 34</a></span>
<span class="normal"><a href="#__codelineno-0-35"> 35</a></span>
<span class="normal"><a href="#__codelineno-0-36"> 36</a></span>
<span class="normal"><a href="#__codelineno-0-37"> 37</a></span>
<span class="normal"><a href="#__codelineno-0-38"> 38</a></span>
<span class="normal"><a href="#__codelineno-0-39"> 39</a></span>
<span class="normal"><a href="#__codelineno-0-40"> 40</a></span>
<span class="normal"><a href="#__codelineno-0-41"> 41</a></span>
<span class="normal"><a href="#__codelineno-0-42"> 42</a></span>
<span class="normal"><a href="#__codelineno-0-43"> 43</a></span>
<span class="normal"><a href="#__codelineno-0-44"> 44</a></span>
<span class="normal"><a href="#__codelineno-0-45"> 45</a></span>
<span class="normal"><a href="#__codelineno-0-46"> 46</a></span>
<span class="normal"><a href="#__codelineno-0-47"> 47</a></span>
<span class="normal"><a href="#__codelineno-0-48"> 48</a></span>
<span class="normal"><a href="#__codelineno-0-49"> 49</a></span>
<span class="normal"><a href="#__codelineno-0-50"> 50</a></span>
<span class="normal"><a href="#__codelineno-0-51"> 51</a></span>
<span class="normal"><a href="#__codelineno-0-52"> 52</a></span>
<span class="normal"><a href="#__codelineno-0-53"> 53</a></span>
<span class="normal"><a href="#__codelineno-0-54"> 54</a></span>
<span class="normal"><a href="#__codelineno-0-55"> 55</a></span>
<span class="normal"><a href="#__codelineno-0-56"> 56</a></span>
<span class="normal"><a href="#__codelineno-0-57"> 57</a></span>
<span class="normal"><a href="#__codelineno-0-58"> 58</a></span>
<span class="normal"><a href="#__codelineno-0-59"> 59</a></span>
<span class="normal"><a href="#__codelineno-0-60"> 60</a></span>
<span class="normal"><a href="#__codelineno-0-61"> 61</a></span>
<span class="normal"><a href="#__codelineno-0-62"> 62</a></span>
<span class="normal"><a href="#__codelineno-0-63"> 63</a></span>
<span class="normal"><a href="#__codelineno-0-64"> 64</a></span>
<span class="normal"><a href="#__codelineno-0-65"> 65</a></span>
<span class="normal"><a href="#__codelineno-0-66"> 66</a></span>
<span class="normal"><a href="#__codelineno-0-67"> 67</a></span>
<span class="normal"><a href="#__codelineno-0-68"> 68</a></span>
<span class="normal"><a href="#__codelineno-0-69"> 69</a></span>
<span class="normal"><a href="#__codelineno-0-70"> 70</a></span>
<span class="normal"><a href="#__codelineno-0-71"> 71</a></span>
<span class="normal"><a href="#__codelineno-0-72"> 72</a></span>
<span class="normal"><a href="#__codelineno-0-73"> 73</a></span>
<span class="normal"><a href="#__codelineno-0-74"> 74</a></span>
<span class="normal"><a href="#__codelineno-0-75"> 75</a></span>
<span class="normal"><a href="#__codelineno-0-76"> 76</a></span>
<span class="normal"><a href="#__codelineno-0-77"> 77</a></span>
<span class="normal"><a href="#__codelineno-0-78"> 78</a></span>
<span class="normal"><a href="#__codelineno-0-79"> 79</a></span>
<span class="normal"><a href="#__codelineno-0-80"> 80</a></span>
<span class="normal"><a href="#__codelineno-0-81"> 81</a></span>
<span class="normal"><a href="#__codelineno-0-82"> 82</a></span>
<span class="normal"><a href="#__codelineno-0-83"> 83</a></span>
<span class="normal"><a href="#__codelineno-0-84"> 84</a></span>
<span class="normal"><a href="#__codelineno-0-85"> 85</a></span>
<span class="normal"><a href="#__codelineno-0-86"> 86</a></span>
<span class="normal"><a href="#__codelineno-0-87"> 87</a></span>
<span class="normal"><a href="#__codelineno-0-88"> 88</a></span>
<span class="normal"><a href="#__codelineno-0-89"> 89</a></span>
<span class="normal"><a href="#__codelineno-0-90"> 90</a></span>
<span class="normal"><a href="#__codelineno-0-91"> 91</a></span>
<span class="normal"><a href="#__codelineno-0-92"> 92</a></span>
<span class="normal"><a href="#__codelineno-0-93"> 93</a></span>
<span class="normal"><a href="#__codelineno-0-94"> 94</a></span>
<span class="normal"><a href="#__codelineno-0-95"> 95</a></span>
<span class="normal"><a href="#__codelineno-0-96"> 96</a></span>
<span class="normal"><a href="#__codelineno-0-97"> 97</a></span>
<span class="normal"><a href="#__codelineno-0-98"> 98</a></span>
<span class="normal"><a href="#__codelineno-0-99"> 99</a></span>
<span class="normal"><a href="#__codelineno-0-100">100</a></span>
<span class="normal"><a href="#__codelineno-0-101">101</a></span>
<span class="normal"><a href="#__codelineno-0-102">102</a></span>
<span class="normal"><a href="#__codelineno-0-103">103</a></span>
<span class="normal"><a href="#__codelineno-0-104">104</a></span>
<span class="normal"><a href="#__codelineno-0-105">105</a></span>
<span class="normal"><a href="#__codelineno-0-106">106</a></span>
<span class="normal"><a href="#__codelineno-0-107">107</a></span>
<span class="normal"><a href="#__codelineno-0-108">108</a></span>
<span class="normal"><a href="#__codelineno-0-109">109</a></span>
<span class="normal"><a href="#__codelineno-0-110">110</a></span>
<span class="normal"><a href="#__codelineno-0-111">111</a></span>
<span class="normal"><a href="#__codelineno-0-112">112</a></span>
<span class="normal"><a href="#__codelineno-0-113">113</a></span>
<span class="normal"><a href="#__codelineno-0-114">114</a></span>
<span class="normal"><a href="#__codelineno-0-115">115</a></span>
<span class="normal"><a href="#__codelineno-0-116">116</a></span>
<span class="normal"><a href="#__codelineno-0-117">117</a></span>
<span class="normal"><a href="#__codelineno-0-118">118</a></span>
<span class="normal"><a href="#__codelineno-0-119">119</a></span>
<span class="normal"><a href="#__codelineno-0-120">120</a></span>
<span class="normal"><a href="#__codelineno-0-121">121</a></span>
<span class="normal"><a href="#__codelineno-0-122">122</a></span>
<span class="normal"><a href="#__codelineno-0-123">123</a></span>
<span class="normal"><a href="#__codelineno-0-124">124</a></span>
<span class="normal"><a href="#__codelineno-0-125">125</a></span>
<span class="normal"><a href="#__codelineno-0-126">126</a></span>
<span class="normal"><a href="#__codelineno-0-127">127</a></span>
<span class="normal"><a href="#__codelineno-0-128">128</a></span>
<span class="normal"><a href="#__codelineno-0-129">129</a></span>
<span class="normal"><a href="#__codelineno-0-130">130</a></span>
<span class="normal"><a href="#__codelineno-0-131">131</a></span>
<span class="normal"><a href="#__codelineno-0-132">132</a></span>
<span class="normal"><a href="#__codelineno-0-133">133</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-16" name="__codelineno-0-16"></a><span class="k">def</span><span class="w"> </span><span class="nf">calculate_clonotypes_pgen</span><span class="p">(</span><span class="n">clonosets_df</span><span class="p">,</span> <span class="n">cl_filter</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">overlap_type</span><span class="o">=</span><span class="s1">&#39;aaVJ&#39;</span><span class="p">,</span> <span class="n">mismatches</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">generation_model</span><span class="o">=</span><span class="s1">&#39;human_T_beta&#39;</span><span class="p">,</span> <span class="n">olga_warnings</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<a id="__codelineno-0-17" name="__codelineno-0-17"></a>
<a id="__codelineno-0-18" name="__codelineno-0-18"></a><span class="w">    </span><span class="sd">&#39;&#39;&#39;</span>
<a id="__codelineno-0-19" name="__codelineno-0-19"></a><span class="sd">    calculates probability of clonotype generation using OLGA model</span>
<a id="__codelineno-0-20" name="__codelineno-0-20"></a>
<a id="__codelineno-0-21" name="__codelineno-0-21"></a><span class="sd">    Args:</span>
<a id="__codelineno-0-22" name="__codelineno-0-22"></a><span class="sd">        clonosets_df (pd.DataFrame): An output of read_clonoset() function </span>
<a id="__codelineno-0-23" name="__codelineno-0-23"></a><span class="sd">        overlap_type (str): Possible values are `aa`, `aaV`, `aaVJ`, `nt`, `ntV`, `ntVJ`. aa/nt define which CDR3 sequence</span>
<a id="__codelineno-0-24" name="__codelineno-0-24"></a><span class="sd">            to use (amino acid or nucleotide). V/J in the overlap_type define whether to check V or J segments</span>
<a id="__codelineno-0-25" name="__codelineno-0-25"></a><span class="sd">            to decide if clonotypes are equal</span>
<a id="__codelineno-0-26" name="__codelineno-0-26"></a><span class="sd">        mismatches (int): number of mismatches in heighbors CDR3 sequence, default=1</span>
<a id="__codelineno-0-27" name="__codelineno-0-27"></a><span class="sd">        generation_model (str): generation model used by OLGA. Possible values are `human_B_heavy`, `human_B_kappa`, </span>
<a id="__codelineno-0-28" name="__codelineno-0-28"></a><span class="sd">            `human_B_lambda`, `human_T_alpha`, `human_T_beta`, `mouse_T_alpha`, `mouse_T_beta`, default=&#39;human_T_beta&#39;</span>
<a id="__codelineno-0-29" name="__codelineno-0-29"></a>
<a id="__codelineno-0-30" name="__codelineno-0-30"></a>
<a id="__codelineno-0-31" name="__codelineno-0-31"></a><span class="sd">    Returns: </span>
<a id="__codelineno-0-32" name="__codelineno-0-32"></a><span class="sd">        clonosets_df (pd.DataFrame): a dataframe with calculated p_gens for each clonotype</span>
<a id="__codelineno-0-33" name="__codelineno-0-33"></a><span class="sd">    &#39;&#39;&#39;</span>
<a id="__codelineno-0-34" name="__codelineno-0-34"></a>    <span class="n">aa</span><span class="p">,</span> <span class="n">check_v</span><span class="p">,</span> <span class="n">check_j</span> <span class="o">=</span> <span class="n">overlap_type_to_flags</span><span class="p">(</span><span class="n">overlap_type</span><span class="p">)</span>
<a id="__codelineno-0-35" name="__codelineno-0-35"></a>    <span class="n">pgen_model</span> <span class="o">=</span> <span class="n">create_olga_model</span><span class="p">(</span><span class="n">generation_model</span><span class="p">)</span>
<a id="__codelineno-0-36" name="__codelineno-0-36"></a>
<a id="__codelineno-0-37" name="__codelineno-0-37"></a>    <span class="k">if</span> <span class="ow">not</span> <span class="n">cl_filter</span><span class="p">:</span>
<a id="__codelineno-0-38" name="__codelineno-0-38"></a>        <span class="n">cl_filter</span> <span class="o">=</span> <span class="n">clf</span><span class="o">.</span><span class="n">Filter</span><span class="p">(</span><span class="n">functionality</span><span class="o">=</span><span class="s2">&quot;a&quot;</span><span class="p">)</span>
<a id="__codelineno-0-39" name="__codelineno-0-39"></a>    <span class="n">clns_olga</span> <span class="o">=</span> <span class="n">cl_filter</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">clonosets_df</span><span class="p">)</span>
<a id="__codelineno-0-40" name="__codelineno-0-40"></a>
<a id="__codelineno-0-41" name="__codelineno-0-41"></a>    <span class="c1"># creating tuples of size 1-3 each according to the overlap_type </span>
<a id="__codelineno-0-42" name="__codelineno-0-42"></a>    <span class="n">overlap_type_vars</span> <span class="o">=</span> <span class="p">[]</span>
<a id="__codelineno-0-43" name="__codelineno-0-43"></a>    <span class="k">if</span> <span class="n">aa</span><span class="p">:</span>
<a id="__codelineno-0-44" name="__codelineno-0-44"></a>        <span class="n">overlap_type_vars</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;cdr3aa&#39;</span><span class="p">)</span>
<a id="__codelineno-0-45" name="__codelineno-0-45"></a>    <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-46" name="__codelineno-0-46"></a>        <span class="n">overlap_type_vars</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;cdr3nt&#39;</span><span class="p">)</span>
<a id="__codelineno-0-47" name="__codelineno-0-47"></a>    <span class="k">if</span> <span class="n">check_v</span><span class="p">:</span>
<a id="__codelineno-0-48" name="__codelineno-0-48"></a>        <span class="n">overlap_type_vars</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;v&#39;</span><span class="p">)</span>
<a id="__codelineno-0-49" name="__codelineno-0-49"></a>    <span class="k">if</span> <span class="n">check_j</span><span class="p">:</span>
<a id="__codelineno-0-50" name="__codelineno-0-50"></a>        <span class="n">overlap_type_vars</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;j&#39;</span><span class="p">)</span>
<a id="__codelineno-0-51" name="__codelineno-0-51"></a>
<a id="__codelineno-0-52" name="__codelineno-0-52"></a>    <span class="c1"># creating neighbours, a {(cdr3, v if required, j if required): [neighbours]} dict, and a {neighbour: [(cdr3, v if required, j if required)]} dict</span>
<a id="__codelineno-0-53" name="__codelineno-0-53"></a>    <span class="n">clonoset_seqs</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">clns_olga</span><span class="p">[</span><span class="n">overlap_type_vars</span><span class="p">]</span><span class="o">.</span><span class="n">itertuples</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="kc">None</span><span class="p">))</span>
<a id="__codelineno-0-54" name="__codelineno-0-54"></a>    <span class="n">clonoset_seqs_for_calculation</span> <span class="o">=</span> <span class="p">[]</span>
<a id="__codelineno-0-55" name="__codelineno-0-55"></a>    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">overlap_type_vars</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">3</span><span class="p">:</span>
<a id="__codelineno-0-56" name="__codelineno-0-56"></a>        <span class="k">for</span> <span class="n">cln</span> <span class="ow">in</span> <span class="n">clonoset_seqs</span><span class="p">:</span>
<a id="__codelineno-0-57" name="__codelineno-0-57"></a>            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">cln</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
<a id="__codelineno-0-58" name="__codelineno-0-58"></a>                <span class="n">seq</span><span class="p">,</span> <span class="n">segment</span> <span class="o">=</span> <span class="n">cln</span>
<a id="__codelineno-0-59" name="__codelineno-0-59"></a>                <span class="n">v</span><span class="p">,</span> <span class="n">j</span> <span class="o">=</span> <span class="n">segment</span><span class="p">,</span> <span class="n">segment</span>
<a id="__codelineno-0-60" name="__codelineno-0-60"></a>            <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">cln</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
<a id="__codelineno-0-61" name="__codelineno-0-61"></a>                <span class="n">seq</span> <span class="o">=</span> <span class="n">cln</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<a id="__codelineno-0-62" name="__codelineno-0-62"></a>            <span class="k">if</span> <span class="ow">not</span> <span class="n">check_v</span><span class="p">:</span>
<a id="__codelineno-0-63" name="__codelineno-0-63"></a>                <span class="n">v</span> <span class="o">=</span> <span class="kc">None</span>
<a id="__codelineno-0-64" name="__codelineno-0-64"></a>            <span class="k">if</span> <span class="ow">not</span> <span class="n">check_j</span><span class="p">:</span>
<a id="__codelineno-0-65" name="__codelineno-0-65"></a>                <span class="n">j</span> <span class="o">=</span> <span class="kc">None</span>
<a id="__codelineno-0-66" name="__codelineno-0-66"></a>            <span class="n">clonoset_seqs_for_calculation</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">seq</span><span class="p">,</span> <span class="n">v</span><span class="p">,</span> <span class="n">j</span><span class="p">))</span>
<a id="__codelineno-0-67" name="__codelineno-0-67"></a>    <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-68" name="__codelineno-0-68"></a>        <span class="n">clonoset_seqs_for_calculation</span> <span class="o">=</span> <span class="n">clonoset_seqs</span>
<a id="__codelineno-0-69" name="__codelineno-0-69"></a>
<a id="__codelineno-0-70" name="__codelineno-0-70"></a>    <span class="c1"># create a temporary column to merge p_gen values with respective clonotypes</span>
<a id="__codelineno-0-71" name="__codelineno-0-71"></a>    <span class="n">clonoset_total_pgen</span> <span class="o">=</span> <span class="n">clns_olga</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
<a id="__codelineno-0-72" name="__codelineno-0-72"></a>    <span class="n">clonoset_total_pgen</span><span class="p">[</span><span class="s1">&#39;temp&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">clonoset_seqs</span>
<a id="__codelineno-0-73" name="__codelineno-0-73"></a>    <span class="n">neighbours</span><span class="p">,</span> <span class="n">cln_neighbours_dict</span> <span class="o">=</span> <span class="n">create_neighbours</span><span class="p">(</span><span class="n">clonoset_seqs</span><span class="p">,</span> <span class="n">mismatches</span><span class="p">,</span> <span class="n">check_v</span><span class="p">,</span> <span class="n">check_j</span><span class="p">)</span>
<a id="__codelineno-0-74" name="__codelineno-0-74"></a>
<a id="__codelineno-0-75" name="__codelineno-0-75"></a>    <span class="n">clonotype_pgen_dict</span> <span class="o">=</span> <span class="p">{}</span>
<a id="__codelineno-0-76" name="__codelineno-0-76"></a>    <span class="n">neighbours_pgen_dict</span> <span class="o">=</span> <span class="p">{}</span>
<a id="__codelineno-0-77" name="__codelineno-0-77"></a>
<a id="__codelineno-0-78" name="__codelineno-0-78"></a>    <span class="n">n_chunks</span> <span class="o">=</span> <span class="mi">40</span>
<a id="__codelineno-0-79" name="__codelineno-0-79"></a>    <span class="n">chunk_size</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">clonoset_seqs_for_calculation</span><span class="p">)</span> <span class="o">//</span> <span class="n">n_chunks</span> <span class="o">+</span> <span class="mi">1</span>
<a id="__codelineno-0-80" name="__codelineno-0-80"></a>    <span class="n">tasks_clns</span> <span class="o">=</span> <span class="p">[]</span>
<a id="__codelineno-0-81" name="__codelineno-0-81"></a>    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">clonoset_seqs_for_calculation</span><span class="p">),</span> <span class="n">chunk_size</span><span class="p">):</span>
<a id="__codelineno-0-82" name="__codelineno-0-82"></a>        <span class="k">if</span> <span class="n">i</span> <span class="o">+</span> <span class="n">chunk_size</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">clonoset_seqs_for_calculation</span><span class="p">):</span>
<a id="__codelineno-0-83" name="__codelineno-0-83"></a>            <span class="n">task</span> <span class="o">=</span> <span class="p">(</span><span class="n">clonoset_seqs_for_calculation</span><span class="p">[</span><span class="n">i</span><span class="p">:</span><span class="n">i</span> <span class="o">+</span> <span class="n">chunk_size</span><span class="p">],</span> <span class="n">aa</span><span class="p">,</span> <span class="n">pgen_model</span><span class="p">,</span> <span class="n">olga_warnings</span><span class="p">)</span>
<a id="__codelineno-0-84" name="__codelineno-0-84"></a>        <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-85" name="__codelineno-0-85"></a>            <span class="n">task</span> <span class="o">=</span> <span class="p">(</span><span class="n">clonoset_seqs_for_calculation</span><span class="p">[</span><span class="n">i</span><span class="p">:],</span> <span class="n">aa</span><span class="p">,</span> <span class="n">pgen_model</span><span class="p">,</span> <span class="n">olga_warnings</span><span class="p">)</span>
<a id="__codelineno-0-86" name="__codelineno-0-86"></a>        <span class="n">tasks_clns</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">task</span><span class="p">)</span>
<a id="__codelineno-0-87" name="__codelineno-0-87"></a>
<a id="__codelineno-0-88" name="__codelineno-0-88"></a>    <span class="n">clonotype_pgen</span> <span class="o">=</span> <span class="n">run_parallel_calculation</span><span class="p">(</span><span class="n">calculate_pgen_mp</span><span class="p">,</span> 
<a id="__codelineno-0-89" name="__codelineno-0-89"></a>                                              <span class="n">tasks_clns</span><span class="p">,</span> 
<a id="__codelineno-0-90" name="__codelineno-0-90"></a>                                              <span class="s1">&#39;Calculating p_gen using OLGA&#39;</span><span class="p">,</span> 
<a id="__codelineno-0-91" name="__codelineno-0-91"></a>                                              <span class="s1">&#39;chunks_clonoset&#39;</span><span class="p">)</span>
<a id="__codelineno-0-92" name="__codelineno-0-92"></a>    <span class="k">for</span> <span class="n">el</span> <span class="ow">in</span> <span class="n">clonotype_pgen</span><span class="p">:</span>
<a id="__codelineno-0-93" name="__codelineno-0-93"></a>        <span class="n">clonotype_pgen_dict</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">el</span><span class="p">)</span>
<a id="__codelineno-0-94" name="__codelineno-0-94"></a>    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">overlap_type_vars</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">3</span><span class="p">:</span>
<a id="__codelineno-0-95" name="__codelineno-0-95"></a>        <span class="n">clonotype_pgen_dict</span> <span class="o">=</span> <span class="p">{</span><span class="nb">tuple</span><span class="p">([</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">ct</span> <span class="k">if</span> <span class="n">x</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">]):</span><span class="n">pgen</span> <span class="k">for</span> <span class="n">ct</span><span class="p">,</span> <span class="n">pgen</span> <span class="ow">in</span> <span class="n">clonotype_pgen_dict</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>
<a id="__codelineno-0-96" name="__codelineno-0-96"></a>
<a id="__codelineno-0-97" name="__codelineno-0-97"></a>    <span class="n">n_chunks</span> <span class="o">=</span> <span class="mi">40</span>
<a id="__codelineno-0-98" name="__codelineno-0-98"></a>    <span class="n">chunk_size</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">neighbours</span><span class="p">)</span> <span class="o">//</span> <span class="n">n_chunks</span> <span class="o">+</span> <span class="mi">1</span>
<a id="__codelineno-0-99" name="__codelineno-0-99"></a>    <span class="n">tasks_nb</span> <span class="o">=</span> <span class="p">[]</span>
<a id="__codelineno-0-100" name="__codelineno-0-100"></a>    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">neighbours</span><span class="p">),</span> <span class="n">chunk_size</span><span class="p">):</span>
<a id="__codelineno-0-101" name="__codelineno-0-101"></a>        <span class="k">if</span> <span class="n">i</span> <span class="o">+</span> <span class="n">chunk_size</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">neighbours</span><span class="p">):</span>
<a id="__codelineno-0-102" name="__codelineno-0-102"></a>            <span class="n">task</span> <span class="o">=</span> <span class="p">(</span><span class="n">neighbours</span><span class="p">[</span><span class="n">i</span><span class="p">:</span><span class="n">i</span> <span class="o">+</span> <span class="n">chunk_size</span><span class="p">],</span> <span class="n">aa</span><span class="p">,</span> <span class="n">pgen_model</span><span class="p">,</span> <span class="n">olga_warnings</span><span class="p">)</span>
<a id="__codelineno-0-103" name="__codelineno-0-103"></a>        <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-104" name="__codelineno-0-104"></a>            <span class="n">task</span> <span class="o">=</span> <span class="p">(</span><span class="n">neighbours</span><span class="p">[</span><span class="n">i</span><span class="p">:],</span> <span class="n">aa</span><span class="p">,</span> <span class="n">pgen_model</span><span class="p">,</span> <span class="n">olga_warnings</span><span class="p">)</span>
<a id="__codelineno-0-105" name="__codelineno-0-105"></a>        <span class="n">tasks_nb</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">task</span><span class="p">)</span>
<a id="__codelineno-0-106" name="__codelineno-0-106"></a>
<a id="__codelineno-0-107" name="__codelineno-0-107"></a>    <span class="n">neighbours_pgen</span> <span class="o">=</span> <span class="n">run_parallel_calculation</span><span class="p">(</span><span class="n">calculate_pgen_mp</span><span class="p">,</span> 
<a id="__codelineno-0-108" name="__codelineno-0-108"></a>                                                <span class="n">tasks_nb</span><span class="p">,</span> 
<a id="__codelineno-0-109" name="__codelineno-0-109"></a>                                                <span class="s1">&#39;Calculating p_gen using OLGA&#39;</span><span class="p">,</span> 
<a id="__codelineno-0-110" name="__codelineno-0-110"></a>                                                <span class="s1">&#39;chunks_neighbors&#39;</span><span class="p">)</span>
<a id="__codelineno-0-111" name="__codelineno-0-111"></a>    <span class="k">for</span> <span class="n">el</span> <span class="ow">in</span> <span class="n">neighbours_pgen</span><span class="p">:</span>
<a id="__codelineno-0-112" name="__codelineno-0-112"></a>        <span class="n">neighbours_pgen_dict</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">el</span><span class="p">)</span>
<a id="__codelineno-0-113" name="__codelineno-0-113"></a>
<a id="__codelineno-0-114" name="__codelineno-0-114"></a>    <span class="c1"># matching (neighbor, pgen) pairs with their respective clonotypes</span>
<a id="__codelineno-0-115" name="__codelineno-0-115"></a>    <span class="n">clonotype_neighbours_pgen</span> <span class="o">=</span> <span class="p">{</span><span class="n">ct</span><span class="p">:</span> <span class="p">[(</span><span class="n">n</span><span class="p">,</span> <span class="n">neighbours_pgen_dict</span><span class="p">[</span><span class="n">n</span><span class="p">])</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">ns</span><span class="p">]</span> 
<a id="__codelineno-0-116" name="__codelineno-0-116"></a>                                 <span class="k">for</span> <span class="n">ct</span><span class="p">,</span> <span class="n">ns</span> <span class="ow">in</span> <span class="n">cln_neighbours_dict</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>
<a id="__codelineno-0-117" name="__codelineno-0-117"></a>
<a id="__codelineno-0-118" name="__codelineno-0-118"></a>    <span class="c1"># pgen = sum(neighbors_pgen) - (C(len(cdr3),mismatches) - 1) * pgen(clonotype)</span>
<a id="__codelineno-0-119" name="__codelineno-0-119"></a>    <span class="n">clonoset_total_pgen_to_add</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;temp&#39;</span><span class="p">:</span> <span class="p">[],</span> <span class="s1">&#39;p_gen&#39;</span><span class="p">:</span> <span class="p">[]}</span>
<a id="__codelineno-0-120" name="__codelineno-0-120"></a>    <span class="k">for</span> <span class="n">ct</span><span class="p">,</span> <span class="n">ns</span> <span class="ow">in</span> <span class="n">clonotype_neighbours_pgen</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
<a id="__codelineno-0-121" name="__codelineno-0-121"></a>        <span class="n">ns_pgen_sum</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">([</span><span class="n">pgen</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">pgen</span> <span class="ow">in</span> <span class="n">ns</span><span class="p">])</span>
<a id="__codelineno-0-122" name="__codelineno-0-122"></a>        <span class="n">n_overlaps</span> <span class="o">=</span> <span class="n">comb</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">ct</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="n">mismatches</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span>
<a id="__codelineno-0-123" name="__codelineno-0-123"></a>        <span class="n">pgen_ct</span> <span class="o">=</span> <span class="n">clonotype_pgen_dict</span><span class="p">[</span><span class="n">ct</span><span class="p">]</span>
<a id="__codelineno-0-124" name="__codelineno-0-124"></a>        <span class="n">clonoset_total_pgen_to_add</span><span class="p">[</span><span class="s1">&#39;temp&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ct</span><span class="p">)</span>
<a id="__codelineno-0-125" name="__codelineno-0-125"></a>        <span class="n">clonoset_total_pgen_to_add</span><span class="p">[</span><span class="s1">&#39;p_gen&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ns_pgen_sum</span> <span class="o">-</span> <span class="n">n_overlaps</span> <span class="o">*</span> <span class="n">pgen_ct</span><span class="p">)</span>
<a id="__codelineno-0-126" name="__codelineno-0-126"></a>
<a id="__codelineno-0-127" name="__codelineno-0-127"></a>    <span class="n">clonoset_total_pgen_to_add</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">clonoset_total_pgen_to_add</span><span class="p">)</span>
<a id="__codelineno-0-128" name="__codelineno-0-128"></a>
<a id="__codelineno-0-129" name="__codelineno-0-129"></a>    <span class="n">result_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">clonoset_total_pgen_to_add</span><span class="p">,</span> <span class="n">clonoset_total_pgen</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s1">&#39;right&#39;</span><span class="p">,</span> <span class="n">on</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;temp&#39;</span><span class="p">])</span>
<a id="__codelineno-0-130" name="__codelineno-0-130"></a>    <span class="n">result_df</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="s1">&#39;temp&#39;</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<a id="__codelineno-0-131" name="__codelineno-0-131"></a>    <span class="n">pgen</span> <span class="o">=</span> <span class="n">result_df</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;p_gen&#39;</span><span class="p">)</span>
<a id="__codelineno-0-132" name="__codelineno-0-132"></a>    <span class="n">result_df</span><span class="p">[</span><span class="s1">&#39;pgen&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pgen</span>
<a id="__codelineno-0-133" name="__codelineno-0-133"></a>    <span class="k">return</span> <span class="n">result_df</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div><h2 id="processing_stats"><strong>processing_stats</strong></h2>


<div class="doc doc-object doc-module">




    <div class="doc doc-contents first">










  <div class="doc doc-children">












  </div>

    </div>

</div><h2 id="segment_usage"><strong>segment_usage</strong></h2>


<div class="doc doc-object doc-module">




    <div class="doc doc-contents first">










  <div class="doc doc-children">












  </div>

    </div>

</div><h2 id="slurm"><strong>slurm</strong></h2>


<div class="doc doc-object doc-module">




    <div class="doc doc-contents first">










  <div class="doc doc-children">












  </div>

    </div>

</div><h2 id="stats"><strong>stats</strong></h2>


<div class="doc doc-object doc-module">




    <div class="doc doc-contents first">










  <div class="doc doc-children">










<div class="doc doc-object doc-function">


<h4 id="stats.calc_clonoset_stats" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">calc_clonoset_stats</span><span class="p">(</span><span class="n">clonosets_df</span><span class="p">,</span> <span class="n">cl_filter</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span></code>

</h4>


    <div class="doc doc-contents ">

        <p>Calculates statistics for clonosets regarding clonotype, read and UMI counts.
Also gives counts for functional clonotypes and non-singletons: clonotypes, 
having only one count (UMI count if present, read count in other cases).
Clonosets are given to the function in a form of pd.DataFrame</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>clonosets_df</code>
            </td>
            <td>
                  <code><span title="pandas.DataFrame">DataFrame</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>dataframe, containing two required columns: 
<code>sample_id</code> and <code>filename</code>. Also recommended to have <code>chain</code> column in this DF.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>cl_filter</code>
            </td>
            <td>
                  <code><span title="repseq.clone_filter.Filter">Filter</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>clonoset filter - object from <code>clone_filter.py</code> module.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>pd.DataFrame: dataframe with clonotype statistics for each sample in clonosets_df</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>repseq/stats.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-20">20</a></span>
<span class="normal"><a href="#__codelineno-0-21">21</a></span>
<span class="normal"><a href="#__codelineno-0-22">22</a></span>
<span class="normal"><a href="#__codelineno-0-23">23</a></span>
<span class="normal"><a href="#__codelineno-0-24">24</a></span>
<span class="normal"><a href="#__codelineno-0-25">25</a></span>
<span class="normal"><a href="#__codelineno-0-26">26</a></span>
<span class="normal"><a href="#__codelineno-0-27">27</a></span>
<span class="normal"><a href="#__codelineno-0-28">28</a></span>
<span class="normal"><a href="#__codelineno-0-29">29</a></span>
<span class="normal"><a href="#__codelineno-0-30">30</a></span>
<span class="normal"><a href="#__codelineno-0-31">31</a></span>
<span class="normal"><a href="#__codelineno-0-32">32</a></span>
<span class="normal"><a href="#__codelineno-0-33">33</a></span>
<span class="normal"><a href="#__codelineno-0-34">34</a></span>
<span class="normal"><a href="#__codelineno-0-35">35</a></span>
<span class="normal"><a href="#__codelineno-0-36">36</a></span>
<span class="normal"><a href="#__codelineno-0-37">37</a></span>
<span class="normal"><a href="#__codelineno-0-38">38</a></span>
<span class="normal"><a href="#__codelineno-0-39">39</a></span>
<span class="normal"><a href="#__codelineno-0-40">40</a></span>
<span class="normal"><a href="#__codelineno-0-41">41</a></span>
<span class="normal"><a href="#__codelineno-0-42">42</a></span>
<span class="normal"><a href="#__codelineno-0-43">43</a></span>
<span class="normal"><a href="#__codelineno-0-44">44</a></span>
<span class="normal"><a href="#__codelineno-0-45">45</a></span>
<span class="normal"><a href="#__codelineno-0-46">46</a></span>
<span class="normal"><a href="#__codelineno-0-47">47</a></span>
<span class="normal"><a href="#__codelineno-0-48">48</a></span>
<span class="normal"><a href="#__codelineno-0-49">49</a></span>
<span class="normal"><a href="#__codelineno-0-50">50</a></span>
<span class="normal"><a href="#__codelineno-0-51">51</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-20" name="__codelineno-0-20"></a><span class="k">def</span><span class="w"> </span><span class="nf">calc_clonoset_stats</span><span class="p">(</span><span class="n">clonosets_df</span><span class="p">,</span> <span class="n">cl_filter</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
<a id="__codelineno-0-21" name="__codelineno-0-21"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-22" name="__codelineno-0-22"></a><span class="sd">    Calculates statistics for clonosets regarding clonotype, read and UMI counts.</span>
<a id="__codelineno-0-23" name="__codelineno-0-23"></a><span class="sd">    Also gives counts for functional clonotypes and non-singletons: clonotypes, </span>
<a id="__codelineno-0-24" name="__codelineno-0-24"></a><span class="sd">    having only one count (UMI count if present, read count in other cases).</span>
<a id="__codelineno-0-25" name="__codelineno-0-25"></a><span class="sd">    Clonosets are given to the function in a form of pd.DataFrame</span>
<a id="__codelineno-0-26" name="__codelineno-0-26"></a>
<a id="__codelineno-0-27" name="__codelineno-0-27"></a><span class="sd">    Args:</span>
<a id="__codelineno-0-28" name="__codelineno-0-28"></a><span class="sd">        clonosets_df (pd.DataFrame): dataframe, containing two required columns: </span>
<a id="__codelineno-0-29" name="__codelineno-0-29"></a><span class="sd">            `sample_id` and `filename`. Also recommended to have `chain` column in this DF.</span>
<a id="__codelineno-0-30" name="__codelineno-0-30"></a><span class="sd">        cl_filter (Filter): clonoset filter - object from `clone_filter.py` module.</span>
<a id="__codelineno-0-31" name="__codelineno-0-31"></a>
<a id="__codelineno-0-32" name="__codelineno-0-32"></a><span class="sd">    Returns:</span>
<a id="__codelineno-0-33" name="__codelineno-0-33"></a><span class="sd">        pd.DataFrame: dataframe with clonotype statistics for each sample in clonosets_df</span>
<a id="__codelineno-0-34" name="__codelineno-0-34"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-35" name="__codelineno-0-35"></a>
<a id="__codelineno-0-36" name="__codelineno-0-36"></a>    <span class="n">df</span> <span class="o">=</span> <span class="n">generic_calculation</span><span class="p">(</span><span class="n">clonosets_df</span><span class="p">,</span> <span class="n">calculate_clonoset_stats_cl</span><span class="p">,</span> <span class="n">clonoset_filter</span><span class="o">=</span><span class="n">cl_filter</span><span class="p">,</span> <span class="n">program_name</span><span class="o">=</span><span class="s2">&quot;CalcClonosetStats&quot;</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">)</span>
<a id="__codelineno-0-37" name="__codelineno-0-37"></a>    <span class="n">convert_dict</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;clones&quot;</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
<a id="__codelineno-0-38" name="__codelineno-0-38"></a>                    <span class="s2">&quot;clones_func&quot;</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
<a id="__codelineno-0-39" name="__codelineno-0-39"></a>                    <span class="s2">&quot;clones_func_singletons&quot;</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
<a id="__codelineno-0-40" name="__codelineno-0-40"></a>                    <span class="s2">&quot;clones_func_non_singletons&quot;</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
<a id="__codelineno-0-41" name="__codelineno-0-41"></a>                    <span class="s2">&quot;clones_nonfunc&quot;</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
<a id="__codelineno-0-42" name="__codelineno-0-42"></a>                    <span class="s2">&quot;reads&quot;</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
<a id="__codelineno-0-43" name="__codelineno-0-43"></a>                    <span class="s2">&quot;reads_func&quot;</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
<a id="__codelineno-0-44" name="__codelineno-0-44"></a>                    <span class="s2">&quot;reads_nonfunc&quot;</span><span class="p">:</span> <span class="nb">int</span><span class="p">}</span>
<a id="__codelineno-0-45" name="__codelineno-0-45"></a>    <span class="k">if</span> <span class="ow">not</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;umi&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">isnull</span><span class="p">()</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">any</span><span class="p">():</span>
<a id="__codelineno-0-46" name="__codelineno-0-46"></a>        <span class="n">convert_dict</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s2">&quot;umi&quot;</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
<a id="__codelineno-0-47" name="__codelineno-0-47"></a>                        <span class="s2">&quot;umi_func&quot;</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
<a id="__codelineno-0-48" name="__codelineno-0-48"></a>                        <span class="s2">&quot;umi_nonfunc&quot;</span><span class="p">:</span> <span class="nb">int</span><span class="p">})</span>
<a id="__codelineno-0-49" name="__codelineno-0-49"></a>
<a id="__codelineno-0-50" name="__codelineno-0-50"></a>    <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">convert_dict</span><span class="p">)</span>
<a id="__codelineno-0-51" name="__codelineno-0-51"></a>    <span class="k">return</span> <span class="n">df</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h4 id="stats.calc_diversity_stats" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">calc_diversity_stats</span><span class="p">(</span><span class="n">clonosets_df</span><span class="p">,</span> <span class="n">cl_filter</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">iterations</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">seed</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">drop_small_samples</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span></code>

</h4>


    <div class="doc doc-contents ">

        <p>Calculates <code>observed diversity</code>, <code>Shannon-Wiener</code> and <code>normalized Shannon-Wiener</code> index for
each clonoset in <code>clonosets_df</code>.
<code>observed diversity</code> - total number of unique clonotypes in a given clonoset
<code>Shannon-Wiener</code> - mixed evenness and diversity metric
<code>normalized Shannon-Wiener</code> - evenness metric.
It is highly recommnded to use equal downsampling for all input clonosets for </p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>clonosets_df</code>
            </td>
            <td>
                  <code><span title="pandas.DataFrame">DataFrame</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>dataframe, containing two required columns: 
<code>sample_id</code> and <code>filename</code>. Also recommended to have <code>chain</code> column in this DF.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>segment</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>possible values are <code>v</code>, <code>j</code> or <code>c</code>. Defaults to "v".</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>cl_filter</code>
            </td>
            <td>
                  <code><span title="repseq.clone_filter.Filter">Filter</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>clonoset filter - object from <code>clone_filter.py</code> module.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>table</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>table type - <code>long</code> or <code>wide</code>. Defaults to "long".</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>pd.DataFrame: 'long' or 'wide'. If 'long' it contains four columns, as stated in
the function description. If 'wide' - then it has all possible segments in 
column names, sample_id's - in rows and usage in each cell in the table.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>repseq/stats.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-132">132</a></span>
<span class="normal"><a href="#__codelineno-0-133">133</a></span>
<span class="normal"><a href="#__codelineno-0-134">134</a></span>
<span class="normal"><a href="#__codelineno-0-135">135</a></span>
<span class="normal"><a href="#__codelineno-0-136">136</a></span>
<span class="normal"><a href="#__codelineno-0-137">137</a></span>
<span class="normal"><a href="#__codelineno-0-138">138</a></span>
<span class="normal"><a href="#__codelineno-0-139">139</a></span>
<span class="normal"><a href="#__codelineno-0-140">140</a></span>
<span class="normal"><a href="#__codelineno-0-141">141</a></span>
<span class="normal"><a href="#__codelineno-0-142">142</a></span>
<span class="normal"><a href="#__codelineno-0-143">143</a></span>
<span class="normal"><a href="#__codelineno-0-144">144</a></span>
<span class="normal"><a href="#__codelineno-0-145">145</a></span>
<span class="normal"><a href="#__codelineno-0-146">146</a></span>
<span class="normal"><a href="#__codelineno-0-147">147</a></span>
<span class="normal"><a href="#__codelineno-0-148">148</a></span>
<span class="normal"><a href="#__codelineno-0-149">149</a></span>
<span class="normal"><a href="#__codelineno-0-150">150</a></span>
<span class="normal"><a href="#__codelineno-0-151">151</a></span>
<span class="normal"><a href="#__codelineno-0-152">152</a></span>
<span class="normal"><a href="#__codelineno-0-153">153</a></span>
<span class="normal"><a href="#__codelineno-0-154">154</a></span>
<span class="normal"><a href="#__codelineno-0-155">155</a></span>
<span class="normal"><a href="#__codelineno-0-156">156</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-132" name="__codelineno-0-132"></a><span class="k">def</span><span class="w"> </span><span class="nf">calc_diversity_stats</span><span class="p">(</span><span class="n">clonosets_df</span><span class="p">,</span> <span class="n">cl_filter</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">iterations</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">seed</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">drop_small_samples</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
<a id="__codelineno-0-133" name="__codelineno-0-133"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-134" name="__codelineno-0-134"></a><span class="sd">    Calculates `observed diversity`, `Shannon-Wiener` and `normalized Shannon-Wiener` index for</span>
<a id="__codelineno-0-135" name="__codelineno-0-135"></a><span class="sd">    each clonoset in `clonosets_df`.</span>
<a id="__codelineno-0-136" name="__codelineno-0-136"></a><span class="sd">    `observed diversity` - total number of unique clonotypes in a given clonoset</span>
<a id="__codelineno-0-137" name="__codelineno-0-137"></a><span class="sd">    `Shannon-Wiener` - mixed evenness and diversity metric</span>
<a id="__codelineno-0-138" name="__codelineno-0-138"></a><span class="sd">    `normalized Shannon-Wiener` - evenness metric.</span>
<a id="__codelineno-0-139" name="__codelineno-0-139"></a><span class="sd">    It is highly recommnded to use equal downsampling for all input clonosets for </span>
<a id="__codelineno-0-140" name="__codelineno-0-140"></a>
<a id="__codelineno-0-141" name="__codelineno-0-141"></a><span class="sd">    Args:</span>
<a id="__codelineno-0-142" name="__codelineno-0-142"></a><span class="sd">        clonosets_df (pd.DataFrame): dataframe, containing two required columns: </span>
<a id="__codelineno-0-143" name="__codelineno-0-143"></a><span class="sd">            `sample_id` and `filename`. Also recommended to have `chain` column in this DF.</span>
<a id="__codelineno-0-144" name="__codelineno-0-144"></a><span class="sd">        segment (str, optional): possible values are `v`, `j` or `c`. Defaults to &quot;v&quot;.</span>
<a id="__codelineno-0-145" name="__codelineno-0-145"></a><span class="sd">        cl_filter (Filter, optional): clonoset filter - object from `clone_filter.py` module.</span>
<a id="__codelineno-0-146" name="__codelineno-0-146"></a><span class="sd">        table (str, optional): table type - `long` or `wide`. Defaults to &quot;long&quot;.</span>
<a id="__codelineno-0-147" name="__codelineno-0-147"></a>
<a id="__codelineno-0-148" name="__codelineno-0-148"></a>
<a id="__codelineno-0-149" name="__codelineno-0-149"></a><span class="sd">    Returns:</span>
<a id="__codelineno-0-150" name="__codelineno-0-150"></a><span class="sd">        pd.DataFrame: &#39;long&#39; or &#39;wide&#39;. If &#39;long&#39; it contains four columns, as stated in</span>
<a id="__codelineno-0-151" name="__codelineno-0-151"></a><span class="sd">            the function description. If &#39;wide&#39; - then it has all possible segments in </span>
<a id="__codelineno-0-152" name="__codelineno-0-152"></a><span class="sd">            column names, sample_id&#39;s - in rows and usage in each cell in the table.</span>
<a id="__codelineno-0-153" name="__codelineno-0-153"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-154" name="__codelineno-0-154"></a>    <span class="n">df</span> <span class="o">=</span> <span class="n">generic_calculation</span><span class="p">(</span><span class="n">clonosets_df</span><span class="p">,</span> <span class="n">calculate_diversity_stats_cl</span><span class="p">,</span> <span class="n">clonoset_filter</span><span class="o">=</span><span class="n">cl_filter</span><span class="p">,</span>
<a id="__codelineno-0-155" name="__codelineno-0-155"></a>                             <span class="n">program_name</span><span class="o">=</span><span class="s2">&quot;CalcDiversityStats&quot;</span><span class="p">,</span> <span class="n">iterations</span><span class="o">=</span><span class="n">iterations</span><span class="p">,</span> <span class="n">seed</span><span class="o">=</span><span class="n">seed</span><span class="p">,</span> <span class="n">drop_small_samples</span><span class="o">=</span><span class="n">drop_small_samples</span><span class="p">)</span>
<a id="__codelineno-0-156" name="__codelineno-0-156"></a>    <span class="k">return</span> <span class="n">df</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h4 id="stats.calc_segment_usage" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">calc_segment_usage</span><span class="p">(</span><span class="n">clonosets_df</span><span class="p">,</span> <span class="n">segment</span><span class="o">=</span><span class="s1">&#39;v&#39;</span><span class="p">,</span> <span class="n">cl_filter</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">table</span><span class="o">=</span><span class="s1">&#39;long&#39;</span><span class="p">,</span> <span class="n">by_count</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span></code>

</h4>


    <div class="doc doc-contents ">

        <p>Calculates segment (<code>V</code>, <code>J</code>, or <code>C</code>) usage for several samples. By default outputs
'long' table with four columns: segment name, <code>usage</code>, <code>sample_id</code> and <code>chain</code>.
It also may take a clone_filter as input: <code>cl_filter</code> from <code>clone_filter</code> module.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>clonosets_df</code>
            </td>
            <td>
                  <code><span title="pandas.DataFrame">DataFrame</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>dataframe, containing two required columns: 
<code>sample_id</code> and <code>filename</code>. Also recommended to have <code>chain</code> column in this DF.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>segment</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>possible values are <code>v</code>, <code>j</code> or <code>c</code>. Defaults to "v".</p>
              </div>
            </td>
            <td>
                  <code>&#39;v&#39;</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>cl_filter</code>
            </td>
            <td>
                  <code><span title="repseq.clone_filter.Filter">Filter</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>clonoset filter - object from <code>clone_filter.py</code> module.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>table</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>table type - <code>long</code> or <code>wide</code>. Defaults to "long".</p>
              </div>
            </td>
            <td>
                  <code>&#39;long&#39;</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>pd.DataFrame: 'long' or 'wide'. If 'long' it contains four columns, as stated in
the function description. If 'wide' - then it has all possible segments in 
column names, sample_id's - in rows and usage in each cell in the table.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>repseq/stats.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-53">53</a></span>
<span class="normal"><a href="#__codelineno-0-54">54</a></span>
<span class="normal"><a href="#__codelineno-0-55">55</a></span>
<span class="normal"><a href="#__codelineno-0-56">56</a></span>
<span class="normal"><a href="#__codelineno-0-57">57</a></span>
<span class="normal"><a href="#__codelineno-0-58">58</a></span>
<span class="normal"><a href="#__codelineno-0-59">59</a></span>
<span class="normal"><a href="#__codelineno-0-60">60</a></span>
<span class="normal"><a href="#__codelineno-0-61">61</a></span>
<span class="normal"><a href="#__codelineno-0-62">62</a></span>
<span class="normal"><a href="#__codelineno-0-63">63</a></span>
<span class="normal"><a href="#__codelineno-0-64">64</a></span>
<span class="normal"><a href="#__codelineno-0-65">65</a></span>
<span class="normal"><a href="#__codelineno-0-66">66</a></span>
<span class="normal"><a href="#__codelineno-0-67">67</a></span>
<span class="normal"><a href="#__codelineno-0-68">68</a></span>
<span class="normal"><a href="#__codelineno-0-69">69</a></span>
<span class="normal"><a href="#__codelineno-0-70">70</a></span>
<span class="normal"><a href="#__codelineno-0-71">71</a></span>
<span class="normal"><a href="#__codelineno-0-72">72</a></span>
<span class="normal"><a href="#__codelineno-0-73">73</a></span>
<span class="normal"><a href="#__codelineno-0-74">74</a></span>
<span class="normal"><a href="#__codelineno-0-75">75</a></span>
<span class="normal"><a href="#__codelineno-0-76">76</a></span>
<span class="normal"><a href="#__codelineno-0-77">77</a></span>
<span class="normal"><a href="#__codelineno-0-78">78</a></span>
<span class="normal"><a href="#__codelineno-0-79">79</a></span>
<span class="normal"><a href="#__codelineno-0-80">80</a></span>
<span class="normal"><a href="#__codelineno-0-81">81</a></span>
<span class="normal"><a href="#__codelineno-0-82">82</a></span>
<span class="normal"><a href="#__codelineno-0-83">83</a></span>
<span class="normal"><a href="#__codelineno-0-84">84</a></span>
<span class="normal"><a href="#__codelineno-0-85">85</a></span>
<span class="normal"><a href="#__codelineno-0-86">86</a></span>
<span class="normal"><a href="#__codelineno-0-87">87</a></span>
<span class="normal"><a href="#__codelineno-0-88">88</a></span>
<span class="normal"><a href="#__codelineno-0-89">89</a></span>
<span class="normal"><a href="#__codelineno-0-90">90</a></span>
<span class="normal"><a href="#__codelineno-0-91">91</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-53" name="__codelineno-0-53"></a><span class="k">def</span><span class="w"> </span><span class="nf">calc_segment_usage</span><span class="p">(</span><span class="n">clonosets_df</span><span class="p">,</span> <span class="n">segment</span><span class="o">=</span><span class="s2">&quot;v&quot;</span><span class="p">,</span> <span class="n">cl_filter</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">table</span><span class="o">=</span><span class="s2">&quot;long&quot;</span><span class="p">,</span> <span class="n">by_count</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<a id="__codelineno-0-54" name="__codelineno-0-54"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-55" name="__codelineno-0-55"></a><span class="sd">    Calculates segment (`V`, `J`, or `C`) usage for several samples. By default outputs</span>
<a id="__codelineno-0-56" name="__codelineno-0-56"></a><span class="sd">    &#39;long&#39; table with four columns: segment name, `usage`, `sample_id` and `chain`.</span>
<a id="__codelineno-0-57" name="__codelineno-0-57"></a><span class="sd">    It also may take a clone_filter as input: `cl_filter` from `clone_filter` module.</span>
<a id="__codelineno-0-58" name="__codelineno-0-58"></a>
<a id="__codelineno-0-59" name="__codelineno-0-59"></a>
<a id="__codelineno-0-60" name="__codelineno-0-60"></a><span class="sd">    Args:</span>
<a id="__codelineno-0-61" name="__codelineno-0-61"></a><span class="sd">        clonosets_df (pd.DataFrame): dataframe, containing two required columns: </span>
<a id="__codelineno-0-62" name="__codelineno-0-62"></a><span class="sd">            `sample_id` and `filename`. Also recommended to have `chain` column in this DF.</span>
<a id="__codelineno-0-63" name="__codelineno-0-63"></a><span class="sd">        segment (str, optional): possible values are `v`, `j` or `c`. Defaults to &quot;v&quot;.</span>
<a id="__codelineno-0-64" name="__codelineno-0-64"></a><span class="sd">        cl_filter (Filter, optional): clonoset filter - object from `clone_filter.py` module.</span>
<a id="__codelineno-0-65" name="__codelineno-0-65"></a><span class="sd">        table (str, optional): table type - `long` or `wide`. Defaults to &quot;long&quot;.</span>
<a id="__codelineno-0-66" name="__codelineno-0-66"></a>
<a id="__codelineno-0-67" name="__codelineno-0-67"></a>
<a id="__codelineno-0-68" name="__codelineno-0-68"></a><span class="sd">    Returns:</span>
<a id="__codelineno-0-69" name="__codelineno-0-69"></a><span class="sd">        pd.DataFrame: &#39;long&#39; or &#39;wide&#39;. If &#39;long&#39; it contains four columns, as stated in</span>
<a id="__codelineno-0-70" name="__codelineno-0-70"></a><span class="sd">            the function description. If &#39;wide&#39; - then it has all possible segments in </span>
<a id="__codelineno-0-71" name="__codelineno-0-71"></a><span class="sd">            column names, sample_id&#39;s - in rows and usage in each cell in the table.</span>
<a id="__codelineno-0-72" name="__codelineno-0-72"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-73" name="__codelineno-0-73"></a>
<a id="__codelineno-0-74" name="__codelineno-0-74"></a>
<a id="__codelineno-0-75" name="__codelineno-0-75"></a>    <span class="k">if</span> <span class="n">cl_filter</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-76" name="__codelineno-0-76"></a>        <span class="n">cl_filter</span> <span class="o">=</span> <span class="n">Filter</span><span class="p">()</span>
<a id="__codelineno-0-77" name="__codelineno-0-77"></a>
<a id="__codelineno-0-78" name="__codelineno-0-78"></a>    <span class="n">table_options</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;long&quot;</span><span class="p">,</span> <span class="s2">&quot;wide&quot;</span><span class="p">]</span>
<a id="__codelineno-0-79" name="__codelineno-0-79"></a>    <span class="k">if</span> <span class="n">table</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">table_options</span><span class="p">:</span>
<a id="__codelineno-0-80" name="__codelineno-0-80"></a>        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unknown value for &#39;table&#39; parameter. Possible options: </span><span class="si">{</span><span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">table_options</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-0-81" name="__codelineno-0-81"></a>
<a id="__codelineno-0-82" name="__codelineno-0-82"></a>    <span class="n">possible_segments</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;v&quot;</span><span class="p">,</span> <span class="s2">&quot;j&quot;</span><span class="p">,</span> <span class="s2">&quot;c&quot;</span><span class="p">,</span> <span class="s2">&quot;vj&quot;</span><span class="p">,</span> <span class="s2">&quot;vlen&quot;</span><span class="p">,</span> <span class="s2">&quot;vjlen&quot;</span><span class="p">]</span>
<a id="__codelineno-0-83" name="__codelineno-0-83"></a>    <span class="n">segment</span> <span class="o">=</span> <span class="n">segment</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
<a id="__codelineno-0-84" name="__codelineno-0-84"></a>    <span class="k">if</span> <span class="n">segment</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">possible_segments</span><span class="p">:</span>
<a id="__codelineno-0-85" name="__codelineno-0-85"></a>        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Wrong segment value. Possible values: </span><span class="si">{</span><span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">possible_segments</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-0-86" name="__codelineno-0-86"></a>    <span class="n">df</span> <span class="o">=</span> <span class="n">generic_calculation</span><span class="p">(</span><span class="n">clonosets_df</span><span class="p">,</span> <span class="n">calc_segment_usage_cl</span><span class="p">,</span> <span class="n">clonoset_filter</span><span class="o">=</span><span class="n">cl_filter</span><span class="p">,</span> <span class="n">program_name</span><span class="o">=</span><span class="s2">&quot;CalcSegmentUsage&quot;</span><span class="p">,</span> <span class="n">segment</span><span class="o">=</span><span class="n">segment</span><span class="p">,</span> <span class="n">by_count</span><span class="o">=</span><span class="n">by_count</span><span class="p">)</span>
<a id="__codelineno-0-87" name="__codelineno-0-87"></a>    <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
<a id="__codelineno-0-88" name="__codelineno-0-88"></a>    <span class="k">if</span> <span class="n">table</span> <span class="o">==</span> <span class="s2">&quot;wide&quot;</span><span class="p">:</span>
<a id="__codelineno-0-89" name="__codelineno-0-89"></a>        <span class="k">return</span> <span class="n">df</span>
<a id="__codelineno-0-90" name="__codelineno-0-90"></a>    <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-91" name="__codelineno-0-91"></a>        <span class="k">return</span> <span class="n">df</span><span class="o">.</span><span class="n">melt</span><span class="p">(</span><span class="n">id_vars</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;sample_id&quot;</span><span class="p">,</span> <span class="s2">&quot;chain&quot;</span><span class="p">])</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;value&quot;</span><span class="p">:</span><span class="s2">&quot;usage&quot;</span><span class="p">,</span> <span class="s2">&quot;variable&quot;</span><span class="p">:</span><span class="n">segment</span><span class="p">})</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h4 id="stats.generic_calculation" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">generic_calculation</span><span class="p">(</span><span class="n">clonosets_df_in</span><span class="p">,</span> <span class="n">calc_function</span><span class="p">,</span> <span class="n">clonoset_filter</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">program_name</span><span class="o">=</span><span class="s1">&#39;Calculation&#39;</span><span class="p">,</span> <span class="n">iterations</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">seed</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">drop_small_samples</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">skip_checks</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></code>

</h4>


    <div class="doc doc-contents ">

        <p>Main function that applies batch calculations for multiple clonosets
using a <code>calc_function</code>. It checks inputs, checks if clonotype counts are 
coherent with downsample or top numbers in clonoset filter.
All filters and calc_function are applied to each clonoset in parallel, if
several cores are available.
After all calculations are finished, this function combines the results into 
one pd.DataFrame.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>clonosets_df</code>
            </td>
            <td>
                  <code><span title="pandas.DataFrame">DataFrame</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>dataframe, containing two required columns: 
<code>sample_id</code> and <code>filename</code>. Also recommended to have <code>chain</code> column in this DF.
<code>sample_id</code>'s or <code>sample_id</code>+<code>chain</code> combinations must be unique in this DF.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>calc_function</code>
            </td>
            <td>
                  <code><span title="function_name">function_name</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>function, applicable to a single clonoset (pd.DataFrame)
in VDJtools-like format that returns a dictionary of properties+values as output.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>cl_filter</code>
            </td>
            <td>
                  <code><span title="repseq.clone_filter.Filter">Filter</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>clonoset filter - object from <code>clone_filter.py</code> module.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>program_name</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>the name of applied calculation, it is shown in the progress-bar</p>
              </div>
            </td>
            <td>
                  <code>&#39;Calculation&#39;</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>iterations</code>
            </td>
            <td>
                  <code><span title="int">int</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>number of iterations to obtain mean values for calculations when
random processes (downsampling/mix_tails) in clonoset filter are applied.
Recommended to use 3-5 iterations.</p>
              </div>
            </td>
            <td>
                  <code>1</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>seed</code>
            </td>
            <td>
                  <code><span title="hashable">hashable</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>seed for random events (downsampling/mix_tails). It overrides the 
values, specified in <code>cl_filter</code>.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>drop_small_samples</code>
            </td>
            <td>
                  <code><span title="bool">bool</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p><code>True</code> - samples, that can't be downsampled or top-cropped
because of lack of counts/clonotypes will be dropped before the calculation.
<code>False</code> - small samples will be taken into account, but with fewer counts/clonotypes 
than those with enough counts/clonotypes.</p>
              </div>
            </td>
            <td>
                  <code>False</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
<th>Name</th>          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
<td><code>df</code></td>            <td>
                  <code><span title="pandas.DataFrame">DataFrame</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>resulting DataFrame, with <code>sample_id</code> and <code>chain</code> columns and properties
columns for each clonoset.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>repseq/stats.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-307">307</a></span>
<span class="normal"><a href="#__codelineno-0-308">308</a></span>
<span class="normal"><a href="#__codelineno-0-309">309</a></span>
<span class="normal"><a href="#__codelineno-0-310">310</a></span>
<span class="normal"><a href="#__codelineno-0-311">311</a></span>
<span class="normal"><a href="#__codelineno-0-312">312</a></span>
<span class="normal"><a href="#__codelineno-0-313">313</a></span>
<span class="normal"><a href="#__codelineno-0-314">314</a></span>
<span class="normal"><a href="#__codelineno-0-315">315</a></span>
<span class="normal"><a href="#__codelineno-0-316">316</a></span>
<span class="normal"><a href="#__codelineno-0-317">317</a></span>
<span class="normal"><a href="#__codelineno-0-318">318</a></span>
<span class="normal"><a href="#__codelineno-0-319">319</a></span>
<span class="normal"><a href="#__codelineno-0-320">320</a></span>
<span class="normal"><a href="#__codelineno-0-321">321</a></span>
<span class="normal"><a href="#__codelineno-0-322">322</a></span>
<span class="normal"><a href="#__codelineno-0-323">323</a></span>
<span class="normal"><a href="#__codelineno-0-324">324</a></span>
<span class="normal"><a href="#__codelineno-0-325">325</a></span>
<span class="normal"><a href="#__codelineno-0-326">326</a></span>
<span class="normal"><a href="#__codelineno-0-327">327</a></span>
<span class="normal"><a href="#__codelineno-0-328">328</a></span>
<span class="normal"><a href="#__codelineno-0-329">329</a></span>
<span class="normal"><a href="#__codelineno-0-330">330</a></span>
<span class="normal"><a href="#__codelineno-0-331">331</a></span>
<span class="normal"><a href="#__codelineno-0-332">332</a></span>
<span class="normal"><a href="#__codelineno-0-333">333</a></span>
<span class="normal"><a href="#__codelineno-0-334">334</a></span>
<span class="normal"><a href="#__codelineno-0-335">335</a></span>
<span class="normal"><a href="#__codelineno-0-336">336</a></span>
<span class="normal"><a href="#__codelineno-0-337">337</a></span>
<span class="normal"><a href="#__codelineno-0-338">338</a></span>
<span class="normal"><a href="#__codelineno-0-339">339</a></span>
<span class="normal"><a href="#__codelineno-0-340">340</a></span>
<span class="normal"><a href="#__codelineno-0-341">341</a></span>
<span class="normal"><a href="#__codelineno-0-342">342</a></span>
<span class="normal"><a href="#__codelineno-0-343">343</a></span>
<span class="normal"><a href="#__codelineno-0-344">344</a></span>
<span class="normal"><a href="#__codelineno-0-345">345</a></span>
<span class="normal"><a href="#__codelineno-0-346">346</a></span>
<span class="normal"><a href="#__codelineno-0-347">347</a></span>
<span class="normal"><a href="#__codelineno-0-348">348</a></span>
<span class="normal"><a href="#__codelineno-0-349">349</a></span>
<span class="normal"><a href="#__codelineno-0-350">350</a></span>
<span class="normal"><a href="#__codelineno-0-351">351</a></span>
<span class="normal"><a href="#__codelineno-0-352">352</a></span>
<span class="normal"><a href="#__codelineno-0-353">353</a></span>
<span class="normal"><a href="#__codelineno-0-354">354</a></span>
<span class="normal"><a href="#__codelineno-0-355">355</a></span>
<span class="normal"><a href="#__codelineno-0-356">356</a></span>
<span class="normal"><a href="#__codelineno-0-357">357</a></span>
<span class="normal"><a href="#__codelineno-0-358">358</a></span>
<span class="normal"><a href="#__codelineno-0-359">359</a></span>
<span class="normal"><a href="#__codelineno-0-360">360</a></span>
<span class="normal"><a href="#__codelineno-0-361">361</a></span>
<span class="normal"><a href="#__codelineno-0-362">362</a></span>
<span class="normal"><a href="#__codelineno-0-363">363</a></span>
<span class="normal"><a href="#__codelineno-0-364">364</a></span>
<span class="normal"><a href="#__codelineno-0-365">365</a></span>
<span class="normal"><a href="#__codelineno-0-366">366</a></span>
<span class="normal"><a href="#__codelineno-0-367">367</a></span>
<span class="normal"><a href="#__codelineno-0-368">368</a></span>
<span class="normal"><a href="#__codelineno-0-369">369</a></span>
<span class="normal"><a href="#__codelineno-0-370">370</a></span>
<span class="normal"><a href="#__codelineno-0-371">371</a></span>
<span class="normal"><a href="#__codelineno-0-372">372</a></span>
<span class="normal"><a href="#__codelineno-0-373">373</a></span>
<span class="normal"><a href="#__codelineno-0-374">374</a></span>
<span class="normal"><a href="#__codelineno-0-375">375</a></span>
<span class="normal"><a href="#__codelineno-0-376">376</a></span>
<span class="normal"><a href="#__codelineno-0-377">377</a></span>
<span class="normal"><a href="#__codelineno-0-378">378</a></span>
<span class="normal"><a href="#__codelineno-0-379">379</a></span>
<span class="normal"><a href="#__codelineno-0-380">380</a></span>
<span class="normal"><a href="#__codelineno-0-381">381</a></span>
<span class="normal"><a href="#__codelineno-0-382">382</a></span>
<span class="normal"><a href="#__codelineno-0-383">383</a></span>
<span class="normal"><a href="#__codelineno-0-384">384</a></span>
<span class="normal"><a href="#__codelineno-0-385">385</a></span>
<span class="normal"><a href="#__codelineno-0-386">386</a></span>
<span class="normal"><a href="#__codelineno-0-387">387</a></span>
<span class="normal"><a href="#__codelineno-0-388">388</a></span>
<span class="normal"><a href="#__codelineno-0-389">389</a></span>
<span class="normal"><a href="#__codelineno-0-390">390</a></span>
<span class="normal"><a href="#__codelineno-0-391">391</a></span>
<span class="normal"><a href="#__codelineno-0-392">392</a></span>
<span class="normal"><a href="#__codelineno-0-393">393</a></span>
<span class="normal"><a href="#__codelineno-0-394">394</a></span>
<span class="normal"><a href="#__codelineno-0-395">395</a></span>
<span class="normal"><a href="#__codelineno-0-396">396</a></span>
<span class="normal"><a href="#__codelineno-0-397">397</a></span>
<span class="normal"><a href="#__codelineno-0-398">398</a></span>
<span class="normal"><a href="#__codelineno-0-399">399</a></span>
<span class="normal"><a href="#__codelineno-0-400">400</a></span>
<span class="normal"><a href="#__codelineno-0-401">401</a></span>
<span class="normal"><a href="#__codelineno-0-402">402</a></span>
<span class="normal"><a href="#__codelineno-0-403">403</a></span>
<span class="normal"><a href="#__codelineno-0-404">404</a></span>
<span class="normal"><a href="#__codelineno-0-405">405</a></span>
<span class="normal"><a href="#__codelineno-0-406">406</a></span>
<span class="normal"><a href="#__codelineno-0-407">407</a></span>
<span class="normal"><a href="#__codelineno-0-408">408</a></span>
<span class="normal"><a href="#__codelineno-0-409">409</a></span>
<span class="normal"><a href="#__codelineno-0-410">410</a></span>
<span class="normal"><a href="#__codelineno-0-411">411</a></span>
<span class="normal"><a href="#__codelineno-0-412">412</a></span>
<span class="normal"><a href="#__codelineno-0-413">413</a></span>
<span class="normal"><a href="#__codelineno-0-414">414</a></span>
<span class="normal"><a href="#__codelineno-0-415">415</a></span>
<span class="normal"><a href="#__codelineno-0-416">416</a></span>
<span class="normal"><a href="#__codelineno-0-417">417</a></span>
<span class="normal"><a href="#__codelineno-0-418">418</a></span>
<span class="normal"><a href="#__codelineno-0-419">419</a></span>
<span class="normal"><a href="#__codelineno-0-420">420</a></span>
<span class="normal"><a href="#__codelineno-0-421">421</a></span>
<span class="normal"><a href="#__codelineno-0-422">422</a></span>
<span class="normal"><a href="#__codelineno-0-423">423</a></span>
<span class="normal"><a href="#__codelineno-0-424">424</a></span>
<span class="normal"><a href="#__codelineno-0-425">425</a></span>
<span class="normal"><a href="#__codelineno-0-426">426</a></span>
<span class="normal"><a href="#__codelineno-0-427">427</a></span>
<span class="normal"><a href="#__codelineno-0-428">428</a></span>
<span class="normal"><a href="#__codelineno-0-429">429</a></span>
<span class="normal"><a href="#__codelineno-0-430">430</a></span>
<span class="normal"><a href="#__codelineno-0-431">431</a></span>
<span class="normal"><a href="#__codelineno-0-432">432</a></span>
<span class="normal"><a href="#__codelineno-0-433">433</a></span>
<span class="normal"><a href="#__codelineno-0-434">434</a></span>
<span class="normal"><a href="#__codelineno-0-435">435</a></span>
<span class="normal"><a href="#__codelineno-0-436">436</a></span>
<span class="normal"><a href="#__codelineno-0-437">437</a></span>
<span class="normal"><a href="#__codelineno-0-438">438</a></span>
<span class="normal"><a href="#__codelineno-0-439">439</a></span>
<span class="normal"><a href="#__codelineno-0-440">440</a></span>
<span class="normal"><a href="#__codelineno-0-441">441</a></span>
<span class="normal"><a href="#__codelineno-0-442">442</a></span>
<span class="normal"><a href="#__codelineno-0-443">443</a></span>
<span class="normal"><a href="#__codelineno-0-444">444</a></span>
<span class="normal"><a href="#__codelineno-0-445">445</a></span>
<span class="normal"><a href="#__codelineno-0-446">446</a></span>
<span class="normal"><a href="#__codelineno-0-447">447</a></span>
<span class="normal"><a href="#__codelineno-0-448">448</a></span>
<span class="normal"><a href="#__codelineno-0-449">449</a></span>
<span class="normal"><a href="#__codelineno-0-450">450</a></span>
<span class="normal"><a href="#__codelineno-0-451">451</a></span>
<span class="normal"><a href="#__codelineno-0-452">452</a></span>
<span class="normal"><a href="#__codelineno-0-453">453</a></span>
<span class="normal"><a href="#__codelineno-0-454">454</a></span>
<span class="normal"><a href="#__codelineno-0-455">455</a></span>
<span class="normal"><a href="#__codelineno-0-456">456</a></span>
<span class="normal"><a href="#__codelineno-0-457">457</a></span>
<span class="normal"><a href="#__codelineno-0-458">458</a></span>
<span class="normal"><a href="#__codelineno-0-459">459</a></span>
<span class="normal"><a href="#__codelineno-0-460">460</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-307" name="__codelineno-0-307"></a><span class="k">def</span><span class="w"> </span><span class="nf">generic_calculation</span><span class="p">(</span><span class="n">clonosets_df_in</span><span class="p">,</span> <span class="n">calc_function</span><span class="p">,</span> <span class="n">clonoset_filter</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">program_name</span><span class="o">=</span><span class="s2">&quot;Calculation&quot;</span><span class="p">,</span> <span class="n">iterations</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">seed</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">drop_small_samples</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">skip_checks</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<a id="__codelineno-0-308" name="__codelineno-0-308"></a><span class="w">    </span><span class="sd">&#39;&#39;&#39;</span>
<a id="__codelineno-0-309" name="__codelineno-0-309"></a><span class="sd">    Main function that applies batch calculations for multiple clonosets</span>
<a id="__codelineno-0-310" name="__codelineno-0-310"></a><span class="sd">    using a `calc_function`. It checks inputs, checks if clonotype counts are </span>
<a id="__codelineno-0-311" name="__codelineno-0-311"></a><span class="sd">    coherent with downsample or top numbers in clonoset filter.</span>
<a id="__codelineno-0-312" name="__codelineno-0-312"></a><span class="sd">    All filters and calc_function are applied to each clonoset in parallel, if</span>
<a id="__codelineno-0-313" name="__codelineno-0-313"></a><span class="sd">    several cores are available.</span>
<a id="__codelineno-0-314" name="__codelineno-0-314"></a><span class="sd">    After all calculations are finished, this function combines the results into </span>
<a id="__codelineno-0-315" name="__codelineno-0-315"></a><span class="sd">    one pd.DataFrame.</span>
<a id="__codelineno-0-316" name="__codelineno-0-316"></a>
<a id="__codelineno-0-317" name="__codelineno-0-317"></a><span class="sd">    Args:</span>
<a id="__codelineno-0-318" name="__codelineno-0-318"></a><span class="sd">        clonosets_df (pd.DataFrame): dataframe, containing two required columns: </span>
<a id="__codelineno-0-319" name="__codelineno-0-319"></a><span class="sd">            `sample_id` and `filename`. Also recommended to have `chain` column in this DF.</span>
<a id="__codelineno-0-320" name="__codelineno-0-320"></a><span class="sd">            `sample_id`&#39;s or `sample_id`+`chain` combinations must be unique in this DF.</span>
<a id="__codelineno-0-321" name="__codelineno-0-321"></a><span class="sd">        calc_function (function_name): function, applicable to a single clonoset (pd.DataFrame)</span>
<a id="__codelineno-0-322" name="__codelineno-0-322"></a><span class="sd">            in VDJtools-like format that returns a dictionary of properties+values as output.</span>
<a id="__codelineno-0-323" name="__codelineno-0-323"></a><span class="sd">        cl_filter (Filter, optional): clonoset filter - object from `clone_filter.py` module.</span>
<a id="__codelineno-0-324" name="__codelineno-0-324"></a><span class="sd">        program_name (str): the name of applied calculation, it is shown in the progress-bar</span>
<a id="__codelineno-0-325" name="__codelineno-0-325"></a><span class="sd">        iterations (int): number of iterations to obtain mean values for calculations when</span>
<a id="__codelineno-0-326" name="__codelineno-0-326"></a><span class="sd">            random processes (downsampling/mix_tails) in clonoset filter are applied.</span>
<a id="__codelineno-0-327" name="__codelineno-0-327"></a><span class="sd">            Recommended to use 3-5 iterations.</span>
<a id="__codelineno-0-328" name="__codelineno-0-328"></a><span class="sd">        seed (hashable): seed for random events (downsampling/mix_tails). It overrides the </span>
<a id="__codelineno-0-329" name="__codelineno-0-329"></a><span class="sd">            values, specified in `cl_filter`.</span>
<a id="__codelineno-0-330" name="__codelineno-0-330"></a><span class="sd">        drop_small_samples (bool): `True` - samples, that can&#39;t be downsampled or top-cropped</span>
<a id="__codelineno-0-331" name="__codelineno-0-331"></a><span class="sd">            because of lack of counts/clonotypes will be dropped before the calculation.</span>
<a id="__codelineno-0-332" name="__codelineno-0-332"></a><span class="sd">            `False` - small samples will be taken into account, but with fewer counts/clonotypes </span>
<a id="__codelineno-0-333" name="__codelineno-0-333"></a><span class="sd">            than those with enough counts/clonotypes.</span>
<a id="__codelineno-0-334" name="__codelineno-0-334"></a>
<a id="__codelineno-0-335" name="__codelineno-0-335"></a><span class="sd">    Returns:</span>
<a id="__codelineno-0-336" name="__codelineno-0-336"></a><span class="sd">        df (pd.DataFrame): resulting DataFrame, with `sample_id` and `chain` columns and properties</span>
<a id="__codelineno-0-337" name="__codelineno-0-337"></a><span class="sd">            columns for each clonoset.</span>
<a id="__codelineno-0-338" name="__codelineno-0-338"></a>
<a id="__codelineno-0-339" name="__codelineno-0-339"></a><span class="sd">    &#39;&#39;&#39;</span>
<a id="__codelineno-0-340" name="__codelineno-0-340"></a>
<a id="__codelineno-0-341" name="__codelineno-0-341"></a>
<a id="__codelineno-0-342" name="__codelineno-0-342"></a>    <span class="n">columns_retain</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;sample_id&quot;</span><span class="p">]</span>
<a id="__codelineno-0-343" name="__codelineno-0-343"></a>    <span class="n">clonosets_df</span> <span class="o">=</span> <span class="n">clonosets_df_in</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
<a id="__codelineno-0-344" name="__codelineno-0-344"></a>
<a id="__codelineno-0-345" name="__codelineno-0-345"></a>    <span class="k">if</span> <span class="s2">&quot;sample_id&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">clonosets_df</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
<a id="__codelineno-0-346" name="__codelineno-0-346"></a>        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Clonoset_df does not contain required column &#39;sample_id&#39;&quot;</span><span class="p">)</span>
<a id="__codelineno-0-347" name="__codelineno-0-347"></a>    <span class="k">if</span> <span class="s2">&quot;filename&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">clonosets_df</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
<a id="__codelineno-0-348" name="__codelineno-0-348"></a>        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Clonoset_df does not contain required column &#39;filename&#39;&quot;</span><span class="p">)</span>
<a id="__codelineno-0-349" name="__codelineno-0-349"></a>
<a id="__codelineno-0-350" name="__codelineno-0-350"></a>    <span class="n">split_chain_after_calculation</span> <span class="o">=</span> <span class="kc">False</span>
<a id="__codelineno-0-351" name="__codelineno-0-351"></a>    <span class="k">if</span> <span class="s2">&quot;chain&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">clonosets_df</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
<a id="__codelineno-0-352" name="__codelineno-0-352"></a>        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">clonosets_df</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">clonosets_df</span><span class="o">.</span><span class="n">sample_id</span><span class="o">.</span><span class="n">unique</span><span class="p">()):</span>
<a id="__codelineno-0-353" name="__codelineno-0-353"></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Clonoset_df contains nonunique sample_ids&quot;</span><span class="p">)</span>
<a id="__codelineno-0-354" name="__codelineno-0-354"></a>    <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-355" name="__codelineno-0-355"></a>        <span class="n">columns_retain</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;chain&quot;</span><span class="p">)</span>
<a id="__codelineno-0-356" name="__codelineno-0-356"></a>        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">clonosets_df</span><span class="p">[[</span><span class="s2">&quot;sample_id&quot;</span><span class="p">,</span> <span class="s2">&quot;chain&quot;</span><span class="p">]]</span><span class="o">.</span><span class="n">drop_duplicates</span><span class="p">())</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">clonosets_df</span><span class="p">):</span>
<a id="__codelineno-0-357" name="__codelineno-0-357"></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Clonoset_df contains nonunique sample_id+chain combinations&quot;</span><span class="p">)</span>
<a id="__codelineno-0-358" name="__codelineno-0-358"></a>        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">clonosets_df</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">clonosets_df</span><span class="o">.</span><span class="n">sample_id</span><span class="o">.</span><span class="n">unique</span><span class="p">()):</span>
<a id="__codelineno-0-359" name="__codelineno-0-359"></a>            <span class="n">clonosets_df</span><span class="p">[</span><span class="s2">&quot;sample_id&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">clonosets_df</span><span class="p">[</span><span class="s2">&quot;sample_id&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot;_&quot;</span> <span class="o">+</span> <span class="n">clonosets_df</span><span class="p">[</span><span class="s2">&quot;chain&quot;</span><span class="p">]</span>
<a id="__codelineno-0-360" name="__codelineno-0-360"></a>            <span class="n">split_chain_after_calculation</span> <span class="o">=</span> <span class="kc">True</span>
<a id="__codelineno-0-361" name="__codelineno-0-361"></a>
<a id="__codelineno-0-362" name="__codelineno-0-362"></a>    <span class="n">random_filter</span> <span class="o">=</span> <span class="kc">False</span>
<a id="__codelineno-0-363" name="__codelineno-0-363"></a>    <span class="n">need_downsample</span> <span class="o">=</span> <span class="kc">False</span>
<a id="__codelineno-0-364" name="__codelineno-0-364"></a>    <span class="n">need_top</span> <span class="o">=</span> <span class="kc">False</span>
<a id="__codelineno-0-365" name="__codelineno-0-365"></a>
<a id="__codelineno-0-366" name="__codelineno-0-366"></a>    <span class="n">count_column_by_umi_and_functionality</span> <span class="o">=</span> <span class="p">{</span>
<a id="__codelineno-0-367" name="__codelineno-0-367"></a>            <span class="kc">True</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;a&quot;</span><span class="p">:</span> <span class="s2">&quot;umi&quot;</span><span class="p">,</span>
<a id="__codelineno-0-368" name="__codelineno-0-368"></a>                   <span class="s2">&quot;f&quot;</span><span class="p">:</span> <span class="s2">&quot;umi_func&quot;</span><span class="p">,</span>
<a id="__codelineno-0-369" name="__codelineno-0-369"></a>                   <span class="s2">&quot;n&quot;</span><span class="p">:</span> <span class="s2">&quot;umi_nonfunc&quot;</span><span class="p">},</span>
<a id="__codelineno-0-370" name="__codelineno-0-370"></a>            <span class="kc">False</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;a&quot;</span><span class="p">:</span> <span class="s2">&quot;reads&quot;</span><span class="p">,</span>
<a id="__codelineno-0-371" name="__codelineno-0-371"></a>                    <span class="s2">&quot;f&quot;</span><span class="p">:</span> <span class="s2">&quot;reads_func&quot;</span><span class="p">,</span>
<a id="__codelineno-0-372" name="__codelineno-0-372"></a>                    <span class="s2">&quot;n&quot;</span><span class="p">:</span> <span class="s2">&quot;reads_nonfunc&quot;</span><span class="p">}</span>
<a id="__codelineno-0-373" name="__codelineno-0-373"></a>        <span class="p">}</span>
<a id="__codelineno-0-374" name="__codelineno-0-374"></a>
<a id="__codelineno-0-375" name="__codelineno-0-375"></a>    <span class="n">clone_column_by_functionality</span> <span class="o">=</span> <span class="p">{</span>
<a id="__codelineno-0-376" name="__codelineno-0-376"></a>        <span class="s2">&quot;a&quot;</span><span class="p">:</span> <span class="s2">&quot;clones&quot;</span><span class="p">,</span>
<a id="__codelineno-0-377" name="__codelineno-0-377"></a>        <span class="s2">&quot;f&quot;</span><span class="p">:</span> <span class="s2">&quot;clones_func&quot;</span><span class="p">,</span>
<a id="__codelineno-0-378" name="__codelineno-0-378"></a>        <span class="s2">&quot;n&quot;</span><span class="p">:</span> <span class="s2">&quot;clones_nonfunc&quot;</span>
<a id="__codelineno-0-379" name="__codelineno-0-379"></a>    <span class="p">}</span>
<a id="__codelineno-0-380" name="__codelineno-0-380"></a>
<a id="__codelineno-0-381" name="__codelineno-0-381"></a>    <span class="n">exclude_samples</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
<a id="__codelineno-0-382" name="__codelineno-0-382"></a>
<a id="__codelineno-0-383" name="__codelineno-0-383"></a>
<a id="__codelineno-0-384" name="__codelineno-0-384"></a>    <span class="k">if</span> <span class="n">clonoset_filter</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">skip_checks</span><span class="p">:</span>
<a id="__codelineno-0-385" name="__codelineno-0-385"></a>        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">clonoset_filter</span><span class="o">.</span><span class="n">downsample_size</span><span class="p">,</span> <span class="nb">int</span><span class="p">):</span>
<a id="__codelineno-0-386" name="__codelineno-0-386"></a>            <span class="n">need_downsample</span> <span class="o">=</span> <span class="kc">True</span>
<a id="__codelineno-0-387" name="__codelineno-0-387"></a>        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">clonoset_filter</span><span class="o">.</span><span class="n">top</span><span class="p">,</span> <span class="nb">int</span><span class="p">):</span>
<a id="__codelineno-0-388" name="__codelineno-0-388"></a>            <span class="n">need_top</span> <span class="o">=</span> <span class="kc">True</span>
<a id="__codelineno-0-389" name="__codelineno-0-389"></a>        <span class="k">if</span> <span class="n">need_downsample</span> <span class="ow">or</span> <span class="n">need_top</span><span class="p">:</span>
<a id="__codelineno-0-390" name="__codelineno-0-390"></a>            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Calcultating stats for original clonosets</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="s2">&quot;_&quot;</span><span class="o">*</span><span class="mi">41</span><span class="p">)</span>
<a id="__codelineno-0-391" name="__codelineno-0-391"></a>            <span class="n">stats</span> <span class="o">=</span> <span class="n">calc_clonoset_stats</span><span class="p">(</span><span class="n">clonosets_df</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">)</span>
<a id="__codelineno-0-392" name="__codelineno-0-392"></a>            <span class="n">downsample_column</span> <span class="o">=</span> <span class="n">count_column_by_umi_and_functionality</span><span class="p">[</span><span class="n">clonoset_filter</span><span class="o">.</span><span class="n">by_umi</span><span class="p">][</span><span class="n">clonoset_filter</span><span class="o">.</span><span class="n">functionality</span><span class="p">]</span>
<a id="__codelineno-0-393" name="__codelineno-0-393"></a>            <span class="n">read_column</span> <span class="o">=</span> <span class="n">count_column_by_umi_and_functionality</span><span class="p">[</span><span class="kc">False</span><span class="p">][</span><span class="n">clonoset_filter</span><span class="o">.</span><span class="n">functionality</span><span class="p">]</span>
<a id="__codelineno-0-394" name="__codelineno-0-394"></a>            <span class="n">top_column</span> <span class="o">=</span> <span class="n">clone_column_by_functionality</span><span class="p">[</span><span class="n">clonoset_filter</span><span class="o">.</span><span class="n">functionality</span><span class="p">]</span>
<a id="__codelineno-0-395" name="__codelineno-0-395"></a>
<a id="__codelineno-0-396" name="__codelineno-0-396"></a>        <span class="k">if</span> <span class="n">need_downsample</span><span class="p">:</span>
<a id="__codelineno-0-397" name="__codelineno-0-397"></a>            <span class="n">count_by_reads_samples</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
<a id="__codelineno-0-398" name="__codelineno-0-398"></a>            <span class="k">if</span> <span class="n">stats</span><span class="p">[</span><span class="n">downsample_column</span><span class="p">]</span><span class="o">.</span><span class="n">isnull</span><span class="p">()</span><span class="o">.</span><span class="n">any</span><span class="p">()</span><span class="o">.</span><span class="n">any</span><span class="p">():</span>
<a id="__codelineno-0-399" name="__codelineno-0-399"></a>                <span class="n">nan_downsample_samples</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">stats</span><span class="p">[</span><span class="n">stats</span><span class="p">[</span><span class="n">downsample_column</span><span class="p">]</span><span class="o">.</span><span class="n">isna</span><span class="p">()]</span><span class="o">.</span><span class="n">sample_id</span><span class="p">)</span>
<a id="__codelineno-0-400" name="__codelineno-0-400"></a>                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;WARNING! Following samples have NaN downsample counts (&#39;</span><span class="si">{</span><span class="n">downsample_column</span><span class="si">}</span><span class="s2">&#39;): </span><span class="si">{</span><span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">nan_downsample_samples</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-0-401" name="__codelineno-0-401"></a>                <span class="k">if</span> <span class="n">clonoset_filter</span><span class="o">.</span><span class="n">by_umi</span><span class="p">:</span>
<a id="__codelineno-0-402" name="__codelineno-0-402"></a>                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;These samples will be counted by reads instead&quot;</span><span class="p">)</span>
<a id="__codelineno-0-403" name="__codelineno-0-403"></a>                    <span class="n">count_by_reads_samples</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">nan_downsample_samples</span><span class="p">)</span>
<a id="__codelineno-0-404" name="__codelineno-0-404"></a>                <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-405" name="__codelineno-0-405"></a>                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;These samples will be excluded from further calculations.&quot;</span><span class="p">)</span>
<a id="__codelineno-0-406" name="__codelineno-0-406"></a>                    <span class="n">exclude_samples</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">nan_downsample_samples</span><span class="p">)</span>
<a id="__codelineno-0-407" name="__codelineno-0-407"></a>            <span class="n">not_enough_count_df</span> <span class="o">=</span> <span class="n">stats</span><span class="p">[(</span><span class="n">stats</span><span class="p">[</span><span class="n">downsample_column</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">clonoset_filter</span><span class="o">.</span><span class="n">downsample_size</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="o">~</span><span class="n">stats</span><span class="o">.</span><span class="n">sample_id</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">count_by_reads_samples</span><span class="p">))</span> <span class="o">|</span>
<a id="__codelineno-0-408" name="__codelineno-0-408"></a>                                        <span class="p">(</span><span class="n">stats</span><span class="p">[</span><span class="n">read_column</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">clonoset_filter</span><span class="o">.</span><span class="n">downsample_size</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">stats</span><span class="o">.</span><span class="n">sample_id</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">count_by_reads_samples</span><span class="p">))]</span>
<a id="__codelineno-0-409" name="__codelineno-0-409"></a>            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">not_enough_count_df</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
<a id="__codelineno-0-410" name="__codelineno-0-410"></a>                <span class="n">not_enough_count_samples</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">not_enough_count_df</span><span class="o">.</span><span class="n">sample_id</span><span class="p">)</span>
<a id="__codelineno-0-411" name="__codelineno-0-411"></a>                <span class="k">if</span> <span class="ow">not</span> <span class="n">drop_small_samples</span><span class="p">:</span>
<a id="__codelineno-0-412" name="__codelineno-0-412"></a>                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;WARNING! Following samples have not enough downsample counts (&#39;</span><span class="si">{</span><span class="n">downsample_column</span><span class="si">}</span><span class="s2">&#39; &lt; </span><span class="si">{</span><span class="n">clonoset_filter</span><span class="o">.</span><span class="n">downsample_size</span><span class="si">}</span><span class="s2">): </span><span class="si">{</span><span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">not_enough_count_samples</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-0-413" name="__codelineno-0-413"></a>                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;These samples will be excluded from further calculations.&quot;</span><span class="p">)</span>
<a id="__codelineno-0-414" name="__codelineno-0-414"></a>                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;To suppress the warnings set drop_small_samples=True&quot;</span><span class="p">)</span>
<a id="__codelineno-0-415" name="__codelineno-0-415"></a>                <span class="n">exclude_samples</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">not_enough_count_samples</span><span class="p">)</span>
<a id="__codelineno-0-416" name="__codelineno-0-416"></a>        <span class="k">if</span> <span class="n">need_top</span><span class="p">:</span>
<a id="__codelineno-0-417" name="__codelineno-0-417"></a>            <span class="k">if</span> <span class="n">stats</span><span class="p">[</span><span class="n">downsample_column</span><span class="p">]</span><span class="o">.</span><span class="n">isnull</span><span class="p">()</span><span class="o">.</span><span class="n">any</span><span class="p">()</span><span class="o">.</span><span class="n">any</span><span class="p">():</span>
<a id="__codelineno-0-418" name="__codelineno-0-418"></a>                <span class="n">nan_downsample_samples</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">stats</span><span class="p">[</span><span class="n">stats</span><span class="p">[</span><span class="n">downsample_column</span><span class="p">]</span><span class="o">.</span><span class="n">isna</span><span class="p">()]</span><span class="o">.</span><span class="n">sample_id</span><span class="p">)</span>
<a id="__codelineno-0-419" name="__codelineno-0-419"></a>                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;WARNING! Following samples have NaN counts (&#39;</span><span class="si">{</span><span class="n">downsample_column</span><span class="si">}</span><span class="s2">&#39;): </span><span class="si">{</span><span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">nan_downsample_samples</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-0-420" name="__codelineno-0-420"></a>                <span class="k">if</span> <span class="n">clonoset_filter</span><span class="o">.</span><span class="n">by_umi</span><span class="p">:</span>
<a id="__codelineno-0-421" name="__codelineno-0-421"></a>                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;These samples will be counted by reads instead&quot;</span><span class="p">)</span>
<a id="__codelineno-0-422" name="__codelineno-0-422"></a>                <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-423" name="__codelineno-0-423"></a>                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;These samples will be excluded from further calculations.&quot;</span><span class="p">)</span>
<a id="__codelineno-0-424" name="__codelineno-0-424"></a>                    <span class="n">exclude_samples</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">nan_downsample_samples</span><span class="p">)</span>
<a id="__codelineno-0-425" name="__codelineno-0-425"></a>            <span class="n">not_enough_clones_df</span> <span class="o">=</span> <span class="n">stats</span><span class="p">[</span><span class="n">stats</span><span class="p">[</span><span class="n">top_column</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">clonoset_filter</span><span class="o">.</span><span class="n">top</span><span class="p">]</span>
<a id="__codelineno-0-426" name="__codelineno-0-426"></a>            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">not_enough_clones_df</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
<a id="__codelineno-0-427" name="__codelineno-0-427"></a>                <span class="n">not_enough_clones_samples</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">not_enough_clones_df</span><span class="o">.</span><span class="n">sample_id</span><span class="p">)</span>
<a id="__codelineno-0-428" name="__codelineno-0-428"></a>                <span class="k">if</span> <span class="ow">not</span> <span class="n">drop_small_samples</span><span class="p">:</span>
<a id="__codelineno-0-429" name="__codelineno-0-429"></a>                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;WARNING! Following samples have not enough clonotypes (&#39;</span><span class="si">{</span><span class="n">top_column</span><span class="si">}</span><span class="s2">&#39; &lt; </span><span class="si">{</span><span class="n">clonoset_filter</span><span class="o">.</span><span class="n">top</span><span class="si">}</span><span class="s2">): </span><span class="si">{</span><span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">not_enough_clones_samples</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-0-430" name="__codelineno-0-430"></a>                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;These samples will be excluded from further calculations.&quot;</span><span class="p">)</span>
<a id="__codelineno-0-431" name="__codelineno-0-431"></a>                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;To suppress the warnings set drop_small_samples=True&quot;</span><span class="p">)</span>
<a id="__codelineno-0-432" name="__codelineno-0-432"></a>                <span class="n">exclude_samples</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">not_enough_clones_samples</span><span class="p">)</span>
<a id="__codelineno-0-433" name="__codelineno-0-433"></a>
<a id="__codelineno-0-434" name="__codelineno-0-434"></a>
<a id="__codelineno-0-435" name="__codelineno-0-435"></a>        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">clonoset_filter</span><span class="o">.</span><span class="n">downsample_size</span><span class="p">,</span> <span class="nb">int</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">clonoset_filter</span><span class="o">.</span><span class="n">top</span><span class="p">,</span> <span class="nb">int</span><span class="p">)</span> <span class="ow">and</span> <span class="n">clonoset_filter</span><span class="o">.</span><span class="n">mix_tails</span><span class="p">):</span>
<a id="__codelineno-0-436" name="__codelineno-0-436"></a>            <span class="n">random_filter</span> <span class="o">=</span> <span class="kc">True</span>
<a id="__codelineno-0-437" name="__codelineno-0-437"></a>
<a id="__codelineno-0-438" name="__codelineno-0-438"></a>
<a id="__codelineno-0-439" name="__codelineno-0-439"></a>    <span class="k">if</span> <span class="n">random_filter</span> <span class="ow">and</span> <span class="n">seed</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-440" name="__codelineno-0-440"></a>        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;WARNING! Random filter is applied, but random seed is not set. This may lead to non-reproducible results.&quot;</span><span class="p">)</span>
<a id="__codelineno-0-441" name="__codelineno-0-441"></a>        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;You may set the seed (of any hashable type) by specifying &#39;seed=&#39;&quot;</span><span class="p">)</span>
<a id="__codelineno-0-442" name="__codelineno-0-442"></a>
<a id="__codelineno-0-443" name="__codelineno-0-443"></a>    <span class="n">tasks</span> <span class="o">=</span> <span class="p">[]</span>
<a id="__codelineno-0-444" name="__codelineno-0-444"></a>    <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">r</span> <span class="ow">in</span> <span class="n">clonosets_df</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>
<a id="__codelineno-0-445" name="__codelineno-0-445"></a>        <span class="n">sample_id</span> <span class="o">=</span> <span class="n">r</span><span class="p">[</span><span class="s2">&quot;sample_id&quot;</span><span class="p">]</span>
<a id="__codelineno-0-446" name="__codelineno-0-446"></a>        <span class="n">filename</span> <span class="o">=</span> <span class="n">r</span><span class="p">[</span><span class="s2">&quot;filename&quot;</span><span class="p">]</span>
<a id="__codelineno-0-447" name="__codelineno-0-447"></a>        <span class="k">if</span> <span class="n">sample_id</span> <span class="ow">in</span> <span class="n">exclude_samples</span><span class="p">:</span>
<a id="__codelineno-0-448" name="__codelineno-0-448"></a>            <span class="k">continue</span>
<a id="__codelineno-0-449" name="__codelineno-0-449"></a>        <span class="k">if</span> <span class="n">clonoset_filter</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-450" name="__codelineno-0-450"></a>            <span class="n">task</span> <span class="o">=</span> <span class="p">(</span><span class="n">sample_id</span><span class="p">,</span> <span class="n">filename</span><span class="p">,</span> <span class="n">calc_function</span><span class="p">,</span> <span class="n">clonoset_filter</span><span class="o">.</span><span class="n">spawn</span><span class="p">(),</span> <span class="n">iterations</span><span class="p">,</span> <span class="n">seed</span><span class="p">,</span> <span class="n">program_name</span><span class="p">,</span> <span class="n">random_filter</span><span class="p">,</span> <span class="n">kwargs</span><span class="p">)</span>
<a id="__codelineno-0-451" name="__codelineno-0-451"></a>        <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-452" name="__codelineno-0-452"></a>            <span class="n">task</span> <span class="o">=</span> <span class="p">(</span><span class="n">sample_id</span><span class="p">,</span> <span class="n">filename</span><span class="p">,</span> <span class="n">calc_function</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="n">iterations</span><span class="p">,</span> <span class="n">seed</span><span class="p">,</span> <span class="n">program_name</span><span class="p">,</span> <span class="n">random_filter</span><span class="p">,</span> <span class="n">kwargs</span><span class="p">)</span>
<a id="__codelineno-0-453" name="__codelineno-0-453"></a>        <span class="n">tasks</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">task</span><span class="p">)</span>
<a id="__codelineno-0-454" name="__codelineno-0-454"></a>
<a id="__codelineno-0-455" name="__codelineno-0-455"></a>    <span class="n">results</span> <span class="o">=</span> <span class="n">run_parallel_calculation</span><span class="p">(</span><span class="n">perform_generic_calculation_mp</span><span class="p">,</span> <span class="n">tasks</span><span class="p">,</span> <span class="n">program_name</span><span class="p">,</span> <span class="n">object_name</span><span class="o">=</span><span class="s2">&quot;calcultaion(s)&quot;</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">)</span>
<a id="__codelineno-0-456" name="__codelineno-0-456"></a>    <span class="n">clonosets_df</span> <span class="o">=</span> <span class="n">clonosets_df</span><span class="p">[</span><span class="n">columns_retain</span><span class="p">]</span>
<a id="__codelineno-0-457" name="__codelineno-0-457"></a>    <span class="n">df</span> <span class="o">=</span> <span class="n">clonosets_df</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">results</span><span class="p">),</span> <span class="n">how</span><span class="o">=</span><span class="s2">&quot;left&quot;</span><span class="p">)</span>
<a id="__codelineno-0-458" name="__codelineno-0-458"></a>    <span class="k">if</span> <span class="n">split_chain_after_calculation</span><span class="p">:</span>
<a id="__codelineno-0-459" name="__codelineno-0-459"></a>        <span class="n">df</span><span class="p">[</span><span class="s2">&quot;sample_id&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;sample_id&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="s2">&quot;_&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;_&quot;</span><span class="p">)[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]))</span>
<a id="__codelineno-0-460" name="__codelineno-0-460"></a>    <span class="k">return</span> <span class="n">df</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h4 id="stats.perform_generic_calculation_mp" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">perform_generic_calculation_mp</span><span class="p">(</span><span class="n">args</span><span class="p">)</span></code>

</h4>


    <div class="doc doc-contents ">

        <p>A single-core "worker" for <code>generic_calculation</code> function.
It applies clonoset filter (several times if <code>iterations</code> &gt; 1) and performes a
calculation for a single filtered clonoset.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>args</code>
            </td>
            <td>
                  <code><span title="tuple">tuple</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>tuple, containing all required parameters</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
<th>Name</th>          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
<td><code>clonoset_result</code></td>            <td>
                  <code><span title="dict">dict</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>a dictionary of parameters, calculated for given clonoset
and averaged for iterations (if &gt; 1)</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>repseq/stats.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-462">462</a></span>
<span class="normal"><a href="#__codelineno-0-463">463</a></span>
<span class="normal"><a href="#__codelineno-0-464">464</a></span>
<span class="normal"><a href="#__codelineno-0-465">465</a></span>
<span class="normal"><a href="#__codelineno-0-466">466</a></span>
<span class="normal"><a href="#__codelineno-0-467">467</a></span>
<span class="normal"><a href="#__codelineno-0-468">468</a></span>
<span class="normal"><a href="#__codelineno-0-469">469</a></span>
<span class="normal"><a href="#__codelineno-0-470">470</a></span>
<span class="normal"><a href="#__codelineno-0-471">471</a></span>
<span class="normal"><a href="#__codelineno-0-472">472</a></span>
<span class="normal"><a href="#__codelineno-0-473">473</a></span>
<span class="normal"><a href="#__codelineno-0-474">474</a></span>
<span class="normal"><a href="#__codelineno-0-475">475</a></span>
<span class="normal"><a href="#__codelineno-0-476">476</a></span>
<span class="normal"><a href="#__codelineno-0-477">477</a></span>
<span class="normal"><a href="#__codelineno-0-478">478</a></span>
<span class="normal"><a href="#__codelineno-0-479">479</a></span>
<span class="normal"><a href="#__codelineno-0-480">480</a></span>
<span class="normal"><a href="#__codelineno-0-481">481</a></span>
<span class="normal"><a href="#__codelineno-0-482">482</a></span>
<span class="normal"><a href="#__codelineno-0-483">483</a></span>
<span class="normal"><a href="#__codelineno-0-484">484</a></span>
<span class="normal"><a href="#__codelineno-0-485">485</a></span>
<span class="normal"><a href="#__codelineno-0-486">486</a></span>
<span class="normal"><a href="#__codelineno-0-487">487</a></span>
<span class="normal"><a href="#__codelineno-0-488">488</a></span>
<span class="normal"><a href="#__codelineno-0-489">489</a></span>
<span class="normal"><a href="#__codelineno-0-490">490</a></span>
<span class="normal"><a href="#__codelineno-0-491">491</a></span>
<span class="normal"><a href="#__codelineno-0-492">492</a></span>
<span class="normal"><a href="#__codelineno-0-493">493</a></span>
<span class="normal"><a href="#__codelineno-0-494">494</a></span>
<span class="normal"><a href="#__codelineno-0-495">495</a></span>
<span class="normal"><a href="#__codelineno-0-496">496</a></span>
<span class="normal"><a href="#__codelineno-0-497">497</a></span>
<span class="normal"><a href="#__codelineno-0-498">498</a></span>
<span class="normal"><a href="#__codelineno-0-499">499</a></span>
<span class="normal"><a href="#__codelineno-0-500">500</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-462" name="__codelineno-0-462"></a><span class="k">def</span><span class="w"> </span><span class="nf">perform_generic_calculation_mp</span><span class="p">(</span><span class="n">args</span><span class="p">):</span>
<a id="__codelineno-0-463" name="__codelineno-0-463"></a><span class="w">    </span><span class="sd">&#39;&#39;&#39;</span>
<a id="__codelineno-0-464" name="__codelineno-0-464"></a><span class="sd">    A single-core &quot;worker&quot; for `generic_calculation` function.</span>
<a id="__codelineno-0-465" name="__codelineno-0-465"></a><span class="sd">    It applies clonoset filter (several times if `iterations` &gt; 1) and performes a</span>
<a id="__codelineno-0-466" name="__codelineno-0-466"></a><span class="sd">    calculation for a single filtered clonoset.</span>
<a id="__codelineno-0-467" name="__codelineno-0-467"></a>
<a id="__codelineno-0-468" name="__codelineno-0-468"></a>
<a id="__codelineno-0-469" name="__codelineno-0-469"></a><span class="sd">    Args:</span>
<a id="__codelineno-0-470" name="__codelineno-0-470"></a><span class="sd">        args (tuple): tuple, containing all required parameters</span>
<a id="__codelineno-0-471" name="__codelineno-0-471"></a>
<a id="__codelineno-0-472" name="__codelineno-0-472"></a><span class="sd">    Returns:</span>
<a id="__codelineno-0-473" name="__codelineno-0-473"></a><span class="sd">        clonoset_result (dict): a dictionary of parameters, calculated for given clonoset</span>
<a id="__codelineno-0-474" name="__codelineno-0-474"></a><span class="sd">            and averaged for iterations (if &gt; 1)</span>
<a id="__codelineno-0-475" name="__codelineno-0-475"></a><span class="sd">    &#39;&#39;&#39;</span>
<a id="__codelineno-0-476" name="__codelineno-0-476"></a>
<a id="__codelineno-0-477" name="__codelineno-0-477"></a>
<a id="__codelineno-0-478" name="__codelineno-0-478"></a>    <span class="p">(</span><span class="n">sample_id</span><span class="p">,</span> <span class="n">filename</span><span class="p">,</span> <span class="n">calc_function</span><span class="p">,</span> <span class="n">clonoset_filter</span><span class="p">,</span> <span class="n">iterations</span><span class="p">,</span> <span class="n">seed</span><span class="p">,</span> <span class="n">program_name</span><span class="p">,</span> <span class="n">random_filter</span><span class="p">,</span> <span class="n">kwargs</span><span class="p">)</span> <span class="o">=</span> <span class="n">args</span>
<a id="__codelineno-0-479" name="__codelineno-0-479"></a>    <span class="n">clonoset</span> <span class="o">=</span> <span class="n">read_clonoset</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
<a id="__codelineno-0-480" name="__codelineno-0-480"></a>    <span class="n">colnames</span> <span class="o">=</span> <span class="n">get_column_names_from_clonoset</span><span class="p">(</span><span class="n">clonoset</span><span class="p">)</span>
<a id="__codelineno-0-481" name="__codelineno-0-481"></a>
<a id="__codelineno-0-482" name="__codelineno-0-482"></a>    <span class="k">if</span> <span class="n">random_filter</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">seed</span><span class="p">,</span> <span class="nb">int</span><span class="p">):</span>
<a id="__codelineno-0-483" name="__codelineno-0-483"></a>        <span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="n">seed</span><span class="p">)</span>
<a id="__codelineno-0-484" name="__codelineno-0-484"></a>
<a id="__codelineno-0-485" name="__codelineno-0-485"></a>    <span class="n">clonoset_result</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;sample_id&quot;</span><span class="p">:</span> <span class="n">sample_id</span><span class="p">}</span>
<a id="__codelineno-0-486" name="__codelineno-0-486"></a>    <span class="n">clonoset_results</span> <span class="o">=</span> <span class="p">[]</span>
<a id="__codelineno-0-487" name="__codelineno-0-487"></a>    <span class="n">filtered_clonosets</span> <span class="o">=</span> <span class="p">[]</span>
<a id="__codelineno-0-488" name="__codelineno-0-488"></a>
<a id="__codelineno-0-489" name="__codelineno-0-489"></a>    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">iterations</span><span class="p">):</span>
<a id="__codelineno-0-490" name="__codelineno-0-490"></a>        <span class="k">if</span> <span class="n">clonoset_filter</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-491" name="__codelineno-0-491"></a>            <span class="n">filtered_clonoset</span> <span class="o">=</span> <span class="n">clonoset_filter</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">clonoset</span><span class="p">,</span> <span class="n">colnames</span><span class="o">=</span><span class="n">colnames</span><span class="p">)</span>
<a id="__codelineno-0-492" name="__codelineno-0-492"></a>        <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-493" name="__codelineno-0-493"></a>            <span class="n">filtered_clonoset</span> <span class="o">=</span> <span class="n">clonoset</span>
<a id="__codelineno-0-494" name="__codelineno-0-494"></a>        <span class="n">filtered_clonosets</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">filtered_clonoset</span><span class="p">)</span>
<a id="__codelineno-0-495" name="__codelineno-0-495"></a>
<a id="__codelineno-0-496" name="__codelineno-0-496"></a>    <span class="k">for</span> <span class="n">filtered_clonoset</span> <span class="ow">in</span> <span class="n">filtered_clonosets</span><span class="p">:</span>
<a id="__codelineno-0-497" name="__codelineno-0-497"></a>        <span class="n">clonoset_results</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">calc_function</span><span class="p">(</span><span class="n">filtered_clonoset</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">))</span>
<a id="__codelineno-0-498" name="__codelineno-0-498"></a>    <span class="n">clonoset_result</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">clonoset_results</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span><span class="o">.</span><span class="n">to_dict</span><span class="p">())</span>
<a id="__codelineno-0-499" name="__codelineno-0-499"></a>
<a id="__codelineno-0-500" name="__codelineno-0-500"></a>    <span class="k">return</span> <span class="n">clonoset_result</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div><h2 id="tcrdist_clustering"><strong>tcrdist_clustering</strong></h2>


<div class="doc doc-object doc-module">




    <div class="doc doc-contents first">










  <div class="doc doc-children">












  </div>

    </div>

</div><h2 id="tcrdist_clusters_slurm"><strong>tcrdist_clusters_slurm</strong></h2>


<div class="doc doc-object doc-module">




    <div class="doc doc-contents first">










  <div class="doc doc-children">












  </div>

    </div>

</div><h2 id="vdjtools"><strong>vdjtools</strong></h2>


<div class="doc doc-object doc-module">




    <div class="doc doc-contents first">










  <div class="doc doc-children">












  </div>

    </div>

</div>












                
              </article>
            </div>
          
          
  <script>var tabs=__md_get("__tabs");if(Array.isArray(tabs))e:for(var set of document.querySelectorAll(".tabbed-set")){var labels=set.querySelector(".tabbed-labels");for(var tab of tabs)for(var label of labels.getElementsByTagName("label"))if(label.innerText.trim()===tab){var input=document.getElementById(label.htmlFor);input.checked=!0;continue e}}</script>

<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
          <button type="button" class="md-top md-icon" data-md-component="top" hidden>
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8z"/></svg>
  Back to top
</button>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
    <div class="md-copyright__highlight">
      &copy; 2023 <a href="https://github.com/mmjmike" target="_blank" rel="noopener">Mikhail Myshkin</a>
    </div>
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
        
<div class="md-social">
  
    
    
    
    
      
      
    
    <a href="https://github.com/mmjmike" target="_blank" rel="noopener" title="github.com" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Free 7.0.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M202.1 328.7c0 20.9-10.9 55.1-36.7 55.1s-36.7-34.2-36.7-55.1 10.9-55.1 36.7-55.1 36.7 34.2 36.7 55.1M496 278.2c0 31.9-3.2 65.7-17.5 95-37.9 76.6-142.1 74.8-216.7 74.8-75.8 0-186.2 2.7-225.6-74.8-14.6-29-20.2-63.1-20.2-95 0-41.9 13.9-81.5 41.5-113.6-5.2-15.8-7.7-32.4-7.7-48.8 0-21.5 4.9-32.3 14.6-51.8 45.3 0 74.3 9 108.8 36 29-6.9 58.8-10 88.7-10 27 0 54.2 2.9 80.4 9.2 34-26.7 63-35.2 107.8-35.2 9.8 19.5 14.6 30.3 14.6 51.8 0 16.4-2.6 32.7-7.7 48.2 27.5 32.4 39 72.3 39 114.2m-64.3 50.5c0-43.9-26.7-82.6-73.5-82.6-18.9 0-37 3.4-56 6-14.9 2.3-29.8 3.2-45.1 3.2-15.2 0-30.1-.9-45.1-3.2-18.7-2.6-37-6-56-6-46.8 0-73.5 38.7-73.5 82.6 0 87.8 80.4 101.3 150.4 101.3h48.2c70.3 0 150.6-13.4 150.6-101.3m-82.6-55.1c-25.8 0-36.7 34.2-36.7 55.1s10.9 55.1 36.7 55.1 36.7-34.2 36.7-55.1-10.9-55.1-36.7-55.1"/></svg>
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    
      
      <script id="__config" type="application/json">{"base": "..", "features": ["navigation.tabs", "navigation.sections", "navigation.path", "toc.integrate", "navigation.top", "search.suggest", "search.highlight", "content.tabs.link", "content.code.annotation", "content.code.copy"], "search": "../assets/javascripts/workers/search.973d3a69.min.js", "tags": null, "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}, "version": null}</script>
    
    
      <script src="../assets/javascripts/bundle.f55a23d4.min.js"></script>
      
    
  </body>
</html>